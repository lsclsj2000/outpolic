<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="outpolic.user.ranking.mapper.UserRankingMapper">
    <resultMap id="ContentsRankingMap" type="outpolic.user.ranking.domain.UserRankingContentsDTO">
        <id 	property="rankingView" 		column="rk_view" />
        <result property="osCode" 	column="os_cd" />
        <result property="entName" column="ent_nm" />
        <result property="ctgryName" column="ctgry_nm" />
        <result property="osTtl" column="os_ttl" />
        <result property="osExpln" column="os_expln" />
        <result property="reviewScore" column="avg_review_score" />
        
    </resultMap>
	<select id="getUserRankingOsContents" resultMap="ContentsRankingMap">
		SELECT
		    r.rk_view,
		    o.os_cd,
		    e.ent_nm,
		    c.ctgry_nm,
		    o.os_ttl,
		    o.os_expln,
		    IFNULL(AVG(r2.rvw_evl), 0) AS avg_review_score
		FROM
		    -- ▼▼▼ 핵심 변경점 1: 그냥 ranking 테이블 대신, 서브쿼리를 사용합니다 ▼▼▼
		    (
		        SELECT
		            cl_cd,
		            rk_view,
		            -- 각 cl_cd 그룹 내에서 rk_date를 기준으로 내림차순 정렬하여 순번을 매깁니다.
		            -- 가장 최신 날짜가 1번이 됩니다.
		            ROW_NUMBER() OVER (PARTITION BY cl_cd ORDER BY rk_tot_ymd DESC) AS rn
		        FROM
		            ranking
		    ) r 
		JOIN
		    content_list cl ON r.cl_cd = cl.cl_cd
		JOIN
		    outsourcing o ON cl.cntd_cd = o.os_cd
		JOIN
		    category c ON o.ctgry_id = c.ctgry_id
		JOIN
		    enterprise e ON o.ent_cd = e.ent_cd
		LEFT JOIN
		    outsourcing_contract_details ocd ON cl.cl_cd = ocd.cl_cd
		LEFT JOIN
			outsourcing_status os on ocd.ocd_cd = os.ocd_cd 
		LEFT JOIN 
		    outsourcing_contract oc ON os.oss_prgs_cd = oc.ocd_cd
		LEFT JOIN
		    review r2 ON oc.osc_id = r2.osc_id
		WHERE
		    -- ▼▼▼ 핵심 변경점 2: 서브쿼리에서 매긴 순번(rn)이 1인 것만 필터링 ▼▼▼
		    r.rn = 1 
		    AND cl.cntd_cd LIKE 'os%' -- '외주' 콘텐츠만 필터링
		GROUP BY
		    r.rk_view,
		    o.os_cd,
		    e.ent_nm,
		    c.ctgry_nm,
		    o.os_ttl,
		    o.os_expln
		ORDER BY
		    r.rk_view DESC;
				
	</select>
 </mapper>