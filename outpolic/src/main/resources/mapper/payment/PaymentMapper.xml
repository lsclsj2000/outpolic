<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper	namespace="outpolic.systems.payment.mapper.PaymentMapper">

	<insert id="insertSettlement" parameterType="outpolic.systems.payment.dto.SettlementDTO">
		<selectKey keyProperty="stlmCd" resultType="String" order="BEFORE">
			SELECT
				CASE
					WHEN COUNT(*) = 0 THEN 'STLM_C1'
				ELSE CONCAT(
					'STLM_C',
					MAX(CAST(SUBSTRING_INDEX(stlm_cd, 'STLM_C', -1) AS UNSIGNED)) + 1
				)
			END AS newCode
			FROM settlement
			WHERE stlm_cd LIKE 'STLM_C%';
		</selectKey>
		INSERT INTO settlement (
			stlm_cd,
			mbr_cd,
			gds_cd,
			stc_cd,
			stlm_cnt,
			stlm_amt,
			stlm_used_points,
			stlm_final_amt,
			stlm_payment_info,
			stlm_card_nm,
			stlm_provider_nm,
			stlm_ymdt,
			stlm_method,
			stlm_card_type
		)
		VALUES (
			#{stlmCd},
			#{mbrCd},
			#{gdsCd},
			#{stcCd},
			#{stlmCnt},
			#{stlmAmt},
			#{stlmUsedPoints},
			#{stlmFinalAmt},
			#{stlmPaymentInfo},
			#{stlmCardNm},
			#{stlmProviderNm},
			#{stlmYmdt},
			#{stlmMethod},
			#{stlmCardType}
		)
	</insert>
	
	<select id="selectActiveProductsByTarget" parameterType="string" resultType="outpolic.user.goods.dto.UserGoodsDTO">
	    SELECT
	        gds_cd,
	        gds_nm,
	        gds_amt,
	        gds_type,
	        gds_period_quantity,
	        gds_unit
	    FROM
	        goods
	    WHERE
	        (gds_target_member_type = #{targetMemberType} OR gds_target_member_type = 'ALL')
	        AND gds_status = 1
	    ORDER BY
	        -- 1순위: '구독권'이 먼저, 그 다음 '이용권' 순으로 정렬
	        CASE
	            WHEN gds_type = '구독권' THEN 1
	            WHEN gds_type = '이용권' THEN 2
	            ELSE 99
	        END,
	        -- 2순위: 같은 종류 내에서는 가격이 낮은 순으로 정렬
	        gds_amt ASC
	</select>

</mapper>
