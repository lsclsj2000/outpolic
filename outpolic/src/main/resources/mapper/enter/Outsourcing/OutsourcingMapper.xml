<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="outpolic.enter.outsourcing.mapper.OutsourcingMapper">
	<resultMap id="outsourcingResultMap" type="EnterOutsourcing">
		<id property = "osCd" column="os_cd"/>
		<result property="entCd" column="ent_cd"/>
		<result property="ctgryId" column="ctgry_id" />
		<result property="osTtl" column="os_ttl"/>
		<result property="osExpln" column="os_expln"/>
		<collection property="tagNames" javaType="java.util.List" ofType="java.lang.String" column="os_cd" select="findTagNamesByOsCd"/>
	</resultMap>

    <!-- 수정된 부분 -->
	<insert id="insertOutsourcing" parameterType="EnterOutsourcing">
		/* 외주 등록 insert 구문 */
		insert into outsourcing(
			os_cd, ent_cd, ctgry_id, os_ttl, os_expln, os_reg_ymdt, mbr_cd, stc_cd, os_strt_ymdt, os_end_ymdt, os_amt, os_flfmt_cnt)
		VALUES
			(#{osCd}, #{entCd}, #{ctgryId}, #{osTtl}, #{osExpln}, NOW(), #{mbrCd}, #{stcCd}, #{osStrtYmdt}, #{osEndYmdt}, #{osAmt}, #{osFlfmtCnt})
	</insert>

	<insert id="insertContentList">
		/* 콘텐츠 목록 코드 insert 구문 */
		insert into content_list
		    (cl_cd, cntd_cd, cl_reg_ymdt) 
		values 
		    (#{clCd}, #{cntdCd}, NOW())
	</insert>

    <!-- 수정된 부분 -->
	<insert id="insertCategoryMapping">
		/* 카테고리 매핑 insert 구문 */
		insert into category_mapping
			(ctgry_id, cl_cd, cm_reg_ymdt, mbr_cd) 
		values 
		    (#{ctgryId}, #{clCd}, NOW(), #{mbrCd})
	</insert>
	
    <!-- 수정된 부분 -->
	<insert id="insertTag">
		/* 태그 insert 구문 */
		insert into tag 
		    (tag_cd, tag_nm, mbr_cd, tag_reg_ymdt) 
		values 
		    (#{tagCd}, #{tagName}, #{mbrCd}, NOW())
	</insert>

	<insert id="insertTagMapping">
		/* 태그매핑 insert 구문 */
		insert into tag_mapping 
		    (tag_cd, cl_cd, tm_reg_ymdt, mbr_cd, stc_cd) 
		values 
		    (#{tagCd}, #{clCd}, NOW(), #{mbrCd}, 'SD_ACTIVE')
	</insert>
<!-- 
	<select id="findFilesByOsCd" resultType="outpolic.enter.outsourcing.domain.FileMetaData">
	SELECT
        f.file_cd         as fileIdx,
        f.file_reg_ymdt   as fileRegYmdt,
        f.file_mdfcn_ymdt as fileMdfcnYmdt,
        f.file_extn       as fileExtn,
        f.file_orgnl_nm   as fileOriginalName,
        f.file_srvr_nm    as fileNewName,
        f.file_path       as filePath,
        f.cl_cd           as clCd,
        f.mbr_cd          as mbrCd
    FROM
        file f
    JOIN
        content_list cl ON f.cl_cd = cl.cl_cd
    WHERE
    	cl.cntd_cd = #{osCd}
    order by
    	f.file_reg_ymdt asc
	</select>
	
    collection select="findTagNamesByOsCd"를 위한 쿼리 추가
	<select id="findTagNamesByOsCd" resultType="String">
        SELECT 
            t.tag_nm
        FROM
            tag t
        JOIN
            tag_mapping tm ON t.tag_cd = tm.tag_cd
        JOIN
            content_list cl ON tm.cl_cd = cl.cl_cd
        WHERE
            cl.cntd_cd = #{osCd}
    </select>
 -->
	<select id="findOutsourcingDetailsByEntCd" resultMap = "outsourcingResultMap">
		select
		*
		from
			outsourcing
		where
			ent_cd = #{entCd}
		order by
			os_reg_ymdt desc;
	</select>
	<select id="findOutsourcingDetailsByOsCd" resultMap="outsourcingResultMap">
		select
		*
		from
			outsourcing
		where
			os_cd = #{osCd};
	</select>
	<select id="findLatestOsCd" resultType="String">
		/* 외주 테이블 'OS_C'로 시작하는 코드중, 뒤에 붙는 숫자가 가장 큰 코드 하나를 찾는 구문 */
		select
			os_cd
		from
			outsourcing
		where
			os_cd like 'OS_C%'
		order by
			cast(substring(os_cd,5) as unsigned) desc
		limit 1
	</select>
	<select id="findLatestTagCd" resultType="String">
		/* 태그 테이블에서 'T_C'로 시작하는 태그 코드 중,뒤에 붙는 숫자가 가장 큰 코드 하나를 찾는 구문입니다. */
		select
			tag_cd
		FROM
			tag
		where tag_cd LIKE 'T_C%'
		order by cast(substring(tag_cd,5) as unsigned) desc
		limit 1
	</select>
	<select id="findTagCdByName" resultType="String">
	 /*  'T_C00127'인 데이터의 tag_cd (태그 코드)를 찾아달라는 의미입니다. */
	select
		tag_cd
	from
		tag
	WHERE
		tag_nm = #{tagNm};
	</select>

	<delete id="deleteOutsourcingByOsCd">
		/* 특정 외주 코드 삭제 구문 */
		delete
		from
			outsourcing
		where
			os_cd = #{osCd}
	</delete>
	<delete id="deleteContentListByClCd">
		delete
		from
			content_list
		where
			cl_cd = #{clCd}
	</delete>
	<delete id="deleteCategoryMappingByClCd">
		delete
		from
			category_mapping
		where
			cl_cd = #{clCd}
	</delete>

	<update id="updateOutsourcing" parameterType="EnterOutsourcing">
		update
			outsourcing
		set
			os_ttl = #{osTtl},
			os_expln=#{osExpln},
			os_mdfcn_ymdt = NOW() <!-- 수정 시각은 NOW() 함수를 사용하는 것이 일반적입니다 -->
		where
			os_cd = #{osCd}
	</update>

</mapper>