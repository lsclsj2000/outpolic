<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="outpolic.enter.portfolio.mapper.PortfolioMapper">

    <resultMap id="portfolioDetailResultMap" type="outpolic.enter.portfolio.domain.EnterPortfolio">
        <id property="prtfCd" column="prtf_cd"/>
        <result property="entCd" column="ent_cd"/>
        <result property="prtfTtl" column="prtf_ttl"/>
        <result property="prtfCn" column="prtf_cn"/>
        <result property="prtfDwnldCnt" column="prtf_dwnld_cnt"/>
        <result property="prtfRegYmdt" column="prtf_reg_ymdt"/>
        <result property="admCd" column="adm_cd"/>
        <result property="prtfMdfcnYmdt" column="prtf_mdfcn_ymdt"/>
        <result property="stcCd" column="stc_cd"/>
        <collection property="categories" ofType="outpolic.enter.POAddtional.domain.CategorySearchDto">
            <id property="ctgryId" column="category_id"/>
            <result property="ctgryNm" column="category_name"/>
        </collection>
        <collection property="tagNames" ofType="java.lang.String">
            <result column="tag_name"/>
        </collection>
    </resultMap>

    <select id="findPortfolioDetailsByEntCd" resultMap="portfolioDetailResultMap">
        SELECT
            p.prtf_cd, p.ent_cd, p.prtf_ttl, p.prtf_cn, p.prtf_dwnld_cnt, p.prtf_reg_ymdt, p.adm_cd, p.prtf_mdfcn_ymdt, p.stc_cd,
            c.ctgry_id AS category_id,
            c.ctgry_nm AS category_name,
            t.tag_nm AS tag_name
        FROM
            portfolio p
        LEFT JOIN content_list cl ON p.prtf_cd = cl.cntd_cd AND cl.cl_cd LIKE 'LIST_PO_C%'
        LEFT JOIN category_mapping cm ON cl.cl_cd = cm.cl_cd
        LEFT JOIN category c ON cm.ctgry_id = c.ctgry_id
        LEFT JOIN tag_mapping tm ON cl.cl_cd = tm.cl_cd
        LEFT JOIN tag t ON tm.tag_cd = t.tag_cd
        WHERE
            p.ent_cd = #{entCd}
        ORDER BY
            p.prtf_reg_ymdt DESC
    </select>

    <select id="findPortfolioDetailsByPrtfCd" resultMap="portfolioDetailResultMap">
        SELECT
            p.prtf_cd, p.ent_cd, p.prtf_ttl, p.prtf_cn, p.prtf_dwnld_cnt, p.prtf_reg_ymdt, p.adm_cd, p.prtf_mdfcn_ymdt, p.stc_cd,
            c.ctgry_id AS category_id,
            c.ctgry_nm AS category_name,
            t.tag_nm AS tag_name
        FROM
            portfolio p
        LEFT JOIN content_list cl ON p.prtf_cd = cl.cntd_cd AND cl.cl_cd LIKE 'LIST_PO_C%'
        LEFT JOIN category_mapping cm ON cl.cl_cd = cm.cl_cd
        LEFT JOIN category c ON cm.ctgry_id = c.ctgry_id
        LEFT JOIN tag_mapping tm ON cl.cl_cd = tm.cl_cd
        LEFT JOIN tag t ON tm.tag_cd = t.tag_cd
        WHERE
            p.prtf_cd = #{prtfCd}
    </select>

    <select id="findPortfoliosByTitle" resultType="EnterPortfolio">
        SELECT
            prtf_cd,
            prtf_ttl
        FROM
            portfolio
        WHERE
            prtf_ttl LIKE CONCAT('%',#{query},'%')
        ORDER BY
            prtf_reg_ymdt DESC
        LIMIT 10
    </select>
	
    <select id="countPortfoliosByEntCd" resultType="int">
        SELECT COUNT(*) FROM portfolio WHERE ent_cd = #{entCd}
    </select>

    <insert id="insertPortfolio" parameterType="EnterPortfolio">
        INSERT INTO portfolio (prtf_cd, ent_cd, prtf_ttl, prtf_cn, prtf_dwnld_cnt, prtf_reg_ymdt, adm_cd, stc_cd)
        VALUES (#{prtfCd}, #{entCd}, #{prtfTtl}, #{prtfCn}, 0, NOW(), #{admCd}, 'SD_ACTIVE')
    </insert>

    <insert id="insertContentList">
        INSERT INTO content_list (cl_cd, cntd_cd, cl_reg_ymdt)
        VALUES (#{clCd}, #{cntdCd}, NOW())
    </insert>

    <insert id="insertCategoryMapping">
        INSERT INTO category_mapping (ctgry_id, cl_cd, cm_reg_ymdt, mbr_cd)
        VALUES (#{ctgryCd}, #{clCd}, NOW(), #{mbrCd})
    </insert>

    <insert id="insertTag">
        INSERT INTO tag (tag_cd, tag_nm, mbr_cd, tag_reg_ymdt)
        VALUES (#{tagCd}, #{tagName}, #{mbrCd}, NOW())
    </insert>
    
    <insert id="insertTagMapping">
        INSERT INTO tag_mapping (tag_cd, cl_cd, tm_reg_ymdt, mbr_cd, stc_cd)
        VALUES (#{tagCd}, #{clCd}, NOW(), #{mbrCd}, 'SD_ACTIVE')
    </insert>

    <update id="updatePortfolio" parameterType="EnterPortfolio">
        UPDATE portfolio
        SET
            prtf_ttl = #{prtfTtl},
            prtf_cn = #{prtfCn},
            prtf_mdfcn_ymdt = NOW(),
            adm_cd = #{admCd}
        WHERE
            prtf_cd = #{prtfCd}
    </update>

    <delete id="deleteCategoryMappingByClCd">
        DELETE FROM category_mapping WHERE cl_cd = #{clCd}
    </delete>

    <delete id="deleteTagMappingByClCd">
        DELETE FROM tag_mapping WHERE cl_cd = #{clCd}
    </delete>

    <delete id="deleteOutsourcingPortfolioByPrtfCd">
        DELETE FROM outsourcing_portfolio WHERE prtf_cd = #{prtfCd}
    </delete>
    
    <delete id="deleteBookmarkByClCd">
        DELETE FROM bookmark WHERE cl_cd = #{clCd}
    </delete>

    <delete id="deleteContentListByClCd">
        DELETE FROM content_list WHERE cl_cd = #{clCd}
    </delete>

    <delete id="deletePortfolioByPrtfCd">
        DELETE FROM portfolio WHERE prtf_cd = #{prtfCd}
    </delete>


    <select id="findLatestPrtfCd" resultType="String">
        SELECT prtf_cd FROM portfolio WHERE prtf_cd LIKE 'PO_C%'
        ORDER BY CAST(SUBSTRING(prtf_cd, 5) AS UNSIGNED) DESC LIMIT 1
    </select>

    <select id="findLatestTagCd" resultType="String">
        SELECT tag_cd FROM tag WHERE tag_cd LIKE 'T_C%'
        ORDER BY CAST(SUBSTRING(tag_cd, 5) AS UNSIGNED) DESC LIMIT 1
    </select>

    <select id="findTagCdByName" resultType="String">
        SELECT tag_cd FROM tag WHERE tag_nm = #{tagName}
    </select>
    
    <select id="findClCdByPrtfCd" resultType="String">
        SELECT cl_cd FROM content_list WHERE cntd_cd = #{prtfCd} LIMIT 1
    </select>

</mapper>