<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{admin/layout/adminLayoutMain}">

	<head>
		<meta name="description" content="í•œêµ­ìŠ¤ë§ˆíŠ¸ì •ë³´êµìœ¡ì› íŒ€í”„ë¡œì íŠ¸" />
	</head>
	
	<body>
		<th:block layout:fragment="contents">
			<section class="content-main">
                <div class="content-header">
                	<h2 class="content-title card-title">ê¸°ì—… ëª©ë¡</h2>
                </div>
                <div class="card mb-4">
                    <header class="card-header">
                        <div class="card mb-4 search-filter-card" style="border:none;">
						  <div class="card-body search-filter-body" >
						    <div class="table-responsive">
						      <table class="search-filter-table" >
						        <tbody>
						          <!-- ğŸ” ê²€ìƒ‰ë°” ë¼ì¸ -->
						          <tr>
						            <th>ê²€ìƒ‰</th>
						            <td>
						              <div class="d-flex align-items-center gap-2">
						                <input type="text" id="searchInput" class="form-control" placeholder="ê¸°ì—…ëª…, ëŒ€í‘œìëª…, ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸, íšŒì›ì½”ë“œ ê²€ìƒ‰" style="width: 300px;" />
						                <button type="button" class="btn btn-primary btn-sm" id="searchBtn">ê²€ìƒ‰</button>
						              </div>
						            </td>
						          </tr>
						
						          <!-- ğŸ”½ ë“œë¡­ë‹¤ìš´ 2ê°œ ë¼ì¸ -->
						          <tr>
						            <th>í•„í„°</th>
						            <td>
						              <div class="d-flex align-items-center gap-3">
						                <!-- ìƒíƒœ í•„í„° -->
						                <select id="filterStatus" class="form-select form-select-sm" style="width: 180px;">
						                  <option value="">ì „ì²´ ìƒíƒœ</option>
						                  <option value="SD_ACTIVE">í™œì„± ê¸°ì—…</option>
						                  <option value="SD_DORMANT">íƒˆí‡´ ê¸°ì—…</option>
						                  <option value="SD_WITHDRAWN">íœ´ë©´ ê¸°ì—…</option>
						                  <option value="SD_LIMIT">ì œì¬ ê¸°ì—…</option>
						                </select>
						              </div>
						            </td>
						          </tr>
						        </tbody>
						      </table>
						    </div>
						  </div>
						</div>
                    </header>
                    </div>
                    <div class="card mb-4">
                    <!-- card-header end// -->
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
    <thead>
        <tr class="text-center">
            <th scope="col">íšŒì› ì½”ë“œ</th>
            <th scope="col">ê¸°ì—…ëª…</th>
            <th scope="col">ëŒ€í‘œìëª…</th>
            <th scope="col">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</th>
            <th scope="col">ì—°ë½ì²˜</th>
            <th scope="col">ì£¼ì†Œ</th>
            <th scope="col">ìƒíƒœ</th>
            <th scope="col">ìƒì„¸ì •ë³´</th>
        </tr>
    </thead>
    <tbody id="enterTableBody" class="text-center">
        <tr th:if="${not #lists.isEmpty(enterList)}"
            th:each="corp : ${enterList}">
            <td th:text="${corp.memberCode}">íšŒì› ì½”ë“œ</td>
            <td th:text="${corp.corpName}">ê¸°ì—…ëª…</td>
            <td th:text="${corp.corpRprsv}">ëŒ€í‘œìëª…</td>
            <td th:text="${corp.corpBrno}">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</td>
            <td th:text="${corp.corpTelNo}">ì—°ë½ì²˜</td>
            <td th:text="${corp.corpAddress} + ' ' + ${corp.corpDAddress}">ì£¼ì†Œ</td>
            <td th:switch="${corp.statusCode}">
                <span th:case="SD_ACTIVE" class="badge rounded-pill alert-success">í™œì„±</span>
                <span th:case="SD_WITHDRAWN" class="badge rounded-pill alert-info">íœ´ë©´</span>
                <span th:case="SD_DORMANT" class="badge rounded-pill alert-info">íƒˆí‡´</span>
                <span th:case="SD_LIMIT" class="badge rounded-pill alert-warning">ì œì¬</span>
            </td>
            <td>
                <button class="btn btn-primary w-55 fw-bold btn-detail"
                        th:data-code="${corp.memberCode}"
                        data-bs-toggle="modal"
                        data-bs-target="#memberDetailModal">ìƒì„¸ì •ë³´</button>
            </td>
        </tr>
    </tbody>
</table>
                        </div>
                        <!-- table-responsive //end -->
                    </div>
                    <!-- card-body end// -->
                </div>
            </section>
            
            <div class="modal fade p-10" id="memberDetailModal" tabindex="-1" aria-hidden="true">
			    <div class="modal-dialog modal-lg">
			        <div class="modal-content">
			            <div class="modal-header">
			                <h3>ê¸°ì—… ìƒì„¸ ì •ë³´</h3>
			                <button type="button" class="btn btnEditMember btn-primary w-70 fw-bold">ì •ë³´ ìˆ˜ì •í•˜ê¸°</button>
			            </div>
			            <div class="modal-body">
			                <form class="admin memberEdit" th:action="@{/admin/enterList/detail}" method="post">
			                    <div class="row g-3">
			                        <div class="col-md-6">
			                            <label for="memberCode">íšŒì› ì½”ë“œ</label>
			                            <input type="text" id="memberCode" name="memberCode" class="form-control" disabled />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpName">ê¸°ì—…ëª…</label>
			                            <input type="text" id="corpName" name="corpName" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpRprsv">ëŒ€í‘œìëª…</label>
			                            <input type="text" id="corpRprsv" name="corpRprsv" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpBrno">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
			                            <input type="text" id="corpBrno" name="corpBrno" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpTelNo">ì—°ë½ì²˜</label>
			                            <input type="text" id="corpTelNo" name="corpTelNo" class="form-control" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpFndnYmdt">ì„¤ë¦½ì¼</label>
			                            <input type="text" id="corpFndnYmdt" name="corpFndnYmdt" class="form-control" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpZip">ìš°í¸ë²ˆí˜¸</label>
			                            <input type="text" id="corpZip" name="corpZip" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpAddress">ì£¼ì†Œ</label>
			                            <input type="text" id="corpAddress" name="corpAddress" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpDAddress">ìƒì„¸ì£¼ì†Œ</label>
			                            <input type="text" id="corpDAddress" name="corpDAddress" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpScl">ê¸°ì—… ê·œëª¨</label>
			                            <input type="text" id="corpScl" name="corpScl" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpUrl">í™ˆí˜ì´ì§€</label>
			                            <input type="text" id="corpUrl" name="corpUrl" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpScr">ì‹ ë¢°ë„ ì ìˆ˜</label>
			                            <input type="text" id="corpScr" name="corpScr" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpPortfolioCount">í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜</label>
			                            <input type="text" id="corpPortfolioCount" name="corpPortfolioCount" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpOutsourcingCount">ì™¸ì£¼ê¸€ ìˆ˜</label>
			                            <input type="text" id="corpOutsourcingCount" name="corpOutsourcingCount" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpJoinYmdt">ê°€ì…ì¼</label>
			                            <input type="text" id="corpJoinYmdt" name="corpJoinYmdt" class="form-control readonly-field" readonly />
			                        </div>
			                        <div class="col-md-6">
			                            <label for="corpStatusCode">ìƒíƒœ</label>
			                            <select id="corpStatusCode" name="corpStatusCode" class="form-select readonly-field" disabled>
			                                <option value="SD_ACTIVE">í™œì„±</option>
			                                <option value="SD_WITHDRAWN">íœ´ë©´</option>
			                                <option value="SD_DORMANT">íƒˆí‡´</option>
			                                <option value="SD_LIMIT">ì œì¬</option>
			                            </select>
			                        </div>
			                    </div>
			                    <div class="text-center mt-4">
			                        <button type="button" id="btnSave" class="btn btnSave btn-primary w-70 fw-bold">ì •ë³´ ìˆ˜ì •</button>
			                    </div>
			                </form>
			            </div>
			        </div>
			    </div>
			</div>
		</th:block>
		<th:block layout:fragment="jsScript">
		<script>
		console.log("ìŠ¤í¬ë¦½íŠ¸ ë¡œë”©ë¨");
			$(document).ready(function () {
				// í•„í„°
				 $('#filterStatus, #filterGrade').change(function () {
				        const status = $('#filterStatus').val();
				        const grade = $('#filterGrade').val();
					
				        $.ajax({
				        url: '/admin/memberList/filter',
				            type: 'GET',
				            data: {
				                statusCode: status,
				                gradeCode: grade
				            },
				            dataType: 'json',
				            success: renderMemberList,
				            error: () => alert("í•„í„°ë§ ì‹¤íŒ¨")
				        });
				    });
					
				    // ê²€ìƒ‰
				    $('#searchBtn').click(function () {
				        const keyword = $('#searchInput').val().trim();
				        if (keyword === '') {
				            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
				            return;
				        }
						$('#filterStatus').val('');
 						$('#filterGrade').val('');
				        $.ajax({
				            url: '/admin/memberList/search',
				            type: 'GET',
				            data: { keyword: keyword },
				            success: renderMemberList,
				            error: () => alert("ê²€ìƒ‰ ì‹¤íŒ¨")
				        });
				    });
				
				    // íšŒì› ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ (ê³µí†µ)
				    function renderMemberList(data) {
					  const tbody = $('#memberTableBody');
					  tbody.empty();
					
					  if (!data || data.length === 0) {
					    tbody.append('<tr><td colspan="9" class="text-center">ì¡°íšŒëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
					    return;
					  }
					
					  data.forEach(l => {
					    const gradeLabel = l.gradeCode === 'ADMIN'
					      ? '<span class="badge rounded-pill alert-warning">ê´€ë¦¬ì</span>'
					      : l.gradeCode === 'ENTER'
					        ? '<span class="badge rounded-pill alert-info">ê¸°ì—…íšŒì›</span>'
					        : '<span class="badge rounded-pill alert-success">ì¼ë°˜íšŒì›</span>';
					
					    const statusLabel = l.statusCode === 'SD_ACTIVE'
					      ? '<span class="badge rounded-pill alert-success">í™œì„±</span>'
					      : l.statusCode === 'SD_WITHDRAWN'
					        ? '<span class="badge rounded-pill alert-info">íœ´ë©´</span>'
					        : l.statusCode === 'SD_DORMANT'
					          ? '<span class="badge rounded-pill alert-info">íƒˆí‡´</span>'
					          : '<span class="badge rounded-pill alert-warning">ì œì¬</span>';
					
					    const telMasked = l.memberTelNo.substring(0, 3) + '-****-' + l.memberTelNo.slice(-4);
					
					    const row = `
					      <tr class="text-center">
					        <td>${l.memberCode}</td>
					        <td>${l.memberName}</td>
					        <td>${l.memberId}</td>
					        <td>${l.memberNickname}</td>
					        <td>${gradeLabel}</td>
					        <td>${telMasked}</td>
					        <td>${statusLabel}</td>
					        <td>${l.memberAgreeYN === '1' ? 'Y' : 'N'}</td>
					        <td>
					          <button class="btn btn-primary w-55 fw-bold btn-detail"
					                  data-code="${l.memberCode}"
					                  data-bs-toggle="modal"
					                  data-bs-target="#memberDetailModal">ìƒì„¸ì •ë³´</button>
					        </td>
					      </tr>
					    `;
					
					    tbody.append(row);
					  });
					}
				$('#memberDetailModal').on('hidden.bs.modal', function () {
				    console.log("ëª¨ë‹¬ ë‹«í˜ ì´ë²¤íŠ¸ ì‹¤í–‰");
				    $('body').removeClass('modal-open');
				    $('.modal-backdrop').remove();
				     $('.readonly-field').prop('readonly', true);
			        $('#modalMemberStatusCode').prop('disabled', true);
			        $('#modalMemberGradeCode').prop('disabled', true);
				});
			console.log("ğŸš¨ document.ready ì‹¤í–‰ë¨");
			let isSaveHandlerBound = false;
			    // ìƒì„¸ì •ë³´ ë³´ê¸° ë²„íŠ¼ í´ë¦­
			    $(document).on('click', '.btn-detail', function () { 	
			        const memberCode = $(this).data('code');
			
			        $.ajax({
			            url: '/admin/memberList/detail',
			            type: 'GET',
			            data: { memberCode },
			            success: function (data) {
			                $('#memberCode').val(data.memberCode);
			                $('#modalMemberId').val(data.memberId);
			                $('#modalMemberGradeCode').val(data.gradeCode);
			                $('#modalMemberName').val(data.memberName);
			                $('#modalMemberEmail').val(data.memberEmail);
			                $('#modalMemberNickname').val(data.memberNickname);
			                $('#modalMemberTelNo').val(data.memberTelNo);
			                $('#modalMemberBirth').val(data.memberBirth);
			                $('#modalMemberZip').val(data.memberZip);
			                $('#modalMemberAddress').val(data.memberAddress);
			                $('#modalMemberDAddress').val(data.memberDAddress);
			                $('#modalMemberAgree').val(data.memberAgreeYN);
			                $('#modalMemberJoinYmdt').val(data.memberJoinYmdt);
			                $('#modalMemberStatusCode').val(data.statusCode);
			                $('#modalMemberLastLoginYmdt').val(data.memberLastLoginYmdt);
			
			                const modalEl = document.getElementById('memberDetailModal');
			                if (!modalEl) {
			                    alert('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
			                    console.log("ëª¨ë‹¬ìš”ì†Œê°€ì—†ìŠµë‹ˆë‹¤.");
			                    return;
			                }
			
			                const modal = new bootstrap.Modal(modalEl);
			                modal.show();
			            },
			            error: function () {
			                alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
			            }
			        });
			    });
			
			    // ìˆ˜ì •ëª¨ë“œ í™œì„±í™”
			    $('.btnEditMember').click(function () {
			        $('.readonly-field').prop('readonly', false);
			        $('#modalMemberStatusCode').prop('disabled', false);
			        $('#modalMemberGradeCode').prop('disabled', false);
			    });
			
			    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
			    if (!isSaveHandlerBound) {
			        $(document).on('click', '.btnSave', function () {
			            console.log("btnSave clicked");
			
			            const nickname = $('#modalMemberNickname').val().trim();
			            const memberCode = $('#memberCode').val();
			            
				        if (nickname !== "") { // ë¹ˆ ë¬¸ìì—´ ê²€ì‚¬
				            $.ajax({
				                url: '/admin/check/nickname',
				                type: 'GET',
				                data: {
				                    nickname: nickname,
				                    memberCode: memberCode
				                },
				                success: function (isAvailable) {
				                    if (!isAvailable) {
				                        alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
				                        $('#modalMemberNickname').focus();
				                        return;
				                    }
				
				                    const memberData = {
				                        memberCode: memberCode,
				                        memberNickname: nickname,
				                        gradeCode: $('#modalMemberGradeCode').val(),
				                        memberZip: $('#modalMemberZip').val(),
				                        memberAddress: $('#modalMemberAddress').val(),
				                        memberDAddress: $('#modalMemberDAddress').val(),
				                        statusCode: $('#modalMemberStatusCode').val()
				                    };
				
				                    $.ajax({
				                        url: '/admin/memberList/detail/update',
				                        method: 'POST',
				                        contentType: 'application/json',
				                        data: JSON.stringify(memberData),
				                        success: function (result) {
				                            if (result === 'success') {
				                                alert('íšŒì› ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
				                                location.reload();
				                            } else {
				                                alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
				                            }
				                        },
				                        error: function () {
				                            alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
				                        }
				                    });
				                },
				                error: function () {
				                    alert('ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
				                }
				            });
				            isSaveHandlerBound = true;
				        } else {
				            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
				            $('#modalMemberNickname').focus();
				        }
				    });	
			    }
			
			});
			
		</script>
		</th:block>
	</body>
	
</html>