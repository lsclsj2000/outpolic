<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{admin/layout/adminLayoutMain}">

	<head>
		<meta name="description" content="í•œêµ­ìŠ¤ë§ˆíŠ¸ì •ë³´êµìœ¡ì› íŒ€í”„ë¡œì íŠ¸" />
	</head>
	
	<body>
		<th:block layout:fragment="contents">
			<section class="content-main">
                <div class="content-header">
                	<h2 class="content-title card-title">
					    <span th:switch="${status}">
					        <span th:case="'active'">í™œì„±</span>
					        <span th:case="'withdrawn'">íƒˆí‡´</span>
					        <span th:case="'dormant'">íœ´ë©´</span>
					        <span th:case="'limit'">ì œì¬</span>
					    </span>
                	íšŒì› ëª©ë¡</h2>
                </div>
                <div class="card mb-4">
                    <header class="card-header">
                        <div class="row gx-3">
                            <div class="col-lg-4 col-md-6 me-auto">
                                <input type="text" placeholder="Search..." class="form-control" />
                            </div>
                            <div class="col-lg-2 col-6 col-md-3">
                                <select class="form-select">
                                    <option>ì „ì²´ íšŒì›</option>
                                    <option>í™œì„± íšŒì›</option>
                                    <option>íœ´ë©´ íšŒì›</option>
                                    <option>íƒˆí‡´ íšŒì›</option>
                                </select>
                            </div>
                            <div class="col-lg-2 col-6 col-md-3">
                                <select class="form-select">
                                    <option>Show 20</option>
                                    <option>Show 30</option>
                                    <option>Show 40</option>
                                </select>
                            </div>
                        </div>
                    </header>
                    <!-- card-header end// -->
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr class="text-center">
                                        <th scope="col">íšŒì› ì½”ë“œ</th>
                                        <th scope="col">ì´ë¦„</th>
                                        <th scope="col">ì•„ì´ë””</th>
                                        <th scope="col">ë‹‰ë„¤ì„</th>
                                        <th scope="col">ë“±ê¸‰</th>
                                        <th scope="col">ì—°ë½ì²˜</th>
                                        <th scope="col">ìƒíƒœ</th>
                                        <!--<th scope="col">ê°€ì…ì¼</th>-->
                                        <th scope="col">ì•½ê´€ë™ì˜</th>
                                        <th scope="col">ìƒì„¸ì •ë³´</th>
                                    </tr>
                                </thead>
                                <tbody class="text-center">
                                    <tr th:if="${not #lists.isEmpty(memberList)}"
                                    	th:each="l : ${memberList}">
                                       <th th:text="${l.memberCode}">íšŒì› ì½”ë“œ</th>
                                       <th th:text="${l.memberName}">ì´ë¦„</th>
                                       <th th:text="${l.memberId}">ì•„ì´ë””</th>
                                       <th th:text="${l.memberNickname}">ë‹‰ë„¤ì„</th>
                                       <th th:switch="${l.gradeCode}">
											<span th:case="ADMIN" class="badge rounded-pill alert-warning">ê´€ë¦¬ì</span>
											<span th:case="ENTER" class="badge rounded-pill alert-info">ê¸°ì—…íšŒì›</span>
											<span th:case="USER" class="badge rounded-pill alert-success">ì¼ë°˜íšŒì›</span>
                                       </th>
                                       <th th:text="${l.memberTelNo.substring(0, 3) + '-****-' + l.memberTelNo.substring(l.memberTelNo.length() - 4)}">ì—°ë½ì²˜</th>
                                       <th th:switch="${l.statusCode}">
                                           <span th:case="SD_ACTIVE" class="badge rounded-pill alert-success">í™œì„±</span>
                                           <span th:case="SD_WITHDRAWN" class="badge rounded-pill alert-info">íœ´ë©´</span>
                                           <span th:case="SD_DORMANT" class="badge rounded-pill alert-info">íƒˆí‡´</span>
                                           <span th:case="SD_LIMIT" class="badge rounded-pill alert-warning">ì œì¬</span>
                                       </th>
                                     <!--  <th th:text="${l.memberJoinYmdt}">ê°€ì…ì¼</th>-->
                                       <th th:switch="${l.memberAgreeYN}">
											<span th:case="1" >Y</span>
											<span th:case="0" >N</span>
										</th>
                                       <th scope="col"><button class="btn btn-primary w-55 fw-bold btn-detail" 
													           th:data-code="${l.memberCode}" 
													           data-bs-toggle="modal" 
													           data-bs-target="#memberDetailModal">ìƒì„¸ì •ë³´</button></th>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- table-responsive //end -->
                    </div>
                    <!-- card-body end// -->
                </div>
            </section>
            
            <div class="modal fade p-10" id="memberDetailModal" tabindex="-1" aria-hidden="true">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							<h3 >íšŒì› ìƒì„¸ ì •ë³´</h3>
							<button type="button" class="btn btnEditMember btn-primary w-70 fw-bold">ì •ë³´ ìˆ˜ì •í•˜ê¸°</button>
						</div>
						<div class="row justify-content-center">	
							<form class="admin memberEdit col-10" th:action="@{/admin/memberList/detail}" method="post">
								<div class="form-group mb-10 mt-10">
								    <label for="memberCode">íšŒì› ì½”ë“œ</label>
								    <input type="text" id="memberCode" name="memberCode" class="form-control" disabled />
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberName">ì´ë¦„</label>
								    <input type="text" id="modalMemberName" name="modalMemberName" class="form-control" disabled/>
								</div>
								<div class="form-group mb-10">
									<label for="modalMemberGradeCode">ë“±ê¸‰</label>
									<select id="modalMemberGradeCode" name="modalMemberGradeCode" class="form-select readonly-field" disabled>
									  <option value="ADMIN">ê´€ë¦¬ì</option>
									  <option value="ENTER">ê¸°ì—…íšŒì›</option>
									  <option value="USER">ì¼ë°˜íšŒì›</option>
									</select>
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberNickname">ë‹‰ë„¤ì„</label>
								    <input type="text" id="modalMemberNickname" name="modalMemberNickname" class="form-control readonly-field" readonly/>
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberEmail">ì´ë©”ì¼</label>
								    <input type="email" id="modalMemberEmail" name="modalMemberEmail" class="form-control" disabled/>
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberTelNo">ì „í™”ë²ˆí˜¸</label>
								    <input type="text" id="modalMemberTelNo" name="modalMemberTelNo" class="form-control" disabled/>
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberBirth">ìƒì¼</label>
								    <input type="text" id="modalMemberBirth" name="modalMemberBirth" class="form-control" disabled/>
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberZip">ìš°í¸ë²ˆí˜¸</label>
							        <input type="text" id="modalMemberZip" name="modalMemberZip" class="form-control readonly-field" readonly />
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberAddress">ë„ë¡œëª… ì£¼ì†Œ</label>
								    <input type="text" id="modalMemberAddress" name="modalMemberAddress" class="form-control readonly-field" readonly />
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberDAddress">ìƒì„¸ ì£¼ì†Œ</label>
								    <input type="text" id="modalMemberDAddress" name="modalMemberDAddress" class="form-control readonly-field" readonly/>
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberAgree">ì„ íƒì•½ê´€ ë™ì˜ì—¬ë¶€</label>
								    <input type="text" id="modalMemberAgree" name="modalMemberAgree" class="form-control" disabled/>
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberJoinYmdt">ê°€ì…ì¼</label>
								    <input type="text" id="modalMemberJoinYmdt" name="modalMemberJoinYmdt" class="form-control" disabled/>
								</div>
								<div class="form-group mb-10">
								 <label for="modalMemberStatusCode">ìƒíƒœ</label>
								    <select id="modalMemberStatusCode" name="modalMemberStatusCode" class="form-select readonly-field" disabled>
									    <option value="SD_ACTIVE">í™œì„±</option>
									    <option value="SD_WITHDRAWN">íœ´ë©´</option>
									    <option value="SD_DORMANT">íƒˆí‡´</option>
									    <option value="SD_LIMIT">ì œì¬</option>
									  </select>
								</div>
								<div class="form-group mb-10">
								    <label for="modalMemberLastLoginYmdt">ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì¼ì‹œ</label>
								    <input type="text" id="modalMemberLastLoginYmdt" name="modalMemberLastLoginYmdt" class="form-control" disabled/>
								</div>

					
							 	<div class="form-group mb-30">
					                <button type="button" id="btnSave" class="btn btnSave btn-primary w-70 fw-bold">ì •ë³´ ìˆ˜ì •</button>
					            </div>
					        </form>
	      				</div>
	    			</div> 
	    		</div>
	    	</div>
		</th:block>
		<th:block layout:fragment="jsScript">
		<script>
		console.log("ìŠ¤í¬ë¦½íŠ¸ ë¡œë”©ë¨");
			$(document).ready(function () {
				
				$('#memberDetailModal').on('hidden.bs.modal', function () {
				    console.log("ëª¨ë‹¬ ë‹«í˜ ì´ë²¤íŠ¸ ì‹¤í–‰");
				    $('body').removeClass('modal-open');
				    $('.modal-backdrop').remove();
				     $('.readonly-field').prop('readonly', true);
			        $('#modalMemberStatusCode').prop('disabled', true);
			        $('#modalMemberGradeCode').prop('disabled', true);
				});
			console.log("ğŸš¨ document.ready ì‹¤í–‰ë¨");
			let isSaveHandlerBound = false;
			    // ìƒì„¸ì •ë³´ ë³´ê¸° ë²„íŠ¼ í´ë¦­
			    $('.btn-detail').click(function () { 	
			        const memberCode = $(this).data('code');
			
			        $.ajax({
			            url: '/admin/memberList/detail',
			            type: 'GET',
			            data: { memberCode },
			            success: function (data) {
			                $('#memberCode').val(data.memberCode);
			                $('#modalMemberId').val(data.memberId);
			                $('#modalMemberGradeCode').val(data.gradeCode);
			                $('#modalMemberName').val(data.memberName);
			                $('#modalMemberEmail').val(data.memberEmail);
			                $('#modalMemberNickname').val(data.memberNickname);
			                $('#modalMemberTelNo').val(data.memberTelNo);
			                $('#modalMemberBirth').val(data.memberBirth);
			                $('#modalMemberZip').val(data.memberZip);
			                $('#modalMemberAddress').val(data.memberAddress);
			                $('#modalMemberDAddress').val(data.memberDAddress);
			                $('#modalMemberAgree').val(data.memberAgreeYN);
			                $('#modalMemberJoinYmdt').val(data.memberJoinYmdt);
			                $('#modalMemberStatusCode').val(data.statusCode);
			                $('#modalMemberLastLoginYmdt').val(data.memberLastLoginYmdt);
			
			                const modalEl = document.getElementById('memberDetailModal');
			                if (!modalEl) {
			                    alert('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
			                    console.log("ëª¨ë‹¬ìš”ì†Œê°€ì—†ìŠµë‹ˆë‹¤.");
			                    return;
			                }
			
			                const modal = new bootstrap.Modal(modalEl);
			                modal.show();
			            },
			            error: function () {
			                alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
			            }
			        });
			    });
			
			    // ìˆ˜ì •ëª¨ë“œ í™œì„±í™”
			    $('.btnEditMember').click(function () {
			        $('.readonly-field').prop('readonly', false);
			        $('#modalMemberStatusCode').prop('disabled', false);
			        $('#modalMemberGradeCode').prop('disabled', false);
			    });
			
			    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
			    if (!isSaveHandlerBound) {
			        $(document).on('click', '.btnSave', function () {
			            console.log("btnSave clicked");
			
			            const nickname = $('#modalMemberNickname').val().trim();
			            const memberCode = $('#memberCode').val();
			            
				        if (nickname !== "") { // ë¹ˆ ë¬¸ìì—´ ê²€ì‚¬
				            $.ajax({
				                url: '/admin/check/nickname',
				                type: 'GET',
				                data: {
				                    nickname: nickname,
				                    memberCode: memberCode
				                },
				                success: function (isAvailable) {
				                    if (!isAvailable) {
				                        alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
				                        $('#modalMemberNickname').focus();
				                        return;
				                    }
				
				                    const memberData = {
				                        memberCode: memberCode,
				                        memberNickname: nickname,
				                        gradeCode: $('#modalMemberGradeCode').val(),
				                        memberZip: $('#modalMemberZip').val(),
				                        memberAddress: $('#modalMemberAddress').val(),
				                        memberDAddress: $('#modalMemberDAddress').val(),
				                        statusCode: $('#modalMemberStatusCode').val()
				                    };
				
				                    $.ajax({
				                        url: '/admin/memberList/detail/update',
				                        method: 'POST',
				                        contentType: 'application/json',
				                        data: JSON.stringify(memberData),
				                        success: function (result) {
				                            if (result === 'success') {
				                                alert('íšŒì› ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
				                                location.reload();
				                            } else {
				                                alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
				                            }
				                        },
				                        error: function () {
				                            alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
				                        }
				                    });
				                },
				                error: function () {
				                    alert('ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
				                }
				            });
				            isSaveHandlerBound = true;
				        } else {
				            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
				            $('#modalMemberNickname').focus();
				        }
				    });	
			    }
			
			});
			
		</script>
		</th:block>
	</body>
	
</html>