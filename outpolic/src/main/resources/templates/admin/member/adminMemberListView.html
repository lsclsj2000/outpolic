<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layout/adminLayoutMain}">

<head>
<meta name="description" content="í•œêµ­ìŠ¤ë§ˆíŠ¸ì •ë³´êµìœ¡ì› íŒ€í”„ë¡œì íŠ¸" />
</head>

<body>
	<th:block layout:fragment="contents">
		<section class="content-main">
			<div class="content-header">
				<h2 class="content-title card-title">íšŒì› ëª©ë¡</h2>
			</div>
			<div class="card mb-4">
				<header class="card-header">
					<div class="card mb-4 search-filter-card" style="border: none;">
						<div class="card-body search-filter-body">
							<div class="table-responsive">
								<table class="search-filter-table">
									<tbody>
										<!-- ğŸ” ê²€ìƒ‰ë°” ë¼ì¸ -->
										<tr>
											<th>ê²€ìƒ‰</th>
											<td>
												<div class="d-flex align-items-center gap-2">
													<input type="text" id="searchInput" class="form-control"
														placeholder="ì´ë¦„, ì•„ì´ë””, ë‹‰ë„¤ì„, íšŒì›ì½”ë“œ ê²€ìƒ‰" style="width: 300px;" />
													<button type="button" class="btn btn-primary btn-sm"
														id="searchBtn">ê²€ìƒ‰</button>
												</div>
											</td>
										</tr>

										<!-- ğŸ”½ ë“œë¡­ë‹¤ìš´ 2ê°œ ë¼ì¸ -->
										<tr>
											<th>í•„í„°</th>
											<td>
												<div class="d-flex align-items-center gap-3">
													<!-- ìƒíƒœ í•„í„° -->
													<select id="filterStatus"
														class="form-select form-select-sm" style="width: 180px;">
														<option value="">ì „ì²´ ìƒíƒœ</option>
														<option value="SD_ACTIVE">í™œì„± íšŒì›</option>
														<option value="SD_DORMANT">íœ´ë©´ íšŒì›</option>
														<option value="SD_WITHDRAWN">íƒˆí‡´ íšŒì›</option>
														<option value="SD_LIMIT">ì œì¬ íšŒì›</option>
													</select>

													<!-- ë“±ê¸‰ í•„í„° -->
													<select id="filterGrade" class="form-select form-select-sm"
														style="width: 180px;">
														<option value="">ì „ì²´ ë“±ê¸‰</option>
														<option value="ADMIN">ê´€ë¦¬ì</option>
														<option value="ENTER">ê¸°ì—…íšŒì›</option>
														<option value="USER">ì¼ë°˜íšŒì›</option>
													</select>
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</header>
			</div>
			<div class="card mb-4">
				<!-- card-header end// -->
				<div class="card-body">
					<div class=" d-flex flex-row">
						<div class="d-flex flex-wrap gap-3 align-items-center mb-3 w-50">
							<p class="fs-6 mb-0">
								<span class="badge bg-light text-dark px-3 py-2"> ì „ì²´ íšŒì› ìˆ˜
									: <span id="totalCount" class="fw-bold text-primary"
									th:text="${memberList.size()}">0</span> ëª…
								</span>
							</p>
	
							<p class="fs-6 mb-0" id="filteredCountWrap" style="display: none;">
								<span class="badge bg-light text-dark px-3 py-2"> ê²€ìƒ‰ ê²°ê³¼ :
									<span id="filteredCount" class="fw-bold text-success">0</span> ê±´
								</span>
							</p>
						</div>
						<div class="w-50 mb-3" style="display : flex; justify-content : flex-end;">
							<select id="filterOrder" class="form-select w-auto d-inline-block ms-2">
							  <option value="">ì •ë ¬ ê¸°ì¤€</option>
							  <option value="recent">ìµœê·¼ ê°€ì…ìˆœ</option>
							  <option value="oldest">ì˜¤ë˜ëœ ê°€ì…ìˆœ</option>
							</select>
						</div>
					</div>

					<div class="table-responsive">
						<table class="table table-hover">
							<colgroup>
								<col style="width: 3%;">
								<col style="width: 7%;">
								<col style="width: 10%;">
								<col style="width: 12%;">
								<col style="width: 12%;">
								<col style="width: 10%;">
								<col style="width: 14%;">
								<col style="width: 10%;">
								<col style="width: 8%;">
								<col style="width: 14%;">
							</colgroup>
							<thead>
								<tr class="text-center">
									<th scope="col" class="start text-center col-1">no.</th>
									<th scope="col">íšŒì› ì½”ë“œ</th>
									<th scope="col">ì´ë¦„</th>
									<th scope="col">ì•„ì´ë””</th>
									<th scope="col">ë‹‰ë„¤ì„</th>
									<th scope="col">ë“±ê¸‰</th>
									<th scope="col">ì—°ë½ì²˜</th>
									<th scope="col">ìƒíƒœ</th>
									<!--<th scope="col">ê°€ì…ì¼</th>-->
									<th scope="col">ì•½ê´€ë™ì˜</th>
									<th scope="col">ìƒì„¸ì •ë³´</th>
								</tr>
							</thead>
							<tbody id="memberTableBody" class="text-center">
								<tr th:if="${not #lists.isEmpty(memberList)}"
									th:each="l, stat : ${memberList}">
									<td class="start text-center" th:text="${stat.index + 1}"></td>
									<td th:text="${l.memberCode}">íšŒì› ì½”ë“œ</td>
									<td th:text="${l.memberName}">ì´ë¦„</td>
									<td th:text="${l.memberId}">ì•„ì´ë””</td>
									<td th:text="${l.memberNickname}">ë‹‰ë„¤ì„</td>
									<td th:switch="${l.gradeCode}"><span th:case="ADMIN"
										class="badge rounded-pill alert-warning">ê´€ë¦¬ì</span> <span
										th:case="ENTER" class="badge rounded-pill alert-info">ê¸°ì—…íšŒì›</span>
										<span th:case="USER" class="badge rounded-pill alert-success">ì¼ë°˜íšŒì›</span>
									</td>
									<td
										th:text="${#strings.length(l.memberTelNo) >= 7} ? 
                									${l.memberTelNo.substring(0, 3) + '-****-' + l.memberTelNo.substring(l.memberTelNo.length() - 4)} : '-'">
										ì—°ë½ì²˜</td>
									<td th:switch="${l.statusCode}"><span th:case="SD_ACTIVE"
										class="badge rounded-pill alert-success">í™œì„±</span> <span
										th:case="SD_WITHDRAWN" class="badge rounded-pill alert-info">íœ´ë©´</span>
										<span th:case="SD_DORMANT"
										class="badge rounded-pill alert-info">íƒˆí‡´</span> <span
										th:case="SD_LIMIT" class="badge rounded-pill alert-warning">ì œì¬</span>
									</td>
									<!--  <th th:text="${l.memberJoinYmdt}">ê°€ì…ì¼</th>-->
									<td th:switch="${l.memberAgreeYN}"><span th:case="1">Y</span>
										<span th:case="0">N</span></td>
									<td scope="col"><button
											class="btn btn-primary fw-bold btn-detail"
											th:data-code="${l.memberCode}" data-bs-toggle="modal"
											data-bs-target="#memberDetailModal"
											style="padding: 5px 20px;">ìƒì„¸ì •ë³´</button></td>
								</tr>
							</tbody>
						</table>
					</div>
					<!-- table-responsive //end -->
				</div>
				<!-- card-body end// -->
			</div>
		</section>

		<div class="modal fade p-10" id="memberDetailModal" tabindex="-1"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h3>íšŒì› ìƒì„¸ ì •ë³´</h3>
						<button type="button"
							class="btn btnEditMember btn-primary w-70 fw-bold">ì •ë³´
							ìˆ˜ì •í•˜ê¸°</button>
					</div>
					<div class="modal-body">
						<form class="admin memberEdit"
							th:action="@{/admin/memberList/detail}" method="post">
							<div class="row g-3">
								<div class="col-md-6">
									<label for="memberCode">íšŒì› ì½”ë“œ</label> <input type="text"
										id="memberCode" name="memberCode" class="form-control"
										disabled />
								</div>
								<div class="col-md-6">
									<label for="modalMemberName">ì´ë¦„</label> <input type="text"
										id="modalMemberName" name="modalMemberName"
										class="form-control" disabled />
								</div>
								<div class="col-md-6">
									<label for="modalMemberGradeCode">ë“±ê¸‰</label> <select
										id="modalMemberGradeCode" name="modalMemberGradeCode"
										class="form-select readonly-field" disabled>
										<option value="ADMIN">ê´€ë¦¬ì</option>
										<option value="ENTER">ê¸°ì—…íšŒì›</option>
										<option value="USER">ì¼ë°˜íšŒì›</option>
									</select>
								</div>
								<div class="col-md-6">
									<label for="modalMemberNickname">ë‹‰ë„¤ì„</label> <input type="text"
										id="modalMemberNickname" name="modalMemberNickname"
										class="form-control readonly-field" readonly />
								</div>
								<div class="col-md-6">
									<label for="modalMemberEmail">ì´ë©”ì¼</label> <input type="email"
										id="modalMemberEmail" name="modalMemberEmail"
										class="form-control" disabled />
								</div>
								<div class="col-md-6">
									<label for="modalMemberTelNo">ì „í™”ë²ˆí˜¸</label> <input type="text"
										id="modalMemberTelNo" name="modalMemberTelNo"
										class="form-control" disabled />
								</div>
								<div class="col-md-6">
									<label for="modalMemberBirth">ìƒì¼</label> <input type="text"
										id="modalMemberBirth" name="modalMemberBirth"
										class="form-control" disabled />
								</div>
								<div class="col-md-6">
									<label for="modalMemberZip">ìš°í¸ë²ˆí˜¸</label> <input type="text"
										id="modalMemberZip" name="modalMemberZip"
										class="form-control readonly-field" disabled />
								</div>
								<div class="col-md-6">
									<label for="modalMemberAddress">ë„ë¡œëª… ì£¼ì†Œ</label> <input
										type="text" id="modalMemberAddress" name="modalMemberAddress"
										class="form-control readonly-field" disabled />
								</div>
								<div class="col-md-6">
									<label for="modalMemberDAddress">ìƒì„¸ ì£¼ì†Œ</label> <input
										type="text" id="modalMemberDAddress"
										name="modalMemberDAddress" class="form-control readonly-field"
										disabled />
								</div>
								<div class="col-md-6">
									<label for="modalMemberAgree">ì„ íƒì•½ê´€ ë™ì˜ì—¬ë¶€</label> <input
										type="text" id="modalMemberAgree" name="modalMemberAgree"
										class="form-control" disabled />
								</div>
								<div class="col-md-6">
									<label for="modalMemberJoinYmdt">ê°€ì…ì¼</label> <input type="text"
										id="modalMemberJoinYmdt" name="modalMemberJoinYmdt"
										class="form-control" disabled />
								</div>
								<div class="col-md-6">
									<label for="modalMemberStatusCode">ìƒíƒœ</label> <select
										id="modalMemberStatusCode" name="modalMemberStatusCode"
										class="form-select readonly-field" disabled>
										<option value="SD_ACTIVE">í™œì„±</option>
										<option value="SD_DORMANT">íœ´ë©´</option>
										<option value="SD_WITHDRAWN">íƒˆí‡´</option>
										<option value="SD_LIMIT">ì œì¬</option>
									</select>
								</div>
								<div class="col-md-6">
									<label for="modalMemberLastLoginYmdt">ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì¼ì‹œ</label> <input
										type="text" id="modalMemberLastLoginYmdt"
										name="modalMemberLastLoginYmdt" class="form-control" disabled />
								</div>
							</div>

							<div class="text-center mt-4">
								<button type="button" id="btnSave"
									class="btn btnSave btn-primary w-70 fw-bold">ì •ë³´ ìˆ˜ì •</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</th:block>
	<th:block layout:fragment="jsScript">
		<script>
		console.log("ìŠ¤í¬ë¦½íŠ¸ ë¡œë”©ë¨");
			$(document).ready(function () {
				// í•„í„°
				 $('#filterStatus, #filterGrade, #filterOrder').change(function () {
				        const status = $('#filterStatus').val();
				        const grade = $('#filterGrade').val();
				       	const order = $('#filterOrder').val();
					
				        $.ajax({
				        url: '/admin/memberList/filter',
				            type: 'GET',
				            data: {
				                statusCode: status,
				                gradeCode: grade,
				                orderBy: order
				            },
				            dataType: 'json',
				            success: renderMemberList,
				            error: () => alert("í•„í„°ë§ ì‹¤íŒ¨")
				        });
				    });
					
				    // ê²€ìƒ‰
				    $('#searchBtn').click(function () {
				        const keyword = $('#searchInput').val().trim();

						$('#filterStatus').val('');
 						$('#filterGrade').val('');
 						$('#filterOrder').val('');
				        $.ajax({
				            url: '/admin/memberList/search',
				            type: 'GET',
				            data: { keyword: keyword },
				            success: renderMemberList,
				            error: () => alert("ê²€ìƒ‰ ì‹¤íŒ¨")
				        });
				    });
				    
				    $('#searchInput').on('input', function () {
					  const keyword = $(this).val().trim();
					  if (keyword === '') {
					    $('#filteredCountWrap').hide(); // ğŸ‘‰ 'ê²€ìƒ‰ ê²°ê³¼ Nëª…' ì˜ì—­ ìˆ¨ê¸°ê¸°
					  }
					});
				
				    // íšŒì› ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ (ê³µí†µ)
				    function renderMemberList(data) {
					  const tbody = $('#memberTableBody');
					  tbody.empty();
					  
					   // ê²°ê³¼ ê°œìˆ˜ ì¶œë ¥
					  $('#filteredCount').text(data.length);
					  $('#filteredCountWrap').show();
					
					  if (!data || data.length === 0) {
					    tbody.append('<tr><td colspan="9" class="text-center">ì¡°íšŒëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
					    return;
					  }
					
					  data.forEach((l, index) => {
					    const gradeLabel = l.gradeCode === 'ADMIN'
					      ? '<span class="badge rounded-pill alert-warning">ê´€ë¦¬ì</span>'
					      : l.gradeCode === 'ENTER'
					        ? '<span class="badge rounded-pill alert-info">ê¸°ì—…íšŒì›</span>'
					        : '<span class="badge rounded-pill alert-success">ì¼ë°˜íšŒì›</span>';
					
					    const statusLabel = l.statusCode === 'SD_ACTIVE'
					      ? '<span class="badge rounded-pill alert-success">í™œì„±</span>'
					      : l.statusCode === 'SD_WITHDRAWN'
					        ? '<span class="badge rounded-pill alert-info">íƒˆí‡´</span>'
					        : l.statusCode === 'SD_DORMANT'
					          ? '<span class="badge rounded-pill alert-info">íœ´ë©´</span>'
					          : '<span class="badge rounded-pill alert-warning">ì œì¬</span>';
					
					    const telMasked = l.memberTelNo.substring(0, 3) + '-****-' + l.memberTelNo.slice(-4);

					    const row = `
					      <tr class="text-center">
					      	<td>${index + 1}</td>
					        <td>${l.memberCode}</td>
					        <td>${l.memberName}</td>
					        <td>${l.memberId}</td>
					        <td>${l.memberNickname}</td>
					        <td>${gradeLabel}</td>
					        <td>${telMasked}</td>
					        <td>${statusLabel}</td>
					        <td>${l.memberAgreeYN === '1' ? 'Y' : 'N'}</td>
					        <td>
					          <button class="btn btn-primary w-55 fw-bold btn-detail"
					                  data-code="${l.memberCode}"
					                  data-bs-toggle="modal"
					                  data-bs-target="#memberDetailModal"
					                  style="padding: 5px 20px;">ìƒì„¸ì •ë³´</button>
					        </td>
					      </tr>
					    `;
					
					    tbody.append(row);
					  });
					}
				$('#memberDetailModal').on('hidden.bs.modal', function () {
				    console.log("ëª¨ë‹¬ ë‹«í˜ ì´ë²¤íŠ¸ ì‹¤í–‰");
				    $('body').removeClass('modal-open');
				    $('.modal-backdrop').remove();
				     $('.readonly-field').prop('readonly', true);
			        $('#modalMemberStatusCode').prop('disabled', true);
			        $('#modalMemberGradeCode').prop('disabled', true);
				});
			console.log("ğŸš¨ document.ready ì‹¤í–‰ë¨");
			let isSaveHandlerBound = false;
			    // ìƒì„¸ì •ë³´ ë³´ê¸° ë²„íŠ¼ í´ë¦­
			    $(document).on('click', '.btn-detail', function () { 	
			        const memberCode = $(this).data('code');
			
			        $.ajax({
			            url: '/admin/memberList/detail',
			            type: 'GET',
			            data: { memberCode },
			            success: function (data) {
			                $('#memberCode').val(data.memberCode);
			                $('#modalMemberId').val(data.memberId);
			                $('#modalMemberGradeCode').val(data.gradeCode);
			                $('#modalMemberName').val(data.memberName);
			                $('#modalMemberEmail').val(data.memberEmail);
			                $('#modalMemberNickname').val(data.memberNickname);
			                $('#modalMemberTelNo').val(data.memberTelNo);
			                $('#modalMemberBirth').val(data.memberBirth);
			                $('#modalMemberZip').val(data.memberZip);
			                $('#modalMemberAddress').val(data.memberAddress);
			                $('#modalMemberDAddress').val(data.memberDAddress);
			                $('#modalMemberAgree').val(data.memberAgreeYN);
			                $('#modalMemberJoinYmdt').val(data.memberJoinYmdt);
			                $('#modalMemberStatusCode').val(data.statusCode);
			                $('#modalMemberLastLoginYmdt').val(data.memberLastLoginYmdt);
			
			                const modalEl = document.getElementById('memberDetailModal');
			                if (!modalEl) {
			                    alert('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
			                    console.log("ëª¨ë‹¬ìš”ì†Œê°€ì—†ìŠµë‹ˆë‹¤.");
			                    return;
			                }
			
			                const modal = new bootstrap.Modal(modalEl);
			                modal.show();
			            },
			            error: function () {
			                alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
			            }
			        });
			    });
			
			    // ìˆ˜ì •ëª¨ë“œ í™œì„±í™”
			    $('.btnEditMember').click(function () {
			        $('.readonly-field').prop('readonly', false);
			        $('#modalMemberStatusCode').prop('disabled', false);
			        $('#modalMemberGradeCode').prop('disabled', false);
			    });
			
			    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
			    if (!isSaveHandlerBound) {
			        $(document).on('click', '.btnSave', function () {
			            console.log("btnSave clicked");
			
			            const nickname = $('#modalMemberNickname').val().trim();
			            const memberCode = $('#memberCode').val();
			            
				        if (nickname !== "") { // ë¹ˆ ë¬¸ìì—´ ê²€ì‚¬
				            $.ajax({
				                url: '/admin/check/nickname',
				                type: 'GET',
				                data: {
				                    nickname: nickname,
				                    memberCode: memberCode
				                },
				                success: function (isAvailable) {
				                    if (!isAvailable) {
				                        alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
				                        $('#modalMemberNickname').focus();
				                        return;
				                    }
				
				                    const memberData = {
				                        memberCode: memberCode,
				                        memberNickname: nickname,
				                        gradeCode: $('#modalMemberGradeCode').val(),
				                        memberZip: $('#modalMemberZip').val(),
				                        memberAddress: $('#modalMemberAddress').val(),
				                        memberDAddress: $('#modalMemberDAddress').val(),
				                        statusCode: $('#modalMemberStatusCode').val()
				                    };
				
				                    $.ajax({
				                        url: '/admin/memberList/detail/update',
				                        method: 'POST',
				                        contentType: 'application/json',
				                        data: JSON.stringify(memberData),
				                        success: function (result) {
				                            if (result === 'success') {
				                                alert('íšŒì› ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
				                                location.reload();
				                            } else {
				                                alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
				                            }
				                        },
				                        error: function () {
				                            alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
				                        }
				                    });
				                },
				                error: function () {
				                    alert('ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
				                }
				            });
				            isSaveHandlerBound = true;
				        } else {
				            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
				            $('#modalMemberNickname').focus();
				        }
				    });	
			    }
			
			});
			
		</script>
	</th:block>
</body>

</html>