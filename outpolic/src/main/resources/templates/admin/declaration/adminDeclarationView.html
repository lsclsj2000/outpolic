<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{admin/layout/adminLayoutMain}">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="한국스마트정보교육원 팀프로젝트" />
		<title>신고 내역 조회</title>
	</head>
	
	
	<th:block layout:fragment="contents">
		<section class="content-main">
	        <div class="content-header">
	            <div>
	                <h2 class="content-title card-title">신고 내역 조회</h2>
	                <p>사용자 신고 내역 조회</p>
	            </div>
	        </div>
	        <div class="card mb-4 search-filter-card">
	            <div class="card-body search-filter-body">
	                <div class="table-responsive">
	                    <table class="search-filter-table">
							<tbody>
								<tr>
									<th>기본검색</th>
									<td>
										<select class="form-select" style="width: 120px;">
											<option>제목</option>
											<option>내용</option>
											<option>문의코드</option>
											<option>작성자</option>
										</select>
										<input type="text" placeholder="검색어를 입력하세요" class="form-control" style="width: 250px;" />
									</td>
								</tr>
								<tr>
									<th>기간검색</th>
									<td>
										<select class="form-select" style="width: 120px;">
											<option>작성일자</option>
											<option>수정일자</option>
										</select>
										<input type="date" class="form-control" style="width: 150px;" />
										<span> ~ </span>
										<input type="date" class="form-control" style="width: 150px;" />
										<button type="button" class="btn btn-sm btn-light">오늘</button>
										<button type="button" class="btn btn-sm btn-light">어제</button>
										<button type="button" class="btn btn-sm btn-light">일주일</button>
										<button type="button" class="btn btn-sm btn-light">지난달</button>
										<button type="button" class="btn btn-sm btn-light">1개월</button>
										<button type="button" class="btn btn-sm btn-light">3개월</button>
										<button type="button" class="btn btn-sm btn-light">전체</button>
									</td>
								</tr>
								<tr>
									<th>처리상태</th>
									<td>
										<div class="radio-group">
											<label><input type="radio" name="levelSearch" value="all" checked /> 전체</label>
											<label><input type="radio" name="levelSearch" value="general" /> 확인전</label>
											<label><input type="radio" name="levelSearch" value="excellent" /> 처리중</label>
											<label><input type="radio" name="levelSearch" value="special" /> 처리완료</label>
										</div>
									</td>
								</tr>
							</tbody>
						</table>
						<div class="search-filter-buttons">
							<button type="button" class="btn btn-primary">검색</button>
							<button type="button" class="btn btn-secondary">초기화</button>
						</div>
	                </div>
	            </div>
	        </div>
	        <div class="card mb-4">
	            <div class="card-body">
	                <div class="table-responsive">
	                    <table class="table table-hover">
	                        <thead>
	                            <tr>
	                                <th scope="col" class="start text-center col-1">신고코드</th>
	                                <th scope="col" class="text-center col-1">신고타입</th>
	                                <th scope="col" class="text-center col-1">신고사유</th>
	                                <th scope="col" class="text-center col-1">신고자</th>
	                                <th scope="col" class="text-center col-1">신고대상</th>
	                                <th scope="col" class="text-center col-1">신고일시</th>
	                                <th scope="col" class="text-center col-1">처리상태</th>
	                                <th scope="col" class="text-center col-1">처리결과</th>
	                                <th scope="col" class="end text-center col-1">Action</th>
	                            </tr>
	                        </thead>
	                        <tbody>
								<tr class="start pt-30"
								    style="border:0px; border-bottom: solid 1px #ececec;"
								    th:each="d : ${adminDeclarationList}">
								    
								    <td class="start text-center">
								        <span th:text="${d.declarationCode}">신고코드</span>
								    </td>
								    <td scope="col" class="text-center" th:text="${d.declarationTypeName}">신고타입</td>
								    <td scope="col" class="text-center" th:text="${d.declarationReasonName}">신고사유</td>
								    <td scope="col" class="text-center" th:text="${d.declarationMemberCode}">신고자</td>
								    <td scope="col" class="text-center" th:text="${d.declarationTargetCode}">신고대상</td>
								    <td scope="col" class="text-center" th:text="${d.declarationRegYmdt}">신고일시</td>
								    <td scope="col" class="text-center" th:switch="${d.declarationStcName}">
	                                	<span th:case="${'처리완료'}" class="badge rounded-pill alert-success">처리완료</span>
	                                	<span th:case="${'처리중'}" class="badge rounded-pill alert-info">처리중</span>
	                                	<span th:case="${'요청중'}" class="badge rounded-pill alert-warning">요청중</span>
	                                </td>
	                                <td scope="col" class="text-center" th:text="${d.declarationResultName}">처리결과</td>
								    <td scope="col" class="text-center">
								    	<a href="#" class="btn btn-light rounded font-sm SR_open-edit-popup-btn" th:data-declaration-code="${d.declarationCode}">수정</a>
										<a href="#" class="btn btn-md rounded font-sm SR_open-process-popup-btn" th:data-declaration-code="${d.declarationCode}">처리</a>
									</td>
								</tr>
							</tbody>
	                    </table>
	                </div>
	            </div>
	        </div>
	    </section>

		<div id="declarationModal" class="SR_modal">
			<div class="SR_modal-content-wrapper">
				<div class="SR_popup-header">
					<h2>신고 내역 수정</h2>
					<button class="SR_close-button">&times;</button>
				</div>
                <div class="SR_popup-info">
                    <div class="SR_writer-info">
                    	<span>작성자 : </span>
                        <span id="SR_writerCode">작성자 코드</span> | <span id="SR_writerName">작성자명</span>
                        <p></p>
                        <span>작성일자 : </span><span id="SR_writeDate">작성일자</span>
                    </div>
                    <select id="declarationStatusEdit" name="status" class="SR_form-control SR_status-dropdown">
                        </select>
                </div>

				<form id="declarationForm">
                    <div class="SR_form-group">
                        <div class="SR_input-half">
                            <label for="declarationCodeDisplay">신고코드</label>
                            <input type="text" id="declarationCodeDisplay" name="declarationCode" class="SR_form-control" readonly>
                        </div>
					</div>

                    <div class="SR_form-group">
                        <div class="SR_input-half">
                            <label for="declarationTypeCodeDisplay">신고타입 코드</label>
                            <input type="text" id="declarationTypeCodeDisplay" name="declarationTypeCode" class="SR_form-control" readonly>
                        </div>
                        <div class="SR_input-half">
                            <label for="declarationTypeEdit">신고타입 이름</label>
                            <select id="declarationTypeEdit" name="declarationType" class="SR_form-control">
							    </select>
                        </div>
					</div>
					
					<div class="SR_form-group">
					    <div class="SR_input-half">
					        <label for="declarationReasonCodeDisplay">신고사유 코드</label> 
                            <input type="text" id="declarationReasonCodeDisplay" name="declarationReasonCode" class="SR_form-control" readonly> 
                        </div>
					    <div class="SR_input-half">
					        <label for="declarationReasonEdit">신고사유 이름</label> 
                            <select id="declarationReasonEdit" name="declarationReason" class="SR_form-control">
					        </select>
					    </div>
					</div>

                    <div class="SR_form-group SR_full-width">
						<label for="declarationContentEdit">신고 내용</label>
						<textarea id="declarationContentEdit" name="declarationContent" class="SR_form-control" rows="5" readonly></textarea>
					</div>

                    <div class="SR_form-group SR_full-width">
                        <label>첨부파일 목록</label>
                        <div id="SR_fileList" class="SR_form-control SR_file-list">
                            </div>
                    </div>
                    
					<div class="SR_popup-footer">
                        <div class="SR_update-info">
                        	<span>수정정보 : </span>
                            <span id="SR_updaterName">수정자</span> | <span id="SR_updateDate">수정일시</span>
                        </div>
						<button type="submit" id="answerSaveButton" class="btn btn-md rounded font-sm">저장</button>
					</div>
				</form>
			</div>
		</div>
		<!-- 처리 팝업창 추가 -->
		<div id="answerModal" class="SR_modal">
			<div class="SR_modal-content-wrapper">
				<div class="SR_popup-header">
					<h2>신고 처리</h2> <!-- 문의 답변 -> 신고 처리로 변경 -->
					<button class="SR_close-button-answer">&times;</button> <!-- 닫기 버튼 id 변경 -->
				</div>
                <div class="SR_popup-info">
                    <div class="SR_writer-info">
                    	<span>작성정보 : </span>
                        <span id="SR_answerWriterCode">작성자 코드</span> | <span id="SR_answerWriterName">작성자명</span> | <span id="SR_answerWriteDate">작성일자</span>
                    </div>
                    <!-- 이 부분은 신고처리 팝업이므로 '신고 처리 상태'를 나타내는 영역으로 변경 -->
                    <div id="SR_answerStatusDisplay" class="badge rounded-pill alert-warning mr-20"></div>
                </div>

				<!-- declarationForm 대신 다른 ID 사용 권장 (겹치지 않게) -->
				<div id="processFormDisplay"> 
                    <div class="SR_form-group">
                        <div class="SR_input-half" style="width:30%;">
                            <label for="answerDeclarationTypeCodeDisplay">신고타입 이름</label> <!-- id 변경 -->
                            <input id="answerDeclarationTypeCodeDisplay" name="declarationType" class="SR_form-control" readonly>
                        </div>
                        <div class="SR_input-half" style="width:66%;">
                            <label for="answerDeclarationCodeDisplay">신고코드</label> <!-- id 변경 -->
                            <input type="text" id="answerDeclarationCodeDisplay" name="declarationCode" class="SR_form-control" readonly>
                        </div>
					</div>

                    <div class="SR_form-group SR_full-width">
						<label for="answerDeclarationContentDisplay">신고 내용</label> <!-- id 변경 -->
						<textarea id="answerDeclarationContentDisplay" name="declarationContent" class="SR_form-control" rows="5" readonly></textarea>
					</div>

                    <div class="SR_form-group SR_full-width">
                        <label>첨부파일 목록</label>
                        <div id="SR_answerFileList" class="SR_form-control SR_file-list"> <!-- id 변경 -->
                            </div>
                    </div>
                    	
                    <form id="declarationProcessForm"> <!-- 폼 ID 변경 -->
                        <div class="SR_form-group SR_full-width">
                            <label for="declarationResultSelect">처리 결과</label> <!-- 라벨 및 id 변경 -->
                            <select id="declarationResultSelect" name="declarationResult" class="SR_form-control">
                                <!-- 옵션은 JS에서 동적으로 로드 -->
                            </select>
                        </div>
	                    <div class="SR_form-group SR_full-width">
							<label for="declarationProcessContent">처리 내용</label> <!-- 라벨 및 id 변경 -->
							<textarea id="declarationProcessContent" name="declarationProcessContent" class="SR_form-control" rows="10" placeholder="처리 내용을 입력하세요."></textarea>
						</div>
					</form>
                    
					<div class="SR_popup-footer">
                        <div class="SR_update-info">
                        	<span>수정정보 : </span>
                            <span id="SR_answerUpdaterName">수정자</span> | <span id="SR_answerUpdateDate">수정일시</span>
                        </div>
						<button type="submit" id="processSaveButton" class="btn btn-md rounded font-sm">처리 저장</button> <!-- 버튼 ID 변경 -->
					</div>
				</div>
			</div>
		</div>
		
		</th:block>

	    <th:block layout:fragment="jsScript">
			<script>
			document.addEventListener('DOMContentLoaded', function () {
                // 기존 수정 모달 관련 요소들
			    const declarationModal = document.getElementById('declarationModal');
			    const closeEditButton = document.querySelector('#declarationModal .SR_close-button');
			    const openEditPopupButtons = document.querySelectorAll('.SR_open-edit-popup-btn'); // 클래스명 변경

			    const editWriterCodeElem = declarationModal.querySelector('#SR_writerCode');
			    const editWriterNameElem = declarationModal.querySelector('#SR_writerName');
			    const editWriteDateElem = declarationModal.querySelector('#SR_writeDate');
			    const editDeclarationStatusEdit = declarationModal.querySelector('#declarationStatusEdit');
			    const editDeclarationCodeDisplay = declarationModal.querySelector('#declarationCodeDisplay');
			    const editDeclarationTypeCodeDisplay = declarationModal.querySelector('#declarationTypeCodeDisplay');
			    const editDeclarationTypeEdit = declarationModal.querySelector('#declarationTypeEdit');
			    const editDeclarationReasonCodeDisplay = declarationModal.querySelector('#declarationReasonCodeDisplay');
			    const editDeclarationReasonEdit = declarationModal.querySelector('#declarationReasonEdit');
			    const editDeclarationContentEdit = declarationModal.querySelector('#declarationContentEdit');
			    const editFileListElem = declarationModal.querySelector('#SR_fileList');
			    const editUpdaterNameElem = declarationModal.querySelector('#SR_updaterName');
			    const editUpdateDateElem = declarationModal.querySelector('#SR_updateDate');
			    const editAnswerSaveButton = declarationModal.querySelector('#answerSaveButton');
                const declarationForm = document.getElementById('declarationForm');


                // 새로운 처리 모달 관련 요소들
                const answerModal = document.getElementById('answerModal');
                const closeProcessButton = document.querySelector('#answerModal .SR_close-button-answer'); // 클래스명 변경
                const openProcessPopupButtons = document.querySelectorAll('.SR_open-process-popup-btn'); // 새로운 클래스명

                // 처리 팝업 내부 요소들 (ID 변경)
                const processWriterCodeElem = answerModal.querySelector('#SR_answerWriterCode');
                const processWriterNameElem = answerModal.querySelector('#SR_answerWriterName');
                const processWriteDateElem = answerModal.querySelector('#SR_answerWriteDate');
                const processStatusDisplayElem = answerModal.querySelector('#SR_answerStatusDisplay');
                const processDeclarationTypeCodeDisplay = answerModal.querySelector('#answerDeclarationTypeCodeDisplay');
                const processDeclarationCodeDisplay = answerModal.querySelector('#answerDeclarationCodeDisplay');
                const processDeclarationContentDisplay = answerModal.querySelector('#answerDeclarationContentDisplay');
                const processFileListElem = answerModal.querySelector('#SR_answerFileList');
                const declarationResultSelect = answerModal.querySelector('#declarationResultSelect');
                const declarationProcessContent = answerModal.querySelector('#declarationProcessContent');
                const processUpdaterNameElem = answerModal.querySelector('#SR_answerUpdaterName');
                const processUpdateDateElem = answerModal.querySelector('#SR_answerUpdateDate');
                const processSaveButton = answerModal.querySelector('#processSaveButton');
                const declarationProcessForm = document.getElementById('declarationProcessForm'); // 처리 폼 ID


			    let currentDeclarationData = null; // 수정 모달용
                let currentProcessDeclarationData = null; // 처리 모달용
                let originalDeclarationStcCode = ''; // 수정 모달용

			    function stripHtmlAndRemoveImages(html) {
			        if (!html) return '';
			        const doc = new DOMParser().parseFromString(html, 'text/html');
			        doc.querySelectorAll('img').forEach(img => img.remove());
			        return doc.body.textContent || '';
			    }

                // --- 수정 팝업 관련 로직 (기존 코드에서 변수명만 변경) ---
			    openEditPopupButtons.forEach(button => {
			        button.addEventListener('click', function (event) {
			            event.preventDefault();
			            const declarationCode = this.getAttribute('data-declaration-code');

			            // 팝업 내용 초기화
			            editWriterCodeElem.textContent = '';
			            editWriterNameElem.textContent = '';
			            editWriteDateElem.textContent = '';
			            editDeclarationCodeDisplay.value = '';
			            editDeclarationTypeCodeDisplay.value = '';
			            editDeclarationReasonCodeDisplay.value = '';
			            editDeclarationContentEdit.value = '';
			            editFileListElem.innerHTML = '';
			            editUpdaterNameElem.textContent = '';
			            editUpdateDateElem.textContent = '';
			            editDeclarationTypeEdit.innerHTML = '';
			            editDeclarationReasonEdit.innerHTML = '';
			            editDeclarationStatusEdit.innerHTML = ''; 
			            
                        // 모든 요소들을 기본적으로 활성화 상태로 설정 (팝업 열릴 때마다 초기화)
                        editDeclarationStatusEdit.disabled = false;
                        editDeclarationTypeEdit.disabled = false;
                        editDeclarationReasonEdit.disabled = false;
                        editAnswerSaveButton.style.display = 'inline-block';
                        editDeclarationContentEdit.readOnly = true;


			            // 1. 신고 상세 정보 로드
			            fetch(`/admin/adminDeclarationDetail?declarationCode=${declarationCode}`)
			                .then(response => {
			                    if (!response.ok) {
			                        throw new Error('Network response was not ok');
			                    }
			                    return response.json();
			                })
			                .then(data => {
			                    console.log("[수정 팝업] 신고 상세 데이터:", data);
			                    currentDeclarationData = data;
			                    originalDeclarationStcCode = data.declarationStcCode; 

			                    // 데이터로 팝업 필드 채우기
			                    editWriterCodeElem.textContent = data.declarationMemberCode || 'N/A';
			                    editWriterNameElem.textContent = data.declarationMemberName || 'N/A';
			                    editWriteDateElem.textContent = data.declarationRegYmdt || 'N/A';
			                    editDeclarationCodeDisplay.value = data.declarationCode || '';
			                    editDeclarationTypeCodeDisplay.value = data.declarationTypeCode || '';
			                    editDeclarationReasonCodeDisplay.value = data.declarationReasonCode || '';
			                    editDeclarationContentEdit.value = stripHtmlAndRemoveImages(data.declarationCn); 
			                    editUpdaterNameElem.textContent = data.declarationMdfcnAdmCode || '없음';
			                    editUpdateDateElem.textContent = data.declarationMdfcnYmdt || '없음';

			                    // 첨부파일 정보 표시
			                    if (data.declarationSaOrgnlName && data.declarationSaPath) {
			                        editFileListElem.innerHTML = `<a href="${data.declarationSaPath}" target="_blank">${data.declarationSaOrgnlName}</a>`;
			                    } else {
			                        editFileListElem.textContent = '첨부 파일 없음';
			                    }
			                    
			                    // 2. 신고 타입 드롭다운 채우기
			                    return fetch('/admin/declarationTypes');
			                })
			                .then(response => {
			                    if (!response.ok) {
			                        throw new Error('Network response for types was not ok');
			                    }
			                    return response.json();
			                })
			                .then(types => {
			                    console.log("[수정 팝업] 신고 타입 목록:", types);
			                    editDeclarationTypeEdit.innerHTML = '';
			                    types.forEach(type => {
			                        const option = document.createElement('option');
			                        option.value = type.declarationTypeCode;
			                        option.textContent = type.declarationTypeName;
			                        editDeclarationTypeEdit.appendChild(option);
			                    });

			                    const currentTypeCode = currentDeclarationData.declarationTypeCode;
			                    if (currentTypeCode) {
			                        editDeclarationTypeEdit.value = currentTypeCode;
			                    }

			                    // 3. 신고 사유 드롭다운 채우기 (선택된 타입에 따라) 및 선택
			                    return loadDeclarationReasons(editDeclarationTypeEdit.value, editDeclarationReasonEdit, currentDeclarationData.declarationReasonCode);
			                })
			                .then(() => { // 모든 데이터 로드가 완료된 후 처리 상태에 따른 UI 제어
			                    // 4. 처리 상태 드롭다운 채우기 및 UI 활성화/비활성화
			                    return fetch('/admin/declarationStatus')
			                        .then(res => {
			                            if (!res.ok) throw new Error('Failed to load declaration status');
			                            return res.json();
			                        })
			                        .then(statusList => {
			                            console.log("[수정 팝업] 신고 상태 목록:", statusList);
			                            editDeclarationStatusEdit.innerHTML = ''; 

                                        const currentStcCode = currentDeclarationData.declarationStcCode;
                                        
                                        if (currentStcCode === 'SD_INQUIRY_ING') { // 1. 요청중일 때
                                            // '요청중' 옵션 추가 (현재 값)
                                            let option = document.createElement('option');
                                            option.value = 'SD_INQUIRY_ING';
                                            option.textContent = '요청중';
                                            editDeclarationStatusEdit.appendChild(option);

                                            // '처리중' 옵션만 추가
                                            option = document.createElement('option');
                                            option.value = 'SD_PROCESS_ING';
                                            option.textContent = '처리중';
                                            editDeclarationStatusEdit.appendChild(option);

                                            editDeclarationStatusEdit.disabled = false; // 드롭다운 활성화
                                            editDeclarationTypeEdit.disabled = false; // 신고타입이름 수정 가능
                                            editDeclarationReasonEdit.disabled = false; // 신고사유이름 수정 가능
                                            editAnswerSaveButton.style.display = 'inline-block'; // 저장 버튼 활성화

                                        } else if (currentStcCode === 'SD_PROCESS_ING') { // 2. 처리중일 때
                                            // '처리중' 옵션만 추가 (현재 값)
                                            const option = document.createElement('option');
                                            option.value = 'SD_PROCESS_ING';
                                            option.textContent = '처리중';
                                            editDeclarationStatusEdit.appendChild(option);

                                            editDeclarationStatusEdit.disabled = true; // 드롭다운 비활성화
                                            editDeclarationTypeEdit.disabled = false; // 신고타입이름 수정 가능
                                            editDeclarationReasonEdit.disabled = false; // 신고사유이름 수정 가능
                                            editAnswerSaveButton.style.display = 'inline-block'; // 저장 버튼 활성화

                                        } else if (currentStcCode === 'SD_PROCESS_END') { // 3. 처리완료일 때
                                            // '처리완료' 옵션만 추가 (현재 값)
                                            const option = document.createElement('option');
                                            option.value = 'SD_PROCESS_END';
                                            option.textContent = '처리완료';
                                            editDeclarationStatusEdit.appendChild(option);

                                            editDeclarationStatusEdit.disabled = true; // 드롭다운 비활성화
                                            editDeclarationTypeEdit.disabled = true; // 신고타입이름 수정 불가
                                            editDeclarationReasonEdit.disabled = true; // 신고사유이름 수정 불가
                                            editAnswerSaveButton.style.display = 'none'; // 저장 버튼 숨김
                                        }

                                        // 어떤 경우든 현재 상태 값을 선택 (위에서 옵션을 이미 추가했으므로 안전함)
                                        editDeclarationStatusEdit.value = currentStcCode;
                                        
			                        });
			                })
			                .catch(error => {
			                    console.error('[수정 팝업] 데이터 로드 중 오류 발생:', error);
			                    alert('데이터를 불러오는 데 실패했습니다.');
			                });

			            declarationModal.style.display = 'flex';
			            document.body.style.overflow = 'hidden';
			        });
			    });

                // 수정 팝업 닫기 (닫기 버튼)
			    closeEditButton.addEventListener('click', function () {
			        declarationModal.style.display = 'none';
			        document.body.style.overflow = 'auto';
			    });

			    // 수정 팝업 닫기 (바깥 클릭 시)
			    window.addEventListener('click', function (event) {
			        if (event.target === declarationModal) {
			            declarationModal.style.display = 'none';
			            document.body.style.overflow = 'auto';
			        }
			    });

			    // 신고 타입 드롭다운 변경 시 신고 사유 동적 로드 및 코드 업데이트
			    editDeclarationTypeEdit.addEventListener('change', function() {
			        const selectedTypeCode = this.value;
			        editDeclarationTypeCodeDisplay.value = selectedTypeCode; 
			        loadDeclarationReasons(selectedTypeCode, editDeclarationReasonEdit, null); 
			    });

			    // 신고 사유 드롭다운 변경 시 코드 업데이트
			    editDeclarationReasonEdit.addEventListener('change', function() {
			        editDeclarationReasonCodeDisplay.value = this.value; 
			    });

                // 수정 팝업 - 처리 상태 드롭다운 변경 시 경고 메시지 로직
                editDeclarationStatusEdit.addEventListener('change', function() {
                    const newStcCode = this.value;
                    const oldStcCode = originalDeclarationStcCode; 

                    if (oldStcCode === 'SD_INQUIRY_ING' && newStcCode === 'SD_PROCESS_ING') {
                        const confirmChange = confirm("요청중에서 처리중으로 상태를 변경하시겠습니까? (처리중에서 요청중으로 재수정은 불가합니다.)");
                        if (!confirmChange) {
                            this.value = oldStcCode;
                        }
                    } 
                });

			    function loadDeclarationReasons(typeCode, reasonSelectElement, currentReasonCode) {
			        return fetch(`/admin/getDeclarationReasonsByTypeCode?dtCode=${typeCode}`)
			            .then(response => {
			                if (!response.ok) {
			                    throw new Error('Network response for reasons was not ok');
			                }
			                return response.json();
			            })
			            .then(reasons => {
			                console.log(`[수정 팝업] 신고 사유 목록 (타입: ${typeCode}):`, reasons);
			                reasonSelectElement.innerHTML = '';
			                if (reasons && reasons.length > 0) {
			                    reasons.forEach(reason => {
			                        const option = document.createElement('option');
			                        option.value = reason.drCode;
			                        option.textContent = reason.drName;
			                        reasonSelectElement.appendChild(option);
			                    });
			        
			                    if (currentReasonCode && reasonSelectElement.querySelector(`option[value="${currentReasonCode}"]`)) {
			                        reasonSelectElement.value = currentReasonCode;
			                    } else if (reasons.length > 0) {
			                        reasonSelectElement.value = reasons[0].drCode;
			                    }
			                    editDeclarationReasonCodeDisplay.value = reasonSelectElement.value;
			                } else {
			                    reasonSelectElement.innerHTML = '<option value="">사유 없음</option>';
			                    editDeclarationReasonCodeDisplay.value = ''; 
			                }
			            })
			            .catch(error => {
			                console.error('[수정 팝업] 신고 사유 로드 중 오류 발생:', error);
			                reasonSelectElement.innerHTML = '<option value="">사유 로드 실패</option>';
			                editDeclarationReasonCodeDisplay.value = '';
			            });
			    }

			    // 수정 팝업 - 저장 버튼 클릭 (폼 제출)
			    declarationForm.addEventListener('submit', function (event) {
			        event.preventDefault();

			        const data = {
			            declarationCode: editDeclarationCodeDisplay.value, 
			            declarationTypeCode: editDeclarationTypeEdit.value, 
			            declarationReasonCode: editDeclarationReasonEdit.value, 
			            declarationStcCode: editDeclarationStatusEdit.value, 
			            declarationCn: currentDeclarationData.declarationCn 
			        };

			        console.log("[수정 팝업] 저장할 데이터:", data);

                    // --- 중요: 백엔드 로직 추가 필요 ---
                    // 1. 백엔드 (AdminDeclarationController.java의 updateDeclaration 메서드)에서
                    //    이 요청을 받을 때, 'declarationStcCode'가 'SD_PROCESS_ING'로 변경되었는지 확인합니다.
                    // 2. 만약 이전 상태가 'SD_INQUIRY_ING'였고, 현재 상태가 'SD_PROCESS_ING'로 변경되었다면,
                    //    'declaration_process' 테이블에 새로운 레코드를 삽입하는 로직을 추가해야 합니다.
                    //    - dp_cd: MyBatis의 <selectKey>를 사용하여 자동 생성 (제공해주신 SQL 사용)
                    //    - decl_cd: data.declarationCode (현재 신고 코드)
                    //    - adm_cd: 현재 로그인한 관리자의 코드 (백엔드 세션/보안 컨텍스트에서 가져와야 함)
                    //    - dp_reg_ymdt: NOW()
                    //    - drc_cd: (선택 사항) 처리 결과 코드 (이 시점에서는 아직 처리 결과가 없을 수 있음)
                    // 3. 이 삽입 로직이 성공한 후에 기존의 declaration 테이블 업데이트를 진행합니다.
                    // ------------------------------------

			        fetch('/admin/updateDeclaration', { 
			            method: 'POST',
			            headers: {
			                'Content-Type': 'application/json'
			            },
			            body: JSON.stringify(data)
			        })
			        .then(response => {
			            if (!response.ok) {
			                return response.text().then(text => { throw new Error(text || 'Update failed'); });
			            }
			            return response.text();
			        })
			        .then(result => {
			            if (result === "OK") {
			                alert('신고 내역이 성공적으로 업데이트되었습니다.');
			                declarationModal.style.display = 'none';
			                document.body.style.overflow = 'auto';
			                location.reload(); 
			            } else {
			                alert('업데이트 실패: ' + result); 
			            }
			        })
			        .catch(error => {
			            console.error('[수정 팝업] 업데이트 중 오류 발생:', error);
			            alert('업데이트에 실패했습니다: ' + error.message);
			        });
			    });

                // --- 처리 팝업 관련 로직 ---
                openProcessPopupButtons.forEach(button => {
                    button.addEventListener('click', function(event) {
                        event.preventDefault();
                        const declarationCode = this.getAttribute('data-declaration-code');

                        // 처리 팝업 초기화
                        processWriterCodeElem.textContent = '';
                        processWriterNameElem.textContent = '';
                        processWriteDateElem.textContent = '';
                        processStatusDisplayElem.textContent = '';
                        processDeclarationTypeCodeDisplay.value = '';
                        processDeclarationCodeDisplay.value = '';
                        processDeclarationContentDisplay.value = '';
                        processFileListElem.innerHTML = '';
                        declarationResultSelect.innerHTML = ''; // 처리 결과 드롭다운 초기화
                        declarationProcessContent.value = ''; // 처리 내용 초기화
                        processUpdaterNameElem.textContent = '';
                        processUpdateDateElem.textContent = '';
                        processSaveButton.style.display = 'inline-block'; // 저장 버튼 보이게
                        declarationProcessContent.readOnly = false; // 기본적으로 처리 내용은 수정 가능

                        fetch(`/admin/adminDeclarationDetail?declarationCode=${declarationCode}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log("[처리 팝업] 신고 상세 데이터:", data);
                                currentProcessDeclarationData = data; // 처리 모달용 데이터 저장

                                processWriterCodeElem.textContent = data.declarationMemberCode || 'N/A';
                                processWriterNameElem.textContent = data.declarationMemberName || 'N/A';
                                processWriteDateElem.textContent = data.declarationRegYmdt || 'N/A';
                                processStatusDisplayElem.textContent = data.declarationStcName || 'N/A';
                                processDeclarationTypeCodeDisplay.value = data.declarationTypeName || ''; // 타입 이름 표시
                                processDeclarationCodeDisplay.value = data.declarationCode || '';
                                processDeclarationContentDisplay.value = stripHtmlAndRemoveImages(data.declarationCn);
                                processUpdaterNameElem.textContent = data.declarationMdfcnAdmCode || '없음';
                                processUpdateDateElem.textContent = data.declarationMdfcnYmdt || '없음';
                                // 기존 처리 내용이 있다면 로드 (declaration_process 테이블에서 가져와야 함)
                                // 현재 data 객체에 declarationProcessCn 필드가 없으므로,
                                // 백엔드에서 AdminDeclarationDetail 조회 시 해당 필드를 함께 가져오도록 수정 필요
                                declarationProcessContent.value = data.declarationProcessCn || ''; 

                                if (data.declarationSaOrgnlName && data.declarationSaPath) {
                                    processFileListElem.innerHTML = `<a href="${data.declarationSaPath}" target="_blank">${data.declarationSaOrgnlName}</a>`;
                                } else {
                                    processFileListElem.textContent = '첨부 파일 없음';
                                }

                                // 처리 결과 드롭다운 로드
                                return fetch('/admin/declarationResults'); // 처리 결과를 가져오는 새 엔드포인트 가정
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response for results was not ok');
                                }
                                return response.json();
                            })
                            .then(results => {
                                console.log("[처리 팝업] 처리 결과 목록:", results);
                                declarationResultSelect.innerHTML = '';
                                results.forEach(result => {
                                    const option = document.createElement('option');
                                    option.value = result.drc_cd; // 백엔드에서 오는 필드명에 맞춰 수정 (drc_cd, drc_nm 가정)
                                    option.textContent = result.drc_nm; // 백엔드에서 오는 필드명에 맞춰 수정
                                    declarationResultSelect.appendChild(option);
                                });

                                // 기존 처리 결과가 있다면 선택
                                // currentProcessDeclarationData.declarationResultCode는 현재 없으므로,
                                // 백엔드에서 AdminDeclarationDetail 조회 시 해당 필드를 함께 가져오도록 수정 필요
                                if (currentProcessDeclarationData.declarationResultCode) {
                                    declarationResultSelect.value = currentProcessDeclarationData.declarationResultCode;
                                }

                                // 처리 상태에 따른 UI 제어 (처리 팝업)
                                const currentStcCode = currentProcessDeclarationData.declarationStcCode;
                                if (currentStcCode === 'SD_PROCESS_END') { // 처리 완료 상태일 경우
                                    declarationResultSelect.disabled = true; // 처리 결과 수정 불가
                                    declarationProcessContent.readOnly = true; // 처리 내용 수정 불가
                                    processSaveButton.style.display = 'none'; // 처리 저장 버튼 숨김
                                } else {
                                    declarationResultSelect.disabled = false; // 활성화
                                    declarationProcessContent.readOnly = false; // 활성화
                                    processSaveButton.style.display = 'inline-block'; // 저장 버튼 보이게
                                }
                            })
                            .catch(error => {
                                console.error('[처리 팝업] 데이터 로드 중 오류 발생:', error);
                                alert('데이터를 불러오는 데 실패했습니다.');
                            });

                        answerModal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    });
                });

                // 처리 팝업 닫기 (닫기 버튼)
                closeProcessButton.addEventListener('click', function () {
                    answerModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                });

                // 처리 팝업 닫기 (바깥 클릭 시)
                window.addEventListener('click', function (event) {
                    if (event.target === answerModal) {
                        answerModal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });

                // 처리 팝업 - 저장 버튼 클릭 (폼 제출)
                declarationProcessForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const data = {
                        declarationCode: processDeclarationCodeDisplay.value,
                        declarationResultCode: declarationResultSelect.value, // 선택된 처리 결과 코드
                        declarationProcessCn: declarationProcessContent.value, // 입력된 처리 내용
                        // adm_cd: 백엔드에서 현재 로그인한 관리자 코드를 가져와야 함
                    };

                    console.log("[처리 팝업] 저장할 처리 데이터:", data);

                    // --- 중요: 백엔드 로직 추가 필요 ---
                    // 1. 백엔드 (새로운 /admin/processDeclaration 엔드포인트)에서
                    //    이 요청을 받을 때, 'declaration_process' 테이블에 새로운 레코드를 삽입하는 로직을 추가해야 합니다.
                    //    - dp_cd: MyBatis의 <selectKey>를 사용하여 자동 생성 (제공해주신 SQL 사용)
                    //    - decl_cd: data.declarationCode (현재 신고 코드)
                    //    - adm_cd: 현재 로그인한 관리자의 코드 (백엔드 세션/보안 컨텍스트에서 가져와야 함)
                    //    - dp_cn: data.declarationProcessCn (처리 내용)
                    //    - dp_reg_ymdt: NOW()
                    //    - drc_cd: data.declarationResultCode (선택된 처리 결과 코드)
                    // 2. 'declaration' 테이블의 'stc_cd'를 'SD_PROCESS_END' (처리완료)로 업데이트하는 로직도 추가해야 합니다.
                    //    (처리 팝업에서 저장하면 해당 신고는 '처리완료'가 되어야 함)
                    // ------------------------------------

                    fetch('/admin/processDeclaration', { // 처리 로직을 위한 새 엔드포인트 가정
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || 'Process failed'); });
                        }
                        return response.text();
                    })
                    .then(result => {
                        if (result === "OK") {
                            alert('신고 처리가 성공적으로 완료되었습니다.');
                            answerModal.style.display = 'none';
                            document.body.style.overflow = 'auto';
                            location.reload(); 
                        } else {
                            alert('처리 실패: ' + result); 
                        }
                    })
                    .catch(error => {
                        console.error('[처리 팝업] 처리 중 오류 발생:', error);
                        alert('처리에 실패했습니다: ' + error.message);
                    });
                });

			});
			</script>
		</th:block>
</html>