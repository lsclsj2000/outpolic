<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layout/adminLayoutMain}">

<head>
<meta name="description" content="ë¡œê·¸ì¸ ê¸°ë¡" />
<style>
.pagination .page-item .page-link {
	min-width: 40px; /* ë„ˆë¹„ í™•ë³´ */
	height: 40px;
	padding: 6px 10px; /* ë‚´ë¶€ ì—¬ë°± */
	text-align: center; /* í…ìŠ¤íŠ¸ ê°€ìš´ë° ì •ë ¬ */
	line-height: 1.5; /* ì¤„ê°„ê²© ì¡°ì • */
	display: inline-flex; /* ì •ë ¬ ê°œì„  */
	justify-content: center;
	align-items: center;
	font-size: 14px; /* í•„ìš” ì‹œ í°íŠ¸ ì‚¬ì´ì¦ˆ ì¡°ì • */
}
</style>
</head>

<body>
	<th:block layout:fragment="contents">
		<section class="content-main">
			<div class="content-header">
				<h2 class="content-title">ë¡œê·¸ì¸ ê¸°ë¡</h2>
			</div>

			<div class="card mb-4 search-filter-card">
				<div class="card-body search-filter-body">
					<div id="searchForm">
						<div class="table-responsive">
							<table class="search-filter-table">
								<tbody>
									<tr>
										<th>ê¸°ë³¸ê²€ìƒ‰</th>
										<td><select id="searchType" class="form-select"
											style="width: 120px;">
												<option value="mbrCd">íšŒì›ì½”ë“œ</option>
										</select> <input type="text" id="searchKeyword"
											placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="form-control"
											style="width: 250px;" /></td>
									</tr>
									<tr>
										<th>ê¸°ê°„</th>
										<td><input type="date" id="startDate"
											class="form-control" style="width: 150px;" /> <span>
												~ </span> <input type="date" id="endDate" class="form-control"
											style="width: 150px;" /></td>
									</tr>
								</tbody>
							</table>
							<div class="search-filter-buttons">
								<button type="button" id="searchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
								<button type="button" id="resetBtn" class="btn btn-secondary">ì´ˆê¸°í™”</button>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="card mb-4">
				<div class="card-body">
					<h5 class="mb-3 fw-bold">ìµœê·¼ 7ì¼ê°„ ë¡œê·¸ì¸ ìˆ˜</h5>
					<canvas id="loginLineChart" height="60"></canvas>
				</div>
			</div>

			<!-- ğŸ“‹ ë¡œê·¸ì¸ ê¸°ë¡ í…Œì´ë¸” -->
			<div class="card">
				<div class="card-body">
					<div class=" d-flex flex-row">
						<div class="d-flex flex-wrap gap-3 align-items-center mb-3 w-50">
							<p class="fs-6 mb-0">
								<span class="badge bg-light text-dark px-3 py-2"> ì „ì²´ : <span
									id="totalCount" class="fw-bold text-primary total-count"
									th:text="${totalCount}">0</span> ê±´
								</span>
							</p>

							<p class="fs-6 mb-0" id="filteredCountWrap"
								style="display: none;">
								<span class="badge bg-light text-dark px-3 py-2"> ê²€ìƒ‰ ê²°ê³¼ :
									<span id="filteredCount" class="fw-bold text-success">0</span>
									ê±´
								</span>
							</p>
						</div>
					</div>
					<div class="table-responsive">
						<table class="table text-center">
							<thead>
								<tr>
									<th scope="col">No.</th>
									<th scope="col">íšŒì›ì½”ë“œ</th>
									<th scope="col">ë¡œê·¸ì¸ì‹œê°„</th>
									<th scope="col">ë¡œê·¸ì•„ì›ƒì‹œê°„</th>
									<th scope="col">IP</th>
								</tr>
							</thead>
							<tbody id="loginHistoryTableBody">
								<tr th:if="${loginList == null or #lists.isEmpty(loginList)}">
									<td colspan="7">ë¡œê·¸ì¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td>
								</tr>
								<tr th:each="log, iterStat : ${loginList}">
									<td
										th:text="${(currentPage - 1) * pageSize + iterStat.index + 1}"></td>
									<td th:text="${log?.memberCode ?: '-'}"></td>
									<td th:text="${log?.loginTime ?: '-'}"></td>
									<td th:text="${log?.logoutTime ?: '-'}"></td>
									<td th:text="${log?.ip ?: '-'}"></td>
								</tr>
							</tbody>
						</table>
						<div id="paginationArea">
							<div
								th:insert="~{admin/fragments/pagination :: paginationFragment}"></div>
						</div>
					</div>
				</div>
			</div>
		</section>

	</th:block>

	<th:block layout:fragment="jsScript">
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script>
			// ì°¨íŠ¸ ê·¸ë¦¬ê¸°
			$(document).ready(function () {
			  $.ajax({
			    type: 'GET',
			    url: '/admin/loginHistory/chartData',
			    success: function (data) {
			      const labels = data.map(item => item.date);
			      const counts = data.map(item => item.count);
			
			      const ctx = document.getElementById('loginLineChart').getContext('2d');
			      new Chart(ctx, {
			        type: 'line',
			        data: {
			          labels: labels,
			          datasets: [{
			            label: 'ë¡œê·¸ì¸ ìˆ˜',
			            data: counts,
						borderColor: '#264796', // âœ… ì„  ìƒ‰ìƒ
						backgroundColor: 'rgba(38, 71, 150, 0.1)',
						pointBackgroundColor: '#264796', // âœ… ì  ìƒ‰ìƒ
						pointBorderColor: '#264796',
			            borderWidth: 2,
			            fill: false,
			            tension: 0.2
			          }]
			        },
			        options: {
			          scales: {
			            y: {
			              beginAtZero: true,
			              ticks: {
			                precision: 0 // ì •ìˆ˜ë§Œ
			              }
			            }
			          }
			        }
			      });
			    },
			    error: function () {
			      alert("ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
			    }
			  });
			});
		</script>
		<script>
			// ê²€ìƒ‰
			$('#searchBtn').on('click', function () {
			  const keyword = $('#searchKeyword').val();
			  const startDate = $('#startDate').val();
			  const endDate = $('#endDate').val();
			
			  $.ajax({
			    type: 'GET',
			    url: '/admin/loginHistory/search',
			    data: { keyword, startDate, endDate },
			    success: function (data) {
			      const $tbody = $('#loginHistoryTableBody');
			      $tbody.empty(); // ê¸°ì¡´ ë‚´ìš© ë¹„ì›€
			      const list = data;         // ê²€ìƒ‰ëœ ë¦¬ìŠ¤íŠ¸
      			  const count = list.length;   // ê²€ìƒ‰ëœ ê°œìˆ˜
					
			      // ğŸ”½ í˜ì´ì§€ë„¤ì´ì…˜ ìˆ¨ê¸°ê¸°
			      $('#paginationArea').hide();
			
			      if (data.length === 0) {
			        $tbody.append('<tr><td colspan="7">ë¡œê·¸ì¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
			      } else {
			        data.forEach((log, index) => {
			          $tbody.append(`
			            <tr>
			              <td>${index + 1}</td>
			              <td>${log.memberCode ?? '-'}</td>
			              <td>${log.loginTime ?? '-'}</td>
			              <td>${log.logoutTime ?? '-'}</td>
			              <td>${log.ip ?? '-'}</td>
			            </tr>
			          `);
			        });
			      }
			      // âœ… ê²€ìƒ‰ ê²°ê³¼ ìˆ˜ í‘œì‹œ
			      $('#filteredCount').text(count);       // ìˆ«ì í‘œì‹œ
			      $('#filteredCountWrap').show();        // ì˜ì—­ ë³´ì—¬ì£¼ê¸°
			
			      // âœ… ì „ì²´ ìˆ˜ ìœ ì§€ (í•„ìš” ì‹œ)
			      $('#totalCount').text(data.totalCount);
			    },
			    error: function () {
			      alert('ë¡œê·¸ì¸ ê¸°ë¡ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
			    }
			  });
			});
			
			$('#resetBtn').on('click', function(){
				 window.location.href = '/admin/loginHistory';
			});
			
			
			/* ê·¸ëƒ¥ ë¦¬ë¡œë“œ ì‹œì¼œ!
			
			// ğŸ” reset ë²„íŠ¼
			$('#resetBtn').on('click', function () {
			  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
			  $('#startDate').val('');
			  $('#endDate').val('');
			  $('#searchKeyword').val('');
			  $('#searchType').val('mbrCd');
			  $("input[name='currentPage']").val(1);
			
			  // âœ… ì „ì²´ ë¡œê·¸ì¸ ê¸°ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (1í˜ì´ì§€ ê¸°ì¤€)
			  $.ajax({
			    type: 'GET',
			    url: '/admin/loginHistory/init?page=1',
			    success: function (data) {
			      const $tbody = $('#loginHistoryTableBody');
			      $tbody.empty();
			
			      // ğŸ”¼ í˜ì´ì§€ë„¤ì´ì…˜ ë‹¤ì‹œ ë³´ì´ê¸°
			      $('#paginationArea').show();
			
			      if (data.length === 0) {
			        $tbody.append('<tr><td colspan="7">ë¡œê·¸ì¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
			      } else {
			      	const page = 1; // ë˜ëŠ” URLì—ì„œ page íŒŒì‹±
				    const rowPerPage = 30;
				    const startNumber = (page - 1) * rowPerPage;
			        data.forEach((log, index) => {
			          $tbody.append(`
			            <tr>
			              <td>${startNumber + index + 1}</td>
			              <td>${log.memberCode ?? '-'}</td>
			              <td>${log.loginTime ?? '-'}</td>
			              <td>${log.logoutTime ?? '-'}</td>
			              <td>${log.ip ?? '-'}</td>
			            </tr>
			          `);
			        });
			
			        // ğŸ‘‰ í˜ì´ì§• ë‹¤ì‹œ ê·¸ë¦¬ê¸° í•¨ìˆ˜ í˜¸ì¶œ í•„ìš” ì‹œ ì—¬ê¸°ì— ì¶”ê°€
			        // renderPagination(data.totalCount, data.currentPage);
			      }
			    },
			    error: function () {
			      alert('ì „ì²´ ë¡œê·¸ì¸ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
			    }
			  });
			}); */
		</script>

	</th:block>
</body>

</html>