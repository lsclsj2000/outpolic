<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{admin/layout/adminLayoutMain}">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="í•œêµ­ìŠ¤ë§ˆíŠ¸ì •ë³´êµìœ¡ì› íŒ€í”„ë¡œì íŠ¸" />
		<title>ê³µì§€ì‚¬í•­ ë‚´ì—­ ì¡°íšŒ</title>
		
		<style>
			.ellipsis-single-line {
			    white-space: nowrap;
			    overflow: hidden;
			    text-overflow: ellipsis;
			    max-width: 100%;
			    display: inline-block;
			}
		</style>
	</head>
	
	<th:block layout:fragment="contents">
		<section class="content-main">
	        <div class="content-header">
	            <div>
	                <h2 class="content-title card-title">ê³µì§€ì‚¬í•­ ë‚´ì—­ ì¡°íšŒ</h2>
	            </div>
	        </div>
	        <!-- ê²€ìƒ‰ í•„í„° -->
	        <div class="card mb-4 search-filter-card">
	            <div class="card-body search-filter-body">
	                <div class="table-responsive">
	                    <form id="searchForm" method="get" action="/admin/adminAnn">
							<table class="search-filter-table">
								<tbody>
									<tr>
										<th>ê¸°ë³¸ê²€ìƒ‰</th>
										<td>
											<select class="form-select" name="searchField" style="width: 120px;" 
											        th:value="${searchField}">
											    <option value="title" th:selected="${searchField} == 'title'">ì œëª©</option>
												<option value="type" th:selected="${searchField} == 'type'">ë‚´ìš©</option>
												<option value="writer" th:selected="${searchField} == 'writer'">ì‘ì„±ì</option>
											</select>
											<input type="text" name="searchKeyword" class="form-control" style="width: 250px;"
											       placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" th:value="${searchKeyword}" />
										</td>
									</tr>
									<tr>
									    <th>ê¸°ê°„ê²€ìƒ‰</th>
									    <td>
									        <select name="dateField" class="form-select" style="width: 120px;">
											    <option value="reg" th:selected="${dateField} == 'reg'">ì‘ì„±ì¼ì</option>
											    <option value="mod" th:selected="${dateField} == 'mod'">ìˆ˜ì •ì¼ì</option>
											</select>
									        <input type="date" id="startDate" name="startDate" class="form-control" style="width: 150px;" th:value="${startDate}" />
									        <span> ~ </span>
									        <input type="date" id="endDate" name="endDate" class="form-control" style="width: 150px;" th:value="${endDate}" />
									        <button type="button" class="btn btn-sm btn-light date-btn" data-range="today">ì˜¤ëŠ˜</button>
									        <button type="button" class="btn btn-sm btn-light date-btn" data-range="yesterday">ì–´ì œ</button>
									        <button type="button" class="btn btn-sm btn-light date-btn" data-range="7days">ì¼ì£¼ì¼</button>
									        <button type="button" class="btn btn-sm btn-light date-btn" data-range="lastmonth">ì§€ë‚œë‹¬</button>
									        <button type="button" class="btn btn-sm btn-light date-btn" data-range="1month">1ê°œì›”</button>
									        <button type="button" class="btn btn-sm btn-light date-btn" data-range="3months">3ê°œì›”</button>
									        <button type="button" class="btn btn-sm btn-light date-btn" data-range="all">ì „ì²´</button>
									    </td>
									</tr>
									<tr>
										<th>ìƒíƒœ</th>
										<td>
											<div class="radio-group">
												<label><input type="radio" name="status" value="" th:checked="${status == null or status == ''}" /> ì „ì²´</label>
												<label><input type="radio" name="status" value="SD_ACTIVE" th:checked="${status == 'SD_ACTIVE'}" /> í™œì„±</label>
												<label><input type="radio" name="status" value="SD_INACTIVE" th:checked="${status == 'SD_INACTIVE'}" /> ë¹„í™œì„±</label>
											</div>
										</td>
									</tr>
								</tbody>
							</table>
						
							<div class="search-filter-buttons">
								<button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
								<button type="button" id="resetButton" class="btn btn-secondary">ì´ˆê¸°í™”</button>
							</div>
						</form>
	                </div>
	            </div>
	        </div>
	        <div class="card mb-4">
	            <div class="card-body">
	                <div class="table-responsive">
	                    <table class="table table-hover">
	                        <thead>
	                            <tr>
	                                <th scope="col" class="start text-center col-1">No.</th>
	                                <th scope="col" class="text-center col-3">ì œëª©</th>
	                                <th scope="col" class="text-center col-4">ë‚´ìš©</th>
	                                <th scope="col" class="text-center col-1">ìƒíƒœ</th>
	                                <th scope="col" class="text-center col-1">ì‘ì„±ì</th>
	                                <th scope="col" class="text-center col-1">ì‘ì„±ì¼ì</th>
	                                <th scope="col" class="end text-center col-2">Action</th>
	                            </tr>
	                        </thead>
	                        <tbody>
							    <tr th:if="${not #lists.isEmpty(adminAnnList)}"
							        th:each="l : ${adminAnnList}"
							        class="start pt-30"
							        style="border:0px; border-bottom: solid 1px #ececec;">
							        
							        <td class="start text-center">
							            <span th:text="${l.annCode}">No.</span>
							        </td>
							        <td scope="col">
							            <span th:text="${l.annTitle}"
							                   style="text-decoration: none;"
							                   onmouseout="this.style.color='black'">
							                   ì œëª©
							            </span>
							        </td>
							        <td scope="col" class="text-truncate" style="max-width: 300px;">
									    <span style="display: inline-block; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
									          th:text="${l.annCn}">
									        ë‚´ìš©
									    </span>
									</td>
							        <td scope="col" class="text-center" th:switch="${l.annStcCode}">
							            <span th:case="${'SD_ACTIVE'}" class="badge rounded-pill alert-info">í™œì„±</span>
							            <span th:case="${'SD_INACTIVE'}" class="badge rounded-pill alert-warning">ë¹„í™œì„±</span>
							        </td>
							        <td scope="col" class="text-center" th:text="${l.annAdmCode}">ì‘ì„±ì</td>
							        <td scope="col" class="text-center" th:text="${l.annRegYmdt}">ì‘ì„±ì¼ì</td>
							        <td scope="col" class="text-center">
							            <a href="#" class="btn btn-light rounded font-sm SR_open-popup-btn" th:data-inquiry-code="${l.annCode}">ìˆ˜ì •</a>
							        </td>
							    </tr>
							    <tr th:if="${#lists.isEmpty(adminAnnList)}">
							        <td colspan="7" class="text-center">ì¡°íšŒëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
							    </tr>
							</tbody>
	                    </table>
	                </div>
	            </div>
	        </div>
	    </section>
	    
	    <!-- ê³µì§€ì‚¬í•­ ìˆ˜ì • ëª¨ë‹¬ -->
	    <div id="annMdfcnModal" class="SR_modal">
			<div class="SR_modal-content-wrapper">
				<div class="SR_popup-header">
					<h2>ê³µì§€ì‚¬í•­ ìˆ˜ì •</h2>
					<button class="SR_close-button">&times;</button>
				</div>
				<form id="inquiryEditForm">
                    <div class="SR_form-group">
                        <div class="SR_input-half">
                            <label class="col-lg-3 col-form-label">ë“±ë¡ì</label>
                            <input type="text" id="editRegAdm" name="editRegAdm" class="SR_form-control" readonly>
                        </div>
                        <div class="SR_input-half">
                            <label class="col-lg-3 col-form-label" for="inquiryTitleEdit">ë“±ë¡ì¼ì‹œ</label>
                            <input type="text" id="editRegDate" name="editRegDate" class="SR_form-control" readonly>
                        </div>
					</div>

                    <div class="SR_form-group">
                        <div class="SR_input-half">
                            <label class="col-lg-3 col-form-label" for="inquiryTypeCodeDisplay">ê³µì§€ì‚¬í•­ ì½”ë“œ</label>
                            <input type="text" id="editCode" name="editCode" class="SR_form-control" readonly>
                        </div>
                        <div class="SR_input-half">
                        </div>
					</div>
					
					<div class="SR_form-group SR_full-width">
						<label class="col-lg-3 col-form-label" for="inquiryTypeEdit">ì œëª©</label>
                        <input type="text" id="editName" name="editName" class="SR_form-control">
					</div>

                    <div class="SR_form-group SR_full-width">
						<label class="col-lg-3 col-form-label" for="inquiryContentEdit">ë‚´ìš©</label>
						<textarea id="editExpln" name="editExpln" class="SR_form-control" rows="5"></textarea>
					</div>
					<div class="row mb-4">
						<div class="SR_form-group mb-0">
		                   <label class="col-lg-1 col-form-label pb-0 mb-0">Status</label>
						</div>
	                   <div class="col-lg-8 ml-20" style="display: flex; flex-direction: row;">
							<label class="form-check my-2">
								<input type="radio" class="form-check-input" name="editStatus" value="SD_ACTIVE" />
								<span class="form-check-label">í™œì„±</span>
							</label>
							<label class="form-check my-2 ml-20">
								<input type="radio" class="form-check-input" name="editStatus" value="SD_INACTIVE" />
								<span class="form-check-label">ë¹„í™œì„±</span>
							</label>
						</div>
	               	</div>
	               	<div class="SR_form-group SR_full-width">
                        <label>ì²¨ë¶€íŒŒì¼ ëª©ë¡</label>
                        <div id="SR_fileList" class="SR_form-control SR_file-list">
                            íŒŒì¼1.jpg (1.2MB) <br>
                            íŒŒì¼2.pdf (3.5MB)
                        </div>
                    </div>
					<div class="SR_popup-footer">
                        <div class="SR_update-info">
                        	<span>ìˆ˜ì •ì •ë³´ : </span>
                            <span id="SR_updaterName">ìˆ˜ì •ì</span> | <span id="SR_updateDate">ìˆ˜ì •ì¼ì‹œ</span>
                        </div>
						<button type="submit" id="saveButton" class="btn btn-md rounded font-sm">ì €ì¥</button>
					</div>
				</form>
			</div>
		</div>
	</th:block>

    <th:block layout:fragment="jsScript">
		<script>
		document.addEventListener('DOMContentLoaded', function () {
            // **1. ëª¨ë‹¬ ê´€ë ¨ ì½”ë“œ ì‹œì‘**
            const modal = document.getElementById('annMdfcnModal');
            const openBtns = document.querySelectorAll('.SR_open-popup-btn');
            const closeBtn = modal.querySelector('.SR_close-button');
            const saveBtn = document.getElementById('saveButton');

            // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
            openBtns.forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const annCode = btn.getAttribute('data-inquiry-code');

                    fetch(`/admin/getAdminAnnDetail?code=${annCode}`)
                        .then(res => res.json())
                        .then(data => {
                        	console.log('ğŸ“¦ ê³µì§€ì‚¬í•­ ë‹¨ê±´ ë°ì´í„°:', data);
                            console.log('ğŸ“ ì²¨ë¶€íŒŒì¼ ëª©ë¡:', data.adminAnnFiles);
                            document.getElementById('editCode').value = data.annCode || '';
                            document.getElementById('editName').value = data.annTitle || '';
                            document.getElementById('editExpln').value = data.annCn || '';
                            document.getElementById('editRegAdm').value = data.annAdmCode || '';
                            document.getElementById('editRegDate').value = data.annRegYmdt || '';
                            document.getElementById('SR_updaterName').innerText = data.annMdfcnAdmCode || '-';
                            document.getElementById('SR_updateDate').innerText = data.annMdfcnYmdt || '-';

                            const radios = document.querySelectorAll('input[name="editStatus"]');
                            radios.forEach(r => {
                                r.checked = (r.value === data.annStcCode);
                            });

                         // ì²¨ë¶€íŒŒì¼ ëª©ë¡ ì¶œë ¥
                            const fileListDiv = document.getElementById('SR_fileList');
                            fileListDiv.innerHTML = '';

                            if (data.adminAnnFiles && data.adminAnnFiles.length > 0) {
                                data.adminAnnFiles.forEach(file => {
                                    if (!file) return; // âœ… null ìš”ì†Œ ê±´ë„ˆëœ€

                                    const fileSizeMB = (file.saSize / (1024 * 1024)).toFixed(1);
                                    const fileName = file.saOrgnlName;
                                    const saCode = file.saCode;

                                    const fileItem = document.createElement('div');
                                    fileItem.innerHTML = `<a href="/admin/adminAnn/file/download?saCode=${saCode}" target="_blank">${fileName}</a> (${fileSizeMB}MB)`;
                                    fileListDiv.appendChild(fileItem);
                                });
                            } else {
                                fileListDiv.textContent = 'ì²¨ë¶€íŒŒì¼ ì—†ìŒ';
                            }

                            // ëª¨ë‹¬ ì—´ê¸°
                            modal.style.display = 'flex';
                            document.body.style.overflow = 'hidden';
                        })
                        .catch(err => {
                            console.error('ë‹¨ê±´ ì¡°íšŒ ì‹¤íŒ¨:', err);
                            alert('ê³µì§€ì‚¬í•­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        });
                });
            });

            closeBtn.addEventListener('click', function () {
                closeModal();
            });

            saveBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const payload = {
                    annCode: document.getElementById('editCode').value,
                    annTitle: document.getElementById('editName').value,
                    annCn: document.getElementById('editExpln').value,
                    annStcCode: document.querySelector('input[name="editStatus"]:checked')?.value || '',
                };

                fetch('/admin/updateAdminAnn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    if (!res.ok) throw new Error('Update failed');
                    return res.text();
                })
                .then(result => {
                    alert("ê³µì§€ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeModal();
                    location.reload();
                })
                .catch(err => {
                    console.error("ìˆ˜ì • ì‹¤íŒ¨:", err);
                    alert("ê³µì§€ì‚¬í•­ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
            });

            window.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeModal();
                }
            });

            function closeModal() {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            // **ëª¨ë‹¬ ê´€ë ¨ ì½”ë“œ ë**

            // ------------------

            // **2. ë‚ ì§œ/ì´ˆê¸°í™” ë²„íŠ¼ ê´€ë ¨ ì½”ë“œ ì‹œì‘**
            // âœ… ë‚ ì§œ ë²„íŠ¼ í´ë¦­ ì‹œ startDate, endDate ìë™ ì„¤ì •
            document.querySelectorAll('.date-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const range = button.getAttribute('data-range');
                    const today = new Date();
                    let startDate = new Date();
                    let endDate = new Date();

                    switch (range) {
                        case 'today':
                            break;
                        case 'yesterday':
                            startDate.setDate(today.getDate() - 1);
                            endDate.setDate(today.getDate() - 1);
                            break;
                        case '7days':
                            startDate.setDate(today.getDate() - 7);
                            break;
                        case 'lastmonth':
                            startDate.setMonth(today.getMonth() - 1);
                            startDate.setDate(1);
                            endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
                            break;
                        case '1month':
                            startDate.setMonth(today.getMonth() - 1);
                            break;
                        case '3months':
                            startDate.setMonth(today.getMonth() - 3);
                            break;
                        case 'all':
                            document.getElementById('startDate').value = '';
                            document.getElementById('endDate').value = '';
                            return;
                    }

                    const formatDate = (date) => {
                        const year = date.getFullYear();
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const day = date.getDate().toString().padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };

                    document.getElementById('startDate').value = formatDate(startDate);
                    document.getElementById('endDate').value = formatDate(endDate);
                });
            });

            // âœ… ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ í•„í„° ë¦¬ì…‹
            document.getElementById('resetButton').addEventListener('click', function () {
                window.location.href = '/admin/adminAnn';
            });
            // **ë‚ ì§œ/ì´ˆê¸°í™” ë²„íŠ¼ ê´€ë ¨ ì½”ë“œ ë**
        });
		</script>
	</th:block>
</html>