<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{enter/layout/enterLayoutkjw}">
	<head>
		<meta name="description" content="한국스마트정보교육원 ksmybatis" />
		    <link rel="shortcut icon" type="image/x-icon" th:href="@{/enter/assets/imgs/theme/favicon.svg}" />
 
    <link href="/enter/assets/css/main.css?v=1.1" rel="stylesheet" type="text/css" />	</head>
	
	<meta charset="UTF-8">
<title>Insert title here</title>
</head>
		<th:block layout:fragment="contents">
		        <div class="main-container w-100">
            <h1 class="section-title">새 외주 프로젝트 신청</h1>
            
            <div class="card">
              		 <form id="outsourcingApplicationForm" action="/enter/requests/add" method="post">
    
				    <input type="hidden" name="entCd" th:value="${supplierCd}"> <div class="form-group">
				        <label for="ocdTtl">프로젝트 제목 <span class="required-star">*</span></label>
				        <input type="text" id="ocdTtl" name="ocdTtl" class="form-control" required>
				    </div>
				
				    <div class="form-group">
				        <label for="ocdExpln">제안 상세 설명 <span class="required-star">*</span></label>
				        <textarea id="ocdExpln" name="ocdExpln" class="form-control" rows="8" required></textarea>
				    </div>
				
				    <div class="flex-row">
				        <div class="form-group">
				            <label for="ocdDedline">희망 작업 기한</label>
				            <input type="date" id="ocdDedline" name="ocdDedline" class="form-control">
				        </div>
				        <div class="form-group">
				            <label for="ocdAmt">제안 금액 (세전 기준) <span class="required-star">*</span></label>
				            <div class="input-with-unit">
				                <input type="number" id="ocdAmt" name="ocdAmt" class="form-control" required>
				                <span>원</span>
				            </div>
				        </div>
				    </div>
				    
				    <div class="form-group">
				        <label for="application_reference_files">참고 자료 첨부</label>
				        <input type="file" id="application_reference_files" name="files" multiple>
				    </div>
				    
				    <button type="submit" class="btn-submit">
				        <i class="fas fa-check-circle mr-2"></i> 외주 프로젝트 신청하기
				    </button>
				</form>
            </div>
        </div>
        </th:block>

        <th:block layout:fragment="jsFile">
            <script th:src="@{/enter/assets/js/vendor/jquery-3.6.0.min.js}"></script>
            <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const MAX_FILE_COUNT = 5; // 최대 파일 개수 (현재 5개로 설정되어 있음)

                    /**
                     * 파일 입력 필드에 대한 미리보기 기능을 초기화하고 파일 개수 제한을 관리합니다.
                     * @param {string} fileInputId - 파일 입력 필드의 ID (예: 'application_reference_files')
                     * @param {string} previewContainerId - 미리보기 이미지를 표시할 컨테이너의 ID (예: 'application-file-preview-container')
                     */
                    function initializeFilePreview(fileInputId, previewContainerId) {
                        const fileInput = document.getElementById(fileInputId);
                        const previewContainer = document.getElementById(previewContainerId);

                        if (!fileInput || !previewContainer) {
                            console.error(`Element with ID '${fileInputId}' or '${previewContainerId}' not found. Cannot initialize file preview.`);
                            return;
                        }

                        fileInput.addEventListener('change', function (event) {
                            previewContainer.innerHTML = ''; // 이전 미리보기 제거
                            const newlySelectedFiles = event.target.files; // 새로 선택된 파일들
                            const currentFilesDt = new DataTransfer(); // 유효한 파일만 담을 DataTransfer 객체

                            // 새로 선택된 파일들을 순회하며 MAX_FILE_COUNT를 초과하지 않는 선에서 DataTransfer 객체에 추가
                            for (let i = 0; i < newlySelectedFiles.length; i++) {
                                const file = newlySelectedFiles.item(i);
                                // 현재까지 추가된 파일의 개수가 MAX_FILE_COUNT를 초과하면 더 이상 추가하지 않고 경고
                                if (currentFilesDt.items.length < MAX_FILE_COUNT) {
                                    currentFilesDt.items.add(file);
                                } else {
                                    alert(`파일은 최대 ${MAX_FILE_COUNT}개까지 첨부할 수 있습니다. 초과된 파일은 자동으로 제외됩니다.`);
                                    break; // 제한을 초과했으므로 루프를 중단
                                }
                            }

                            // 파일 입력 필드에 최종적으로 허용된 파일 목록을 업데이트
                            fileInput.files = currentFilesDt.files;

                            // 업데이트된 파일 목록으로 미리보기 렌더링
                            const filesToRender = fileInput.files;

                            if (filesToRender.length > 0) {
                                for (let i = 0; i < filesToRender.length; i++) {
                                    const file = filesToRender.item(i);
                                    const fileType = file.type;
                                    const fileName = file.name;

                                    const fileDiv = document.createElement('div');
                                    fileDiv.classList.add('relative', 'w-24', 'h-24', 'overflow-hidden', 'rounded-lg', 'shadow-sm', 'group', 'flex', 'items-center', 'justify-center', 'text-gray-500', 'bg-gray-100', 'text-center', 'break-all', 'p-1');

                                    if (fileType.startsWith('image/')) {
                                        const reader = new FileReader();
                                        reader.onload = (e) => {
                                            fileDiv.innerHTML = `
                                                <img src="${e.target.result}" alt="Reference File" class="w-full h-full object-cover">
                                                <button type="button" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white opacity-0 group-hover:opacity-100 transition-opacity remove-file-btn" data-file-name="${fileName}">
                                                    <i class="fas fa-times-circle"></i>
                                                </button>
                                            `;
                                        };
                                        reader.readAsDataURL(file);
                                    } else {
                                        let iconClass = 'fas fa-file';
                                        if (fileType.includes('pdf')) iconClass = 'fas fa-file-pdf';
                                        else if (fileType.includes('word')) iconClass = 'fas fa-file-word';
                                        else if (fileType.includes('powerpoint')) iconClass = 'fas fa-file-powerpoint';
                                        else if (fileType.includes('text')) iconClass = 'fas fa-file-alt';

                                        fileDiv.innerHTML = `
                                            <div class="flex flex-col items-center justify-center p-1">
                                                <i class="${iconClass} text-3xl mb-1 text-gray-400"></i>
                                                <span class="text-xs font-medium">${fileName}</span>
                                            </div>
                                            <button type="button" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white opacity-0 group-hover:opacity-100 transition-opacity remove-file-btn" data-file-name="${fileName}">
                                                <i class="fas fa-times-circle"></i>
                                            </button>
                                        `;
                                    }
                                    previewContainer.appendChild(fileDiv);
                                }
                            } else {
                                // 파일이 하나도 없을 경우 미리보기 컨테이너를 비웁니다.
                                previewContainer.innerHTML = '';
                            }

                            // 동적으로 추가된 제거 버튼에 이벤트 리스너를 다시 연결 (중요: 매번 새로 연결해야 함)
                            previewContainer.querySelectorAll('.remove-file-btn').forEach(button => {
                                button.addEventListener('click', function() {
                                    const fileNameToRemove = this.dataset.fileName;
                                    const dt = new DataTransfer();
                                    const currentInputFiles = fileInput.files;

                                    // 제거할 파일을 제외하고 나머지 파일들을 새 DataTransfer 객체에 추가
                                    for (let j = 0; j < currentInputFiles.length; j++) {
                                        if (currentInputFiles.item(j).name !== fileNameToRemove) {
                                            dt.items.add(currentInputFiles.item(j));
                                        }
                                    }
                                    fileInput.files = dt.files; // 파일 입력 필드 업데이트
                                    this.closest('div').remove(); // 해당 미리보기 div 제거
                                });
                            });
                        });
                    }

                    // --- 외주 프로젝트 신청 폼 (outsourcingApplicationForm) 초기화 ---
                    const outsourcingApplicationForm = document.getElementById('outsourcingApplicationForm');
                    if (outsourcingApplicationForm) {
                        outsourcingApplicationForm.addEventListener('submit', function (e) {
                            e.preventDefault(); // 기본 폼 제출 방지
                            
                            const formData = new FormData(outsourcingApplicationForm);
                            
                            // 유효성 검사 (기존 로직 유지)
                            if(!formData.get('ocdTtl')){
								alert('프로젝트 제목을 입력해주세요.');
								return;
                            }
                            
                            if(!formData.get('ocdAmt') || parseFloat(formData.get('ocdAmt')) <=0){
								alert('제안 금액을 올바르게 입력해주세요.');
								return;
                            }
                            
                            // fetch API를 사용하여 서버에 데이터 전송
                            fetch('/enter/requests/add', {
								method:'POST',
								body:formData
                            })
                            
                            .then(response => response.json())
                            .then(data => {

                            if(data.success){
								alert(data.message);
								
								outsourcingApplicationForm.reset();
								document.getElementById('application-file-preview-container').innerHTML = '';
                            }else{
								alert('오류: ' + (data.message || '알 수 없는 오류가 발생했습니다.'));

                            }
                            })
                            .catch(error=> {
								console.error('Fetch Error:',error);
								alert('신청 처리 중 네트워크 오류가 발생했습니다.');
                            });
                    

                            // TODO: 실제 백엔드 연동 시 여기에 AJAX 요청 로직을 추가해야 함
                            // 현재는 콘솔 로그와 알림으로 대체

                            const outsourcingId = document.getElementById('outsourcing_id') ? document.getElementById('outsourcing_id').value : 'N/A';
                            const proposalDescription = document.getElementById('proposal_description').value.trim();
                            const desiredWorkStartDate = document.getElementById('desired_work_start_date').value;
                            const desiredWorkEndDate = document.getElementById('desired_work_end_date').value;
                            const proposedAmount = document.getElementById('proposed_amount').value;
                            const files = document.getElementById('application_reference_files').files; // 이 시점의 files는 이미 제한이 적용된 상태여야 함

                            // 기본 유효성 검사
                            if (!proposalDescription) {
                                alert('제안 상세 설명을 입력해주세요.');
                                document.getElementById('proposal_description').focus();
                                return;
                            }
                            if (!proposedAmount || parseFloat(proposedAmount) <= 0) {
                                alert('제안 금액을 올바르게 입력해주세요.');
                                document.getElementById('proposed_amount').focus();
                                return;
                            }

                            console.log('외주 프로젝트 신청 데이터:', {
                                outsourcing_id: outsourcingId,
                                proposal_description: proposalDescription,
                                desired_work_start_date: desiredWorkStartDate,
                                desired_work_end_date: desiredWorkEndDate,
                                proposed_amount: parseFloat(proposedAmount),
                                reference_files_count: files.length
                            });
                            alert('외주 프로젝트 신청이 성공적으로 접수되었습니다! (실제 저장 로직은 백엔드 구현 필요)');
                            
                            outsourcingApplicationForm.reset(); // 폼 초기화
                            document.getElementById('application-file-preview-container').innerHTML = ''; // 파일 미리보기 초기화
                            document.getElementById('application_reference_files').value = ''; // input[type=file]의 files 객체를 명시적으로 초기화 (reset()만으로는 부족할 수 있음)
                        });

                        // 외주 신청 폼의 파일 미리보기 초기화 함수 호출
                        initializeFilePreview('application_reference_files', 'application-file-preview-container');
                    }

                    // --- 포트폴리오 문의 폼 (portfolioInquiryForm) 초기화 ---
                    // outsourcingRequestListView.html에는 이 부분이 필요 없습니다.
                    // 만약 이 HTML 파일에서 포트폴리오 문의 폼도 다룬다면 주석을 해제하세요.
                    /*
                    const portfolioInquiryForm = document.getElementById('portfolioInquiryForm');
                    if (portfolioInquiryForm) {
                        portfolioInquiryForm.addEventListener('submit', function (e) {
                            e.preventDefault();

                            const portfolioId = document.getElementById('portfolio_id').value;
                            const inquiryDescription = document.getElementById('inquiry_description').value.trim();
                            const desiredProjectStartDate = document.getElementById('desired_project_start_date').value;
                            const desiredProjectEndDate = document.getElementById('desired_project_end_date').value;
                            const desiredBudget = document.getElementById('desired_budget').value;
                            const files = document.getElementById('inquiry_reference_files').files;

                            if (!inquiryDescription) {
                                alert('의뢰 상세 내용을 입력해주세요.');
                                document.getElementById('inquiry_description').focus();
                                return;
                            }
                            if (desiredBudget && parseFloat(desiredBudget) < 0) {
                                alert('희망 예산을 올바르게 입력해주세요.');
                                document.getElementById('desired_budget').focus();
                                return;
                            }

                            console.log('포트폴리오 문의 데이터:', {
                                portfolio_id: portfolioId,
                                inquiry_description: inquiryDescription,
                                desired_project_start_date: desiredProjectStartDate,
                                desired_project_end_date: desiredProjectEndDate,
                                desired_budget: desiredBudget ? parseFloat(desiredBudget) : null,
                                reference_files_count: files.length
                            });
                            alert('포트폴리오 문의 (새 외주 의뢰)가 성공적으로 접수되었습니다! (실제 저장 로직은 백엔드 구현 필요)');

                            portfolioInquiryForm.reset();
                            document.getElementById('inquiry-file-preview-container').innerHTML = '';
                            document.getElementById('inquiry_reference_files').value = '';
                        });
                        initializeFilePreview('inquiry_reference_files', 'inquiry-file-preview-container');
                    }
                    */
                });
            </script>
            
            <script th:src="@{/enter/assets/js/main.js}"></script>
        </th:block>
        </html>