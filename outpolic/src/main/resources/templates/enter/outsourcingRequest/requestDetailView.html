<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{enter/layout/enterLayoutkjw}">
<head>
    <meta charset="UTF-8">
    <title>요청 상세 보기</title>
    <style>
        .request-card { background: #ffffff; border-radius: 12px; padding: 2rem; box-shadow: 0 8px 25px rgba(0,0,0,0.07); margin-bottom: 2rem; }
        .request-header h1 { font-size: 1.8rem; font-weight: 800; color: #1f2937; margin: 0 0 1rem 0; }
        .meta-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; padding: 1.5rem 0; margin-bottom: 1.5rem; }
        .meta-item { font-size: 1rem; color: #4b5563; }
        .meta-item strong { color: #111827; display: block; margin-bottom: 0.25rem; }
        .request-body { line-height: 1.6; }
        .request-body h3 { font-size: 1.2rem; font-weight: 700; margin-top: 0; }
        .communication-thread { background: #ffffff; border-radius: 12px; padding: 2rem; box-shadow: 0 8px 25px rgba(0,0,0,0.07); }
        .communication-thread h2 { font-size: 1.5rem; font-weight: 700; margin-top: 0; margin-bottom: 1.5rem; }
        .reply-history { max-height: 400px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 1.5rem; }
        #reply-form textarea { width: 100%; min-height: 100px; padding: 0.8rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; box-sizing: border-box; resize: vertical; margin-bottom: 1rem; }
        #reply-form button { display: block; width: 100%; background-color: #16a34a; color: white; padding: 0.8rem; border: none; border-radius: 6px; font-size: 1rem; font-weight: 700; cursor: pointer; }
        /* 추가된 부분 */
        .action-bar { text-align: right; margin-top: 1rem; }
        .action-button { padding: 0.6rem 1.2rem; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; margin-left: 0.5rem; }
        .btn-cancel { background-color: #ef4444; color: white; }
    </style>
</head>
<body>
<th:block layout:fragment="contents">
    <div class="container">
        <div class="request-card">
            <div class="request-header"><h1 id="request-title"></h1></div>
            <div class="meta-grid">
                <div class="meta-item"><strong>요청자</strong> <span id="requester-name"></span></div>
                <div class="meta-item"><strong>공급자</strong> <span id="recipient-name"></span></div>
                <div class="meta-item"><strong>요청일</strong> <span id="request-date"></span></div>
                <div class="meta-item"><strong>희망 예산</strong> <span id="request-amount"></span></div>
            </div>
            <div class="request-body">
                <h3>상세 요청 내용</h3>
                <p id="request-content"></p>
            </div>
            <div class="action-bar" id="requester-actions" style="display: none;">
                <button class="action-button btn-cancel" id="cancel-request-btn">요청 취소</button>
            </div>
        </div>

        <div class="communication-thread">
            <h2>답변 및 진행 상황</h2>
            <div id="reply-history" class="reply-history"></div>
            <form id="reply-form">
                <textarea id="reply-content" placeholder="추가 문의나 답변을 입력하세요..."></textarea>
                <button type="submit">메시지 전송</button>
            </form>
        </div>
    </div>
</th:block>

<th:block layout:fragment="jsFile">
    <!-- 
      [수정됨] th:inline="javascript" 속성 추가 및 CDATA 블록으로 감싸기
      이것이 Thymeleaf에서 JavaScript 파싱 오류를 피하는 표준적인 방법입니다.
    -->
    <script th:inline="javascript">
    /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            const pathParts = window.location.pathname.split('/');
            const requestId = pathParts[pathParts.length - 1];
            
            // 이 부분은 th:inline="javascript"를 통해 서버에서 안전하게 값을 주입받습니다.
            const currentMbrCd = /*[[${session.loginMember != null ? session.loginMember.mbrCd : null}]]*/ 'MB_C0000036'; 

            // UI 요소
            const titleEl = document.getElementById('request-title');
            const requesterEl = document.getElementById('requester-name');
            const recipientEl = document.getElementById('recipient-name');
            const dateEl = document.getElementById('request-date');
            const amountEl = document.getElementById('request-amount');
            const contentEl = document.getElementById('request-content');
            const historyContainer = document.getElementById('reply-history');
            const replyForm = document.getElementById('reply-form');
            const replyContentInput = document.getElementById('reply-content');
            const requesterActions = document.getElementById('requester-actions');

            fetch(`/api/enter/requests/${requestId}`)
                .then(response => {
                    // 이제 이 '<' 기호는 XML 파서에 의해 안전하게 무시됩니다.
                    if (response.status === 403) throw new Error('권한이 없습니다.');
                    if (!response.ok) throw new Error('요청 정보를 불러오지 못했습니다.');
                    return response.json();
                })
                .then(data => {
                    const request = data.request;
                    titleEl.textContent = request.ocd_ttl;
                    requesterEl.textContent = request.demanderName;
                    recipientEl.textContent = request.supplierName;
                    dateEl.textContent = new Date(request.ocd_dmnd_ymdt).toLocaleDateString();
                    amountEl.textContent = request.ocd_amt ? `${request.ocd_amt.toLocaleString()}원` : '협의';
                    contentEl.textContent = request.ocd_expln;

                    if (currentMbrCd === request.mbr_cd) {
                        requesterActions.style.display = 'block';
                    }
                    
                    renderReplies(data.replies);
                })
                .catch(error => {
                    alert(error.message);
                    window.location.href = '/enter/requests/sent'; 
                });
            
            function renderReplies(replies) {
                // (구현 필요)
            }

            replyForm.addEventListener('submit', function(e) {
                e.preventDefault();
                // (구현 필요)
            });
            
            document.getElementById('cancel-request-btn')?.addEventListener('click', function() {
                if (confirm('정말로 이 요청을 취소하시겠습니까?')) {
                    fetch(`/api/enter/requests/${requestId}/cancel`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('요청이 취소되었습니다.');
                                location.reload();
                            } else {
                                throw new Error(data.message);
                            }
                        })
                        .catch(error => alert('취소 처리 중 오류가 발생했습니다: ' + error.message));
                }
            });
        });
    /*]]>*/
    </script>
</th:block>
</body>
</html>