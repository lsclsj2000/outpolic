<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{enter/layout/enterLayoutOsstList}">
<head>
    <meta name="description" content="í•œêµ­ìŠ¤ë§ˆíŠ¸ì •ë³´êµìœ¡ì› íŒ€í”„ë¡œì íŠ¸" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì™¸ì£¼ ì§„í–‰ í˜„í™©</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/enter/assets/css/enterOutsourcingStatus.css}">
    <style>
        /* For the report and feedback display boxes */
        .SR_report-feedback-card {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            transition: transform 0.2s ease-in-out;
        }
        .SR_report-feedback-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <div layout:fragment="contents">
    	<input type="hidden" id="ocdCdHidden" th:value="${EnterOsstDetail.ocdCd}" />
        <main class="SR_flex-grow">
            <div class="SR_label-container">
                   <div class="SR_blue-bar"></div>
                <h2 class="SR_text-3xl SR_font-bold SR_text-gray-800" 
                    th:text="${'[' + EnterOsstDetail.ocdTitle + '] ì§„í–‰ í˜„í™©'}">[ì™¸ì£¼ëª…] ì§„í–‰ í˜„í™©</h2>
            </div>

            <div class="SR_max-w-6xl SR_mx-auto SR_container-bg SR_p-8 SR_rounded-lg SR_box-shadow SR_mb-8">
                <div class="SR_flex SR_flex-col SR_lg:flex-row SR_gap-8 SR_mb-8">
                    <div class="SR_w-full SR_lg:w-1/3 SR_section-card SR_mb-0">
                        <h3 class="SR_text-xl SR_font-semibold SR_text-gray-700 SR_mb-4">ì™¸ì£¼ ì‹ ì²­/ë¬¸ì˜ ë‚´ìš©</h3>
                        <div class="SR_p-3 SR_bg-gray-50 SR_rounded-md SR_border SR_border-gray-200">
                            <p class="SR_text-base SR_font-semibold SR_text-blue-700 SR_mb-2">
                                <a th:href="@{/enter/outsourcing-requests/{ocdCd}(ocdCd=${EnterOsstDetail.ocdCd})}" class="SR_underline"
                                   th:text="${EnterOsstDetail.ocdTitle}">ì‹ ì²­ì œëª©</a>
                            </p>
                            <p class="SR_text-sm SR_text-gray-600">â€¢ ì‘ì„±ì:
                                <span class="SR_text-sm SR_text-gray-600"
                                   th:text="${EnterOsstDetail.memberName}"></span>
                            </p>
                            <p class="SR_text-sm SR_text-gray-600">â€¢ ì‘ì„±ì¼ì:
                                <span class="SR_text-sm SR_text-gray-600"
                                   th:text="${EnterOsstDetail.ocdDmndYmdt}"></span>
                            </p>
                            <p class="SR_text-sm SR_text-gray-600">â€¢ í¬ë§ì‘ì—…ê¸°í•œ:
                                <span class="SR_text-sm SR_text-gray-600"
                                   th:text="${EnterOsstDetail.ocdDedline}"></span>
                            </p>
                            <p class="SR_text-sm SR_text-gray-600">â€¢ í¬ë§ë‹¨ê°€:
                                <span class="SR_text-sm SR_text-gray-600"
                                   th:text="${#numbers.formatInteger(EnterOsstDetail.ocdAmt, 0, 'COMMA')}"></span>
                            </p>
                            <p class="SR_text-sm SR_text-gray-600 SR_flex SR_items-baseline">â€¢ ë‚´ìš©:
                                <span class="SR_text-sm SR_text-gray-600 SR_flex-1 SR_truncate"
                                   th:text="${EnterOsstDetail.ocdExpln}"></span>
                            </p>
                        </div>
                    </div>

                    <div class="SR_w-full SR_lg:w-1/3 SR_section-card SR_mb-0">
                        <h3 class="SR_text-xl SR_font-semibold SR_text-gray-700 SR_mb-4">ìµœê·¼ í™œë™</h3>
                        <div id="recent-activities-list" class="SR_scrollable-activity-list">
                        </div>
                    </div>

                    <div class="SR_w-full SR_lg:w-1/3 SR_section-card SR_mb-0">
                        <h3 class="SR_text-xl SR_font-semibold SR_text-gray-700 SR_mb-4">ê³µê¸‰ì ë° ìˆ˜ìš”ì</h3>
                        <div id="key-contacts-list">
                            <div class="SR_contact-card">
                                <div class="SR_contact-avatar supplier">S</div>
                                <div class="SR_contact-details">
                                    <div class="SR_contact-name" th:text="${EnterOsstDetail.entMbrName + '(ê³µê¸‰ì)'}">ê³µê¸‰ì ì´ë¦„</div>
                                    <div class="SR_contact-role" th:text="${EnterOsstDetail.entName}">ê¸°ì—…ëª…</div>
                                    <a href="#" class="SR_contact-email" th:text="${EnterOsstDetail.entMbrEmail}">ê³µê¸‰ì ì´ë©”ì¼</a>
                                </div>
                            </div>
                            <div class="SR_contact-card">
                                <div class="SR_contact-avatar customer">C</div>
                                <div class="SR_contact-details">
                                    <div class="SR_contact-name" th:text="${EnterOsstDetail.memberName + '(ìˆ˜ìš”ì)'}">ìˆ˜ìš”ì ì´ë¦„</div>
                                    <a href="#" class="SR_contact-email" th:text="${EnterOsstDetail.memberEmail}">ìˆ˜ìš”ì ì´ë©”ì¼</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="SR_mb-8 SR_text-center">
                    <div class="SR_segmented-progress-container" id="segmented-progress-bar">
                    </div>
                    <p id="progress-percentage-text" class="SR_progress-percentage-text">20%</p>
                    <p id="progress-status-message" class="SR_text-center SR_text-gray-600 SR_mt-2">ì´ˆê¸° ê³„ì•½ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="SR_max-w-6xl SR_mx-auto SR_container-bg SR_p-8 SR_rounded-lg SR_box-shadow">
                <div class="SR_flex SR_flex-col SR_lg:flex-row SR_gap-8">
                    <div class="SR_w-full SR_lg:w-1/3 SR_bg-gray-50 SR_p-6 SR_rounded-lg SR_box-shadow">
                        <h3 class="SR_text-xl SR_font-semibold SR_text-gray-700 SR_mb-4">ì§„í–‰ ë‹¨ê³„</h3>
                        <ul id="progress-steps" class="SR_progress-steps-list">
                            <li th:each="step, stat : ${groupedStepData}"
                                th:data-step-id="${stat.index + 1}"
                                th:classappend="${step.isCompleted()} ? 'SR_completed-step' : (${step.isInProgress()} ? 'SR_current-step' : '')"
                                onclick="displayStepDetails(this.dataset.stepId)">
                                <div class="SR_step-icon" th:text="${stat.index + 1}">1</div>
                                <span class="SR_step-name" th:text="${step.stcNm}">ê³„ì•½ ì²´ê²°</span>
                                <span class="SR_step-status" th:text="${step.isCompleted()} ? 'ì™„ë£Œ' : (${step.isInProgress()} ? 'ì§„í–‰ ì¤‘' : 'ì˜ˆì •')">ì™„ë£Œ</span>
                            </li>
                        </ul>
                    </div>

                    <div class="SR_w-full SR_lg:w-2\/3 SR_flex SR_flex-col SR_gap-8">
                        <div id="progress-list">
                            <div th:each="step, stat : ${groupedStepData}"
                                 th:data-step-id="${stat.index + 1}"
                                 th:classappend="${stat.index + 1 == 1} ? '' : 'SR_hidden'"
                                 class="SR_bg-white SR_p-6 SR_rounded-lg SR_box-shadow SR_border SR_border-gray-200 SR_step-container">
                                
                                <div class="SR_mb-6">
                                    <h5 class="SR_mb-3">[ ê³µê¸‰ì ë³´ê³ ì„œ ]</h5>
                                    <th:block th:if="${not #lists.isEmpty(step.reports)}">
                                        <div th:each="report : ${step.reports}" class="SR_bg-gray-500 SR_p-3 SR_rounded-md SR_mb-2 SR_border SR_border-blue-200 SR_report-box SR_report-feedback-card">
                                            <p><strong th:text="${report.osstRecordTitle}">ì´ˆê¸° ê³„ì•½ì„œ ì œì¶œ</strong></p>
                                            <p th:text="${report.osstRecordCn}">í”„ë¡œì íŠ¸ ì´ˆê¸° ê³„ì•½ì„œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                                            <p class="SR_text-xs SR_text-gray-500" th:text="${report != null ? 'ì‘ì„±ì¼: ' + report.osstRecordRegYmdt : 'ì‘ì„±ì¼ ì •ë³´ ì—†ìŒ'}">ì‘ì„±ì¼: 2025-07-07</p>
                                        </div>
                                    </th:block>
                                    <div th:if="${#lists.isEmpty(step.reports)}" 
                                    	 class="SR_bg-gray-500 SR_p-3 SR_rounded-md SR_mb-2 SR_border SR_border-blue-300 SR_report-feedback-card"
                                    	 style="text-align: center;">ì œì¶œëœ ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                                    
                                    <div th:id="'submitReportBtnContainer-' + ${stat.index}"
									     class="SR_flex SR_justify-end SR_gap-4 SR_mt-4"
									     style="display: none;">
									    <button type="button" class="SR_btn-primary" onclick="openModal('submitReportModal')">ë³´ê³ ì„œ ì œì¶œ</button>
									</div>
                                </div>

                                <div class="SR_mb-6 mt-30">
                                    <h5 class="SR_mb-3">[ ìˆ˜ìš”ì í”¼ë“œë°± ]</h5>
                                    <th:block th:if="${not #lists.isEmpty(step.feedbacks)}">
                                        <div th:each="feedback : ${step.feedbacks}" class="SR_bg-gray-500 SR_p-3 SR_rounded-md SR_mb-2 SR_border SR_border-blue-200 SR_feedback-box SR_report-feedback-card">
                                            <p><strong th:text="${feedback.osstRecordTitle}">ê³„ì•½ì„œ ê²€í†  ì™„ë£Œ</strong></p>
                                            <p th:text="${feedback.osstRecordCn}">ì œì¶œëœ ê³„ì•½ì„œ ë‚´ìš© í™•ì¸í–ˆìŠµë‹ˆë‹¤.</p><p class="SR_text-xs SR_text-gray-500 text-left" th:text="${feedback != null ? 'ì‘ì„±ì¼: ' + feedback.osstRecordRegYmdt : 'ì‘ì„±ì¼ ì •ë³´ ì—†ìŒ'}">ì‘ì„±ì¼: 2025-07-08</p>
                                        </div>
                                    </th:block>
                                    <div th:if="${#lists.isEmpty(step.feedbacks)}" 
                                    	 class="SR_bg-gray-500 SR_p-3 SR_rounded-md SR_mb-2 SR_border SR_border-blue-300 SR_report-feedback-card"
                                    	 style="text-align: center;">ì œì¶œëœ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.</div>

                                    <div th:if="${step.isInProgress() and memberRole == 'DEMANDER'}" class="SR_flex SR_justify-end SR_gap-4 SR_mt-4">
                                        <button type="button" class="SR_btn-primary" onclick="openModal('giveFeedbackModal')">í”¼ë“œë°± ì‘ì„±</button>
                                    </div>
                                </div>

                                <div class="SR_mb-6 mt-30">
                                    <h5 class="SR_mb-3">[ ìµœì¢… ê²°ê³¼ë¬¼ ]</h5>
                                    <th:block th:if="${not #lists.isEmpty(step.finalResults)}">
                                        <ul>
                                            <li th:each="result : ${step.finalResults}" class="SR_bg-gray-500 SR_p-3 SR_rounded-md SR_mb-2 SR_border SR_border-blue-300 SR_report-feedback-card">
                                                <a th:href="@{'/files/' + ${result.osstRecordUpCode}}" target="_blank" class="SR_text-blue-700 SR_underline" th:text="${result.osstRecordTitle}">signed_contract.pdf</a>
                                                <p th:text="${result.osstRecordCn}"></p>
                                                <p class="SR_text-xs SR_text-gray-500" th:text="${result != null ? 'ì‘ì„±ì¼: ' + result.osstRecordRegYmdt : 'ì‘ì„±ì¼ ì •ë³´ ì—†ìŒ'}">ì‘ì„±ì¼: 2025-07-08</p>
                                            </li>
                                        </ul>
                                    </th:block>
                                    <div th:if="${#lists.isEmpty(step.finalResults)}" 
                                    	 class="SR_bg-gray-500 SR_p-3 SR_rounded-md SR_mb-2 SR_border SR_border-blue-300 SR_report-feedback-card" 
                                    	 style="text-align: center;">ì œì¶œëœ ê²°ê³¼ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
               <div id="step-approval-button-container"
			        class="SR_flex SR_justify-end SR_mt-4 mt-30 SR_hidden">
                   <button class="SR_btn-secondary" onclick="approveStep()">ë‹¨ê³„ ìŠ¹ì¸</button>
               </div>
            </div>
        </main>


        <div id="submitReportModal" class="SR_fixed SR_inset-0 SR_bg-gray-600 SR_bg-opacity-50 SR_flex SR_items-center SR_justify-center SR_hidden SR_z-50">
            <form id="reportForm" enctype="multipart/form-data" class="SR_bg-white SR_p-8 SR_rounded-lg SR_box-shadow SR_w-11\/12 SR_md\:w-1\/2 SR_lg\:w-1\/3 SR_modal-dialog-content">
                <h3 class="SR_text-xl SR_font-bold SR_mb-4">ê²°ê³¼ë¬¼ ì œì¶œ</h3>
                <input type="text" id="reportTitle" name="osrTtl" placeholder="ë³´ê³ ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”." maxlength="50" class="SR_w-full SR_p-3 SR_border SR_rounded-md SR_mb-4">
                <label for="feedbackCodeSelect" class="SR_block SR_text-sm SR_font-semibold SR_text-gray-700 SR_mb-2">ê´€ë ¨ í”¼ë“œë°± ì„ íƒ (ì„ íƒ ì‚¬í•­):</label>
                <select id="feedbackCodeSelect" name="osrUpCd" class="SR_w-full SR_p-3 SR_border SR_rounded-md SR_mb-4">
                    <option value="">í”¼ë“œë°±ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
                <textarea id="reportContent" name="osrCn" class="SR_w-full SR_p-3 SR_border SR_rounded-md SR_mb-4" rows="5" placeholder="ë³´ê³ ì„œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                <input type="file" id="reportFile"name="attachment" class="SR_mb-4">
                <div class="SR_flex SR_justify-end SR_gap-4">
                    <button type="button" class="SR_btn-primary" onclick="closeModal('submitReportModal')">ì·¨ì†Œ</button>
                    <button type="button" class="SR_btn-primary ml-10" onclick="submitReport()">ì œì¶œ</button>
                </div>
            </form>
        </div>

        <div id="giveFeedbackModal" class="SR_fixed SR_inset-0 SR_bg-gray-600 SR_bg-opacity-50 SR_flex SR_items-center SR_justify-center SR_hidden SR_z-50">
            <form id="feedbackForm" enctype="multipart/form-data" class="SR_bg-white SR_p-8 SR_rounded-lg SR_box-shadow SR_w-11\/12 SR_md\:w-1\/2 SR_lg\:w-1\/3 SR_modal-dialog-content">
                <h3 class="SR_text-xl SR_font-bold SR_mb-4">í”¼ë“œë°± í•˜ê¸°</h3>
                <input type="text" id="feedbackTitle" name="osrTtl" placeholder="í”¼ë“œë°± ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”." maxlength="50" class="SR_w-full SR_p-3 SR_border SR_rounded-md SR_mb-4">
                <label for="reportCodeSelect" class="SR_block SR_text-sm SR_font-semibold SR_text-gray-700 SR_mb-2">ê´€ë ¨ ë³´ê³ ì„œ ì„ íƒ (ì„ íƒ ì‚¬í•­):</label>
                <select id="reportCodeSelect" name="osrUpCd" class="SR_w-full SR_p-3 SR_border SR_rounded-md SR_mb-4">
                    <option value="">ë³´ê³ ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>	
                    </select>
                <textarea id="feedbackContent" name="osrCn" class="SR_w-full SR_p-3 SR_border SR_rounded-md SR_mb-4" rows="5" placeholder="í”¼ë“œë°± ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                <input type="file" id="feedbackFile" name="attachment" class="SR_mb-4"> <div class="SR_flex SR_justify-end SR_gap-4">
                    <button type="button" class="SR_btn-primary" onclick="closeModal('giveFeedbackModal')">ì·¨ì†Œ</button>
                    <button type="button" class="SR_btn-primary ml-10" onclick="submitFeedback()">í”¼ë“œë°± ì œì¶œ</button>
                </div>
            </form>
        </div>
    </div>
    
    <th:block layout:fragment="jsScript">
        <script th:inline="javascript">
            const groupedStepDataFromBackend = /*[[${groupedStepData}]]*/ []; 
            

            const progressStepsData = groupedStepDataFromBackend;

            const recentActivitiesData = /*[[${recentActivities}]]*/ [];
            const memberRole = /*[[${memberRole}]]*/ "SUPPLIER";

            let currentStepIndex = progressStepsData.findIndex(step => step.ospCustYn === 0 && step.ospSplyYmdt !== null);

            if (currentStepIndex === -1) {
                currentStepIndex = progressStepsData.findIndex(step => step.ospCustYn === 0 && step.ospSplyYmdt === null);
            }
            
            let activeContentStepIndex = (currentStepIndex !== -1) ? currentStepIndex : 0;
            
            document.addEventListener('DOMContentLoaded', () => {
                renderRecentActivities();
                updateProgressDisplay();
                displayStepDetails(activeContentStepIndex + 1); 
            });

            function getStepStatus(step) {
                if (step.ospCustYn === 1) { 
                    return 'ì™„ë£Œ';
                } else if (step.ospCustYn === 0 && step.ospSplyYmdt !== null) { 
                    return 'ì§„í–‰ ì¤‘';
                } else {
                    return 'ì˜ˆì •';
                }
            }

            function isStepCompleted(step) {
                return step.ospCustYn !== null && step.ospCustYn === 1; 
            }

            function isInProgress(step) {
                // ì›ë˜ ì¡°ê±´
                if (step.ospCustYn !== null && step.ospCustYn === 0 && step.ospSplyYmdt !== null) return true;

                // ì˜ˆì™¸: ì§„í–‰ì¤‘ ë‹¨ê³„ê°€ ì—†ê³  ì´ ë‹¨ê³„ê°€ ì²« ë²ˆì§¸ ì˜ˆì • ë‹¨ê³„ì¼ ê²½ìš°
                const hasRealInProgress = progressStepsData.some(s => s.ospCustYn === 0 && s.ospSplyYmdt !== null);
                if (!hasRealInProgress) {
                    const firstPendingIndex = progressStepsData.findIndex(s => s.ospCustYn === 0 && s.ospSplyYmdt === null);
                    if (progressStepsData.indexOf(step) === firstPendingIndex) {
                        return true;
                    }
                }

                return false;
            }


            function updateProgressDisplay() {
                const segmentedProgressBar = document.getElementById('segmented-progress-bar');
                const progressPercentageText = document.getElementById('progress-percentage-text');
                const progressStatusMessage = document.getElementById('progress-status-message');

                segmentedProgressBar.innerHTML = '';

                progressStepsData.forEach(step => {
                    const segment = document.createElement('div');
                    segment.classList.add('SR_progress-segment');
                    if (isStepCompleted(step)) {
                        segment.classList.add('completed');
                    } else if (isInProgress(step)) {
                        segment.classList.add('current');
                    }
                    segment.textContent = progressStepsData.indexOf(step) + 1; 
                    segmentedProgressBar.appendChild(segment);
                });

                const completedStepsCount = progressStepsData.filter(step => isStepCompleted(step)).length;
                const currentStepData = progressStepsData.find(step => isInProgress(step));
                let calculatedProgress = completedStepsCount;
                if (currentStepData) {
                    calculatedProgress += 0.5;
                }
                const progressPercentage = (calculatedProgress / progressStepsData.length) * 100;
                progressPercentageText.textContent = `${Math.round(progressPercentage)}%`;

                if (currentStepData) {
                    progressStatusMessage.textContent = `${currentStepData.stcNm} ë‹¨ê³„ (${getStepStatus(currentStepData)})`;
                } else if (completedStepsCount === progressStepsData.length) {
                    progressStatusMessage.textContent = `ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ`;
                } else {
                    progressStatusMessage.textContent = `ì§„í–‰ ì¤‘ì¸ ë‹¨ê³„ ì—†ìŒ`;
                }
            }

            function displayStepDetails(stepId) {
                activeContentStepIndex = stepId - 1;

                // ëª¨ë“  ë‹¨ê³„ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
                document.querySelectorAll('.SR_step-container').forEach(container => {
                    container.classList.add('SR_hidden');
                });

                // ì„ íƒí•œ ë‹¨ê³„ ì»¨í…Œì´ë„ˆ ë³´ì´ê¸°
                const selectedStepContainer = document.querySelector(`.SR_step-container[data-step-id="${stepId}"]`);
                if (selectedStepContainer) {
                    selectedStepContainer.classList.remove('SR_hidden');
                }

                // ì§„í–‰ ë‹¨ê³„ ëª©ë¡ í•˜ì´ë¼ì´íŒ…
                document.querySelectorAll('#progress-steps li').forEach(item => {
                    item.classList.remove('SR_selected-step');
                });
                document.querySelector(`#progress-steps li[data-step-id="${stepId}"]`).classList.add('SR_selected-step');

                // í˜„ì¬ ë‹¨ê³„ ë°ì´í„°
                const step = progressStepsData[activeContentStepIndex];

                // âœ… ë‹¨ê³„ ìŠ¹ì¸ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
                const approveButtonContainer = document.getElementById('step-approval-button-container');
                if (step && isInProgress(step)) {
                    approveButtonContainer.classList.remove('SR_hidden');
                } else {
                    approveButtonContainer.classList.add('SR_hidden');
                }

                // âœ… ê³µê¸‰ì ë³´ê³ ì„œ ì œì¶œ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
                const reportBtnContainer = document.getElementById(`submitReportBtnContainer-${activeContentStepIndex}`);

				// ê¸°ì¡´ ì¡°ê±´ ìœ ì§€
				if (step && isInProgress(step) && memberRole === 'SUPPLIER') {
				    reportBtnContainer.style.display = 'flex';
				} else {
				    reportBtnContainer.style.display = 'none';
				}

                // âœ… ìˆ˜ìš”ì í”¼ë“œë°± ì œì¶œ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
                const feedbackBtnContainer = document.querySelector('.SR_flex.SR_justify-end.SR_gap-4.SR_mt-4 > button[onclick*="giveFeedbackModal"]')?.parentElement;
                if (feedbackBtnContainer) {
                    if (step && isInProgress(step) && memberRole === 'DEMANDER') {
                        feedbackBtnContainer.style.display = 'flex';
                    } else {
                        feedbackBtnContainer.style.display = 'none';
                    }
                }
            }

            // ëª¨ë‹¬ ë“œë¡­ë‹¤ìš´ì„ í˜„ì¬ ë‹¨ê³„ì˜ ì‹¤ì œ ë³´ê³ ì„œ/í”¼ë“œë°± ë°ì´í„°ë¡œ ì±„ìš°ë„ë¡ ìˆ˜ì •
            function populateFeedbackCodeDropdown() {
                const dropdown = document.getElementById('feedbackCodeSelect');
                dropdown.innerHTML = '<option value="">í”¼ë“œë°±ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                const currentStepData = progressStepsData[activeContentStepIndex];
                if (currentStepData && currentStepData.feedbacks) { 
                    currentStepData.feedbacks.forEach(feedback => {
                        const option = document.createElement('option');
                        option.value = feedback.osstRecordCode; 
                        option.textContent = feedback.osstRecordTitle; 
                        dropdown.appendChild(option);
                    });
                }
            }

            function populateReportCodeDropdown() {
                const dropdown = document.getElementById('reportCodeSelect');
                dropdown.innerHTML = '<option value="">ë³´ê³ ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                // í˜„ì¬ ë‹¨ê³„ì˜ í”¼ë“œë°± ëª©ë¡ì—ì„œ ë³´ê³ ì„œì™€ ì—°ê´€ë  ìˆ˜ ìˆëŠ” í”¼ë“œë°±ì˜ ì½”ë“œë¥¼ ì±„ì›ë‹ˆë‹¤.
                const currentStepData = progressStepsData[activeContentStepIndex];
                if (currentStepData && currentStepData.reports) { 
                    currentStepData.reports.forEach(report => {
                        const option = document.createElement('option');
                        option.value = report.osstRecordCode; 
                        option.textContent = report.osstRecordTitle; 
                        dropdown.appendChild(option);
                    });
                }
            }

            function openModal(modalId) {
                document.getElementById(modalId).classList.remove('SR_hidden');
                if (modalId === 'submitReportModal') {
                    populateFeedbackCodeDropdown();
                } else if (modalId === 'giveFeedbackModal') {
                    populateReportCodeDropdown();
                }
            }

            function closeModal(modalId) {
                document.getElementById(modalId).classList.add('SR_hidden');
                // ëª¨ë‹¬ ë‹«ì„ ë•Œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                if (modalId === 'submitReportModal') {
                    document.getElementById('reportTitle').value = '';
                    document.getElementById('feedbackCodeSelect').value = '';
                    document.getElementById('reportContent').value = '';
                    document.getElementById('reportFile').value = '';
                } else if (modalId === 'giveFeedbackModal') {
                    document.getElementById('feedbackTitle').value = '';
                    document.getElementById('reportCodeSelect').value = '';
                    document.getElementById('feedbackContent').value = '';
                    document.getElementById('feedbackFile').value = '';
                }
            }
            
            function approveStep() {
                const currentStep = progressStepsData[activeContentStepIndex];
                const ocdCd = document.getElementById('ocdCdHidden').value;

                fetch('/enter/approveStep', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `ospCd=${currentStep.ospCd}`
                })
                .then(res => res.text())
                .then(data => {
                    if (data === 'OK') {
                        showMessageBox("'í˜„ì¬ ë‹¨ê³„'ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.", () => {
                            location.href = `/enter/enterOsstDetail?ocd_cd=${ocdCd}`;
                        });
                    } else {
                        showMessageBox("ë‹¨ê³„ ìŠ¹ì¸ ì‹¤íŒ¨: " + data);
                    }
                });
            }
            
            function showMessageBox(message, callback) {
                let messageBox = document.getElementById('SR_messageBox');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'SR_messageBox';
                    messageBox.className = 'SR_fixed SR_inset-0 SR_bg-gray-600 SR_bg-opacity-50 SR_flex SR_items-center SR_justify-center SR_z-50';
                    messageBox.innerHTML = `
                        <div class="SR_bg-white SR_p-6 SR_rounded-lg SR_shadow-lg SR_max-w-sm SR_w-full SR_text-center">
                            <p class="SR_mb-4" id="SR_messageText"></p>
                            <button class="SR_btn-primary" id="SR_messageConfirmBtn">í™•ì¸</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                }

                document.getElementById('SR_messageText').textContent = message;
                messageBox.classList.remove('SR_hidden');

                const confirmButton = document.getElementById('SR_messageConfirmBtn');
                confirmButton.onclick = () => {
                    messageBox.classList.add('SR_hidden');
                    if (typeof callback === 'function') {
                        callback();
                    }
                };
            }
            

            function closeMessageBox() {
                const messageBox = document.getElementById('SR_messageBox');
                if (messageBox) {
                    messageBox.classList.add('SR_hidden');
                }
            }
            
            function submitReport() {
                const title = document.getElementById('reportTitle').value.trim();
                const content = document.getElementById('reportContent').value.trim();

                if (title === '') {
                    alert('ë³´ê³ ì„œ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (title.length > 50) {
                    alert('ë³´ê³ ì„œ ì œëª©ì€ 50ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (content === '') {
                    alert('ë³´ê³ ì„œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const form = document.getElementById('reportForm');
                const formData = new FormData(form);

                formData.append('ospCd', progressStepsData[activeContentStepIndex].ospCd);
                formData.append('osrType', 'report'); // íƒ€ì… ê³ ì •

                fetch('/enter/submitRecord', {
                    method: 'POST',
                    body: formData
                }).then(res => res.text())
                  .then(data => {
                    if (data === "OK") {
                        alert('ë³´ê³ ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.reload();
                    } else {
                        alert('ì‹¤íŒ¨: ' + data);
                    }
                });
            }


            function submitFeedback() {
                const title = document.getElementById('feedbackTitle').value.trim();
                const content = document.getElementById('feedbackContent').value.trim();

                if (title === '') {
                    alert('í”¼ë“œë°± ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (title.length > 50) {
                    alert('í”¼ë“œë°± ì œëª©ì€ 50ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (content === '') {
                    alert('í”¼ë“œë°± ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const formData = new FormData();
                formData.append('osrTtl', title);
                formData.append('osrCn', content);
                formData.append('osrUpCd', document.getElementById('reportCodeSelect').value);
                formData.append('osrType', 'feedback');
                formData.append('ospCd', progressStepsData[activeContentStepIndex].ospCd);
                formData.append('attachment', document.getElementById('feedbackFile').files[0]);

                const ocdCd = document.getElementById('ocdCdHidden').value;

                fetch('/enter/submitRecord', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.text())
                .then(data => {
                    if (data === "OK") {
                        alert('í”¼ë“œë°±ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.href = `/enter/enterOsstDetail?ocd_cd=${ocdCd}`;
                    } else {
                        alert('ì‹¤íŒ¨: ' + data);
                    }
                });
            }

            function renderRecentActivities() {
                const activitiesListContainer = document.getElementById('recent-activities-list');
                activitiesListContainer.innerHTML = '';

                if (recentActivitiesData.length === 0) {
                    activitiesListContainer.innerHTML = `<p class="SR_text-gray-600">ìµœê·¼ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                recentActivitiesData.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'SR_activity-item';
                    activityItem.innerHTML = `
                        <div class="SR_activity-icon">ğŸ“</div>
                        <div class="SR_activity-content">
                            <div class="SR_activity-date">${activity.osstRecordRegYmdt}</div>
                            <div class="SR_activity-description">${activity.osstRecordTitle}</div>
                        </div>
                    `;
                    activitiesListContainer.appendChild(activityItem);
                });
            }

            // New: Add Activity to Recent Activities
            function addActivity(description) {
                const today = new Date().toISOString().slice(0, 10);
                recentActivitiesData.unshift({ date: today, description: description });	
                renderRecentActivities();
            }
        </script>
    </th:block>
</body>
</html>