<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{enter/layout/enterLayoutOP}">
<head>
    <title>내 포트폴리오</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- 외주 디자인에 맞춘 포트폴리오 카드 스타일 --- */
        .outsourcing-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }
        .outsourcing-item-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%; /* 카드 높이 동일하게 유지 */
        }
        .outsourcing-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        .outsourcing-thumbnail-wrapper {
            width: 100%;
            height: 180px;
            overflow: hidden;
            background-color: #f3f4f6;
        }
        .outsourcing-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .outsourcing-thumbnail-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 1rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f3f4f6;
        }
        .card-status {
            font-size: 0.8em;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        .status-badge.primary {
            color: #264796;
            background-color: #e0e9fa;
        }
        .card-applicant-price {
            text-align: right;
            font-weight: 600;
        }
        .applicant-count {
            font-size: 0.8em;
            color: #6b7280;
        }
        .outsource-price {
            font-size: 1.1em;
            color: #1f2937;
        }
        .card-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .card-title {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 5px;
        }
        .card-category {
            font-size: 0.9em;
            color: #6b7280;
            margin-bottom: 10px;
        }
        .card-summary {
            font-size: 0.9em;
            color: #4b5563;
            line-height: 1.6;
            max-height: 3.2em; /* 2줄까지만 보이도록 */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            margin-bottom: 15px;
        }
        .card-footer {
            border-top: 1px solid #f3f4f6;
            padding: 15px;
            font-size: 0.85em;
            color: #9ca3af;
        }
        /* --- 기존 포트폴리오 버튼 및 UI 스타일 유지 --- */
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .mb-10 { margin-bottom: 40px; }
        .section-title { font-size: 2em; font-weight: 700; margin-bottom: 20px !important; color: #1f2937; display: inline-block; }
        .btn-action { background-color: #264796; border: none; color: white; padding: 10px 20px; text-align: center; display: inline-flex; align-items: center; gap: 8px; font-size: 16px; cursor: pointer; border-radius: 5px; transition: background-color 0.2s ease; margin-bottom: 30px; }
        .btn-action:hover { background-color: #29A56C; }
        .hidden { display: none !important; }
        .no-portfolio-container { text-align: center; padding: 50px 20px; border: 2px dashed #e0e0e0; border-radius: 8px; background-color: #fafafa; }
        
        .portfolio-actions { display: flex; gap: 10px; margin-top: auto; padding-top: 15px; }
        .btn-edit, .btn-delete, .btn-share { border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        .btn-edit { background-color: #3b82f6; color: white; }
        .btn-edit:hover { background-color: #2563eb; }
        .btn-delete { background-color: #ef4444; color: white; }
        .btn-delete:hover { background-color: #dc2626; }
        .btn-share { background-color: #14b8a6; color: white; }
        .btn-share:hover { background-color: #0d9488; }
        /* --- 모달 관련 CSS --- */
        @media (min-width: 1400px) { .modal-dialog.modal-xxl { max-width: 1320px; } }
        .modal-body.custom-modal-body { max-height: 85vh; overflow-y: auto; }
        .fi-rs-heart.active { color: #F15B5B; font-weight: 900; }
        .bookmark-btn .fi-rs-heart.active { color: #F15B5B !important; }
        .modal-portfolio-content img { max-width: 100%; height: auto; display: block; margin-bottom: 15px; }
        .modal-portfolio-content .no-image-placeholder { height: 200px; display: flex; align-items: center; justify-content: center; background-color: #f0f0f0; color: #aaa; font-size: 1.2em; text-align: center; margin-bottom: 15px; border-radius: 8px; }
        .modal-portfolio-content p { line-height: 1.6; color: #333; margin-bottom: 15px; white-space: pre-wrap; }
    </style>
</head>
<body>
<th:block layout:fragment="contents">
    <div class="page-container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
        <h1 class="section-title">내 포트폴리오</h1>
        
        <button id="addPortfolioBtn" class="btn-action" style="margin-left:920px;">
            <i class="fas fa-plus"></i> 새 포트폴리오 등록하기
        </button>

        <div id="portfolioItemsGrid" class="outsourcing-items-grid"></div>
        
        <div id="noPortfolioMessage" class="no-portfolio-container hidden">
            <p>등록된 포트폴리오가 없습니다. 새로운 포트폴리오를 등록해보세요!</p>
        </div>
    </div>
    
    <div class="modal fade" id="portfolioDetailModal" tabindex="-1" aria-labelledby="portfolioModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xxl"> 
            <div class="modal-content"> 
                <div class="modal-header border-bottom-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body custom-modal-body pt-0">
                    <div class="d-flex h-100">
                        <div id="modalInfoSection" class="p-4" style="width: 40%; overflow-y: auto;">
                            </div>
                        <div id="modalContentSection" class="p-3 ps-4 border-start" style="width: 60%; overflow-y: auto;">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="jsFile">
    <script th:src="@{/enter/assets/js/vendor/jquery-3.6.0.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let lastFocusedElement = null;

        function handleBookmarkClick(clickedButtonElement) {
            const clCd = clickedButtonElement.dataset.clCd;
            if (!clCd) return;
            const heartIcons = document.querySelectorAll(`.bookmark-btn[data-cl-cd="${clCd}"] i.fi-rs-heart`);
            if (heartIcons.length === 0) return;
            const isCurrentlyBookmarked = heartIcons[0].classList.contains('active');
            const apiUrl = '/api/enter/bookmarks';
            heartIcons.forEach(icon => icon.classList.toggle('active'));
            let options;
            if (isCurrentlyBookmarked) {
                options = { method: 'DELETE' };
                fetch(`${apiUrl}/${clCd}`, options).then(response => {
                    if (!response.ok) {
                        alert('찜 해제에 실패했습니다.');
                        heartIcons.forEach(icon => icon.classList.add('active'));
                    }
                });
            } else {
                options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clCd: clCd })
                };
                fetch(apiUrl, options).then(response => {
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) alert('로그인이 필요한 기능입니다.');
                        else alert('찜하기에 실패했습니다.');
                        heartIcons.forEach(icon => icon.classList.remove('active'));
                    }
                });
            }
        }

        function openDetailModal(contentsId) {
            const modalElement = document.getElementById('portfolioDetailModal');
            if (!modalElement) return;
            lastFocusedElement = document.activeElement;
            const infoSection = modalElement.querySelector('#modalInfoSection');
            const contentSection = modalElement.querySelector('#modalContentSection');
            const detailModal = new bootstrap.Modal(modalElement);
            infoSection.innerHTML = `<div class="text-center p-5"><div class="spinner-border" role="status"></div></div>`;
            contentSection.innerHTML = `<div class="text-center p-5"><div class="spinner-border" role="status"></div></div>`;
            detailModal.show();
            
            function fixDuplicatedPath(buggyPath, correctFileName) {
                if (!buggyPath || !correctFileName) {
                    return buggyPath;
                }
                if (buggyPath.endsWith(correctFileName)) {
                    const pathWithoutLastPart = buggyPath.substring(0, buggyPath.length - correctFileName.length);
                    if(pathWithoutLastPart) return pathWithoutLastPart;
                }
                return buggyPath;
            }

            $.ajax({
                url: `/user/api/contents/${contentsId}`,
                type: 'GET',
                dataType: 'json',
                success: function(detail) {
                    const title = detail.contentsTitle || '제목 없음';
                    const isBookmarked = detail.isBookmarked || false; 
                    const clCd = detail.clCd || '';
                    const prtfCd = detail.contentsId; 
                    const infoHtml = `
                        <div class="d-flex align-items-center mb-3">
                            <img src="/user/assets/imgs/theme/icons/icon-user.svg" alt="logo" class="rounded-circle me-3" style="width: 50px; height: 50px; border: 1px solid #eee;">
                            <div><h6 class="mb-0 fw-bold">${detail.enterName || '회사명 없음'}</h6><small class="text-muted">MASTER</small></div>
                        </div>
                        <hr class="my-3">
                        <h3 class="fw-bold mb-3">${title}</h3>
                        <div class="d-flex align-items-center mb-4">
                        
                        </div>
                        <div class="mb-4">
                            <h6 class="fw-bold">프로젝트 설명</h6>
                            <p class="text-muted" style="white-space: pre-wrap;">${detail.contentsBody || '설명 없음'}</p>
                        </div>
                        <div class="mb-4">
                            <h6 class="fw-bold">참여 기간</h6>
                            <p class="text-muted">${(detail.participationStartDate ? new Date(detail.participationStartDate).toLocaleDateString() : '') + ' ~ ' + (detail.participationEndDate ? new Date(detail.participationEndDate).toLocaleDateString() : '')}</p>
                        </div>
                        <div class="mb-4">
                            <h6 class="fw-bold">클라이언트</h6>
                            <p class="text-muted">${detail.client || '정보 없음'}</p>
                        </div>
                        <div>
                            <h6 class="fw-bold">업종</h6>
                            <p class="text-muted">${detail.industry || '정보 없음'}</p>
                        </div>`;
                    infoSection.innerHTML = infoHtml;

                    let imagesHtml = '<div class="no-image-placeholder"><i class="fas fa-image"></i> 이미지가 없습니다.</div>';
                    if (detail.filesJson) {
                        try {
                            const files = JSON.parse(detail.filesJson);
                            if (files && files.length > 0) {
                                imagesHtml = files.map(file => {
                                    let correctedPath = fixDuplicatedPath(file.filePath, file.fileNewName);
                                   
                                    let imageUrl = file.filePath; 

                                    if (imageUrl && !imageUrl.startsWith('/attachment/')) {
                                        imageUrl = '/attachment/' + imageUrl;
                                    }
                                    return `<img src="${imageUrl}" alt="${file.fileOriginalName || '이미지'}" class="img-fluid" style="margin-bottom: 15px;">`;
                                }).join('');
                            }
                        } catch (e) {
                            imagesHtml = '<p class="text-center text-danger">이미지를 불러오는 중 오류가 발생했습니다.</p>';
                        }
                    }
                    contentSection.innerHTML = `<div class="modal-portfolio-content">${imagesHtml}</div>`;
                },
                error: function(xhr) {
                    infoSection.innerHTML = '<p class="text-center">상세 정보를 불러오는 데 실패했습니다.</p>';
                    contentSection.innerHTML = '<p class="text-center">이미지를 불러오는 데 실패했습니다.</p>'; 
                }
            });
        }
        
        function getDaysDifference(startDate, endDate) {
            if (!startDate || !endDate) return null;
            const start = new Date(startDate.split('T')[0]);
            const end = new Date(endDate.split('T')[0]);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        $(document).ready(function() {
            const grid = $('#portfolioItemsGrid');
            const noPortfolioMessage = $('#noPortfolioMessage');

            function loadAndRenderPortfolioList() {
                $.ajax({
                    url: '/enter/portfolio/listData',
                    cache: false,
                    success: function(portfolios) {
                        grid.empty();
                        if (portfolios && portfolios.length > 0) {
                            noPortfolioMessage.addClass('hidden');
                            grid.removeClass('hidden');

                            portfolios.forEach(p => {
                                const thumbnailUrl = p.prtfThumbnailUrl ? p.prtfThumbnailUrl : null;
                                const thumbnailImageHtml = thumbnailUrl ? 
                                    `<img src="${thumbnailUrl}" alt="${p.prtfTtl} 썸네일" class="outsourcing-thumbnail">` : 
                                    `<div class="outsourcing-thumbnail-placeholder">이미지 없음</div>`;
                                    
                                const categoryHtml = p.ctgryNm ? `<p class="card-category">${p.ctgryNm}</p>` : '';
                                
                                const statusHtml = `<span class="status-badge">포트폴리오</span>`;
                                const applicantAndPriceHtml = `<div class="card-applicant-price"><div class="applicant-count">다운로드수 ${p.prtfDwnldCnt || 0}회</div></div>`;
                                
                                const durationDays = getDaysDifference(p.prtfPeriodStart, p.prtfPeriodEnd);
                                const durationHtml = durationDays !== null ? `<i class="far fa-calendar-alt"></i> 진행 기간 ${durationDays}일` : '';
                                
                                const cardContent = `
                                    <div class="outsourcing-thumbnail-wrapper">${thumbnailImageHtml}</div>
                                    <div class="card-header">
                                        <div class="card-status">${statusHtml}</div>
                                        ${applicantAndPriceHtml}
                                    </div>
                                    <div class="card-content">
                                        <h3 class="card-title">${p.prtfTtl}</h3>
                                        ${categoryHtml}
                                        <p class="card-summary">${p.prtfCn}</p>
                                        <div class="portfolio-actions">
                                            <button class="btn-edit" data-prtf-cd="${p.prtfCd}">수정</button>
                                            <button class="btn-delete" data-prtf-cd="${p.prtfCd}">삭제</button>
                                        </div>
                                    </div>
                                    <div class="card-footer">${durationHtml}</div>`;
                                    
                                const card = $(`<div class="outsourcing-item-card portfolio-modal-trigger" role="button" data-contents-id="${p.prtfCd}">${cardContent}</div>`);
                                grid.append(card);
                            });
                        } else {
                            noPortfolioMessage.removeClass('hidden');
                            grid.addClass('hidden');
                        }
                    },
                    error: function(xhr) {
                        console.error("포트폴리오 목록 로딩 오류:", xhr.responseText);
                        noPortfolioMessage.text('목록을 불러오는 데 실패했습니다.').removeClass('hidden');
                        grid.addClass('hidden');
                    }
                });
            }

            // '새 포트폴리오 등록' 버튼
            $('#addPortfolioBtn').on('click', () => window.location.href = '/enter/portfolio/add');
            
            // 이벤트 위임을 사용하여 동적으로 생성된 카드에 이벤트 리스너 추가
            grid.on('click', '.portfolio-modal-trigger', function(e) {
                if ($(e.target).closest('.portfolio-actions').length === 0) {
                    const contentsId = $(this).data('contents-id');
                    if (contentsId) {
                        openDetailModal(contentsId);
                    }
                }
            });

            grid.on('click', '.portfolio-actions button', function(e) {
                e.stopPropagation(); // 버튼 클릭 시 모달이 열리는 것을 방지
                const $button = $(this);
                const prtfCd = $button.data('prtf-cd');

                if ($button.hasClass('btn-edit')) {
                    window.location.href = `/enter/portfolio/edit/${prtfCd}`;
                } else if ($button.hasClass('btn-delete')) {
                    if (confirm('정말로 삭제하시겠습니까? 관련 데이터가 모두 삭제됩니다.')) {
                        $.ajax({
                            url: `/enter/portfolio/delete/${prtfCd}`,
                            type: 'DELETE',
                            success: function(res) {
                                if (res.success) {
                                    alert(res.message || '삭제 요청이 접수되었습니다.');
                                    loadAndRenderPortfolioList(); 
                                } else {
                                    alert('삭제 실패: ' + (res.message || '알 수 없는 오류'));
                                }
                            },
                            error: function(xhr) {
                                alert('삭제 중 오류가 발생했습니다.');
                            }
                        });
                    } 
                } else if ($button.hasClass('btn-share')) {
                    alert('공유 기능은 아직 구현되지 않았습니다.'); 
                }
            });

            // 초기 목록 로드
            loadAndRenderPortfolioList();
        });
    </script>
</th:block>
</body>
</html>