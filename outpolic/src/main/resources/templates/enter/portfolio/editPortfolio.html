<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{enter/layout/enterLayoutkjw}">
<head>
    <title>포트폴리오 수정</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        .portfolio-add-form-container { max-width: 800px; margin: 40px auto; padding: 30px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .portfolio-add-form-container h3 { text-align: center; margin-bottom: 30px; font-size: 1.8em; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-control { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .form-actions { text-align: right; margin-top: 30px; }
        .btn-submit { background-color: #4CAF50; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
        .btn-submit:hover { background-color: #45a049; }
        .category-search-wrapper { position: relative; }
        .search-results-dropdown { display: none; position: absolute; width: 100%; border: 1px solid #ddd; background-color: #fff; z-index: 1000; max-height: 200px; overflow-y: auto; }
        .search-results-dropdown .result-item { padding: 10px; cursor: pointer; }
        .search-results-dropdown .result-item:hover { background-color: #f0f0f0; }
        .selected-items-area {display:flex; flex-wrap: wrap; padding:5px; border:1px solid #ced4da; border-radius: .25rem; }
        .selected-item-badge { display: flex; align-items: center; background-color: #0d6efd; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; }
        .selected-item-badge .remove-btn { margin-left: 8px; background: none; border: none; color: white; font-size: 1.2em; cursor: pointer; padding: 0; line-height: 1; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 5px; }
         .category-input-group { display: flex; align-items: center; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 8px; overflow: visible; position: relative; }
        .category-input-group:last-of-type { margin-bottom: 0; }
        .category-input-group .category-name-input { border: none; flex-grow: 1; padding: 12px 15px; box-shadow: none; border-radius: 0; }
        .category-input-group .category-name-input:focus { outline: none; box-shadow: none; }
        .category-input-group .category-controls { display: flex; align-items: center; background-color: #f8f8f8; border-left: 1px solid #eee; padding: 0 5px; }
        .category-input-group .category-controls button { background: none; border: none; padding: 10px; cursor: pointer; font-size: 1em; color: #555; transition: color 0.2s ease; line-height: 1; }
        .category-input-group .category-controls button:hover { color: #3BB77E; }
        .category-input-group .category-controls .add-row-btn { background-color: #f0f0f0; color: #007bff; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; justify-content: center; align-items: center; margin-right: 5px; padding: 0; }
        .category-input-group .category-controls .add-row-btn:hover { background-color: #e0e0e0; color: #0056b3; }
        .category-input-group .category-controls .remove-category-btn { color: #dc3545; }
        .category-input-group .category-controls .remove-category-btn:hover { color: #c82333; }
        .add-category-btn-wrapper { display: none; } /* 이 섹션 전체를 숨김 */
        .category-search-dropdown-item { position: absolute; width: 100%; box-sizing: border-box; top: 100%; left: 0; border: 1px solid #ddd; background-color: #fff; z-index: 1001; max-height: 150px; overflow-y: auto; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px; padding: 5px 0; }
        .category-search-dropdown-item .result-item { padding: 10px; cursor: pointer; }
        .category-search-dropdown-item .result-item:hover { background-color: #f0f0f0; }
    </style>
</head>
<body>
<th:block layout:fragment="contents">
    <div class="portfolio-add-form-container">
        <h3>포트폴리오 수정</h3>
        <form id="portfolioEditForm" th:object="${portfolio}" enctype="multipart/form-data">
            
            <input type="hidden" th:field="*{prtfCd}" />
            <input type="hidden" th:field="*{entCd}" />
            <input type="hidden" th:field="*{mbrCd}" />
            <div class="form-group">
			   
			</div>
            
            <div class="form-group">
                <label for="prtfTtl">제목</label>
                <input type="text" id="prtfTtl" th:field="*{prtfTtl}" required class="form-control">
                <div id="prtfTtlError" class="error-message"></div>
            </div>
            
            <div class="form-group">
                <label>카테고리 <span style="color:red;">*</span></label>
                <div id="category-inputs-container">
                	<th:block th:if="${portfolio.categories != null and !portfolio.categories.empty}">
                		<script th:inline="javascript">
                			/*<![CDATA[*/
                			// $(document).ready() 제거 버전 (글로벌 함수 호출)
                			var categories = /*[[${portfolio.categories}]]*/ [];
                			categories.forEach(function(cat){
                			});
                			/*]]>*/
                		</script>
                	</th:block>
                </div>
                <div class="error-message" id="categoryCodesError"></div>
            </div>

			<div class="form-group">
			    <label for="tags">태그 (쉼표로 구분)</label>
			    <div class="tag-search-wrapper" style="position: relative;"> 
			    <input type="text" id="tags" name="tags" class="form-control" th:value="${#strings.listJoin(portfolio.tagNames, ', ')}">
			        <div id="tag-search-results" class="search-results-dropdown"></div> </div>
			</div>

            <div class="form-group">
                <label for="prtfCn">상세 내용</label>
                <textarea id="prtfCn" th:field="*{prtfCn}" rows="8" class="form-control"></textarea>
                 <div id="prtfCnError" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="portfolioFiles">대표 이미지 변경</label>
                <input type="file" id="portfolioFiles" name="portfolioFiles" multiple>
                <div style="margin-top: 10px;">
                    <p>현재 이미지:</p>
                    <img th:if="*{prtfThumbnailUrl}" th:src="*{prtfThumbnailUrl}" width="150" alt="Current Thumbnail"/>
                    <span th:if="*{prtfThumbnailUrl == null}">없음</span>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-submit">수정 완료</button>
            </div>
        </form>
    </div>
</th:block>




<th:block layout:fragment="jsFile">
    <script th:src="@{/enter/assets/js/vendor/jquery-3.6.0.min.js}"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script>
    // --- 카테고리 함수 (글로벌 스코프) ---
    function getCategoryInputTemplate(name = '', id = '') {
        return `
            <div class="category-input-group">
                <input type="text" class="form-control category-name-input" placeholder="카테고리 이름 입력"  value="${name}" >
                <div class="category-controls">
                    <button type="button" class="add-row-btn"><i class="fas fa-plus"></i></button>
                    <button type="button" class="remove-category-btn"><i class="fas fa-times"></i></button>
                </div>
                <div class="category-search-dropdown-item"></div>
            </div>
        `;
    }
    function addCategoryInput(name = '', id = '') {
        const container = $('#category-inputs-container');
        if (container.length === 0) {
            console.error("Error: #category-inputs-container not found when trying to add category input.");
            return;
        }
        container.append(getCategoryInputTemplate(name, id));
    }
        $(document).ready(function() {
            // --- 전역 변수 및 초기화 ---
            const prtfCd = $('input[name="prtfCd"]').val(); // 현재 포트폴리오의 고유 코드

            // 검색용 타임아웃 변수들
            let categorySearchTimeout;
            let tagSearchTimeout;
            let outsourcingSearchTimeout;


            // --- 1. 메인 폼(포트폴리오 수정) 제출 로직 ---
            $('#portfolioEditForm').on('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);

                // 해결책 2: 카테고리 코드를 쉼표로 구분된 문자열로 만들어 전송
                const categoryIds = [];
                $('#hidden-category-inputs input[name="categoryCodes"]').each(function() {
                    categoryIds.push($(this).val());
                });
                formData.set('categoryCodes', categoryIds.join(',')); // 기존 'categoryCodes'를 덮어쓰거나 새로 추가

                $.ajax({
                    url: '/enter/portfolio/edit-ajax',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        if (res.success) {
                            alert(res.message);
                            window.location.href = res.redirectUrl;
                        } else {
                            // 상세 오류 처리 로직 (필요시 구현)
                            alert('수정 실패: ' + (res.message || '알 수 없는 오류'));
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : '서버 통신에 실패했습니다.';
                        alert('오류가 발생했습니다: ' + errorMsg);
                    }
                });
            });


            $(document).ready(function() {
                let categorySearchTimeout;
                let tagSearchTimeout;
                
                // --- 오류 메시지 초기화 함수 ---
                function clearErrors() { 
                    $('.error-message').text('');
                }

                // 초기 로드 시 최소 하나의 카테고리 입력 필드 보장
                if ($('#category-inputs-container .category-input-group').length === 0) {
                    addCategoryInput();
                }

                // '카테고리 추가' 버튼 클릭 이벤트 (각 항목 내 '+' 버튼)
                $(document).on('click', '.add-row-btn', function() {
                    const currentItem = $(this).closest('.category-input-group');
                    currentItem.after(getCategoryInputTemplate()); 
                    currentItem.next('.category-input-group').find('.category-name-input').focus(); 
                });

                // '카테고리 삭제' 버튼 클릭 이벤트
                $(document).on('click', '.remove-category-btn', function() {
                    const itemToRemove = $(this).closest('.category-input-group');
                    if ($('#category-inputs-container .category-input-group').length > 1) { 
                        itemToRemove.remove();
                    } else {
                        alert('최소 하나의 카테고리는 남겨야 합니다.');
                        itemToRemove.find('.category-name-input').val(''); 
                        itemToRemove.find('.category-id-input').val(''); 
                    }
                });

                // --- 카테고리 검색/자동 완성 로직 (동적 생성 필드에 적용) ---
                $(document).on('input', '.category-name-input', function() {
                    const currentInput = $(this);
                    const hiddenIdInput = currentInput.siblings('.category-id-input');
                    const dropdown = currentInput.closest('.category-input-group').find('.category-search-dropdown-item');
                    const query = currentInput.val();
                    
                    clearTimeout(categorySearchTimeout);
                    hiddenIdInput.val(''); 

                    if (query.length < 1) {
                        dropdown.hide().empty();
                        dropdown.css('display','none');
                        return;
                    }

                    categorySearchTimeout = setTimeout(() => {
                        $.get('/enter/outsourcing/api/categories/search', { query: query }, function(data) { // 동일한 API 사용
                            dropdown.empty();
                            if (data && data.length > 0) {
                                data.forEach(cat => {
                                    dropdown.append(`<div class="result-item" data-id="${cat.ctgryId}">${cat.ctgryNm}</div>`);
                                });
                                dropdown.show();
                                dropdown.css('display','block');
                            } else {
                                dropdown.hide();
                                dropdown.css('display','none');
                            }
                        });
                    }, 300);
                });

                // 검색 결과 클릭 시 해당 입력 필드 채우기
                $(document).on('click', '.category-search-dropdown-item .result-item', function() {
                    const selectedItem = $(this);
                    const ctgryId = selectedItem.data('id');
                    const ctgryNm = selectedItem.text();
                    
                    const categoryInputGroup = selectedItem.closest('.category-input-group');
                    categoryInputGroup.find('.category-name-input').val(ctgryNm);
                    categoryInputGroup.find('.category-id-input').val(ctgryId); 
                    
                    selectedItem.parent().hide().empty(); 
                    selectedItem.parent().css('display','none');
                });

        });
        });
    </script>
</th:block>