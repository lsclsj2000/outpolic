<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{enter/layout/enterLayoutkjw}">
<head>
    <title>포트폴리오 수정</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body { font-family: "Inter", sans-serif; }
        .main-container { max-width: 960px; margin: 0 auto; padding: 30px 20px; }
        .section-title { font-size: 2.25rem; font-weight: 700; color: #1f2937; margin-bottom: 2.5rem; text-align: center;
            border-left: 5px solid #264796; padding-left: 1rem; display: inline-block; } /* 포트폴리오 섹션 타이틀 색상 변경 */
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2.5rem; border: 1px solid #e5e7eb; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 10px; color: #253D4E;
            font-size: 1.05rem; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; color: #4b5563; }
        textarea.form-control { height: auto; min-height: 150px; }
        .form-actions { text-align: right; margin-top: 30px; }
        .btn-submit { background-color: #28a745; color: white; padding: 12px 25px; border: none;
            border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; }
        .btn-submit:hover { background-color: #218838; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 5px; }
        
        /* Select2 높이 및 정렬 조정 */
        .select2-container { width: 100% !important; }
        .select2-container .select2-selection--single { height: calc(2.25rem + 14px); border-radius: 8px;
            border: 1px solid #d1d5db; display: flex; align-items: center; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: normal;
            padding-left: 15px; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: calc(2.25rem + 12px); }

        /* 카테고리 동적 입력 필드 그룹 */
        .category-row-group {
            display: flex; gap: 10px; margin-bottom: 10px; align-items: center;
        }
        .category-row-group .category-select { flex-grow: 1; min-width: 150px; }
        .category-controls button {
            background-color: #6c757d; color: white; border: none; border-radius: 5px;
            padding: 8px 12px; cursor: pointer; font-size: 0.9em; line-height: 1;
            transition: background-color 0.2s;
        }
        .category-controls button:hover { background-color: #5a6268; }
        .category-controls button.remove-category-btn { background-color: #dc3545; }
        .category-controls button.remove-category-btn:hover { background-color: #c82333; }
        .tag-search-wrapper { position: relative; }
        .search-results-dropdown { display: none; position: absolute; width: 100%; border: 1px solid #ddd;
            background-color: #fff; z-index: 1000; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .search-results-dropdown .result-item, .search-results-dropdown .result-item-tag { padding: 8px 12px; cursor: pointer; }
        .search-results-dropdown .result-item:hover, .search-results-dropdown .result-item-tag:hover { background-color: #f0f0f0; }

        /* 이미지 미리보기 스타일 */
        #image-preview {
            margin-top:15px; width: 150px; height: 150px; border: 1px solid #ddd; background-color: #f8f8f8;
            display: flex; align-items: center; justify-content: center; color: #aaa; overflow: hidden;
            position: relative; /* 삭제 버튼 위치를 위해 */
        }
        #image-preview img {
            width: 100%; height: 100%; object-fit: cover;
        }
        #image-preview span { /* 이미지 없음 텍스트 */
            text-align: center;
        }
        .remove-image-btn {
            position: absolute; top: 5px; right: 5px;
            background: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%;
            width: 25px; height: 25px; cursor: pointer; font-size: 0.8em; line-height: 25px; text-align: center;
        }
        .remove-image-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body>
<th:block layout:fragment="contents">
    <div class="main-container">
        <h1 class="section-title">포트폴리오 수정</h1>
        <div class="card">
            <form id="portfolioEditForm" th:object="${portfolio}">

                <input type="hidden" th:field="*{prtfCd}" />
                <input type="hidden" th:field="*{entCd}" />
                <input type="hidden" th:field="*{mbrCd}" />

                <div class="form-group">
                    <label for="prtfTtl">제목 <span style="color:red;">*</span></label>
                    <input type="text" id="prtfTtl" name="prtfTtl" th:value="*{prtfTtl}" required class="form-control">
                </div>

                <div class="form-group">
                    <label for="prtfCn">상세 내용 <span style="color:red;">*</span></label>
                    <textarea id="prtfCn" name="prtfCn" th:text="*{prtfCn}" rows="8" class="form-control" required></textarea>
                </div>

                <div class="form-group">
                    <label>카테고리 <span style="color:red;">*</span></label>
                    <div id="category-inputs-container">
                        </div>
                    <button type="button" id="add-category-row-btn" class="btn btn-secondary mt-2">
                        <i class="fas fa-plus"></i> 카테고리 추가
                    </button>
                    <div class="error-message" id="categoryError"></div>
                </div>

                <div class="form-group">
                    <label for="tags">태그 (쉼표로 구분)</label>
                    <div class="tag-search-wrapper">
                        <input type="text" id="tags" name="tags" class="form-control" th:value="${#strings.listJoin(portfolio.tagNames, ', ')}">
                        <div id="tag-search-results" class="search-results-dropdown"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="portfolioImage">대표 이미지 변경</label>
                    <input type="file" id="portfolioImage" name="portfolioImage" class="form-control" accept="image/*">
                    <div id="image-preview">
                        </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-submit">수정 완료</button>
                </div>
            </form>
        </div>
    </div>
</th:block>

<th:block layout:fragment="jsFile">
    <script th:src="@{/enter/assets/js/vendor/jquery-3.6.0.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script th:inline="javascript">
        $(document).ready(function() {
            // Thymeleaf 모델에서 초기 데이터 가져오기
            // portfolio.categories는 이제 List<CategorySearchDto> (단일 경로) 형태를 가짐
            const initialCategoryPath = /*[[${portfolio.categories}]]*/ []; 
            let initialThumbnailUrl = /*[[${portfolio.prtfThumbnailUrl}]]*/ null; // let으로 변경하여 나중에 null로 변경할 수 있도록 함

            let categorySearchTimeout;
            let tagSearchTimeout;

            // --- 이미지 미리보기 및 삭제 관련 함수 (스코프 문제 해결 위해 상단으로 이동) ---
            function updateImagePreview(url = null) {
                const previewContainer = $('#image-preview');
                previewContainer.empty(); // 기존 내용 비우기

                if (url) {
                    previewContainer.html(`
                        <img src="${url}" alt="Thumbnail">
                        <button type="button" class="remove-image-btn"><i class="fas fa-times"></i></button>
                    `);
                } else {
                    previewContainer.html('<span>이미지 없음</span>');
                }
            }
            
            // 페이지 로드 시 초기 이미지 미리보기 설정
            updateImagePreview(initialThumbnailUrl);

            // --- 카테고리 드롭다운을 동적으로 생성하고 채우는 함수 ---
            function createCategoryRowHtml(uniqueId) {
                let html = `
                    <div class="category-row-group" data-row-id="${uniqueId}">
                        <select class="form-control category-select" data-level="1" data-row-id="${uniqueId}"><option value="">1차 선택</option></select>
                        <select class="form-control category-select" data-level="2" data-row-id="${uniqueId}" style="display:none;"><option value="">2차 선택</option></select>
                        <select class="form-control category-select" data-level="3" data-row-id="${uniqueId}" style="display:none;"><option value="">3차 선택</option></select>
                        <input type="hidden" class="final-category-id" name="categoryCodes" value="">
                        <div class="category-controls">
                            <button type="button" class="add-row-btn"><i class="fas fa-plus"></i></button>
                            <button type="button" class="remove-category-btn"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                `;
                return html;
            }

            function populateDropdown($select, categories, selectedValue = '') {
                const level = $select.data('level');
                if ($select.hasClass("select2-hidden-accessible")) { $select.select2('destroy'); } // 기존 select2 인스턴스 파괴
                $select.html(`<option value="">${level}차 선택</option>`); // 기본 옵션 추가
                if (categories && categories.length > 0) {
                    categories.forEach(cat => {
                        const isSelected = (cat.ctgryId === selectedValue) ? 'selected' : '';
                        $select.append(`<option value="${cat.ctgryId}" ${isSelected}>${cat.ctgryNm}</option>`);
                    });
                }
                $select.show().select2({ placeholder: `${level}차 분류 검색...`, width: 'style', allowClear: true }); // allowClear 옵션 추가
            }

            function addCategoryRow(path = []) { // path는 단일 카테고리 경로 (List<CategorySearchDto>)
                const uniqueId = new Date().getTime();
                $('#category-inputs-container').append(createCategoryRowHtml(uniqueId));
                const $rowGroup = $(`div[data-row-id="${uniqueId}"]`);

                // 1차 카테고리 로드
                $.get('/api/categories', { parentId: '' }, function(categories) { // parentId를 빈 문자열로 보내서 1차 카테고리 요청
                    populateDropdown($rowGroup.find('select[data-level="1"]'), categories, path[0] ? path[0].ctgryId : '');

                    // 기존 경로에 따라 하위 드롭다운 채우기
                    if (path.length > 1) {
                        // 첫 번째 드롭다운은 이미 채웠으므로, 두 번째부터 시작
                        for (let i = 0; i < path.length - 1; i++) {
                            const parentId = path[i].ctgryId;
                            const childId = path[i+1].ctgryId;
                            const currentLevel = i + 1;
                            const nextLevel = i + 2;
                            const $nextSelect = $rowGroup.find(`select[data-level="${nextLevel}"]`);

                            $.get('/api/categories', { parentId: parentId }, function(subCategories) {
                                populateDropdown($nextSelect, subCategories, childId);
                            });
                        }
                    }
                    // 최종 선택된 카테고리 ID를 hidden input에 설정 (초기 로드 시)
                    if (path.length > 0) {
                        $rowGroup.find('.final-category-id').val(path[path.length - 1].ctgryId);
                    }
                });
            }
            
            // 페이지 로드 시 기존 카테고리 정보 표시
            // initialCategoryPath는 이제 List<CategorySearchDto> (단일 경로) 형태임.
            // 포트폴리오는 단 하나의 대표 카테고리만 가질 것이므로, 첫 번째 줄에만 이 경로를 채움.
            if (initialCategoryPath && initialCategoryPath.length > 0) {
                addCategoryRow(initialCategoryPath); 
            } else {
                addCategoryRow(); // 초기에는 빈 카테고리 줄 하나 추가
            }

            // --- 이벤트 핸들러들 ---

            // 카테고리 행 추가 버튼
            $(document).on('click', '#add-category-row-btn', function() { addCategoryRow(); });

            // 카테고리 행 삭제 버튼
            $(document).on('click', '.remove-category-btn', function() {
                if ($('#category-inputs-container .category-row-group').length > 1) {
                    $(this).closest('.category-row-group').remove();
                } else {
                    alert('최소 하나의 카테고리는 남겨야 합니다.');
                }
            });

            // 카테고리 드롭다운 변경 이벤트 (동적으로 하위 드롭다운 로드)
            $(document).on('change', '.category-select', function() {
                const $this = $(this);
                const selectedValue = $this.val();
                const level = $this.data('level');
                const rowId = $this.data('row-id');
                const $rowGroup = $(`div[data-row-id="${rowId}"]`);
                const $hiddenInput = $rowGroup.find('.final-category-id');

                // 현재 선택된 드롭다운의 하위 드롭다운 초기화 및 숨기기
                for (let i = level + 1; i <= 3; i++) {
                    const $nextSelect = $rowGroup.find(`select[data-level="${i}"]`);
                    if ($nextSelect.data('select2')) { $nextSelect.select2('destroy'); }
                    $nextSelect.html(`<option value="">${i}차 선택</option>`).hide(); // option value 추가
                }

                // 최종 카테고리 ID 설정: 현재 선택된 값 또는 상위 레벨의 값
                if (selectedValue) {
                    $hiddenInput.val(selectedValue);
                    // 하위 카테고리 로드
                    if (level < 3) {
                        $.get('/api/categories', { parentId: selectedValue }, function(subCategories) {
                            populateDropdown($rowGroup.find(`select[data-level="${level + 1}"]`), subCategories);
                        });
                    }
                } else {
                    // 선택 해제 시, 해당 레벨의 값으로 설정 (상위가 있다면 상위 값으로)
                    const prevLevelValue = (level > 1) ? $rowGroup.find(`select[data-level="${level - 1}"]`).val() : '';
                    $hiddenInput.val(prevLevelValue);
                }
            });


            // 태그 검색 (input 이벤트 위임)
            $('#tags').on('input', function() {
                clearTimeout(tagSearchTimeout);
                const parts = $(this).val().split(',');
                const query = parts[parts.length - 1].trim(); // 마지막 태그만 검색어
                const $tagResultsDiv = $('#tag-search-results');

                if (query.length < 1) {
                    $tagResultsDiv.hide().empty();
                    return;
                }

                tagSearchTimeout = setTimeout(() => {
                    $.get('/enter/portfolio/api/tags/search', { query: query }, function(data) {
                        $tagResultsDiv.empty().show();
                        if (data && data.length > 0) {
                            data.forEach(tag => $tagResultsDiv.append(`<div class="result-item-tag" data-tag="${tag}">${tag}</div>`));
                        } else {
                            $tagResultsDiv.append('<div class="result-item-tag">검색 결과 없음</div>');
                        }
                    });
                }, 300);
            });

            // 태그 검색 결과 선택 (click 이벤트 위임)
            $(document).on('click', '#tag-search-results .result-item-tag', function() {
                const selectedTag = $(this).data('tag');
                const $tagsInput = $('#tags');
                let parts = $tagsInput.val().split(',');
                parts[parts.length - 1] = ' ' + selectedTag; // 마지막 부분 대체
                $tagsInput.val(parts.join(', ') + ', '); // 쉼표와 공백 추가
                $('#tag-search-results').hide().empty();
                $tagsInput.focus();
            });

            // 파일 입력 변경 시 미리보기 업데이트
            $('#portfolioImage').on('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        updateImagePreview(e.target.result); // Base64 URL로 미리보기
                    };
                    reader.readAsDataURL(file);
                } else {
                    // 파일 선택 취소 시, initialThumbnailUrl (원래 DB에 있던 경로)로 복원
                    updateImagePreview(initialThumbnailUrl); 
                }
            });

            // 이미지 삭제 버튼 클릭 시
            $(document).on('click', '#image-preview .remove-image-btn', function() {
                if (confirm('현재 대표 이미지를 삭제하시겠습니까? (수정 완료 시 반영됩니다)')) {
                    $('#portfolioImage').val(''); // 파일 input 초기화
                    initialThumbnailUrl = null; // **핵심**: 이 변수를 null로 만들어 서버에 이미지 삭제를 알리는 플래그로 사용
                    updateImagePreview(null); // 미리보기 비우기
                    alert('대표 이미지가 삭제 대기 중입니다. 수정 완료 시 반영됩니다.');
                }
            });

            // 폼 제출 로직
            $('#portfolioEditForm').on('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this); // 폼 데이터 자동 수집

                // 카테고리 유효성 검사 (최소 1개 선택)
                const categoryCodes = $('input.final-category-id').map((_, el) => $(el).val()).get().filter(c => c);
                if (categoryCodes.length === 0) {
                    $('#categoryError').text('카테고리는 최소 하나 이상 선택해야 합니다.');
                    return;
                } else {
                    $('#categoryError').empty(); // 에러 메시지 초기화
                }
                
                // --- 이미지 전송 로직 보강 ---
                const imageInput = document.getElementById('portfolioImage');
                const newFileSelected = imageInput.files.length > 0;

                if (newFileSelected) {
                    formData.append('portfolioImage', imageInput.files[0]); // 새 파일 선택 시 파일 추가
                } else if (initialThumbnailUrl === null) { 
                    // 사용자가 기존 이미지를 삭제했고 새 이미지를 선택하지 않은 경우
                    // 서버에 "이미지 삭제"를 명시적으로 알리기 위해 빈 문자열을 보냄
                    formData.append('portfolioImage', new Blob([]), ''); // 빈 Blob으로 빈 파일 전송
                } 
                // else if (!newFileSelected && initialThumbnailUrl !== null) {
                //    // 파일 선택 없는데 initialThumbnailUrl이 null이 아니면 기존 이미지 유지
                //    // 이 경우는 폼데이터에 portfolioImage를 추가하지 않음으로써 서버에서 기존 이미지 유지
                // }
                // --- 이미지 전송 로직 보강 끝 ---


                $.ajax({
                    url: '/enter/portfolio/edit-ajax',
                    type: 'POST',
                    data: formData,
                    processData: false, // FormData를 사용할 때는 필수
                    contentType: false, // FormData를 사용할 때는 필수
                    success: function(res) {
                        if (res.success) {
                            alert(res.message);
                            window.location.href = res.redirectUrl;
                        } else {
                            alert('수정 실패: ' + (res.message || '알 수 없는 오류'));
                        }
                    },
                    error: function(xhr) {
                        alert('오류가 발생했습니다: ' + (xhr.responseJSON ? xhr.responseJSON.message : '서버 통신 실패'));
                        console.error("AJAX Error:", xhr.status, xhr.responseText);
                    }
                });
            });
        });
    </script>
</th:block>
</body>
</html>