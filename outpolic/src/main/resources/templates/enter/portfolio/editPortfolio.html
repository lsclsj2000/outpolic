<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{enter/layout/enterLayoutkjw}">
<head>
    <meta charset="UTF-8">
    <title>포트폴리오 수정</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body { font-family: "Inter", sans-serif; }
        .main-container { max-width: 960px; margin: 0 auto; padding: 30px 20px; }
        .section-title { font-size: 2.25rem; font-weight: 700; color: #1f2937; margin-bottom: 2.5rem; text-align: center;
            border-left: 5px solid #264796; padding-left: 1rem; display: inline-block; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2.5rem; border: 1px solid #e5e7eb; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 10px; color: #253D4E;
            font-size: 1.05rem; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; color: #4b5563; }
        textarea.form-control { height: auto; min-height: 150px; }
        .form-actions { text-align: right; margin-top: 30px; }
        .btn-submit { background-color: #28a745; color: white; padding: 12px 25px; border: none;
            border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; }
        .btn-submit:hover { background-color: #218838; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 5px; }
        
        .select2-container { width: 100% !important; }
        .select2-container .select2-selection--single { height: calc(2.25rem + 14px); border-radius: 8px;
            border: 1px solid #d1d5db; display: flex; align-items: center; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: normal;
            padding-left: 15px; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: calc(2.25rem + 12px); }

        .category-row-group {
            display: flex; gap: 10px; margin-bottom: 10px; align-items: center;
        }
        .category-row-group .category-select { flex-grow: 1; min-width: 150px; }
        .tag-search-wrapper { position: relative; }
        .search-results-dropdown { display: none; position: absolute; width: 100%; border: 1px solid #ddd;
            background-color: #fff; z-index: 1000; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .search-results-dropdown .result-item, .search-results-dropdown .result-item-tag { padding: 8px 12px; cursor: pointer; }
        .search-results-dropdown .result-item:hover, .search-results-dropdown .result-item-tag:hover { background-color: #f0f0f0; }

        #image-preview {
            margin-top:15px; width: 150px; height: 150px; border: 1px solid #ddd; background-color: #f8f8f8;
            display: flex; align-items: center; justify-content: center; color: #aaa; overflow: hidden;
            position: relative; 
        }
        #image-preview img {
            width: 100%; height: 100%; object-fit: cover;
        }
        #image-preview span {
            text-align: center;
        }
        .remove-image-btn {
            position: absolute; top: 5px; right: 5px;
            background: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%;
            width: 25px; height: 25px; cursor: pointer; font-size: 0.8em; line-height: 25px; text-align: center;
        }
        .remove-image-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>

<body>
<th:block layout:fragment="contents">
    <div class="main-container">
        <h1 class="section-title">포트폴리오 수정</h1>
        <div class="card">
            <form id="portfolioEditForm" th:object="${portfolio}">
                <input type="hidden" th:field="*{prtfCd}" />
                <input type="hidden" th:field="*{entCd}" />
                <input type="hidden" th:field="*{mbrCd}" />

                <div class="form-group">
                    <label for="prtfTtl">제목 <span style="color:red;">*</span></label>
                    <input type="text" id="prtfTtl" name="prtfTtl" th:value="*{prtfTtl}" required class="form-control">
                </div>

                <div class="form-group">
                    <label for="prtfCn">상세 내용 <span style="color:red;">*</span></label>
                    <textarea id="prtfCn" name="prtfCn" th:text="*{prtfCn}" rows="8" class="form-control" required></textarea>
                </div>

                <div class="form-group">
                    <label>카테고리 <span style="color:red;">*</span></label>
                    <div id="category-inputs-container">
                        <div class="category-row-group">
                            <select class="form-control category-select" data-level="1"><option value="">1차 선택</option></select>
                            <select class="form-control category-select" data-level="2" style="display:none;"><option value="">2차 선택</option></select>
                            <select class="form-control category-select" data-level="3" style="display:none;"><option value="">3차 선택</option></select>
                            <input type="hidden" class="final-category-id" name="categoryCodes" value="">
                        </div>
                    </div>
                    <div class="error-message" id="categoryError"></div>
                </div>

                <div class="form-group">
                    <label for="tags">태그 (쉼표로 구분)</label>
                    <div class="tag-search-wrapper">
                        <input type="text" id="tags" name="tags" class="form-control" th:value="${#strings.listJoin(portfolio.tagNames, ', ')}">
                        <div id="tag-search-results" class="search-results-dropdown"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="portfolioImage">대표 이미지 변경</label>
                    <input type="file" id="portfolioImage" name="portfolioImage" class="form-control" accept="image/*">
                    <div id="image-preview"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-submit">수정 완료</button>
                </div>
            </form>
        </div>
    </div>
</th:block>

<th:block layout:fragment="jsFile">
    <script th:src="@{/enter/assets/js/vendor/jquery-3.6.0.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script th:inline="javascript">
        $(document).ready(function() {
            // =================================================================
            // 1. 초기 데이터 설정
            // =================================================================
            const categoryJson = /*[[${categoryPathJson}]]*/ '[]';
            const initialCategoryPath = JSON.parse(categoryJson);
            let initialThumbnailUrl = /*[[${portfolio.prtfThumbnailUrl}]]*/ null;
            
            // =================================================================
            // 2. 함수 정의
            // =================================================================

            /**
             * 이미지 미리보기를 업데이트하는 함수
             * @param {string|null} url - 표시할 이미지의 URL
             */
            function updateImagePreview(url = null) {
                const previewContainer = $('#image-preview');
                previewContainer.empty();

                if (url) {
                    const displayUrl = url.startsWith('/attachment/') ? url : '/attachment' + url.replace(/^\/+/, '');
                    previewContainer.html(`
                        <img src="${displayUrl}" alt="Thumbnail">
                        <button type="button" class="remove-image-btn"><i class="fas fa-times"></i></button>
                    `);
                } else {
                    previewContainer.html('<span>이미지 없음</span>');
                }
            }

            /**
             * 특정 레벨의 드롭다운을 API에서 받아온 데이터로 채우는 함수
             * @param {number} level - 채울 드롭다운의 레벨 (1, 2, 3)
             * @param {string} parentId - 부모 카테고리 ID (1차는 '')
             * @param {string|null} selectedId - 미리 선택할 카테고리 ID
             * @returns {Promise} - AJAX 요청의 Promise 객체
             */
            function populateDropdown(level, parentId, selectedId = null) {
                const $select = $(`.category-select[data-level='${level}']`);
                if ($select.hasClass("select2-hidden-accessible")) {
                    $select.select2('destroy');
                }
                $select.html('').hide();

                return $.get('/api/categories', { parentId: parentId }, function(categories) {
                    if (categories && categories.length > 0) {
                        $select.html(`<option value="">${level}차 선택</option>`);
                        categories.forEach(cat => {
                            const isSelected = (cat.ctgryId === selectedId) ? 'selected' : '';
                            $select.append(`<option value="${cat.ctgryId}" ${isSelected}>${cat.ctgryNm}</option>`);
                        });
                        $select.show().select2({ placeholder: `${level}차 분류 선택...`, width: 'style', allowClear: true });
                        if (selectedId) {
                            $select.val(selectedId).trigger('change.select2');
                        }
                    }
                });
            }

            /**
             * 카테고리 드롭다운 변경 시 하위 드롭다운을 로드하는 함수
             */
            function handleCategoryChange() {
                const $this = $(this);
                const level = $this.data('level');
                const selectedValue = $this.val();

                // 하위 레벨 드롭다운 초기화
                for (let i = level + 1; i <= 3; i++) {
                    const $nextSelect = $(`.category-select[data-level='${i}']`);
                    if ($nextSelect.hasClass("select2-hidden-accessible")) {
                        $nextSelect.select2('destroy');
                    }
                    $nextSelect.html('').hide();
                }

                // 최종 선택된 ID 업데이트
                let finalId = selectedValue;
                if (!finalId && level > 1) {
                    finalId = $(`.category-select[data-level='${level - 1}']`).val();
                }
                $('.final-category-id').val(finalId);

                // 하위 카테고리 로드
                if (selectedValue && level < 3) {
                    populateDropdown(level + 1, selectedValue);
                }
            }

            /**
             * 페이지 로드 시, 기존에 저장된 카테고리 경로를 따라 드롭다운을 설정하는 함수
             */
            async function initializeCategorySelectors() {
                if (!initialCategoryPath || initialCategoryPath.length === 0) {
                    await populateDropdown(1, '');
                    return;
                }

                // 1차 카테고리부터 순차적으로 로드 및 선택
                await populateDropdown(1, '', initialCategoryPath[0]?.ctgryId);

                for (let i = 0; i < initialCategoryPath.length - 1; i++) {
                    const parentId = initialCategoryPath[i].ctgryId;
                    const childId = initialCategoryPath[i + 1]?.ctgryId;
                    await populateDropdown(i + 2, parentId, childId);
                }
                
                // 최종 카테고리 ID 설정
                $('.final-category-id').val(initialCategoryPath[initialCategoryPath.length - 1].ctgryId);
            }

            // =================================================================
            // 3. 이벤트 리스너 바인딩
            // =================================================================

            // 카테고리 드롭다운 변경
            $('#category-inputs-container').on('change', '.category-select', handleCategoryChange);

            // 이미지 미리보기 및 삭제
            $('#portfolioImage').on('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => updateImagePreview(e.target.result);
                    reader.readAsDataURL(file);
                } else {
                    updateImagePreview(initialThumbnailUrl); 
                }
            });
            $(document).on('click', '#image-preview .remove-image-btn', function() {
                if (confirm('현재 대표 이미지를 삭제하시겠습니까? (수정 완료 시 반영됩니다)')) {
                    $('#portfolioImage').val('');
                    initialThumbnailUrl = null;
                    updateImagePreview(null);
                }
            });
            
            // 폼 제출
            $('#portfolioEditForm').on('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);

                if (!$('.final-category-id').val()) {
                    $('#categoryError').text('카테고리는 최소 하나 이상 선택해야 합니다.');
                    return;
                }
                $('#categoryError').empty();

                const imageInput = document.getElementById('portfolioImage');
                if (imageInput.files.length > 0) {
                    formData.append('portfolioImage', imageInput.files[0]);
                } else if (initialThumbnailUrl === null) { 
                    formData.append('portfolioImage', new Blob([]), '');
                } 

                $.ajax({
                    url: '/enter/portfolio/edit-ajax',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        if (res.success) {
                            alert(res.message);
                            window.location.href = res.redirectUrl;
                        } else {
                            alert('수정 실패: ' + (res.message || '알 수 없는 오류'));
                        }
                    },
                    error: function(xhr) {
                        alert('오류가 발생했습니다: ' + (xhr.responseJSON ? xhr.responseJSON.message : '서버 통신 실패'));
                    }
                });
            });

            // =================================================================
            // 4. 초기화 실행
            // =================================================================
            updateImagePreview(initialThumbnailUrl);
            initializeCategorySelectors();

        });
    </script>
</th:block>
</body>
</html>