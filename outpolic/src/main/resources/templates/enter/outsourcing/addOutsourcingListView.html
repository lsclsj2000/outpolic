<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{enter/layout/enterLayoutkjw}">
<head>
    <title>새 외주 등록</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: "Inter", sans-serif; }
        .main-container { max-width: 960px; margin: 0 auto; padding: 30px 20px; }
        .section-title { font-size: 2.25rem; font-weight: 700; color: #1f2937; margin-bottom: 2.5rem; text-align: center; border-left: 5px solid #3BB77E; padding-left: 1rem; display: inline-block; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); padding: 2.5rem; border: 1px solid #e5e7eb; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 10px; color: #253D4E; font-size: 1.05rem; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; color: #4b5563; }
        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .flex-row > .form-group { flex: 1; min-width: 250px; }
        .input-with-unit { display: flex; align-items: center; width : 100%; }
        .input-with-unit input { flex-grow: 1; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .input-with-unit span { background-color: #f3f4f6; border: 1px solid #d1d5db; border-left: none; padding: 12px 15px; }
        .image-preview-container { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 0.75rem; }
        .image-preview-item { position: relative; width: 96px; height: 96px; border-radius: 0.5rem; border: 1px solid #e5e7eb; background-color: #f3f4f6; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 4px; overflow: hidden; }
        .image-preview-item i { font-size: 2rem; color: #6b7280; }
        .image-preview-item span { font-size: 0.75rem; color: #4b5563; word-break: break-all; }
        .category-input-group { display: flex; align-items: center; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 8px; overflow: visible; position: relative; }
        .category-input-group .category-name-input { border: none; flex-grow: 1; padding: 12px 15px; box-shadow: none; border-radius: 0; }
        .category-input-group .category-controls { display: flex; align-items: center; background-color: #f8f8f8; border-left: 1px solid #eee; padding: 0 5px; }
        .category-input-group .category-controls button { background: none; border: none; padding: 10px; cursor: pointer; font-size: 1em; color: #555; }
        .category-search-dropdown-item { position: absolute; width: 100%; box-sizing: border-box; top: 100%; left: 0; border: 1px solid #ddd; background-color: #fff; z-index: 1001; max-height: 150px; overflow-y: auto; display: none; }
        .search-results-dropdown .result-item, .search-results-dropdown .result-item-tag { padding: 10px; cursor: pointer; }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .form-navigation { margin-top: 30px; display: flex; justify-content: space-between; gap: 10px; }
        .form-navigation .btn-step { background-color: #007bff; color: white; padding: 12px 25px; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; flex-grow: 1; }
        .progress-indicator { display: flex; justify-content: center; margin-bottom: 30px; gap: 10px; }
        .progress-step { width: 40px; height: 40px; border-radius: 50%; background-color: #e0e0e0; color: #888; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .progress-step.active { background-color: #3BB77E; color: white; }
    </style>
</head>
<body>
<th:block layout:fragment="contents">
    <div class="main-container">
        <h1 class="section-title">새 외주 등록</h1>
        <div class="card">
            <form id="outsourcingRegistrationForm">
                <input type="hidden" name="entCd" th:value="${entCd}">
                <input type="hidden" name="mbrCd" th:value="${mbrCd}">
                <input type="hidden" id="currentOsCd" value="">
                
                <div class="progress-indicator">
                    <div class="progress-step active" data-step="1">1</div>
                    <div class="progress-step" data-step="2">2</div>
                    <div class="progress-step" data-step="3">3</div>
                    <div class="progress-step" data-step="4">4</div>
                </div>

                <!-- Step 1: 기본 정보 -->
                <div class="form-step active" id="step1">
                    <!-- ★ 수정된 부분: outsourcing -> formData -->
                    <div class="form-group">
                        <label for="osTtl">외주 프로젝트 제목 <span style="color:red;">*</span></label>
                        <input type="text" id="osTtl" name="osTtl" class="form-control" required th:value="${formData.osTtl}">
                    </div>
                    <div class="form-group">
                        <label for="osExpln">외주 프로젝트 내용 <span style="color:red;">*</span></label>
                        <textarea id="osExpln" name="osExpln" class="form-control" rows="8" required th:text="${formData.osExpln}"></textarea>
                    </div>
                     <div class="flex-row">
                        <div class="form-group">
                            <label for="osStrtYmdt">희망 작업 시작일시 <span style="color:red;">*</span></label>
                            <input type="datetime-local" id="osStrtYmdt" name="osStrtYmdt" class="form-control" required th:value="${formData.osStrtYmdt != null ? #temporals.format(formData.osStrtYmdt, 'yyyy-MM-dd''T''HH:mm') : ''}">
                        </div>
                        <div class="form-group">
                            <label for="osEndYmdt">희망 작업 종료일시 <span style="color:red;">*</span></label>
                            <input type="datetime-local" id="osEndYmdt" name="osEndYmdt" class="form-control" required th:value="${formData.osEndYmdt != null ? #temporals.format(formData.osEndYmdt, 'yyyy-MM-dd''T''HH:mm') : ''}">
                        </div>
                    </div>
                    <div class="flex-row">
                        <div class="form-group">
                            <label for="osAmt">희망 금액 <span style="color:red;">*</span></label>
                            <div class="input-with-unit">
                                <input type="number" id="osAmt" name="osAmt" class="form-control" min="0" required th:value="${formData.osAmt}">
                                <span>원</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="osFlfmtCnt">수행 가능 인원 <span style="color:red;">*</span></label>
                            <div class="input-with-unit">
                                <input type="number" id="osFlfmtCnt" name="osFlfmtCnt" class="form-control" min="1" required th:value="${formData.osFlfmtCnt}">
                                <span>명</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-navigation">
                        <button type="button" class="btn-step next" data-step="1">다음</button>
                    </div>
                </div>

                <!-- Step 2: 카테고리/태그 -->
                <div class="form-step" id="step2">
                    <div class="form-group">
                        <label>카테고리 <span style="color:red;">*</span></label>
                        <div id="category-inputs-container"></div>
                    </div>
                    <div class="form-group">
                        <label for="tags">태그 (쉼표로 구분)</label>
                        <div class="tag-search-wrapper">
                             <!-- ★ 수정된 부분: outsourcing -> formData -->
                             <input type="text" id="tags" name="tags" class="form-control" th:value="${formData.tags}">
                             <div id="tag-search-results" class="search-results-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-navigation">
                        <button type="button" class="btn-step prev" data-step="2">이전</button>
                        <button type="button" class="btn-step next" data-step="2">다음</button>
                    </div>
                </div>

                <!-- Step 3: 파일 첨부 -->
                <div class="form-step" id="step3">
                    <div class="form-group">
                        <label for="outsourcingReferenceFiles">첨부 파일</label>
                        <input type="file" id="outsourcingReferenceFiles" name="outsourcingReferenceFiles" multiple class="form-control p-2">
                        <p class="form-instruction">참고 자료 등 필요한 파일을 첨부해주세요. (최대 5개)</p>
                        <div class="image-preview-container mt-3" id="outsourcingReferenceFiles-preview-container"></div>
                    </div>
                    <div class="form-navigation">
                        <button type="button" class="btn-step prev" data-step="3">이전</button>
                        <button type="button" class="btn-step next" data-step="3">다음</button>
                    </div>
                </div>

                <!-- Step 4: 최종 확인 및 포트폴리오 연결 -->
                <div class="form-step" id="step4">
                    <h3>최종 확인 및 포트폴리오 연결</h3>
                    <div class="linking-section" style="margin-top: 20px;">
                        <h4>현재 연결된 포트폴리오</h4>
                        <div id="linked-portfolio-list" style="border:1px solid #eee; min-height: 80px; padding: 8px; margin-bottom: 15px;"></div>
                        <h4>연결할 포트폴리오 검색</h4>
                        <input type="text" id="portfolio-search-input" class="form-control" placeholder="연결할 포트폴리오 제목을 검색하세요">
                        <div id="portfolio-search-results" class="search-results-list" style="border:1px solid #eee; min-height: 80px; padding: 8px;"></div>
                    </div>
                    <div class="form-navigation">
                        <button type="button" class="btn-step prev" data-step="4">이전</button>
                        <button type="button" class="btn-step submit" data-step="4">외주 등록 완료</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</th:block>

<th:block layout:fragment="jsFile">
    <!-- ★ 수정된 부분: outsourcing -> formData -->
    <div id="file-url-storage" style="display: none;">
        <span th:if="${formData.referenceFileUrls != null and !#lists.isEmpty(formData.referenceFileUrls)}"
              th:each="url : ${formData.referenceFileUrls}"
              th:data-url="${#strings.replace(url, '\', '')}"></span>
    </div>

    <script>
    $(document).ready(function() {
        const MAX_FILE_COUNT = 5;
        let currentStepNum = 1;
        let currentOsCd = '';
        let categorySearchTimeout, tagSearchTimeout, portfolioSearchTimeout;

        function setMinDateTime() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const kstDate = new Date(now.getTime() - offset);
            $('#osStrtYmdt').attr('min', kstDate.toISOString().slice(0, 16));
        }

        function showStep(stepNum) {
            $('.form-step').removeClass('active');
            $(`#step${stepNum}`).addClass('active');
            $('.progress-step').removeClass('active');
            for (let i = 1; i <= stepNum; i++) {
                $(`.progress-step[data-step="${i}"]`).addClass('active');
            }
            if (stepNum === 4 && currentOsCd) {
                loadLinkedPortfoliosForStep4();
            }
        }

        function getCategoryInputTemplate(name = '', id = '') {
            return `<div class="category-input-group"><input type="text" class="form-control category-name-input" placeholder="카테고리 이름 입력" value="${name}"><input type="hidden" class="category-id-input" value="${id}"><div class="category-controls"><button type="button" class="add-row-btn"><i class="fas fa-plus"></i></button><button type="button" class="remove-category-btn"><i class="fas fa-times"></i></button></div><div class="category-search-dropdown-item search-results-dropdown"></div></div>`;
        }

        function addCategoryInput(name = '', id = '') {
            $('#category-inputs-container').append(getCategoryInputTemplate(name, id));
        }

        function initializeFilePreview(fileInputId, previewContainerId) {
            const fileInput = document.getElementById(fileInputId);
            const previewContainer = document.getElementById(previewContainerId);
            if (!fileInput || !previewContainer) return;
            fileInput.addEventListener('change', function (event) {
                previewContainer.innerHTML = '';
                const newlySelectedFiles = event.target.files;
                const currentFilesDt = new DataTransfer();
                for (let i = 0; i < newlySelectedFiles.length; i++) {
                    if (currentFilesDt.items.length < MAX_FILE_COUNT) {
                        currentFilesDt.items.add(newlySelectedFiles[i]);
                    } else {
                        alert(`파일은 최대 ${MAX_FILE_COUNT}개까지 첨부할 수 있습니다.`);
                        break;
                    }
                }
                fileInput.files = currentFilesDt.files;
                Array.from(fileInput.files).forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'image-preview-item';
                    fileDiv.innerHTML = `<i class="fas fa-file"></i><span>${file.name}</span>`;
                    previewContainer.appendChild(fileDiv);
                });
            });
        }

        function loadLinkedPortfoliosForStep4() {
            const listDiv = $('#linked-portfolio-list').empty();
            if (!currentOsCd) {
                listDiv.append('<p style="color:red;">외주 정보 저장 후 포트폴리오를 연결할 수 있습니다.</p>');
                return;
            }
            $.get(`/enter/outsourcing/${currentOsCd}/linked-portfolios`, function(data) {
                if (data && data.length > 0) {
                    data.forEach(p => listDiv.append(`<div class="linked-item" data-prtf-cd="${p.prtfCd}"><span>${p.prtfTtl}</span><button type="button" class="btn-unlink">해제</button></div>`));
                } else {
                    listDiv.append('<p style="color:#888;">연결된 포트폴리오가 없습니다.</p>');
                }
            }).fail(() => listDiv.append('<p style="color:red;">연결된 포트폴리오 로딩 실패.</p>'));
        }

        setMinDateTime();
        showStep(currentStepNum);
        initializeFilePreview('outsourcingReferenceFiles', 'outsourcingReferenceFiles-preview-container');
        if ($('#category-inputs-container .category-input-group').length === 0) {
            addCategoryInput();
        }

        (function loadInitialFiles() {
            var fileUrls = [];
            $('#file-url-storage span').each(function() { fileUrls.push($(this).data('url')); });
            var previewContainer = $('#outsourcingReferenceFiles-preview-container');
            fileUrls.forEach(function(url) {
                var fileName = url.substring(url.lastIndexOf('/') + 1);
                previewContainer.append(`<div class="image-preview-item"><i class="fas fa-file"></i><span>${fileName}</span></div>`);
            });
        })();

        $(document).on('click', '.add-row-btn', () => addCategoryInput());
        $(document).on('click', '.remove-category-btn', function() {
            if ($('#category-inputs-container .category-input-group').length > 1) $(this).closest('.category-input-group').remove();
            else alert('최소 하나의 카테고리는 남겨야 합니다.');
        });
        $(document).on('input', '.category-name-input', function() {
            const currentInput = $(this), dropdown = currentInput.closest('.category-input-group').find('.category-search-dropdown-item'), query = currentInput.val();
            clearTimeout(categorySearchTimeout);
            currentInput.siblings('.category-id-input').val('');
            if (query.length < 1) { dropdown.hide().empty(); return; }
            categorySearchTimeout = setTimeout(() => {
                $.get('/enter/outsourcing/api/categories/search', { query: query }, function(data) {
                    dropdown.empty().show();
                    if (data && data.length > 0) data.forEach(cat => dropdown.append(`<div class="result-item" data-id="${cat.ctgryId}">${cat.ctgryNm}</div>`));
                });
            }, 300);
        });
        $(document).on('click', '.category-search-dropdown-item .result-item', function() {
            const selectedItem = $(this), categoryInputGroup = selectedItem.closest('.category-input-group');
            categoryInputGroup.find('.category-name-input').val(selectedItem.text());
            categoryInputGroup.find('.category-id-input').val(selectedItem.data('id'));
            selectedItem.parent().hide().empty();
        });

        $('#tags').on('input', function() {
            const query = $(this).val().split(',').pop().trim();
            clearTimeout(tagSearchTimeout);
            if (query.length < 1) { $('#tag-search-results').hide().empty(); return; }
            tagSearchTimeout = setTimeout(() => {
                $.get('/enter/outsourcing/api/tags/search', { query: query }, function(data) {
                    const resultsDiv = $('#tag-search-results').empty().show();
                    if (data && data.length > 0) data.forEach(tag => resultsDiv.append(`<div class="result-item-tag" data-tag="${tag}">${tag}</div>`));
                });
            }, 300);
        });
        $(document).on('click', '.result-item-tag', function() {
            const selectedTag = $(this).data('tag'), tagInput = $('#tags'), parts = tagInput.val().split(',');
            parts[parts.length - 1] = ' ' + selectedTag;
            tagInput.val(parts.join(',') + ', ').focus();
            $('#tag-search-results').hide().empty();
        });

        $('#portfolio-search-input').on('input', function() {
            const query = $(this).val(), entCd = $('input[name="entCd"]').val(), resultsDiv = $('#portfolio-search-results').empty();
            clearTimeout(portfolioSearchTimeout);
            if (query.length < 1) { resultsDiv.hide(); return; }
            if (!currentOsCd) { resultsDiv.html('<p style="color:red;">외주 저장 후 검색 가능</p>').show(); return; }
            portfolioSearchTimeout = setTimeout(() => {
                $.get(`/enter/outsourcing/${currentOsCd}/unlinked-portfolios`, { query, entCd }, function(data) {
                    resultsDiv.show();
                    if (data && data.length > 0) data.forEach(p => resultsDiv.append(`<div class="search-result-item" data-prtf-cd="${p.prtfCd}"><span>${p.prtfTtl}</span><button type="button" class="btn-link">+ 연결</button></div>`));
                    else resultsDiv.append('<p style="color:#888;">검색 결과 없음</p>');
                });
            }, 300);
        });
        $(document).on('click', '#portfolio-search-results .btn-link', function() {
            const prtfCd = $(this).closest('.search-result-item').data('prtf-cd');
            $.ajax({ url: '/enter/outsourcing/link-portfolio', type: 'POST', contentType: 'application/json', data: JSON.stringify({ osCd: currentOsCd, prtfCd }),
                success: () => { alert('포트폴리오 연결됨'); loadLinkedPortfoliosForStep4(); $('#portfolio-search-input').val('').trigger('input'); },
                error: () => alert('연결 실패')
            });
        });
        $(document).on('click', '#linked-portfolio-list .btn-unlink', function() {
            if (!confirm('연결을 해제하시겠습니까?')) return;
            const prtfCd = $(this).closest('.linked-item').data('prtf-cd');
            $.ajax({ url: '/enter/outsourcing/unlink-portfolio', type: 'DELETE', contentType: 'application/json', data: JSON.stringify({ osCd: currentOsCd, prtfCd }),
                success: () => { alert('연결 해제됨'); loadLinkedPortfoliosForStep4(); },
                error: () => alert('해제 실패')
            });
        });

        $('.btn-step.next').on('click', function() {
            const stepId = $(this).data('step');
            if (stepId === 1) saveStep1AndProceed();
            else if (stepId === 2) saveStep2AndProceed();
            else if (stepId === 3) saveStep3AndProceed();
        });
        $('.btn-step.prev').on('click', function() { currentStepNum--; showStep(currentStepNum); });
        $('.btn-step.submit').on('click', () => completeRegistration());

        function saveStep1AndProceed() {
            const formData = new FormData(document.getElementById('outsourcingRegistrationForm'));
            $.ajax({ url: '/enter/outsourcing/save-step1', type: 'POST', data: formData, processData: false, contentType: false,
                success: res => {
                    if (res.success && res.osCd) {
                        currentOsCd = res.osCd; $('#currentOsCd').val(res.osCd);
                        currentStepNum = 2; showStep(currentStepNum);
                    } else { alert('1단계 저장 실패: ' + (res.message || '오류')); }
                }, error: () => alert('1단계 저장 중 서버 오류')
            });
        }

        function saveStep2AndProceed() {
            const formData = new FormData();
            formData.append('osCd', currentOsCd);
            const categoryIds = [];
            $('#category-inputs-container .category-id-input').each(function() { if ($(this).val()) categoryIds.push($(this).val()); });
            formData.append('categoryCodes', categoryIds.join(','));
            formData.append('tags', $('#tags').val());
            $.ajax({ url: '/enter/outsourcing/save-step2', type: 'POST', data: formData, processData: false, contentType: false,
                success: res => {
                    if (res.success) { currentStepNum = 3; showStep(currentStepNum); }
                    else { alert('2단계 저장 실패: ' + (res.message || '오류')); }
                }, error: () => alert('2단계 저장 중 서버 오류')
            });
        }

        function saveStep3AndProceed() {
            const formData = new FormData();
            formData.append('osCd', currentOsCd);
            const files = document.getElementById('outsourcingReferenceFiles').files;
            for (let i = 0; i < files.length; i++) formData.append('outsourcingReferenceFiles', files[i]);
            
            $.ajax({ url: '/enter/outsourcing/save-step3', type: 'POST', data: formData, processData: false, contentType: false,
                success: res => {
                    if (res.success) { currentStepNum = 4; showStep(currentStepNum); }
                    else { alert('3단계 파일 업로드 실패: ' + (res.message || '오류')); }
                }, error: xhr => { console.error("AJAX Error:", xhr); alert('3단계 파일 업로드 중 서버 오류'); }
            });
        }

        function completeRegistration() {
            if (!currentOsCd) { alert("저장된 외주 정보가 없습니다."); return; }
            $.ajax({ url: '/enter/outsourcing/complete-registration', type: 'POST', contentType: 'application/json', data: JSON.stringify({ osCd: currentOsCd }),
                success: res => {
                    if (res.success) { alert(res.message); window.location.href = res.redirectUrl; }
                    else { alert('최종 등록 실패: ' + (res.message || '오류')); }
                }, error: () => alert('최종 등록 중 서버 오류')
            });
        }
    });
    </script>
</th:block>
</body>
</html>