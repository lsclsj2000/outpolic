<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{enter/layout/enterLayoutkjw}">
<head>
    <title>새 외주 등록</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body { font-family: "Inter", sans-serif; }
        .main-container { max-width: 960px; margin: 0 auto; padding: 30px 20px; }
        .section-title { font-size: 2.25rem; font-weight: 700; color: #1f2937; margin-bottom: 2.5rem; text-align: center; border-left: 5px solid #264796; padding-left: 1rem; display: inline-block; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); padding: 2.5rem; border: 1px solid #e5e7eb; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 10px; color: #253D4E; font-size: 1.05rem; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; color: #4b5563; }
        textarea.form-control { height: auto; min-height: 150px; /* 적절한 기본 높이 설정 */ }
        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .flex-row > .form-group { flex: 1; min-width: 250px; }
        .input-with-unit { display: flex; align-items: center; width : 100%; }
        .input-with-unit input { flex-grow: 1; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .input-with-unit span { background-color: #f3f4f6; border: 1px solid #d1d5db; border-left: none; padding: 12px 15px; }
        /* 파일 미리보기 컨테이너와 아이템 스타일 */
        .file-preview-container { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 0.75rem; }
        .file-preview-item { position: relative; width: 96px; height: 96px; border-radius: 0.5rem; border: 1px solid #e5e7eb; background-color: #f3f4f6; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 4px; overflow: hidden; }
        .file-preview-item img { width:100%;height:100%;object-fit:cover; }
        .file-preview-item span { font-size:12px; padding: 5px; word-break: break-all; } /* 파일명 길 때 줄바꿈 */
        .remove-file-btn, .remove-existing-file-btn { position:absolute;top:0;right:0;background:rgba(0,0,0,0.5);color:white;border:none;cursor:pointer;width:20px;height:20px;font-size:12px;line-height:20px;text-align:center;border-radius:50%; }
        
        .search-results-dropdown { display: none; position: absolute; width: 100%; border: 1px solid #ddd; background-color: #fff; z-index: 1000; max-height: 150px; overflow-y: auto; }
        .result-item-tag { padding: 8px 12px; cursor: pointer; }
        .result-item-tag:hover { background-color: #f0f0f0; }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .form-navigation { margin-top: 30px; display: flex; justify-content: space-between; gap: 10px; }
        .form-navigation .btn-step { background-color: #007bff; color: white; padding: 12px 25px; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; flex-grow: 1; }
        .form-navigation .btn-step.prev { background-color: #6c757d; }
        .form-navigation .btn-step.submit { background-color: #28a745; }
        .progress-indicator { display: flex; justify-content: center; margin-bottom: 30px; gap: 10px; }
        .progress-step { width: 40px; height: 40px; border-radius: 50%; background-color: #e0e0e0; color: #888; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .progress-step.active { background-color: #264796; color: white; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 5px; }
        /* Select2 높이 및 정렬 조정 */
        .select2-container { width: 100% !important; }
        .select2-container .select2-selection--single { height: calc(2.25rem + 14px); border-radius: 8px; border: 1px solid #d1d5db; display: flex; align-items: center; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: normal; padding-left: 15px; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: calc(2.25rem + 12px); }
    </style>
</head>
<body>
<th:block layout:fragment="contents">
    <div class="main-container">
        <h1 class="section-title">새 외주 등록</h1>
        <div class="card">
            <form id="outsourcingRegistrationForm">
                <input type="hidden" name="entCd" th:value="${entCd}">
                <input type="hidden" name="mbrCd" th:value="${mbrCd}">
                <input type="hidden" id="currentOsCd" value="">
                
                <div class="progress-indicator">
                    <div class="progress-step active" data-step="1">1</div>
                    <div class="progress-step" data-step="2">2</div>
                    <div class="progress-step" data-step="3">3</div>
                    <div class="progress-step" data-step="4">4</div>
                </div>

                <div class="form-step active" id="step1">
                    <div class="form-group">
                        <label for="osTtl">외주 프로젝트 제목 <span style="color:red;">*</span></label>
                        <input type="text" id="osTtl" name="osTtl" class="form-control" required >
                    </div>
                    <div class="form-group">
                        <label for="osExpln">외주 프로젝트 내용 <span style="color:red;">*</span></label>
                        <textarea id="osExpln" name="osExpln" class="form-control" rows="8" required ></textarea>
                    </div>
                     <div class="flex-row">
                        <div class="form-group">
                            <label for="osStrtYmdt">희망 작업 시작일시 <span style="color:red;">*</span></label>
                            <input type="datetime-local" id="osStrtYmdt" name="osStrtYmdt" class="form-control" required >
                        </div>
                        <div class="form-group">
                            <label for="osEndYmdt">희망 작업 종료일시 <span style="color:red;">*</span></label>
                            <input type="datetime-local" id="osEndYmdt" name="osEndYmdt" class="form-control" required >
                        </div>
                    </div>
                    <div class="flex-row">
                        <div class="form-group">
                            <label for="osAmt">희망 금액 <span style="color:red;">*</span></label>
                            <div class="input-with-unit">
                                <input type="number" id="osAmt" name="osAmt" class="form-control" min="0" required >
                                <span>원</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="osFlfmtCnt">수행 가능 인원 <span style="color:red;">*</span></label>
                            <div class="input-with-unit">
                                <input type="number" id="osFlfmtCnt" name="osFlfmtCnt" class="form-control" min="1" required >
                                <span>명</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-navigation">
                        <button type="button" class="btn-step next" data-step="1">다음</button>
                    </div>
                </div>

                <div class="form-step" id="step2">
                    <div class="form-group">
                        <label>카테고리 <span style="color:red;">*</span></label>
                        <div id="category-rows-container"></div>
                        <button type="button" id="add-category-row-btn" class="btn btn-secondary mt-2" style="background-color: #6c757d; border-color: #6c757d;">+ 카테고리 추가</button>
                        <div class="error-message" id="categoryCodesError"></div>
                    </div>
                    <div class="form-group">
                        <label for="tags">태그 (쉼표로 구분)</label>
                        <div class="tag-search-wrapper" style="position: relative;">
                             <input type="text" id="tags" name="tags" class="form-control" >
                             <div id="tag-search-results" class="search-results-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-navigation">
                        <button type="button" class="btn-step prev" data-step="2">이전</button>
                        <button type="button" class="btn-step next" data-step="2">다음</button>
                    </div>
                </div>

                <div class="form-step" id="step3">
                    <div class="form-group">
                        <label for="outsourcingThumbnailFile">대표 이미지 <span style="color:red;">*</span></label>
                        <input type="file" id="outsourcingThumbnailFile" name="outsourcingThumbnailFile" class="form-control" accept="image/*" required>
                        <p class="form-instruction">외주 목록에 표시될 대표 이미지를 첨부해주세요.</p>
                        <div class="file-preview-container mt-3" id="outsourcingThumbnailFile-preview-container">
                            <div class="file-preview-item"><span>이미지 없음</span></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="outsourcingReferenceFiles">참조 파일 (최대 5개)</label>
                        <input type="file" id="outsourcingReferenceFiles" name="outsourcingReferenceFiles" multiple class="form-control" accept="image/*, .pdf, .doc, .docx, .ppt, .pptx, .txt">
                        <p class="form-instruction">참고 자료 등 필요한 파일을 첨부해주세요.</p>
                        <div class="file-preview-container mt-3" id="outsourcingReferenceFiles-preview-container"></div>
                    </div>
                    <div class="form-navigation">
                        <button type="button" class="btn-step prev" data-step="3">이전</button>
                        <button type="button" class="btn-step next" data-step="3">다음</button>
                    </div>
                </div>

                <div class="form-step" id="step4">
                    <h3>최종 확인 및 포트폴리오 연결</h3>
                    <div class="linking-section" style="margin-top: 20px;">
                        <h4>연결할 포트폴리오 검색</h4>
                        <input type="text" id="portfolio-search-input" class="form-control" placeholder="연결할 포트폴리오 제목을 검색하세요">
                        <div id="portfolio-search-results" class="search-results-dropdown" style="max-height: 150px; overflow-y: auto;"></div>
                        <h4 style="margin-top: 20px;">현재 연결된 포트폴리오</h4>
                        <div id="linked-portfolio-list" style="border:1px solid #eee; min-height: 80px; padding: 8px;"></div>
                    </div>
                    <div class="form-navigation">
                        <button type="button" class="btn-step prev" data-step="4">이전</button>
                        <button type="button" class="btn-step submit" data-step="4" id="btn-edit-complete">외주 등록 완료</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</th:block>

<th:block layout:fragment="jsFile">
    <script th:src="@{/enter/assets/js/vendor/jquery-3.6.0.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script th:inline="javascript">
        $(document).ready(function() {
            // --- 1. 전역 변수 및 데이터 초기화 ---
            const MAX_FILES_STEP3_THUMBNAIL = 1; // 썸네일은 1개
            const MAX_FILES_STEP3_REFERENCE = 5; // 참조 파일은 5개
            let currentStepNum = 1;
            let osCd = /*[[${outsourcing.osCd}]]*/ ''; // let으로 변경하여 saveStep1에서 업데이트 가능하도록
            const entCd = /*[[${entCd}]]*/ ''; // Model에서 받아온 entCd 사용
            const initialCategories = []; 
            // add 페이지에서는 기존 파일이 없으므로, 빈 배열로 초기화합니다.
            // edit 페이지에서는 이 값이 서버에서 넘어옵니다.
            const existingThumbnailUrl = null; // add 페이지에는 초기 썸네일 없음
            const existingReferenceFileUrls = []; // add 페이지에는 초기 참조 파일 없음

            let tagSearchTimeout, portfolioSearchTimeout;

            // --- 2. UI 요소 jQuery 객체화 ---
            const $categoryRowsContainer = $('#category-rows-container');
            const $tagsInput = $('#tags');
            const $tagResultsDiv = $('#tag-search-results');
            const $portfolioSearchInput = $('#portfolio-search-input');
            const $portfolioResultsDiv = $('#portfolio-search-results');
            const $linkedPortfolioList = $('#linked-portfolio-list');

            // --- 3. 헬퍼 함수 정의 ---

            function showStep(stepNum) {
                $('.form-step').removeClass('active');
                $(`#step${stepNum}`).addClass('active');
                $('.progress-step').removeClass('active').eq(stepNum - 1).addClass('active');
                if (stepNum === 4 && osCd) { loadLinkedPortfolios(); }
                if (stepNum === 3) {
                    // 썸네일 파일 미리보기 초기화 (add 페이지는 초기 썸네일 없음)
                    initializeFilePreview('outsourcingThumbnailFile', 'outsourcingThumbnailFile-preview-container', false, existingThumbnailUrl ? [existingThumbnailUrl] : []);
                    // 참조 파일 미리보기 초기화 (add 페이지는 초기 참조 파일 없음)
                    initializeFilePreview('outsourcingReferenceFiles', 'outsourcingReferenceFiles-preview-container', true, existingReferenceFileUrls);
                }
            }

            /**
             * 파일 입력 필드에 대한 미리보기 및 파일 관리 로직 (addPortfolio.html에서 가져옴)
             * @param {string} fileInputId - 파일 input 요소의 ID
             * @param {string} previewContainerId - 미리보기 이미지가 추가될 컨테이너의 ID
             * @param {boolean} isMultiple - 다중 파일 선택이 가능한지 여부
             * @param {string[] | string} initialFiles - 초기 미리보기로 표시할 파일 URL 배열 (또는 단일 URL 문자열)
             */
            function initializeFilePreview(fileInputId, previewContainerId, isMultiple, initialFiles) {
                const fileInput = document.getElementById(fileInputId);
                const previewContainer = document.getElementById(previewContainerId);
                if (!fileInput || !previewContainer) return;

                // 기존 미리보기 초기화
                previewContainer.innerHTML = '';
                
                // initialFiles가 단일 문자열이면 배열로 변환
                const filesToDisplay = Array.isArray(initialFiles) ? initialFiles : (initialFiles ? [initialFiles] : []);

                // 기존 파일 미리보기 추가
                filesToDisplay.forEach(url => {
                    const fileName = url.substring(url.lastIndexOf('/') + 1);
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-preview-item';
                    let innerHTML = '';
                    // URL이 `/attachment/`로 시작하는 절대 경로인지 확인
                    // Spring ResourceHandler가 `/attachment/**`를 처리하므로, 웹 경로로 적합
                    const cleanedUrl = url.startsWith('/attachment/') ? url : (url.startsWith('attachment/') ? '/' + url : url); 
                    
                    if (cleanedUrl && cleanedUrl.match(/\.(jpeg|jpg|gif|png|jfif)$/i)) {
                        innerHTML = `<img src="${cleanedUrl}" alt="Preview">`;
                    } else if (cleanedUrl) { // 이미지가 아닌 파일 (pdf, doc 등)
                        innerHTML = `<span>${fileName}</span>`;
                    } else { // URL이 비어있으면 "이미지 없음" 또는 "파일 없음" 표시
                        innerHTML = `<span>${isMultiple ? '파일 없음' : '이미지 없음'}</span>`;
                    }
                    // 기존 파일은 remove-existing-file-btn으로 관리 (이벤트는 아래에서 처리)
                    fileDiv.innerHTML = innerHTML + `<button type="button" class="remove-existing-file-btn" data-file-url="${url}">X</button>`;
                    previewContainer.appendChild(fileDiv);
                });

                // 초기 미리보기가 없었고, 단일 파일 입력 필드인 경우 기본 "이미지 없음" 플레이스홀더 추가
                if (!isMultiple && filesToDisplay.length === 0) {
                    previewContainer.innerHTML = `<div class="file-preview-item"><span>이미지 없음</span></div>`;
                }
                
                fileInput.addEventListener('change', function(event) {
                    // 새 파일 선택 시 기존 미리보기(썸네일 필드일 경우) 또는 전체 미리보기(참조 파일 필드일 경우)를 초기화
                    if (!isMultiple) { // 단일 파일 (썸네일)
                        previewContainer.innerHTML = '';
                    } else { // 다중 파일 (참조 파일)
                        // 기존의 '새로 추가된' 파일 미리보기만 지우고, '기존 파일' 미리보기는 남겨둬야 할 수 있음
                        // 이 로직은 `editOutsourcing.html`에서 더 복잡해지므로, 현재는 단순화
                        // 여기서는 일단 모두 지우는 방식으로 진행 (새로 선택한 파일이 이전 파일들을 대체하는 경우)
                        previewContainer.innerHTML = '';
                        // 하지만 `editOutsourcing.html`에서는 기존 파일 목록을 서버에서 받아와 유지해야 합니다.
                        // `add` 페이지에서는 `existingReferenceFileUrls`가 비어있으니, 그냥 비워도 됩니다.
                        filesToDisplay.forEach(url => { // 기존 파일 다시 추가 (선택된 파일은 나중에 추가)
                             const fileName = url.substring(url.lastIndexOf('/') + 1);
                             const fileDiv = document.createElement('div');
                             fileDiv.className = 'file-preview-item';
                             const cleanedUrl = url.startsWith('/attachment/') ? url : (url.startsWith('attachment/') ? '/' + url : url);
                             let innerHTML = '';
                             if (cleanedUrl && cleanedUrl.match(/\.(jpeg|jpg|gif|png|jfif)$/i)) {
                                 innerHTML = `<img src="${cleanedUrl}" alt="Preview">`;
                             } else if (cleanedUrl) {
                                 innerHTML = `<span>${fileName}</span>`;
                             }
                             fileDiv.innerHTML = innerHTML + `<button type="button" class="remove-existing-file-btn" data-file-url="${url}">X</button>`;
                             previewContainer.appendChild(fileDiv);
                        });
                    }

                    const files = event.target.files;
                    const dataTransfer = new DataTransfer(); 
                    let currentFileCount = filesToDisplay.length; // 기존 파일 개수 포함

                    for (let i = 0; i < files.length; i++) {
                        if ((isMultiple && (currentFileCount + dataTransfer.items.length) >= MAX_FILES_STEP3_REFERENCE) ||
                            (!isMultiple && dataTransfer.items.length >= MAX_FILES_STEP3_THUMBNAIL)) {
                            alert(`파일은 최대 ${isMultiple ? MAX_FILES_STEP3_REFERENCE : MAX_FILES_STEP3_THUMBNAIL}개까지 첨부할 수 있습니다.`);
                            break;
                        }
                        dataTransfer.items.add(files[i]);
                    }
                    fileInput.files = dataTransfer.files; // 필터링된/제한된 파일 목록으로 업데이트

                    Array.from(fileInput.files).forEach(file => {
                        const fileDiv = document.createElement('div');
                        fileDiv.className = 'file-preview-item';
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                fileDiv.innerHTML = `<img src="${e.target.result}" alt="Preview">
                                                    <button type="button" class="remove-file-btn" data-file-input-id="${fileInputId}" data-file-name="${file.name}">X</button>`;
                            };
                            reader.readAsDataURL(file);
                        } else {
                            fileDiv.innerHTML = `<span>${file.name}</span>
                                                <button type="button" class="remove-file-btn" data-file-input-id="${fileInputId}" data-file-name="${file.name}">X</button>`;
                        }
                        previewContainer.appendChild(fileDiv);
                    });
                     // 미리보기가 비어있고 단일 파일인 경우 "이미지 없음" 플레이스홀더 추가
                     if (!isMultiple && fileInput.files.length === 0 && filesToDisplay.length === 0) {
                         previewContainer.innerHTML = `<div class="file-preview-item"><span>이미지 없음</span></div>`;
                     }
                });

                // 동적으로 추가된 파일 삭제 버튼 이벤트
                $(document).off('click', `#${previewContainerId} .remove-file-btn`).on('click', `#${previewContainerId} .remove-file-btn`, function() {
                    const fileNameToRemove = $(this).data('file-name');
                    const targetFileInputId = $(this).data('file-input-id');
                    const targetFileInput = document.getElementById(targetFileInputId);

                    const currentFiles = Array.from(targetFileInput.files);
                    const dataTransfer = new DataTransfer();
                    currentFiles.forEach(file => {
                        if (file.name !== fileNameToRemove) {
                            dataTransfer.items.add(file);
                        }
                    });
                    targetFileInput.files = dataTransfer.files; // 파일 목록 업데이트
                    $(this).closest('.file-preview-item').remove(); // UI에서 제거

                    // 단일 파일 입력 필드이고, 파일이 모두 제거되었으면 "이미지 없음" 플레이스홀더 추가
                    if (!isMultiple && targetFileInput.files.length === 0 && previewContainer.children.length === 0) {
                         previewContainer.innerHTML = `<div class="file-preview-item"><span>이미지 없음</span></div>`;
                    }
                });

                // 기존 파일 삭제 버튼 (서버에 삭제 요청 - add 페이지에서는 서버 삭제 로직 없음)
                // 이 이벤트는 `editOutsourcing.html`에서 더 의미 있음.
                $(document).off('click', `#${previewContainerId} .remove-existing-file-btn`).on('click', `#${previewContainerId} .remove-existing-file-btn`, function() {
                    if (!confirm('이 파일을 미리보기에서 제거하시겠습니까? (실제 서버 파일 삭제는 최종 저장 시 반영될 수 있습니다.)')) return;
                    $(this).closest('.file-preview-item').remove(); // UI에서만 제거
                    alert('파일이 미리보기에서 제거되었습니다. 최종 등록/수정 시 반영됩니다.');
                });
            }


            function createCategoryRowHtml(isExisting, name, id) {
                if (isExisting) {
                    return `
                        <div class="category-row-existing" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <input type="text" class="form-control" value="${name}" readonly style="background-color: #f8f9fa;">
                            <input type="hidden" class="final-category-id" name="categoryCodes" value="${id}">
                            <button type="button" class="btn btn-danger remove-category-row-btn" style="background-color:#dc3545; border-color:#dc3545; color:white; padding: 8px 12px; line-height: 1;">삭제</button>
                        </div>`;
                } else {
                    const uniqueId = new Date().getTime();
                    return `
                        <div class="category-row-new" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <select class="form-control category-select" data-level="1" data-row-id="${uniqueId}" style="width: 30%;"><option value="">1차 선택</option></select>
                            <select class="form-control category-select" data-level="2" data-row-id="${uniqueId}" style="width: 30%; display:none;"><option value="">2차 선택</option></select>
                            <select class="form-control category-select" data-level="3" data-row-id="${uniqueId}" style="width: 30%; display:none;"><option value="">3차 선택</option></select>
                            <input type="hidden" class="final-category-id" name="categoryCodes" value="">
                            <button type="button" class="btn btn-danger remove-category-row-btn" style="background-color:#dc3545; border-color:#dc3545; color:white; padding: 8px 12px; line-height: 1;">삭제</button>
                        </div>`;
                }
            }

            function populateDropdown($select, categories) {
                const level = $select.data('level');
                if ($select.hasClass("select2-hidden-accessible")) { $select.select2('destroy'); }
                $select.html(`<option value="">${level}차 선택</option>`);
                if (categories && categories.length > 0) {
                    categories.forEach(cat => { $select.append(`<option value="${cat.ctgryId}">${cat.ctgryNm}</option>`); });
                    $select.show().select2({ placeholder: `${level}차 분류 검색...`, width: 'style' });
                } else { $select.hide(); }
            }
            
            function addNewCategoryRow() {
                $categoryRowsContainer.append(createCategoryRowHtml(false, '', ''));
                const $newFirstDropdown = $categoryRowsContainer.find('.category-row-new:last .category-select');
                $.get('/api/categories', function(categories) {
                    populateDropdown($newFirstDropdown, categories);
                });
            }

            function renderInitialCategoryRows() {
                if (initialCategories && initialCategories.length > 0) {
                    const uniqueCategories = new Map();
                    initialCategories.forEach(cat => { if (cat && cat.ctgryId) uniqueCategories.set(cat.ctgryId, cat.ctgryNm); });
                    uniqueCategories.forEach((name, id) => { $categoryRowsContainer.append(createCategoryRowHtml(true, name, id)); });
                }
            }

            function loadLinkedPortfolios() {
                if (osCd) {
                    $linkedPortfolioList.empty();
                    $.get(`/enter/outsourcing/${osCd}/linked-portfolios`, function(data) {
                        if (data && data.length > 0) {
                            data.forEach(p => $linkedPortfolioList.append(`<div class="linked-item" data-prtf-cd="${p.prtfCd}"><span>${p.prtfTtl}</span><button type="button" class="btn-unlink">해제</button></div>`));
                        } else { $linkedPortfolioList.append('<p>연결된 포트폴리오가 없습니다.</p>'); }
                    }).fail(() => $linkedPortfolioList.append('<p style="color:red;">로딩 실패</p>'));
                } else {
                    $linkedPortfolioList.append('<p>먼저 외주 기본 정보를 저장해주세요.</p>');
                }
            }

            // --- 4. 단계별 저장 로직 ---
            function saveStep(step, successCallback) {
                let formData = new FormData();
                formData.append('osCd', osCd); // osCd는 saveStep1 이후에 값이 설정됨

                if (step === 1) {
                    const osTtl = $('#osTtl').val().trim();
                    const osExplnContent = $('#osExpln').val().trim(); // 일반 textarea에서 내용 가져오기
                    const osStrtYmdt = $('#osStrtYmdt').val();
                    const osEndYmdt = $('#osEndYmdt').val();
                    const osAmt = $('#osAmt').val();
                    const osFlfmtCnt = $('#osFlfmtCnt').val();

                    if (!osTtl) { alert('외주 프로젝트 제목을 입력해주세요.'); return; }
                    if (!osExplnContent) { alert('외주 프로젝트 내용을 입력해주세요.'); return; }
                    if (!osStrtYmdt) { alert('희망 작업 시작일시를 입력해주세요.'); return; }
                    if (!osEndYmdt) { alert('희망 작업 종료일시를 입력해주세요.'); return; }
                    if (!osAmt || parseFloat(osAmt) < 0) { alert('희망 금액을 0원 이상으로 입력해주세요.'); return; }
                    if (!osFlfmtCnt || parseInt(osFlfmtCnt) < 1) { alert('수행 가능 인원을 1명 이상으로 입력해주세요.'); return; }

                    formData.append('osTtl', osTtl);
                    formData.append('osExpln', osExplnContent); // 일반 textarea 내용 사용
                    formData.append('osStrtYmdt', osStrtYmdt);
                    formData.append('osEndYmdt', osEndYmdt);
                    formData.append('osAmt', osAmt);
                    formData.append('osFlfmtCnt', osFlfmtCnt);
                } else if (step === 2) {
                    if (!osCd) {
                        alert('먼저 외주 기본 정보를 저장해주세요.');
                        return;
                    }
                    let categoryIds = [];
                    $('.final-category-id').each(function() { if ($(this).val()) categoryIds.push($(this).val()); });
                    if (categoryIds.length === 0) { $('#categoryCodesError').text('최소 하나 이상의 카테고리를 선택해야 합니다.'); return; }
                    categoryIds.forEach(id => formData.append('categoryCodes', id));
                    formData.append('tags', $tagsInput.val());
                } else if (step === 3) {
                    if (!osCd) {
                        alert('먼저 외주 기본 정보를 저장해주세요.');
                        return;
                    }
                    const thumbnailFile = document.getElementById('outsourcingThumbnailFile').files[0];
                    const referenceFiles = document.getElementById('outsourcingReferenceFiles').files;

                    if (!thumbnailFile) { alert('대표 이미지를 등록해주세요.'); return; }

                    formData.append('thumbnailFile', thumbnailFile); // 썸네일 파일
                    for (let i = 0; i < referenceFiles.length; i++) { // 참조 파일들
                        formData.append('referenceFiles', referenceFiles[i]);
                    }
                }

                $.ajax({
                    url: `/enter/outsourcing/save-step${step}`,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: res => {
                        if (res.success) {
                            if (step === 1 && res.osCd) {
                                osCd = res.osCd;
                                $('#currentOsCd').val(osCd);
                            }
                            alert(res.message || `${step}단계 정보가 저장되었습니다.`);
                            if(successCallback) successCallback();
                        } else { alert(`저장 실패: ${res.message || '알 수 없는 오류'}`); }
                    },
                    error: (xhr, status, error) => {
                         console.error(`${step}단계 저장 중 서버 오류:`, status, error, xhr.responseText);
                         alert(`${step}단계 저장 중 오류가 발생했습니다.`);
                    }
                });
            }

            // --- CKEditor 초기화 로직 제거됨 ---

            // --- 5. 이벤트 핸들러 바인딩 ---
            $('.btn-step.next').on('click', function() {
                const stepId = $(this).data('step');
                saveStep(stepId, () => { currentStepNum++; showStep(currentStepNum); });
            });
            $('.btn-step.prev').on('click', function() { currentStepNum--; showStep(currentStepNum); });
            $('#btn-edit-complete').on('click', function() {
                if (!confirm('모든 등록을 완료하시겠습니까?')) return;
                if (!osCd) {
                    alert('외주 기본 정보가 아직 저장되지 않았습니다. 1단계부터 진행해주세요.');
                    return;
                }
                $.ajax({
                    url: '/enter/outsourcing/complete-registration',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ osCd: osCd }),
                    success: res => {
                        if (res.success) { alert(res.message); window.location.href = res.redirectUrl; }
                    },
                    error: () => alert('최종 등록 처리 중 오류 발생')
                });
            });

            $('#add-category-row-btn').on('click', addNewCategoryRow);
            $categoryRowsContainer.on('click', '.remove-category-row-btn', function() { $(this).closest('.category-row-existing, .category-row-new').remove(); });
            $categoryRowsContainer.on('change', '.category-select', function() {
                const $this = $(this);
                const selectedValue = $this.val();
                const level = $this.data('level');
                const rowId = $this.data('row-id');
                const $hiddenInput = $this.closest('.category-row-new').find('.final-category-id');

                for (let i = level + 1; i <= 3; i++) {
                    const $nextSelect = $(`select[data-row-id="${rowId}"][data-level="${i}"]`);
                    if ($nextSelect.data('select2')) { $nextSelect.select2('destroy'); }
                    $nextSelect.html('<option value=""></option>').hide();
                }
                $hiddenInput.val(selectedValue || (level > 1 ? $(`select[data-row-id="${rowId}"][data-level="${level - 1}"]`).val() : ''));

                if (selectedValue && level < 3) {
                    $.get('/api/categories', { parentId: selectedValue }, function(subCategories) {
                        populateDropdown($(`select[data-row-id="${rowId}"][data-level="${level + 1}"]`), subCategories);
                    });
                }
            });

            $tagsInput.on('input', function() {
                clearTimeout(tagSearchTimeout);
                const parts = $(this).val().split(',');
                const query = parts[parts.length - 1].trim();
                if (query.length < 1) { $tagResultsDiv.hide().empty(); return; }
                tagSearchTimeout = setTimeout(() => {
                    $.get('/enter/outsourcing/api/tags/search', { query: query }, function(data) {
                        $tagResultsDiv.empty().show();
                        if (data && data.length > 0) { data.forEach(tag => $tagResultsDiv.append(`<div class="result-item-tag" data-tag="${tag}">${tag}</div>`)); }
                    });
                }, 300);
            });
            $(document).on('click', '.result-item-tag', function() {
                const selectedTag = $(this).data('tag');
                const parts = $tagsInput.val().split(',');
                parts[parts.length - 1] = ' ' + selectedTag;
                $tagsInput.val(parts.join(',') + ', ');
                $tagResultsDiv.hide().empty();
                $tagsInput.focus();
            });
            
            $portfolioSearchInput.on('input', function() {
                clearTimeout(portfolioSearchTimeout);
                const query = $(this).val();
                if (query.length < 1) { $portfolioResultsDiv.hide().empty(); return; }
                portfolioSearchTimeout = setTimeout(() => {
                    if (osCd) {
                        $.get(`/enter/outsourcing/${osCd}/unlinked-portfolios`, { query, entCd }, function(data) {
                            $portfolioResultsDiv.empty().show();
                            if (data && data.length > 0) {
                                data.forEach(p => $portfolioResultsDiv.append(`<div class="result-item" data-prtf-cd="${p.prtfCd}"><span>${p.prtfTtl}</span><button type="button" class="btn-link">+ 연결</button></div>`));
                            } else { $portfolioResultsDiv.append('<p>검색 결과 없음</p>'); }
                        });
                    } else {
                        $portfolioResultsDiv.empty().show().append('<p>먼저 외주 기본 정보를 저장해주세요.</p>');
                    }
                }, 300);
            });
            $(document).on('click', '#portfolio-search-results .result-item .btn-link', function() {
                const prtfCd = $(this).closest('.result-item').data('prtf-cd');
                if (!osCd) { alert('외주 코드가 아직 없습니다. 1단계부터 진행해주세요.'); return; }
                $.ajax({
                    url: '/enter/outsourcing/link-portfolio', type: 'POST', contentType: 'application/json', data: JSON.stringify({ osCd, prtfCd }),
                    success: () => { loadLinkedPortfolios(); $portfolioSearchInput.val('').trigger('input'); },
                    error: () => alert('연결 실패')
                });
            });
            $(document).on('click', '#linked-portfolio-list .btn-unlink', function() {
                if (!confirm('연결을 해제하시겠습니까?')) return;
                const prtfCd = $(this).closest('.linked-item').data('prtf-cd');
                if (!osCd) { alert('외주 코드가 없습니다. 페이지를 새로고침 해주세요.'); return; }
                $.ajax({
                    url: '/enter/outsourcing/unlink-portfolio', type: 'DELETE', contentType: 'application/json', data: JSON.stringify({ osCd, prtfCd }),
                    success: () => loadLinkedPortfolios(),
                    error: () => alert('해제 실패')
                });
            });

            // 기존 파일 삭제 버튼은 initializeFilePreview 함수 내에서 .remove-existing-file-btn을 처리
            
            // --- 6. 페이지 초기화 실행 ---
            renderInitialCategoryRows();
            if ($categoryRowsContainer.children().length === 0) {
                addNewCategoryRow();
            }
            showStep(currentStepNum);
        });
    </script>
</th:block>
</body>
</html>