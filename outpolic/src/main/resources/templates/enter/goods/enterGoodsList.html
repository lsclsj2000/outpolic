<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{enter/layout/enterLayoutMain}">
<head>
<meta name="description" content="한국스마트정보교육원 팀프로젝트" />
<!-- 토스페이먼츠 API JS -->
<script src="https://js.tosspayments.com/v1"></script>

</head>
<body>
	<th:block layout:fragment="contents">
		<script th:inline="javascript">
	        // --- 1. 결제 요청 로직 (Toss Payments) ---
	        document.addEventListener("DOMContentLoaded", function () {
	            const tossPayments = TossPayments("test_ck_ORzdMaqN3wPvMzNqXLNqV5AkYXQG");
	            const paymentButton = document.getElementById("payment-button");
	            
	            paymentButton.addEventListener("click", function (e) {
	                e.preventDefault();
	                const memberCode = /*[[${session.SCD}]]*/ null;
	
	                if (!memberCode) {
	                    alert("로그인 후 이용해주세요.");
	                    window.location.href = '/login';
	                    return;
	                }
	                
	                let selectedProductRow;
	                let orderCount = 0;
	                // 현재 선택된(수량이 1 이상인) 상품을 찾습니다.
	                document.querySelectorAll('.product-row').forEach(row => {
	                    const quantity = parseInt(row.querySelector('.qty-val').value, 10);
	                    if (quantity > 0) {
	                        selectedProductRow = row;
	                        orderCount = quantity;
	                    }
	                });
	                
	                if (!selectedProductRow) {
	                    alert("상품 수량을 1개 이상 선택해주세요.");
	                    return;
	                }
	
	                // 선택된 상품의 정보를 동적으로 읽어옵니다.
	                const grdCd = selectedProductRow.querySelector('input[name="gdsCd"]').value;
	                const usedMileage = document.getElementById('usedMileage').value || 0;
	                const originAmount = parseInt(selectedProductRow.getAttribute('data-price')) * orderCount;
	                const finalPriceEl = document.querySelectorAll(".cart_total_amount h4.text-brand")[1];
	                const finalAmount = parseInt(finalPriceEl.textContent.replace(/[^\d]/g, "")) || 0;
	
	                tossPayments.requestPayment("카드", {
	                    amount: finalAmount,
	                    orderId: "ORDER_" + Date.now(),
	                    orderName: "기업용 상품",
	                    customerName: "기업고객", // 실제로는 세션에서 가져온 회원 이름 사용
	                    // [핵심] successUrl을 기업회원용으로 설정
	                    successUrl: `http://localhost/enter/paymentSuccess?usedMileage=${usedMileage}&grdCd=${grdCd}&orderCount=${orderCount}&originAmount=${originAmount}&mbrCd=${memberCode}`,
	                    failUrl: "http://localhost/enter/paymentFail"
	                });
	            });
	        });
	    </script>
	    <script>
			// --- 2. 화면 UI 및 금액 계산 로직 (일반회원 페이지와 동일한 동적 코드로 교체) ---
			document.addEventListener("DOMContentLoaded", function () {
			    const allProductRows = document.querySelectorAll(".product-row");
			    const totalPriceEl = document.querySelectorAll(".cart_total_amount h4.text-brand")[0];
			    const finalPriceEl = document.querySelectorAll(".cart_total_amount h4.text-brand")[1];
			    const mileageInput = document.getElementById('usedMileage');
			    const resetBtn = document.getElementById("reset-selection");
			
			    function getVal(input) {
			        if (!input) return 0;
			        const val = parseInt(input.value);
			        return isNaN(val) ? 0 : val;
			    }
			    
			    function formatCurrency(num) {
			        return "₩" + num.toLocaleString("ko-KR");
			    }
			    
			    function updateAllUI() {
			        let totalAmount = 0;
			        let selectedProductRow = null;
			
			        allProductRows.forEach(row => {
			            const quantityInput = row.querySelector('.qty-val');
			            const quantity = getVal(quantityInput);
			            
			            if (quantity > 0) {
			                selectedProductRow = row;
			            }
			            
			            const unitPrice = parseInt(row.getAttribute('data-price'), 10);
			            const unitValue = parseInt(row.getAttribute('data-unit-value'), 10);
			            const unitName = row.getAttribute('data-unit-name');
			            
			            const subtotal = quantity * unitPrice;
			            const displayUnitEl = row.querySelector(".days-display, .times-display");
			            const subtotalEl = row.querySelectorAll(".text-body")[1];
			
			            if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
			            if (displayUnitEl) displayUnitEl.innerHTML = (quantity > 0 ? (quantity * unitValue) : '0') + ` <span>${unitName}</span>`;
			
			            totalAmount += subtotal;
			        });
			
			        totalPriceEl.textContent = formatCurrency(totalAmount);
			        
			        const usedMileage = getVal(mileageInput);
			        const finalAmount = Math.max(0, totalAmount - usedMileage);
			        finalPriceEl.textContent = formatCurrency(finalAmount);
			
			        allProductRows.forEach(row => {
			            const quantityInput = row.querySelector('.qty-val');
			            if (selectedProductRow) {
			                if (row === selectedProductRow) {
			                    row.classList.remove('blur-block');
			                    quantityInput.disabled = false;
			                } else {
			                    row.classList.add('blur-block');
			                    quantityInput.disabled = true;
			                }
			            } else {
			                row.classList.remove('blur-block');
			                quantityInput.disabled = false;
			            }
			        });
			    }
			
			    document.querySelectorAll('.qty-val').forEach(input => {
			        input.addEventListener('input', updateAllUI);
			    });
			
			    document.querySelectorAll(".qty-up, .qty-down").forEach((btn) => {
			        btn.addEventListener("click", (e) => {
			            e.preventDefault();
			            const input = btn.closest(".detail-qty")?.querySelector(".qty-val");
			            if (!input) return;
			        
			            let current = getVal(input);
			            if (btn.classList.contains("qty-up")) {
			                current++;
			            } else {
			                current = Math.max(0, current - 1);
			            }
			            input.value = current;
			        
			            input.dispatchEvent(new Event("input"));
			        });
			    });
			
			    mileageInput?.addEventListener("input", updateAllUI);
			    
			    resetBtn?.addEventListener("click", (e) => {
			          e.preventDefault();
			          const ok = confirm("선택한 상품을 모두 초기화할까요?\n확인을 누르면 페이지가 새로고침됩니다.");
			          if (ok) {
			            location.reload();
			          }
			    });
			
			    updateAllUI();
			});
	    </script>
		<form id="paymentForm" method="get">
			<div class="d-flex justify-content-center col-lg-10 m-auto">
				<div class="row w-100">
					<div class="col-lg-7">
						<div class="table-responsive shopping-summery">
							<button id="reset-selection" class="btn btn-secondary mt-3 mb-4" type="button">선택 초기화</button>
							<table class="table table-wishlist">
								<thead>
									<tr style="border: 0px;" class="main-heading">
										<th class="custome-checkbox start pl-30" style="text-align: center;" scope="col">상품</th>
										<th style="text-align: center;">가격</th>
										<th scope="col" style="text-align: center;">개수</th>
										<th style="text-align: center;" scope="col" class="col-2">일 / 회</th>
										<th style="text-align: center;" scope="col" class="end col-2">합계</th>
									</tr>
								</thead>
								<tbody>
								    <tr th:each="product : ${productList}" class="product-row"
								        th:classappend="${product.gdsType == '구독권'} ? 'subs-product' : 'ticket-product'"
								        th:data-price="${product.gdsAmt}"
								        th:data-unit-value="${product.gdsPeriodQuantity}"
								        th:data-unit-name="${product.gdsUnit}">
								
								        <td class="product-des product-name">
								            <h6 class="mb-5" style="text-align: center;" th:text="${product.gdsNm}"></h6>
								            <input type="hidden" name="gdsCd" th:value="${product.gdsCd}">
								        </td>
								        <td class="price" data-title="Price">
								            <h5 class="text-body" style="text-align: center;" th:text="'₩' + ${#numbers.formatDecimal(product.gdsAmt, 0, 'COMMA', 0, 'POINT')}"></h5>
								        </td>
								        <td class="text-center detail-info" data-title="Stock">
								            <div class="detail-extralink mr-15">
								                <div class="detail-qty border radius">
								                    <a href="#" class="qty-down"><i class="fi-rs-angle-small-down"></i></a>
								                    <input type="text"
								                           th:id="${product.gdsType == '구독권'} ? 'subsQuantity' : 'ticketQuantity'"
								                           name="quantity" class="qty-val" value="0" min="1">
								                    <a href="#" class="qty-up"><i class="fi-rs-angle-small-up"></i></a>
								                </div>
								            </div>
								        </td>
								        <td class="price" data-title="Price">
								            <h5 style="text-align: center;"
								                th:classappend="${product.gdsType == '구독권'} ? 'days-display' : 'times-display'">
								                0 <span th:text="${product.gdsUnit}"></span>
								            </h5>
								        </td>
								        <td class="price" data-title="Price">
								            <h5 class="text-body" style="text-align: center;">₩0</h5>
								        </td>
								    </tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="col-lg-5">
						<div class="border p-md-4 cart-totals ml-30">
							<div class="table-responsive">
								<table class="table no-border">
									<tbody>
										<tr style="border: 0px;">
											<td class="cart_total_label"><h6 class="text-muted">결제상품 금액</h6></td>
											<td class="cart_total_amount"><h4 class="text-brand text-end">₩0</h4></td>
										</tr>
										<tr style="border: 0px;"><td scope="col" colspan="2"><div class="divider-2 mt-10 mb-10"></div></td></tr>
										<tr style="border: 0px;">
											<td class="cart_total_label"><h6 class="text-muted">보유 마일리지</h6></td>
											<td class="cart_total_amount"><h5 class="text-heading text-end" id="availableMileage" th:text="${#numbers.formatDecimal(availableMileage, 0, 'COMMA', 0, 'POINT')}"></h5></td>
										</tr>
										<tr style="border: 0px;">
											<td class="cart_total_label" colspan="2">
												<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
													<span><h6>사용</h6></span> 
													<input type="text" style="padding-bottom: 3px; width: 87%; height: 40px; border: none; outline: none; text-align: right;"
														   id="usedMileage" name="usedMileage" inputmode="numeric" placeholder="0"> 
													<span><h6>원</h6></span>
												</div>
											</td>
										</tr>
										<tr style="border: 0px;"><td scope="col" colspan="2"><div class="divider-2 mt-10 mb-10"></div></td></tr>
										<tr style="border: 0px;">
											<td class="cart_total_label"><h6 class="text-muted">최종 결제 금액</h6></td>
											<td class="cart_total_amount"><h4 class="text-brand text-end">₩0</h4></td>
										</tr>
									</tbody>
								</table>
							</div>
							<a href="#" id="payment-button" class="btn mb-20 w-100">결제하기</a>
						</div>
					</div>
				</div>
			</div>
		</form>


		<!-- enterGoodsList JS-->

		<script src="/enter/assets/js/vendor/modernizr-3.6.0.min.js"></script>
		<script src="/enter/assets/js/vendor/jquery-3.6.0.min.js"></script>
		<script src="/enter/assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
		<script src="/enter/assets/js/vendor/bootstrap.bundle.min.js"></script>
		<script src="/enter/assets/js/plugins/slick.js"></script>
		<script src="/enter/assets/js/plugins/jquery.syotimer.min.js"></script>
		<script src="/enter/assets/js/plugins/wow.js"></script>
		<script src="/enter/assets/js/plugins/jquery-ui.js"></script>
		<script src="/enter/assets/js/plugins/perfect-scrollbar.js"></script>
		<script src="/enter/assets/js/plugins/magnific-popup.js"></script>
		<script src="/enter/assets/js/plugins/select2.min.js"></script>
		<script src="/enter/assets/js/plugins/waypoints.js"></script>
		<script src="/enter/assets/js/plugins/counterup.js"></script>
		<script src="/enter/assets/js/plugins/jquery.countdown.min.js"></script>
		<script src="/enter/assets/js/plugins/images-loaded.js"></script>
		<script src="/enter/assets/js/plugins/isotope.js"></script>
		<script src="/enter/assets/js/plugins/scrollup.js"></script>
		<script src="/enter/assets/js/plugins/jquery.vticker-min.js"></script>
		<script src="/enter/assets/js/plugins/jquery.theia.sticky.js"></script>
		<script src="/enter/assets/js/plugins/jquery.elevatezoom.js"></script>
		<!-- Template  JS -->
		<script src="./enter/assets/js/main.js?v=5.6"></script>
		<script src="./enter/assets/js/shop.js?v=5.6"></script>

	</th:block>
</body>
<!-- 추가할 js file -->

</html>