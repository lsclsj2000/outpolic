<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{user/layout/userLayoutInquiryDetail}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ ê³ í•˜ê¸° í˜ì´ì§€</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/user/assets/css/userOutsourcingStatus.css}" />
    <link rel="stylesheet" th:href="@{/user/assets/css/userInquiry.css}">
</head>
<body>
    <th:block layout:fragment="contents">
        <h2 style="margin-bottom:25px;">ì‹ ê³ í•˜ê¸°</h2>
        <form id="declarationForm" method="post" enctype="multipart/form-data" action="/user/declarationWrite">
	        <div class="SR_content-input-box">
	            <div class="row shipping_calculator g-3">
	                <div class="form-group col-lg-6">
	                	<div class="custom_select">
		                    <label for="reporter" class="SR_form-label">ì‘ì„±ì :</label>
		                    <input type="text" id="reporter" class="form-control SR_disabled-input" style="height:45px;" 
							       th:value="${reporter}" readonly>
	                    </div>
	                </div>
	                <div class="form-group col-lg-6">
	                	<div class="custom_select">
		                    <label for="reportDate" class="SR_form-label">ì‘ì„±ì¼ì :</label>
		                    <input type="text" id="reportDate" class="form-control SR_disabled-input" style="height:45px;" readonly>
	                    </div>
	                </div>
	            </div>
	
	            <div class="row shipping_calculator g-3 mb-3">
	                <div class="form-group col-lg-6">
	                    <div class="custom_select">
	                        <label for="reportType" class="SR_form-label" style="font-size: 16px;">ì‹ ê³ íƒ€ì… :</label>
	                        <select class="form-control select-active" id="reportType">
	                        </select>
	                    </div>
	                </div>
	                <div class="form-group col-lg-6">
	                    <div class="custom_select">
	                        <label for="reportReason" class="SR_form-label" style="font-size: 16px;">ì‹ ê³  ì‚¬ìœ  :</label>
	                        <select class="form-control select-active" id="reportReason" disabled>
							    <option value="">ì‹ ê³  íƒ€ì…ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
							</select>
	                    </div>
	                </div>
	            </div>
	            
	            <div class="mb-4">
	                <label for="reportTarget" class="SR_form-label">ì‹ ê³  ëŒ€ìƒ :</label>
	                <input type="text" id="reportTarget" class="form-control SR_clickable-input" placeholder="ì‹ ê³  ëŒ€ìƒì„ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”" data-bs-toggle="modal" data-bs-target="#searchTargetModal" readonly>
	            </div>
	
	            <div class="mb-4">
	                <label for="reportContent" class="SR_form-label">ì‹ ê³  ë‚´ìš© ì…ë ¥ :</label>
	                <textarea id="reportContent" class="form-control SR_form-control-textarea" placeholder="ì‹ ê³  ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
	            </div>
	
	            <div class="SR_file-upload-container" style="margin-top: 0px;">
					<div class="SR_checkbox-container">
						<input type="checkbox" id="SR_attachFileCheckbox">
						<label for="SR_attachFileCheckbox">ì²¨ë¶€íŒŒì¼ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</label>
					</div>
				
					<div class="SR_file-input-area mt-15" id="SR_fileInputArea">
						<div class="SR_file-drop-zone" id="SR_fileDropZone">
							<p>ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë¡­í•˜ê±°ë‚˜</p>
							<label for="SR_fileInput" class="SR_custom-file-button">íŒŒì¼ ì„ íƒ</label>
							<input type="file" id="SR_fileInput" name="attachment" style="display: none;" multiple />
							<div id="SR_selectedFiles" class="SR_selected-files"></div>
						</div>
					</div>
				</div>
	
	        </div>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="SR_total_sky_btn">ì·¨ì†Œ</button>
                <button type="submit" class="btn SR_total_blue_btn">ì œì¶œ</button>
            </div>
	    </form>

        <div class="modal fade" id="searchTargetModal" tabindex="-1" aria-labelledby="searchTargetModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="searchTargetModalLabel">ì‹ ê³  ëŒ€ìƒ ê²€ìƒ‰</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row shipping_calculator g-3 mb-3">
	                        <div class="form-group">
	                        	<div class="custom_select">
		                            <label for="targetTypeSelect" class="SR_form-label" style="font-size: 16px; width:50%;">ì‹ ê³  ëŒ€ìƒ ìœ í˜• ì„ íƒ:</label>
		                            <select class="form-select h-10 rounded-md" id="targetTypeSelect">
		                                <option value="">ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</option>
		                                <option value="portfolio">í¬íŠ¸í´ë¦¬ì˜¤</option>
		                                <option value="outsourcing">ì™¸ì£¼</option>
		                                <option value="enter">ê¸°ì—…íšŒì›</option>
		                                <option value="user">ì¼ë°˜íšŒì›</option>
		                            </select>
	                            </div>
	                        </div>
                        </div>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control h-10 rounded-l-md" id="targetSearchInput" placeholder="ìœ í˜•ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”" disabled>
                            <button class="SR_btn-primary h-10 rounded-r-md flex items-center justify-center" type="button" id="searchTargetBtn" style="height: 45px;" disabled>ê²€ìƒ‰</button>
                        </div>
                        <div id="searchResults" class="list-group">
                            <p class="text-muted text-center mt-3">ìœ í˜•ì„ ì„ íƒí•˜ê³  ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•œ í›„ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="SR_total_sky_btn" data-bs-dismiss="modal">ë‹«ê¸°</button>
                        <button type="button" class="SR_total_blue_btn" id="selectTargetBtn" disabled>ì„ íƒ</button>
                    </div>
                </div>
            </div>
        </div>
    </th:block>

    <th:block layout:fragment="jsScript">
        <script src="https://cdn.ckeditor.com/ckeditor5/34.2.0/super-build/ckeditor.js"></script>
        <script>
        let editorInstance;
        let attachedFiles = [];
        let selectedTarget = null; // selectedTarget ë³€ìˆ˜ ì´ˆê¸°í™”

        document.addEventListener('DOMContentLoaded', function () {
            const reporterInput = document.getElementById('reporter');
            const reportDateInput = document.getElementById('reportDate');
            const reportTypeSelect = document.getElementById('reportType');
            const reportReasonSelect = document.getElementById('reportReason');
            const reportTargetInput = document.getElementById('reportTarget');
            const targetTypeSelect = document.getElementById('targetTypeSelect');
            const targetSearchInput = document.getElementById('targetSearchInput');
            const searchTargetBtn = document.getElementById('searchTargetBtn');
            const searchResultsDiv = document.getElementById('searchResults');
            const selectTargetBtn = document.getElementById('selectTargetBtn');
            const cancelBtn = document.querySelector('.SR_total_sky_btn');
            const declarationForm = document.getElementById('declarationForm');

            const today = new Date();
            reportDateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            if (typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !== 'undefined') {
                $('#reportType').select2();
                $('#reportReason').select2({ disabled: true });
                $('#targetTypeSelect').select2({
                    dropdownParent: $('#searchTargetModal'),
                    width: '100%'
                });
            }

            CKEDITOR.ClassicEditor.create(document.getElementById("reportContent"), {
                toolbar: {
                    items: [
                        'heading', '|', 'bold', 'italic', 'strikethrough', 'underline', '|',
                        'bulletedList', 'numberedList', '|', 'link', 'insertImage', 'blockQuote',
                        'insertTable', 'mediaEmbed', '|', 'undo', 'redo', '|', 'sourceEditing'
                    ],
                    shouldNotGroupWhenFull: true
                },
                placeholder: 'ì‹ ê³  ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                ckfinder: { uploadUrl: '/user/uploadImage' },
                removePlugins: ['ExportPdf', 'ExportWord', 'CKBox', 'CKFinder', 'EasyImage',
                    'RealTimeCollaborativeComments', 'RealTimeCollaborativeTrackChanges',
                    'RealTimeCollaborativeRevisionHistory', 'PresenceList', 'Comments',
                    'TrackChanges', 'TrackChangesData', 'RevisionHistory', 'Pagination',
                    'WProofreader', 'MathType']
            }).then(editor => {
                editorInstance = editor;
            });

            // ì‹ ê³  íƒ€ì… ë“œë¡­ë‹¤ìš´ ë¡œë“œ
            fetch('/user/declarationTypes')
                .then(res => res.json())
                .then(types => {
                    console.log("ë¡œë“œëœ ì‹ ê³  íƒ€ì…:", types);
                    reportTypeSelect.innerHTML = '<option value="">ì‹ ê³  íƒ€ì… ì„ íƒ</option>';
                    types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.dtCode;
                        option.textContent = type.dtName;
                        reportTypeSelect.appendChild(option);
                    });
                    $('#reportType').select2();
                });

            // ì‹ ê³  íƒ€ì… ë³€ê²½ ì‹œ ì‚¬ìœ  ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            $('#reportType').on('change', function () {
                const selectedType = $(this).val();
                console.log("ì„ íƒëœ ì‹ ê³  íƒ€ì… (dtCd):", selectedType);
                $('#reportReason').html('<option value="">ì‹ ê³  ì‚¬ìœ  ì„ íƒ</option>');
                $('#reportReason').prop('disabled', true).select2('destroy').select2({ disabled: true });

                if (!selectedType) return;

                fetch(`/user/declarationReasons?dtCd=${selectedType}`)
                    .then(res => res.json())
                    .then(reasons => {
                        console.log("ë¡œë“œëœ ì‹ ê³  ì‚¬ìœ :", reasons);
                        $('#reportReason').html('<option value="">ì‹ ê³  ì‚¬ìœ  ì„ íƒ</option>');
                        reasons.forEach(reason => {
                            const option = $('<option></option>')
                                .val(reason.drCode)
                                .text(reason.drName);
                            $('#reportReason').append(option);
                        });
                        $('#reportReason').prop('disabled', false).select2();
                    });
            });

            // ì‹ ê³  ì‚¬ìœ  ë³€ê²½ ì‹œ ë¡œê·¸
            $('#reportReason').on('change', function() {
                const selectedReason = $(this).val();
                console.log("ì„ íƒëœ ì‹ ê³  ì‚¬ìœ  (drCd):", selectedReason);
            });

            // ì‹ ê³  ëŒ€ìƒ ìœ í˜• ë³€ê²½ ì‹œ ì²˜ë¦¬
            $('#targetTypeSelect').on('change', function () {
                const selectedType = $(this).val();
                console.log("ëª¨ë‹¬: ì„ íƒëœ ì‹ ê³  ëŒ€ìƒ ìœ í˜•:", selectedType);
                targetSearchInput.value = '';
                searchResultsDiv.innerHTML = '';
                selectTargetBtn.disabled = true;
                selectedTarget = null; // ìœ í˜• ë³€ê²½ ì‹œ ì´ì „ ì„ íƒ ì´ˆê¸°í™” (ì •ìƒ ë™ì‘)

                if (selectedType) {
                    targetSearchInput.disabled = false;
                    searchTargetBtn.disabled = false;
                    targetSearchInput.placeholder = {
                        portfolio: 'í¬íŠ¸í´ë¦¬ì˜¤ ì œëª© ë˜ëŠ” ID',
                        outsourcing: 'ì™¸ì£¼ ì œëª© ë˜ëŠ” ID',
                        enter: 'ê¸°ì—…ëª… ë˜ëŠ” íšŒì›ëª…',
                        user: 'ë‹‰ë„¤ì„ ë˜ëŠ” ì´ë¦„'
                    }[selectedType] || 'ê²€ìƒ‰ì–´ ì…ë ¥';
                } else {
                    targetSearchInput.disabled = true;
                    searchTargetBtn.disabled = true;
                    targetSearchInput.placeholder = 'ìœ í˜• ë¨¼ì € ì„ íƒí•˜ì„¸ìš”';
                }
            });

            // ì‹ ê³  ëŒ€ìƒ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
            searchTargetBtn.addEventListener('click', () => {
                const keyword = targetSearchInput.value.trim();
                const selectedType = targetTypeSelect.value;
                console.log("ëª¨ë‹¬: ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ - ìœ í˜•:", selectedType, "í‚¤ì›Œë“œ:", keyword);
                if (!keyword || !selectedType) return;

                fetch(`/user/searchTarget?type=${selectedType}&keyword=${encodeURIComponent(keyword)}`)
                    .then(res => res.json())
                    .then(results => {
                        console.log("ëª¨ë‹¬: ê²€ìƒ‰ ê²°ê³¼ (raw):", results);
                        searchResultsDiv.innerHTML = '';
                        if (!results.length) {
                            searchResultsDiv.innerHTML = '<p class="text-muted text-center mt-3">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>';
                            return;
                        }
                        results.forEach(item => {
                            let id, name, type;
                            if (selectedType === 'portfolio' && item.prtfCode) {
                                id = item.prtfCode; name = item.prtfTitle; type = 'í¬íŠ¸í´ë¦¬ì˜¤';
                            } else if (selectedType === 'outsourcing' && item.osCode) {
                                id = item.osCode; name = item.osTitle; type = 'ì™¸ì£¼';
                            } else if (selectedType === 'enter' && item.entCode) {
                                id = item.entCode; name = item.entTitle; type = 'ê¸°ì—…íšŒì›';
                            } else if (selectedType === 'user' && item.mbrCode) {
                                id = item.mbrCode; name = item.mbrTitle; type = 'ì¼ë°˜íšŒì›';
                            } else {
                                return;
                            }

                            console.log(`ëª¨ë‹¬: í•­ëª© íŒŒì‹± - id: ${id}, name: ${name}, type: ${type}`);

                            const a = document.createElement('a');
                            a.href = '#';
                            a.classList.add('list-group-item', 'list-group-item-action');
                            a.textContent = `${name} (ID: ${id})`; // IDë„ í•¨ê»˜ í‘œì‹œ
                            a.dataset.id = id;
                            a.dataset.name = name;
                            a.dataset.type = type;
                            a.addEventListener('click', function (e) {
                                e.preventDefault();
                                document.querySelectorAll('#searchResults .list-group-item').forEach(el => el.classList.remove('active'));
                                this.classList.add('active');
                                selectedTarget = { id: this.dataset.id, name: this.dataset.name, type: this.dataset.type };
                                console.log("ëª¨ë‹¬: ëª©ë¡ì—ì„œ ì„ íƒëœ ëŒ€ìƒ (í´ë¦­ í›„):", selectedTarget);
                                selectTargetBtn.disabled = false;
                            });
                            searchResultsDiv.appendChild(a);
                        });
                    });
            });

            // --- ë³€ê²½ëœ ë¶€ë¶„ ì‹œì‘ ---
            // ì‹ ê³  ëŒ€ìƒ ê²€ìƒ‰ ì…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ê²€ìƒ‰ ì‹¤í–‰
            targetSearchInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' || event.keyCode === 13) {
                    event.preventDefault(); // ê¸°ë³¸ Enter ë™ì‘(í¼ ì œì¶œ ë“±) ë°©ì§€
                    if (!this.disabled) { // ì…ë ¥ í•„ë“œê°€ í™œì„±í™”ëœ ìƒíƒœì¼ ë•Œë§Œ ê²€ìƒ‰ ì‹¤í–‰
                        searchTargetBtn.click(); // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ
                    }
                }
            });
            // --- ë³€ê²½ëœ ë¶€ë¶„ ë ---

            // ëª¨ë‹¬ ë‚´ 'ì„ íƒ' ë²„íŠ¼ í´ë¦­
            selectTargetBtn.addEventListener('click', function () {
                console.log("ëª¨ë‹¬: 'ì„ íƒ' ë²„íŠ¼ í´ë¦­ ì‹œ selectedTarget í˜„ì¬ ìƒíƒœ:", selectedTarget);
                if (selectedTarget && selectedTarget.id) {
                    reportTargetInput.value = `[${selectedTarget.type}] ${selectedTarget.name} (${selectedTarget.id})`;
                    console.log("ëª¨ë‹¬: ìµœì¢… ì„ íƒ ë²„íŠ¼ í´ë¦­ - reportTargetInput ê°’ ì„¤ì •ë¨:", reportTargetInput.value);
                    const modal = bootstrap.Modal.getInstance(document.getElementById('searchTargetModal'));
                    if (modal) modal.hide();
                } else {
                    console.log("ëª¨ë‹¬: ì„ íƒëœ ì‹ ê³  ëŒ€ìƒì´ ì—†ê±°ë‚˜ IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
            });

            // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì´ë²¤íŠ¸ (ì¤‘ë³µ ì œê±° í›„ í•˜ë‚˜ì˜ ì •í™•í•œ ë¦¬ìŠ¤ë„ˆ)
            document.getElementById('searchTargetModal').addEventListener('hidden.bs.modal', () => {
                targetTypeSelect.value = '';
                targetSearchInput.value = '';
                targetSearchInput.disabled = true;
                searchTargetBtn.disabled = true;
                selectTargetBtn.disabled = true;
                // selectedTarget = null; // ğŸš¨ ì´ ì¤„ì€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. (ëª¨ë‹¬ ë‹«í˜ ì‹œ ì„ íƒê°’ ìœ ì§€)
                searchResultsDiv.innerHTML = '<p class="text-muted text-center mt-3">ìœ í˜•ì„ ì„ íƒí•˜ê³  ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•œ í›„ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>';
                $('#targetTypeSelect').val('').trigger('change.select2');
            });


            // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
            const attachCheckbox = document.getElementById('SR_attachFileCheckbox');
            const inputArea = document.getElementById('SR_fileInputArea');
            const inputField = document.getElementById('SR_fileInput');
            const dropZone = document.getElementById('SR_fileDropZone');
            const fileListContainer = document.getElementById('SR_selectedFiles');

            function renderSelectedFiles() {
                fileListContainer.innerHTML = '';
                if (attachedFiles.length === 0) {
                    fileListContainer.innerHTML = '<p class="text-gray-400 italic text-center p-5">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</p>';
                    return;
                }
                attachedFiles.forEach((fileData, index) => {
                    const file = fileData.file;
                    const previewURL = fileData.previewURL;

                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'SR_selected-file-item';

                    let previewHtml = '';
                    if (previewURL) {
                        previewHtml = `<img src="${previewURL}" alt="File preview" class="SR_file-preview-img">`;
                    } else {
                        previewHtml = `
                            <div class="SR_file-placeholder">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                </svg>
                            </div>
                        `;
                    }

                    fileDiv.innerHTML = `
                        <div class="SR_file-info">
                            ${previewHtml}
                            <span>${file.name} (${formatBytes(file.size)})</span>
                        </div>
                        <button type="button" class="SR_remove-file" data-index="${index}">&times;</button>
                    `;
                    fileListContainer.appendChild(fileDiv);
                });


                fileListContainer.querySelectorAll('.SR_remove-file').forEach(button => {
                    button.addEventListener('click', e => {
                        const index = parseInt(e.target.dataset.index);
                        const fileRemoved = attachedFiles[index];

                        if (fileRemoved.previewURL) {
                            URL.revokeObjectURL(fileRemoved.previewURL); // ë¯¸ë¦¬ë³´ê¸° URL í•´ì œ
                        }

                        attachedFiles.splice(index, 1);
                        renderSelectedFiles();
                    });
                });
            }

            attachCheckbox.addEventListener('change', () => {
                inputArea.classList.toggle('SR_active', attachCheckbox.checked);
                if (!attachCheckbox.checked) {
                    attachedFiles.forEach(fileData => {
                        if (fileData.previewURL) {
                            URL.revokeObjectURL(fileData.previewURL);
                        }
                    });
                    attachedFiles = [];
                    renderSelectedFiles();
                }
            });

            dropZone.addEventListener('dragover', e => {
                e.preventDefault();
                dropZone.classList.add('SR_hover');
            });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('SR_hover'));
            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.classList.remove('SR_hover');
                handleFiles(e.dataTransfer.files);
            });
            inputField.addEventListener('change', e => handleFiles(e.target.files));

            function handleFiles(files) {
                if (files.length === 0) {
                    return;
                }
                // ê¸°ì¡´ íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™” (ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ì‹œ ë§¤ë²ˆ ìƒˆë¡œ ë Œë”ë§)
                attachedFiles = [];
                [...files].forEach(file => {
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    const allowedTypes = [
                        'image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/webp', // ì´ë¯¸ì§€
                        'application/pdf',                                                        // PDF
                        'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // Word (.doc, .docx)
                        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // Excel (.xls, .xlsx)
                        'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation', // PowerPoint (.ppt, .pptx)
                        'text/plain', 'text/csv',                                                        // í…ìŠ¤íŠ¸, CSV
                        'application/zip', 'application/x-rar-compressed', 'application/x-7z-compressed' // ì••ì¶• íŒŒì¼
                    ];

                    if (file.size > maxSize) {
                        alert(`${file.name}ì€(ëŠ”) 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                        return; // ë‹¤ìŒ íŒŒì¼ë¡œ ë„˜ì–´ê°
                    }

                    if (!allowedTypes.includes(file.type)) {
                        alert(`${file.name}ì€(ëŠ”) í—ˆìš©ë˜ì§€ ì•Šì€ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (í—ˆìš©: JPG, PNG, GIF, BMP, WEBP, PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, CSV, ZIP, RAR, 7Z)`);
                        return; // ë‹¤ìŒ íŒŒì¼ë¡œ ë„˜ì–´ê°
                    }

                    const fileData = {
                        file: file,
                        previewURL: null
                    };

                    if (file.type.startsWith('image/')) {
                        fileData.previewURL = URL.createObjectURL(file);
                    }

                    attachedFiles.push(fileData);
                });
                renderSelectedFiles();
            }

            // ë°”ì´íŠ¸ ë‹¨ìœ„ë¥¼ ì½ê¸° ì‰¬ìš´ í˜•íƒœë¡œ ë³€í™˜
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }


            // í¼ ì œì¶œ ì²˜ë¦¬
            declarationForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const content = editorInstance.getData().trim();
                if (!content) return alert('ì‹ ê³  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                const dtCd = reportTypeSelect.value;
                const drCd = reportReasonSelect.value;
                const declTargetCd = selectedTarget?.id;

                console.log("ì œì¶œ ì§ì „: dtCd:", dtCd);
                console.log("ì œì¶œ ì§ì „: drCd:", drCd);
                console.log("ì œì¶œ ì§ì „: declTargetCd:", declTargetCd);
                console.log("ì œì¶œ ì§ì „: selectedTarget ê°ì²´:", selectedTarget);

                if (!dtCd || !drCd || !declTargetCd) {
                    alert('ì‹ ê³  íƒ€ì…, ì‚¬ìœ , ëŒ€ìƒì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const declaration = {
                    dtCode: dtCd,
                    drCode: drCd,
                    declTargetCd: declTargetCd,
                    declCn: content,
                };

                console.log("JavaScriptì—ì„œ ìµœì¢…ì ìœ¼ë¡œ ìƒì„±ëœ declaration ê°ì²´:", declaration);

                const formData = new FormData();
                formData.append("declaration", new Blob([JSON.stringify(declaration)], { type: "application/json" }));

                if (attachCheckbox.checked) {
                    attachedFiles.forEach(data => formData.append('attachments', data.file));
                }

                fetch('/user/declarationWrite', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.text()) // ì„œë²„ ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ë°›ì•„ì„œ í™•ì¸
                .then(text => {
                    console.log("ì„œë²„ë¡œë¶€í„° ë°›ì€ ì‘ë‹µ í…ìŠ¤íŠ¸ (raw):", text); // ì„œë²„ ì‘ë‹µ ì›ë³¸ í™•ì¸
                    const data = JSON.parse(text); // JSON íŒŒì‹± ì‹œë„
                    alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/';
                })
                .catch(err => {
                    alert('ì‹ ê³  ë“±ë¡ ì‹¤íŒ¨');
                    console.error("Fetch ì˜¤ë¥˜:", err);
                });
            });

            // ì·¨ì†Œ ë²„íŠ¼
            cancelBtn.addEventListener('click', () => {
                if (confirm('ì‘ì„±ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    history.back();
                }
            });

            // ì´ˆê¸° íŒŒì¼ ëª©ë¡ ë Œë”ë§ í˜¸ì¶œ
            renderSelectedFiles();
        });
        </script>
    </th:block>
</body>
</html>