<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{user/layout/userLayoutMain}">

	<head>
		<meta name="description" content="한국스마트정보교육원 팀프로젝트" />
	</head>
	
	<th:block layout:fragment="jsScript">
		<script>
			/*Product Details*/
		    var productDetails = function () {
		        $('.product-image-slider').slick({
		            slidesToShow: 1,
		            slidesToScroll: 1,
		            arrows: false,
		            fade: false,
		            asNavFor: '.slider-nav-thumbnails',
		        });
	
		        $('.slider-nav-thumbnails').slick({
		            slidesToShow: 4,
		            slidesToScroll: 1,
		            asNavFor: '.product-image-slider',
		            dots: false,
		            focusOnSelect: true,
	
		            prevArrow: '<button type="button" class="slick-prev"><i class="fi-rs-arrow-small-left"></i></button>',
		            nextArrow: '<button type="button" class="slick-next"><i class="fi-rs-arrow-small-right"></i></button>'
		        });
	
		        // Remove active class from all thumbnail slides
		        $('.slider-nav-thumbnails .slick-slide').removeClass('slick-active');
	
		        // Set active class to first thumbnail slides
		        $('.slider-nav-thumbnails .slick-slide').eq(0).addClass('slick-active');
	
		        // On before slide change match active thumbnail to current slide
		        $('.product-image-slider').on('beforeChange', function (event, slick, currentSlide, nextSlide) {
		            var mySlideNumber = nextSlide;
		            $('.slider-nav-thumbnails .slick-slide').removeClass('slick-active');
		            $('.slider-nav-thumbnails .slick-slide').eq(mySlideNumber).addClass('slick-active');
		        });
	
		        $('.product-image-slider').on('beforeChange', function (event, slick, currentSlide, nextSlide) {
		            var img = $(slick.$slides[nextSlide]).find("img");
		            $('.zoomWindowContainer,.zoomContainer').remove();
		            if ($(window).width() > 768) {
		                $(img).elevateZoom({
		                    zoomType: "inner",
		                    cursor: "crosshair",
		                    zoomWindowFadeIn: 500,
		                    zoomWindowFadeOut: 750
		                });
		            }
		        });
		        //Elevate Zoom
		        if ( $(".product-image-slider").length ) {
		            if ($(window).width() > 768) {
		                $('.product-image-slider .slick-active img').elevateZoom({
		                    zoomType: "inner",
		                    cursor: "crosshair",
		                    zoomWindowFadeIn: 500,
		                    zoomWindowFadeOut: 750
		                });
		            }
		        }
		        //Filter color/Size
		        $('.list-filter').each(function () {
		            $(this).find('a').on('click', function (event) {
		                event.preventDefault();
		                $(this).parent().siblings().removeClass('active');
		                $(this).parent().toggleClass('active');
		                $(this).parents('.attr-detail').find('.current-size').text($(this).text());
		                $(this).parents('.attr-detail').find('.current-color').text($(this).attr('data-color'));
		            });
		        });
	
		        //Qty Up-Down
		        $('.detail-qty').each(function () {
		            var qtyval = parseInt($(this).find(".qty-val").val(), 10);
		            var $qtyInput = $(this).find(".qty-val");
	
		            $(this).find('.qty-up').on('click', function (event) {
		                event.preventDefault();
		                qtyval = qtyval + 1;
		                $qtyInput.val(qtyval);
		            });
	
		            $(this).find(".qty-down").on("click", function (event) {
		                event.preventDefault();/*  */
		                qtyval = Math.max(1, qtyval - 1);
		                $qtyInput.val(qtyval);
		            });
		        });
	
		        $('.dropdown-menu .cart_list').on('click', function (event) {
		            event.stopPropagation();
		        });
		    };
		
		
		
			/*<![CDATA[*/
			document.addEventListener('DOMContentLoaded', function() {
			
				// -변수에 담아두기 (성능 최적화)
				const contentsContainer = document.getElementById('contentsListContainer');
				const filterButtons = document.querySelectorAll('#myTab .nav-link');
				const headerSearchForm = document.querySelector('form[action="/user/userSearch"]');
				const headerSearchInput = headerSearchForm ? headerSearchForm.querySelector('input[name="keyword"]') : null;
				const resultTitle = document.querySelector('.section-title h3');
				
				
				
				function performAjaxSearch(keyword) {
				    // 1-1. History API를 사용해 브라우저 주소창의 URL을 변경 (페이지 이동은 없음)
				    const newUrl = `/user/userSearch?keyword=${encodeURIComponent(keyword)}`;
				    history.pushState(null, '', newUrl);
				
				    // 1-2. 사용자에게 로딩 중임을 시각적으로 표시
				    contentsContainer.innerHTML = '<div class="col-12 text-center"><p>검색 중...</p></div>';
				
				    // 1-3. 서버의 API에 데이터 요청
				    fetch(`/user/search/api?keyword=${encodeURIComponent(keyword)}`)
				        .then(response => {
				            if (!response.ok) throw new Error('서버 응답 오류');
				            return response.json();
				        })
				        .then(data => {
				            // 1-4. AJAX 성공 시 화면 업데이트
				            
				            // 검색 결과 제목 변경
				            if (keyword && keyword.trim() !== '') {
				                resultTitle.innerHTML = `'<span class="text-brand">${keyword}</span>' 검색 결과`;
				            } else {
				                resultTitle.innerHTML = '전체 콘텐츠';
				            }
				
				            // 받은 데이터로 목록을 완전히 새로 그림
				            contentsContainer.innerHTML = ''; // 컨테이너 초기화
				            if (!data || data.length === 0) {
				                contentsContainer.innerHTML = '<div class="col-12 text-center"><p>검색 결과가 없습니다.</p></div>';
				                return;
				            }
				
				            // 데이터 목록을 순회하며 각 아이템의 HTML을 생성
				            data.forEach((content, index) => {
				                const contentHtml = `
				                    <div class="col-lg-1-5 col-md-4 col-12 col-sm-6 product-item" data-type="${content.contentsType}">
				                        <div class="product-cart-wrap mb-30">
				                            <div class="product-img-action-wrap">
				                                <div class="product-img product-img-zoom">
				                                    <a href="#">
				                                        <img class="default-img" src="https://picsum.photos/id/${index + 40}/300/200" alt="콘텐츠 이미지">
				                                        <img class="hover-img" src="https://picsum.photos/id/${index + 140}/300/200" alt="콘텐츠 이미지">
				                                    </a>
				                                </div>
				                                <div class="product-action-1">
								                    <a aria-label="Add To Wishlist" class="action-btn" href="shop-wishlist.html"><i class="fi-rs-heart"></i></a>
								                    <a aria-label="Compare" class="action-btn" href="shop-compare.html"><i class="fi-rs-shuffle"></i></a>
								                    <a aria-label="Quick view" class="action-btn" data-bs-toggle="modal" data-bs-target="#quickViewModal"><i class="fi-rs-eye"></i></a>
								                </div>
				                            </div>
				                            <div class="product-content-wrap" style="margin-top: 15px;">
				                                <h2><a href="#">${content.contentsTitle}</a></h2>
				                                <div>
				                                    <span class="font-small text-muted">By <a href="#">${content.enterName}</a></span>
				                                </div>
				                            </div>
				                        </div>
				                    </div>
				                `;
				                contentsContainer.insertAdjacentHTML('beforeend', contentHtml);
				            });
				
				            // 새 검색을 했으므로 필터 버튼을 'All'로 초기화
				            setActiveButton(document.querySelector('.nav-link[data-filter="All"]'));
				            productDetails();
				        })
				        .catch(error => {
				            console.error("AJAX Search Error:", error);
				            contentsContainer.innerHTML = '<div class="col-12 text-center"><p>검색 중 오류가 발생했습니다.</p></div>';
				        });
				}
				
				/**
				 * 필터링할 타입 ('All', 'Portfolio', 'Outsourcing')
				 */
				function applyFilter(filter) {
				    const items = contentsContainer.querySelectorAll('.product-item');
				    let visibleCount = 0;
				
				    items.forEach(item => {
				        // 'All' 필터이거나 아이템의 data-type이 필터와 일치하면 보여줌
				        if (filter === 'All' || item.dataset.type === filter) {
				            item.style.display = ''; // 보이기 (CSS display 속성을 기본값으로 복원)
				            visibleCount++;
				        } else {
				            item.style.display = 'none'; // 숨기기
				        }
				    });
				
				    // 필터링 결과 아무것도 보이지 않을 경우 메시지 처리
				    const noResultMessage = contentsContainer.querySelector('.no-filter-result');
				    if (noResultMessage) noResultMessage.remove(); // 기존 메시지 삭제
				    if (visibleCount === 0) {
				        contentsContainer.insertAdjacentHTML('beforeend', '<div class="col-12 text-center no-filter-result"><p>선택하신 필터에 해당하는 결과가 없습니다.</p></div>');
				    }
				}
				
				function setActiveButton(clickedButton) {
				    if (!clickedButton) return;
				    filterButtons.forEach(button => button.classList.remove('active'));
				    clickedButton.classList.add('active');
				}
				
				

				filterButtons.forEach(button => {
				    button.addEventListener('click', function() {
				        setActiveButton(this);            // 클릭된 버튼을 활성화
				        applyFilter(this.dataset.filter); // 현재 화면을 필터링
				    });
				});
				
				// 헤더 검색 폼을 제출(submit)했을 때
				if (headerSearchForm) {
				    headerSearchForm.addEventListener('submit', function(event) {
				        // 현재 페이지가 검색 결과 페이지일 때만 AJAX로 동작하도록 처리
				        if (window.location.pathname.includes('/user/userSearch')) {
				            event.preventDefault(); // 기본 form 제출(페이지 이동)을 막음
				            const newKeyword = headerSearchInput.value;
				            performAjaxSearch(newKeyword); // AJAX 검색 함수 호출
				        }
				    });
				}
			});
			
			/*]]>*/
		</script>
	</th:block>
	
	<th:block layout:fragment="contents">
		<section class="product-tabs section-padding position-relative">
	        <div class="container">
	            <div class="section-title style-2 wow animate__animated animate__fadeIn">
					<!-- 컨트롤러에서 받은 initialKeyword 값에 따라 제목을 동적으로 변경합니다. -->
	                <h3>
						<span th:if="${initialKeyword == null || initialKeyword == ''}">전체 콘텐츠</span>
						<span th:unless="${initialKeyword == null || initialKeyword == ''}">
							'<th:block th:text="${initialKeyword}"/>' 검색 결과
						</span>
					</h3>
					
				</div>
				<ul class="nav nav-tabs links" id="myTab" role="tablist">
				    <li class="nav-item" role="presentation">
				        <!-- [수정] data-filter 속성 추가 -->
				        <button class="nav-link active" data-filter="All" type="button">All</button>
				    </li>
				    <li class="nav-item" role="presentation">
				        <button class="nav-link" data-filter="Portfolio" type="button">포트폴리오</button>
				    </li>
				    <li class="nav-item" role="presentation">
				        <button class="nav-link" data-filter="Outsourcing" type="button">외주</button>
				    </li>
				</ul>
				<br>
				<!--End nav-tabs-->
				<div class="tab-content" id="myTabContent" style="border: none;">
				    <div class="tab-pane fade show active" id="tab-one" role="tabpanel" aria-labelledby="tab-one">
						<!-- AJAX로 결과가 채워질 컨테이너에 id="contentsListContainer" 부여 -->
						<div class="row product-grid-4" id="contentsListContainer">
						
							<!-- 이 부분은 페이지가 처음 로딩될 때만 Thymeleaf가 렌더링합니다. -->
							<div th:if="${not #lists.isEmpty(contentsList)}"
							     th:each="content, iterStat : ${contentsList}"
							     class="col-lg-1-5 col-md-4 col-12 col-sm-6 product-item"
							     th:attr="data-type=${content.contentsType}">
						        <div class="product-cart-wrap mb-30 wow animate__animated animate__fadeIn" data-wow-delay=".1s">
						            <div class="product-img-action-wrap">
						                <div class="product-img product-img-zoom">
						                    <a href="shop-product-right.html">
						                    	<img class="default-img" th:src="@{'https://picsum.photos/id/' + (${iterStat.index} + 20) + '/400/300'}" alt="" />
   	                             				<img class="hover-img" th:src="@{'https://picsum.photos/id/' + (${iterStat.index} + 120) + '/400/300'}" alt="" />
						                    </a>
						                </div>
						                <div class="product-action-1">
						                    <a aria-label="Add To Wishlist" class="action-btn" href="shop-wishlist.html"><i class="fi-rs-heart"></i></a>
						                    <a aria-label="Compare" class="action-btn" href="shop-compare.html"><i class="fi-rs-shuffle"></i></a>
						                    <a aria-label="Quick view" class="action-btn" data-bs-toggle="modal" data-bs-target="#quickViewModal"><i class="fi-rs-eye"></i></a>
						                </div>
						            </div>
						            <div class="product-content-wrap" style="margin-top: 15px;">
						                <h2><a th:text="${content.contentsTitle}" href="shop-product-right.html">콘텐츠 제목</a></h2>
									    <div>
									    	<span class="font-small text-muted">By <a th:text="${content.enterName}" href="vendor-details-1.html">회원닉네임</a></span>
									    </div>
					            	</div>
					        	</div>
					        	<br>
					        	<br>
					   		</div>
							<!-- 검색 결과가 없을 때 (초기 로딩 시) -->
							<div th:if="${#lists.isEmpty(contentsList)}" class="col-12">
								<p class="text-center">표시할 콘텐츠가 없습니다.</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</th:block>
	
</html>