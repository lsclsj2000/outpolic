<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout/userLayoutkjw}"> <head>
    <meta charset="UTF-8">
    <title>ìƒˆ ì™¸ì£¼ í”„ë¡œì íŠ¸ ì‹ ì²­</title>
    <style>
        .main-container { max-width: 960px; margin: 40px auto; padding: 20px; }
        .card { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-submit { display: block; width: 100%; padding: 12px; background-color: #3BB77E; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; text-align: center; }
        .file-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .file-preview-item { position: relative; width: 100px; height: 100px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #555; }
        .file-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-file-btn { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>

<body>
<th:block layout:fragment="content"> <div class="main-container">
        <div class="card">
            <h2 class="mb-4">ìƒˆ ì™¸ì£¼ í”„ë¡œì íŠ¸ ì‹ ì²­</h2>
            <p class="mb-4 text-muted">
                <strong th:text="${supplierName}">ê³µê¸‰ì ì´ë¦„</strong>ì—ê²Œ ë³´ë‚¼ ìš”ì²­ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
            </p>

            <form id="outsourcingApplicationForm">
                <input type="hidden" name="entCd" th:value="${supplierCd}">

                <div class="form-group">
                    <label for="ocdTtl">í”„ë¡œì íŠ¸ ì œëª©</label>
                    <input type="text" id="ocdTtl" name="ocdTtl" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="ocdExpln">ìƒì„¸ ì„¤ëª…</label>
                    <textarea id="ocdExpln" name="ocdExpln" class="form-control" rows="8" required placeholder="í”„ë¡œì íŠ¸ì˜ ëª©ì , ì£¼ìš” ê¸°ëŠ¥, ì°¸ê³  ì‚¬ì´íŠ¸ ë“± ìƒì„¸í•œ ë‚´ìš©ì„ ê¸°ì¬í•´ì£¼ì„¸ìš”."></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="ocdDedline">í¬ë§ ì‘ì—… ê¸°í•œ</label>
                        <input type="date" id="ocdDedline" name="ocdDedline" class="form-control">
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="ocdAmt">ì œì•ˆ ê¸ˆì•¡ (ì›)</label>
                        <input type="number" id="ocdAmt" name="ocdAmt" class="form-control" required placeholder="ì„¸ì „ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">
                    </div>
                </div>

                <div class="form-group">
                    <label for="referenceFiles">ì°¸ê³  ìë£Œ ì²¨ë¶€ (ì„ íƒ)</label>
                    <input type="file" id="referenceFiles" name="files" class="form-control" multiple>
                    <div id="file-preview" class="file-preview-container"></div>
                </div>

                <button type="submit" class="btn-submit">ì™¸ì£¼ í”„ë¡œì íŠ¸ ì‹ ì²­í•˜ê¸°</button>
            </form>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script"> <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('outsourcingApplicationForm');
            const fileInput = document.getElementById('referenceFiles');
            const previewContainer = document.getElementById('file-preview');
            const dataTransfer = new DataTransfer();

            // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ë° ê´€ë¦¬ ê¸°ëŠ¥
            fileInput.addEventListener('change', () => {
                Array.from(fileInput.files).forEach(file => dataTransfer.items.add(file));
                fileInput.files = dataTransfer.files;
                renderPreview();
            });

            function renderPreview() {
                previewContainer.innerHTML = '';
                Array.from(dataTransfer.files).forEach((file, index) => {
                    const reader = new FileReader();
                    const item = document.createElement('div');
                    item.className = 'file-preview-item';

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-file-btn';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.type = 'button';
                    removeBtn.onclick = () => {
                        dataTransfer.items.remove(index);
                        fileInput.files = dataTransfer.files;
                        renderPreview();
                    };
                    item.appendChild(removeBtn);

                    if (file.type.startsWith('image/')) {
                        reader.onload = () => {
                            const img = document.createElement('img');
                            img.src = reader.result;
                            item.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        item.append(`ğŸ“„ ${file.name.substring(0, 10)}...`);
                    }
                    previewContainer.appendChild(item);
                });
            }

            // í¼ ì œì¶œ ê¸°ëŠ¥
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(form);

                if (!formData.get('ocdTtl') || !formData.get('ocdAmt')) {
                    alert('í”„ë¡œì íŠ¸ ì œëª©ê³¼ ì œì•ˆ ê¸ˆì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                    return;
                }

                // userìš© ì»¨íŠ¸ë¡¤ëŸ¬ ê²½ë¡œë¡œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
                fetch('/user/requests/add', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ì™¸ì£¼ ì‹ ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        // ì„±ê³µ í›„, ë³´ë‚¸ ìš”ì²­ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
                        window.location.href = '/user/requests/sent';
                    } else {
                        alert('ì˜¤ë¥˜: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
            });
        });
    </script>
</th:block>
</body>
</html>