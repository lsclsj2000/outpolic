<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout/userLayoutkjw}">
<head>
    <meta charset="UTF-8">
    <title>외주 신청서 작성</title>
    </head>
<body>
<th:block layout:fragment="contents">
    <div class="container">
        <div class="row">
        	<div class="col-lg-10 m-auto mt-30">
        		<h1 class="section-title">외주 신청서</h1>
        		<div class="card">
		            <div class="info-box" th:if="${outsourcing != null}">
		                <h3>신청 대상 외주 프로젝트</h3>
		                <p th:text="${outsourcing.osTtl}">[외주 프로젝트 제목]</p>
		            </div>
		
		            <form id="outsourcing-request-form">
		                <input type="hidden" name="ent_cd" th:value="${outsourcing.entCd}">
		                <input type="hidden" name="cl_cd"  th:value="${outsourcing.clCd}">
                        <input type="hidden" name="ocd_req_type" value="신청">

		                <div class="form-group">
		                    <label for="title">요청 제목<span class="required">*</span></label>
		                    <input type="text" id="title" name="ocd_ttl" class="form-control" th:value="${outsourcing != null ? outsourcing.osTtl + ' 관련 외주 신청' : ''}" required>
		                </div>
		
		                <div class="form-group">
		                    <label for="deliverable">최종 제작물</label>
		                    <input type="text" id="deliverable" name="ocd_frctn_cmdty" class="form-control" placeholder="예: 디자인 원본 파일(PSD), 최종 보고서(PDF)">
		                </div>
		
		                <div class="form-group">
		                    <label for="delivery-method">납품 방법</label>
		                    <input type="text" id="delivery-method" name="ocd_dlvgds_mthd" class="form-control" placeholder="예: 이메일 전달, 클라우드 링크">
		                </div>
		
		                <div class="form-group">
		                    <label for="start-date">희망시작일 <span class="required">*</span></label>
		                    <input type="datetime-local" id="start-date" name="ocd_strt_ymdt" class="form-control" required>
		                </div>
		               
		                <div class="form-group">
		                    <label for="end-date">희망종료일 <span class="required">*</span></label>
		                    <input type="datetime-local" id="end-date" name="ocd_dedline" class="form-control" required>
		                </div>
		
		                <div class="form-group">
		                    <label for="amount">희망 예산 (원)</label>
		                    <input type="number" id="amount" name="ocd_amt" class="form-control" placeholder="숫자만 입력 (협의 가능 시 비워두세요)">
		                </div>
		               
		                <div class="form-group">
		                    <label for="explanation">상세 요청 내용<span class="required">*</span></label>
		                    <textarea id="explanation" name="ocd_expln" class="form-control" rows="6" 
		                   		   placeholder="원하는 작업 내용을 구체적으로 작성해주세요." style="height:300px;" required></textarea>
		                </div>
		
		                <button type="submit" id="submit-button" class="btn-submit">외주 신청하기</button>
		            </form>
		        </div>
        	</div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="jsFile">
    <script>
        document.getElementById('outsourcing-request-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = '전송 중...';

            fetch('/user/outsourcing-requests', {
                method: 'POST',
                body: new FormData(form)
            })
            .then(response => {
                if(response.status === 401){
                    alert('세션이 만료되었거나 권한이 없습니다. 다시 로그인해주세요');
                    throw new Error('Unauthorized access');
                }
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.message || '서버 오류가 발생했습니다.') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = data.redirectUrl;
                } else {
                    throw new Error(data.message || '알 수 없는 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error("Fetch error:",error);
                if(error.message !== 'Unauthorized access'){
                    alert(`오류: ${error.message}`);
                }
                submitButton.disabled = false;
                submitButton.textContent = '외주 신청하기';
            });
        });
    </script>
</th:block>
</body>
</html>