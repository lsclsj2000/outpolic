<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div class="bg-white flex items-center justify-center min-h-screen" th:fragment="userChatRoomFragment">

    <!-- Floating chat button container -->
    <div id="chat-float-button-container" class="SR_chat-float-button"></div>

    <!-- Chat window container -->
    <div id="chat-window-container"></div>

    <!-- Custom modal containers (for alerts, input prompts etc.) -->
    <div id="modal-container"></div>
    <div id="custom-input-modal-container"></div>

    <script type="module">
        // Firebase CDN Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global state variables
        let app;
        let db;
        let auth;
        let userId = null; // User ID set after authentication
        let isAuthReady = false; // Flag to indicate Firebase auth is ready

        // Application state object
        let state = {
            isChatOpen: false, // Chat window open/closed status
            currentView: 'home', // Current view: 'home', 'chatRooms' (list) or 'chatMessages' (messages) - changed default to 'home'
            selectedRoomId: null, // Currently selected chat room ID
            selectedOpponentId: null, // New: Stores the ID of the selected opponent for profile view
            chatRooms: [], // Chat room data (filled with dummy data or real data)
            messages: [], // Messages for the current chat room
            firestoreListeners: [], // Array to store unsubscribe functions for Firestore listeners
            isMaximized: false // New state for chat window maximization
        };

        // Firebase configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // FIX: Corrected the ReferenceError by directly using the global __initial_auth_token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Gemini AI Assistant unique ID (to differentiate from other user IDs)
        const AI_ASSISTANT_ID = "gemini-ai-assistant";
        const AI_ASSISTANT_NAME = "AI 도우미 ✨";

        // Dummy Data for Portfolio and Outsourcing
        const dummyPortfolios = [
            { id: 'p1', title: '웹사이트 개발 프로젝트 (대규모)', description: '반응형 웹사이트 및 백엔드 시스템 구축. 최신 웹 기술 스택을 활용하여 확장성과 안정성을 보장합니다.', imageUrl: 'https://placehold.co/180x120/abc123/ffffff?text=웹사이트' },
            { id: 'p2', title: '모바일 앱 UI/UX 디자인 (혁신적)', description: '사용자 중심의 직관적인 인터페이스 설계 및 디자인 시스템 구축으로 사용자 만족도를 극대화합니다.', imageUrl: 'https://placehold.co/180x120/def456/ffffff?text=모바일앱' },
            { id: 'p3', title: '데이터 분석 대시보드 (실시간)', description: '대용량 데이터의 실시간 수집 및 시각화, 인사이트 도출을 위한 고급 분석 대시보드 솔루션입니다.', imageUrl: 'https://placehold.co/180x120/789ghi/ffffff?text=데이터분석' },
            { id: 'p4', title: 'AI 기반 챗봇 솔루션 (맞춤형)', description: '자연어 처리 및 머신러닝 기술을 활용한 지능형 챗봇 개발로 고객 응대 자동화 및 효율성을 높입니다.', imageUrl: 'https://placehold.co/180x120/jkl012/ffffff?text=AI챗봇' },
            { id: 'p5', title: '클라우드 인프라 구축 (안정성)', description: 'AWS 기반의 고가용성 및 확장 가능한 클라우드 인프라를 설계하고 구축하여 안정적인 서비스 운영을 지원합니다.', imageUrl: 'https://placehold.co/180x120/mno345/ffffff?text=클라우드' },
            { id: 'p6', title: '게임 개발 프레임워크', description: '크로스 플랫폼 게임 개발을 위한 강력한 프레임워크 설계', imageUrl: 'https://placehold.co/180x120/456def/ffffff?text=게임개발' }
        ];

        const dummyOutsourcings = [
            { id: 'o1', title: '신규 서비스 랜딩 페이지 제작', description: '신규 서비스 런칭을 위한 마케팅용 고성능 랜딩 페이지 개발이 필요합니다.', status: '진행 중' },
            { id: 'o2', title: '재고 관리 시스템 개발 의뢰', description: '소상공인을 위한 맞춤형 클라우드 기반 재고 관리 시스템 개발을 의뢰합니다.', status: '대기 중' },
            { id: 'o3', title: 'ERP 시스템 모듈 연동 및 커스터마이징', description: '기존 ERP에 신규 모듈 연동 및 기업 특성에 맞는 기능 커스터마이징 프로젝트입니다.', status: '완료' },
            { id: 'o4', title: '컨텐츠 관리 시스템 고도화 개발', description: '기존 컨텐츠 관리 시스템에 이미지 및 비디오 처리 기능 강화를 위한 고도화 개발을 요청합니다.', status: '진행 중' },
            { id: 'o5', title: '사내 교육 플랫폼 구축', description: '직원 교육을 위한 인터랙티브 온라인 교육 플랫폼 구축 프로젝트입니다.', status: '진행 중' },
            { id: 'o6', title: '보안 솔루션 도입 컨설팅', description: '기업 데이터 보안 강화를 위한 전문가 컨설팅 및 솔루션 도입을 희망합니다.', status: '대기 중' }
        ];

        // Dummy Profile Data for other users (for opponent profile view)
        const dummyUserProfiles = {
            'dummyUser2': { name: '이팀장', company: 'ABC 솔루션', description: '프로젝트 관리 및 기획 전문가입니다.', profileImageUrl: 'https://placehold.co/80x80/6366f1/ffffff?text=이팀장' },
            'dummyUser3': { name: '최대리', company: 'XYZ 디자인', description: '창의적인 UI/UX 디자인을 담당합니다.', profileImageUrl: 'https://placehold.co/80x80/10b981/ffffff?text=최대리' },
            'dummyUser4': { name: '박부장', company: 'Startup Tech', description: '기술 컨설팅 및 솔루션 아키텍처 담당입니다.', profileImageUrl: 'https://placehold.co/80x80/ef4444/ffffff?text=박부장' },
            [AI_ASSISTANT_ID]: { name: AI_ASSISTANT_NAME, company: 'Gemini AI', description: '다양한 질문에 답변하고 대화를 돕는 AI 도우미입니다.', profileImageUrl: 'https://placehold.co/80x80/8b5cf6/ffffff?text=AI' }
        };

        /**
         * Initializes Firebase and sets up the authentication listener.
         */
        async function initializeFirebase() {
            try {
                // Check if Firebase config is missing
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Cannot initialize Firebase.");
                } else {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }

                // Set up listener for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid; // Set authenticated user ID
                        console.log("Firebase authenticated. User ID:", userId);
                    } else {
                        console.log("No user signed in. Attempting sign-in...");
                        try {
                            if (initialAuthToken) {
                                // Try signing in with custom token if available
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token successfully.");
                            } else {
                                // If no custom token, try anonymous sign-in
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID(); // Fallback to random ID if UID still not available
                            console.log("Auth attempt complete. Current User ID:", userId);
                        } catch (error) {
                            // If custom token sign-in fails (e.g., auth/invalid-claims), try anonymous sign-in as fallback
                            console.log("Initial sign-in attempt (custom token) failed. Attempting anonymous sign-in as fallback...", error.message);
                            try {
                                await signInAnonymously(auth);
                                userId = auth.currentUser?.uid || crypto.randomUUID();
                                console.log("Successfully signed in anonymously as fallback. Current User ID:", userId);
                            } catch (anonError) {
                                console.error("Firebase anonymous sign-in fallback also failed:", anonError);
                                userId = crypto.randomUUID(); // Assign random ID if all auth attempts fail
                            }
                        }
                    }
                    isAuthReady = true; // Auth process completed (user or anonymous)
                    // Load dummy data or set up real data listener after Firebase init and auth are complete
                    if (db) { // Check if db was successfully initialized
                         setupFirestoreListeners(); // Set up real Firestore data listeners
                    } else {
                        // Fallback to dummy data if Firebase DB initialization fails
                        loadDummyChatRooms();
                    }
                    render(); // Initial render
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // Fallback to dummy data if Firebase initialization fails
                loadDummyChatRooms();
                isAuthReady = true; // Allow UI rendering even without Firebase
                render();
            }
        }

        /**
         * Loads initial dummy chat room data. Includes dummy messages for each room.
         * This function is called when Firebase Firestore is not initialized or encounters an error.
         */
        function loadDummyChatRooms() {
            const now = new Date();
            // Ensure userId is set before creating dummy rooms that depend on it
            if (!userId) {
                userId = 'dummy-user-' + crypto.randomUUID().substring(0, 8);
            }
            state.chatRooms = [
                {
                    id: 'dummy-room-1',
                    name: '환영합니다! 👋',
                    lastMessage: '채팅 앱에 오신 것을 환영합니다.',
                    lastMessageTimestamp: { toDate: () => new Date(now.getTime() - 60 * 1000) },
                    participants: [userId, 'dummyUser2'], // Ensure current userId is a participant
                    messages: [
                        { senderId: 'dummyUser2', senderName: '이팀장', text: '안녕하세요! 문의사항이 있으시면 언제든지 물어보세요.', timestamp: { toDate: () => new Date(now.getTime() - 55 * 1000) } },
                        { senderId: userId, senderName: `사용자 ${userId.substring(0, 4)}`, text: '네, 감사합니다!', timestamp: { toDate: () => new Date(now.getTime() - 50 * 1000) } },
                        { senderId: AI_ASSISTANT_ID, senderName: AI_ASSISTANT_NAME, text: '환영합니다! 어떤 도움이 필요하신가요?', timestamp: { toDate: () => new Date(now.getTime() - 45 * 1000) } }
                    ]
                },
                {
                    id: 'dummy-room-2',
                    name: '프로젝트 논의방',
                    lastMessage: '다음 주 회의 안건에 대해 논의합시다.',
                    lastMessageTimestamp: { toDate: () => new Date(now.getTime() - 5 * 60 * 1000) },
                    participants: [userId, 'dummyUser3'], // Ensure current userId is a participant
                    messages: [
                        { senderId: 'dummyUser3', senderName: '최대리', text: '회의 자료 준비되셨나요?', timestamp: { toDate: () => new Date(now.getTime() - 4 * 60 * 1000) } },
                        { senderId: userId, senderName: `사용자 ${userId.substring(0, 4)}`, text: '네, 거의 다 됐습니다!', timestamp: { toDate: () => new Date(now.getTime() - 3 * 60 * 1000) } }
                    ]
                },
                {
                    id: 'dummy-room-3',
                    name: '자유 게시판 💬',
                    lastMessage: '오늘 점심 뭐 드셨나요?',
                    lastMessageTimestamp: { toDate: () => new Date(now.getTime() - 15 * 60 * 1000) },
                    participants: [userId, 'dummyUser4'], // Ensure current userId is a participant
                    messages: [
                        { senderId: 'dummyUser4', senderName: '박부장', text: '오늘 점심 뭐 드셨나요? 저는 비빔밥 먹었어요!', timestamp: { toDate: () => new Date(now.getTime() - 14 * 60 * 1000) } },
                        { senderId: userId, senderName: `사용자 ${userId.substring(0, 4)}`, text: '저는 김치찌개 먹었어요!', timestamp: { toDate: () => new Date(now.getTime() - 13 * 60 * 1000) } }
                    ]
                }
            ];
            console.log("Dummy chat rooms and messages loaded.");
        }


        /**
         * Cleans up all active Firestore listeners.
         */
        function cleanupFirestoreListeners() {
            state.firestoreListeners.forEach(unsubscribe => unsubscribe());
            state.firestoreListeners = [];
        }

        /**
         * Sets up real-time Firestore listeners for chat rooms and messages.
         */
        function setupFirestoreListeners() {
            if (!isAuthReady || !db) {
                console.log("Firestore not ready or user not authenticated. Using dummy data fallback.");
                loadDummyChatRooms(); // Load dummy data if Firestore connection fails
                return;
            }

            cleanupFirestoreListeners(); // Unsubscribe existing listeners first

            // Set up listener for chat rooms collection
            const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/chatRooms`);
            const unsubscribeRooms = onSnapshot(roomsCollectionRef, (snapshot) => {
                const rooms = [];
                snapshot.forEach(doc => {
                    rooms.push({ id: doc.id, ...doc.data() });
                });
                // Sort by last message timestamp (newest first)
                state.chatRooms = rooms.sort((a, b) => (b.lastMessageTimestamp?.toDate() || 0) - (a.lastMessageTimestamp?.toDate() || 0));
                console.log("Chat rooms updated:", state.chatRooms);
                // Only re-render chat rooms view if currently on that view
                if (state.currentView === 'chatRooms') {
                    renderChatRoomsView(document.getElementById('dynamic-content'));
                }
            }, (error) => {
                console.error("Error fetching chat rooms:", error);
                loadDummyChatRooms(); // Fallback to dummy data on error
            });
            state.firestoreListeners.push(unsubscribeRooms);

            // Set up listener for messages in the selected chat room (if in messages view)
            if (state.currentView === 'chatMessages' && state.selectedRoomId) {
                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/chatRooms/${state.selectedRoomId}/messages`);
                // Note: Firestore orderBy requires an index; sorting in-memory here for simplicity.
                const unsubscribeMessages = onSnapshot(messagesCollectionRef, (snapshot) => {
                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort by timestamp (oldest first)
                    state.messages = messages.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));
                    console.log(`Messages for room ${state.selectedRoomId} updated:`, state.messages);
                    // Only update the messages content, not the whole view
                    renderMessagesContent();
                    scrollToBottom(); // Scroll to the latest message
                }, (error) => {
                    console.error("Error fetching messages:", error);
                });
                state.firestoreListeners.push(unsubscribeMessages);
            }
        }

        /**
         * Scrolls the chat message area to the bottom.
         */
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                // Use setTimeout to ensure scroll happens after DOM updates
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 0);
            }
        }

        /**
         * Creates a new chat room.
         * @param {string} roomName - The name of the chat room to create
         */
        async function createNewChatRoom(roomName) {
            // If in dummy mode, do not use Firestore
            if (!db) {
                console.warn("Firestore not available. Creating dummy chat room locally.");
                const newRoomId = 'dummy-room-' + Math.random().toString(36).substring(2, 9);
                const now = new Date();
                const newDummyRoom = {
                    id: newRoomId,
                    name: roomName,
                    lastMessage: "새 채팅방이 생성되었습니다.",
                    lastMessageTimestamp: { toDate: () => now },
                    participants: [userId, 'dummyUser2'], // Assume a dummy opponent
                    messages: [ // Add an initial dummy message
                        { senderId: AI_ASSISTANT_ID, senderName: AI_ASSISTANT_NAME, text: `"${roomName}" 채팅방이 개설되었습니다!`, timestamp: { toDate: () => now } }
                    ]
                };
                state.chatRooms.unshift(newDummyRoom); // Add to the beginning of the list
                setState({ currentView: 'chatMessages', selectedRoomId: newRoomId });
                return;
            }

            if (!userId) {
                console.error("Firebase DB not initialized or user not authenticated.");
                showModal("오류", "채팅방을 생성할 수 없습니다. 사용자 인증 또는 데이터베이스 초기화를 확인해주세요.");
                return;
            }
            try {
                const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/chatRooms`);
                const newRoomRef = await addDoc(roomsCollectionRef, {
                    name: roomName,
                    createdAt: serverTimestamp(),
                    lastMessage: "채팅방이 생성되었습니다.",
                    lastMessageTimestamp: serverTimestamp(),
                    participants: [userId] // Add creator as participant
                });
                // Add initial message to the new room
                await addDoc(collection(db, `artifacts/${appId}/public/data/chatRooms/${newRoomRef.id}/messages`), {
                    senderId: AI_ASSISTANT_ID,
                    senderName: AI_ASSISTANT_NAME,
                    text: `"${roomName}" 채팅방이 개설되었습니다!`,
                    timestamp: serverTimestamp()
                });

                console.log("New chat room created with ID:", newRoomRef.id);
                // Navigate to the new chat room immediately after creation
                setState({
                    currentView: 'chatMessages',
                    selectedRoomId: newRoomRef.id
                });
            } catch (error) {
                console.error("Error creating new chat room:", error);
                showModal("채팅방 생성 실패", "새 채팅방을 만드는 데 오류가 발생했습니다: " + error.message);
            }
        }

        /**
         * Sends a message to the currently selected chat room.
         * @param {string} messageText - The content of the message to send
         * @param {string} senderId - The ID of the message sender
         * @param {string} senderName - The name of the message sender
         */
        async function sendMessage(messageText, senderId, senderName) {
            console.log("sendMessage called with text:", messageText); // Debug log
            if (!state.selectedRoomId || !messageText.trim()) {
                console.error("Cannot send message: no room selected, or empty message.");
                return;
            }

            // Create a temporary message object for optimistic update
            const tempMessage = {
                id: 'temp-msg-' + Date.now() + Math.random().toString(36).substring(2, 9), // Unique temporary ID
                senderId: senderId,
                senderName: senderName,
                text: messageText,
                timestamp: { toDate: () => new Date() }, // Client-side timestamp
                isSending: true // Flag for optimistic rendering (optional, but good practice)
            };

            // Add the temporary message to the state and re-render only messages content
            state.messages.push(tempMessage);
            renderMessagesContent(); // Update UI
            scrollToBottom();

            // If in dummy mode, do not use Firestore after optimistic update
            if (!db) {
                console.warn("Firestore not available. Sent dummy message locally (optimistic update).");
                return;
            }

            if (!senderId) { // userId is set in initializeFirebase
                console.error("Cannot send message: sender not identified.");
                return;
            }

            try {
                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/chatRooms/${state.selectedRoomId}/messages`);
                const docRef = await addDoc(messagesCollectionRef, {
                    senderId: senderId,
                    senderName: senderName,
                    text: messageText,
                    timestamp: serverTimestamp()
                });

                // Update last message info in the chat room document (includes AI messages)
                const roomDocRef = doc(db, `artifacts/${appId}/public/data/chatRooms/${state.selectedRoomId}`);
                await updateDoc(roomDocRef, {
                    lastMessage: messageText,
                    lastMessageTimestamp: serverTimestamp()
                });
                console.log("Message sent and room updated (Firestore confirmed).");
            } catch (error) {
                console.error("Error sending message:", error);
                showModal("메시지 전송 실패", "메시지를 보내는 데 오류가 발생했습니다: " + error.message);
                // If send fails, remove the optimistically added message or mark as failed
                const index = state.messages.findIndex(msg => msg.id === tempMessage.id);
                if (index !== -1) {
                    state.messages.splice(index, 1); // Remove it
                    renderMessagesContent(); // Re-render to show removal
                }
            } finally {
                // Clear input and focus regardless of success/failure
                const messageInput = document.getElementById('message-input');
                if (messageInput) {
                    console.log("Before clearing input. Current value:", messageInput.value);
                    messageInput.value = ''; // Clear the input field immediately
                    console.log("After clearing input. Current value:", messageInput.value);
                    messageInput.focus(); // Focus immediately
                    console.log("Message input focused immediately.");
                } else {
                    console.log("Message input element not found in finally block.");
                }
                const replySuggestionsContainer = document.getElementById('reply-suggestions');
                if (replySuggestionsContainer) {
                    replySuggestionsContainer.innerHTML = ''; // Hide suggestions after sending
                }
            }
        }

        /**
         * Calls the Gemini LLM API.
         * @param {string} prompt - The prompt to send to the LLM
         * @returns {Promise<string>} - The LLM's response text
         */
        async function callGeminiAPI(prompt) {
            if (!db) { // Restrict AI features in dummy mode
                showModal("AI 도우미", "죄송합니다. 현재 오프라인 모드에서는 AI 도우미 기능을 사용할 수 없습니다.");
                return "현재 AI 도우미 기능을 사용할 수 없습니다.";
            }

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Automatically provided by Canvas environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API returned an unexpected structure:", result);
                    throw new Error("Gemini API 응답 구조가 예상과 다릅니다.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw new Error("Gemini API 호출 중 오류 발생: " + error.message);
            }
        }

        /**
         * Asks a question to the Gemini AI Assistant and adds the response to the chat.
         */
        async function askAIAssistant() {
            if (!db) { // Restrict AI features in dummy mode
                showModal("AI 도우미", "죄송합니다. 현재 오프라인 모드에서는 AI 도우미 기능을 사용할 수 없습니다.");
                return;
            }

            const question = await new Promise(resolve => {
                // Use custom input modal to get the question
                showModal('AI 도우미에게 질문하기', '무엇을 도와드릴까요?', true);
                const confirmButton = document.getElementById('modal-confirm-button');
                const cancelButton = document.getElementById('modal-cancel-button');
                const inputField = document.getElementById('modal-input');

                const handleConfirm = () => {
                    const value = inputField.value.trim();
                    document.getElementById('custom-input-modal-container').remove();
                    resolve(value);
                };

                const handleCancel = () => {
                    document.getElementById('custom-input-modal-container').remove();
                    resolve(null); // Return null on cancel
                };

                confirmButton.onclick = handleConfirm;
                cancelButton.onclick = handleCancel;
                inputField.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleConfirm();
                    }
                });
            });

            if (!question) {
                console.log("AI Assistant question cancelled.");
                return;
            }

            // Add user's question to chat first
            await sendMessage(question, userId, `사용자 ${userId.substring(0, 4)}`);

            // Add AI response loading message to chat
            const loadingMessageRef = await addDoc(collection(db, `artifacts/${appId}/public/data/chatRooms/${state.selectedRoomId}/messages`), {
                senderId: AI_ASSISTANT_ID,
                senderName: AI_ASSISTANT_NAME,
                text: "AI 응답 생성 중...",
                timestamp: serverTimestamp(),
                isPending: true // Flag to indicate loading state
            });

            try {
                const aiResponse = await callGeminiAPI(question);
                // Update loading message with AI response
                await updateDoc(loadingMessageRef, {
                    text: aiResponse,
                    isPending: false // Loading complete
                });
                console.log("AI Assistant responded:", aiResponse);
            } catch (error) {
                console.error("AI Assistant error:", error);
                // Update loading message with error message
                await updateDoc(loadingMessageRef, {
                    text: "AI 도우미 응답 실패: " + error.message,
                    isPending: false
                });
            }
        }

        /**
         * Generates smart reply suggestions based on recent messages in the current chat room.
         */
        async function suggestSmartReplies() {
            if (state.messages.length === 0) {
                showModal("답장 제안", "답장을 제안할 대화 내용이 없습니다.");
                return;
            }
            if (!db) { // Restrict AI features in dummy mode
                showModal("AI 도우미", "죄송합니다. 현재 오프라인 모드에서는 답장 제안 기능을 사용할 수 없습니다.");
                return;
            }

            // Get only the last 5 messages for the summary prompt
            const recentMessages = state.messages.slice(-5);
            let conversationText = "다음 채팅 대화에 대해 3가지 짧고 정중하며 관련성 있는 답장을 제안해 주세요. 답변에는 제안된 답장만 포함하고, 각 답장은 새 줄로 구분해주세요. (예: 네, 알겠습니다.\\n다른 의견 있으신가요?\\n수고하세요.):\n\n";
            recentMessages.forEach(msg => {
                const timestamp = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '';
                conversationText += `[${timestamp}] ${msg.senderName}: ${msg.text}\n`;
            });

            const replySuggestionsContainer = document.getElementById('reply-suggestions');
            if (replySuggestionsContainer) {
                replySuggestionsContainer.innerHTML = `<span class="text-gray-500 text-sm">답장 제안 생성 중...</span>`;
            }

            try {
                const rawSuggestions = await callGeminiAPI(conversationText);
                const suggestions = rawSuggestions.split('\n').filter(s => s.trim() !== '').slice(0, 3); // Use max 3 suggestions

                if (replySuggestionsContainer) {
                    replySuggestionsContainer.innerHTML = ''; // Clear existing loading message
                    if (suggestions.length > 0) {
                        suggestions.forEach(s => {
                            const suggestionSpan = document.createElement('span');
                            suggestionSpan.className = 'bg-[#e0eaf5] text-[#264790] text-sm px-3 py-1 rounded-full cursor-pointer hover:bg-[#cce0f0] transition-colors whitespace-nowrap shadow-sm';
                            suggestionSpan.textContent = s.trim();
                            suggestionSpan.onclick = () => {
                                const messageInput = document.getElementById('message-input');
                                if (messageInput) {
                                    messageInput.value = s.trim();
                                    messageInput.focus(); // Keep focus after inserting suggestion
                                }
                                replySuggestionsContainer.innerHTML = ''; // Hide suggestions after selection
                            };
                            replySuggestionsContainer.appendChild(suggestionSpan);
                        });
                    } else {
                        replySuggestionsContainer.innerHTML = `<span class="text-gray-500 text-sm">제안된 답장이 없습니다.</span>`;
                    }
                }
            } catch (error) {
                console.error("Failed to suggest replies:", error);
                if (replySuggestionsContainer) {
                    replySuggestionsContainer.innerHTML = `<span class="text-red-500 text-sm">답장 제안 실패: ${error.message}</span>`;
                }
            }
        }


        /**
         * Displays a custom modal message.
         * @param {string} title - Modal title
         * @param {string} message - Modal message content (can be HTML string)
         * @param {boolean} withInput - Whether to include an input field (default: false)
         * @returns {Promise<string|null>} - The input value or null (for input modals)
         */
        function showModal(title, message, withInput = false) {
            return new Promise(resolve => {
                const modalContainerId = withInput ? 'custom-input-modal-container' : 'modal-container';
                const existingModal = document.getElementById(modalContainerId);
                if (existingModal) existingModal.remove(); // Remove any previously open modal

                const body = document.body;
                const div = document.createElement('div');
                div.id = modalContainerId;
                div.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[2000]';

                let inputHtml = '';
                if (withInput) {
                    inputHtml = `<input type="text" id="modal-input" placeholder="여기에 입력하세요" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-[#264790] text-gray-800">`;
                }

                div.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">${title}</h3>
                        <div class="text-gray-600 mb-4">${message}</div>
                        ${inputHtml}
                        <div class="flex justify-end space-x-3">
                            ${withInput ? `<button id="modal-cancel-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-75 rounded-md">취소</button>` : ''}
                            <button id="modal-confirm-button" class="bg-[#264790] hover:bg-[#345c9a] text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-[#264790] focus:ring-opacity-75 rounded-md">확인</button>
                        </div>
                    </div>
                `;
                body.appendChild(div);

                const confirmButton = document.getElementById('modal-confirm-button');
                const cancelButton = document.getElementById('modal-cancel-button');
                const inputField = document.getElementById('modal-input');

                confirmButton.onclick = () => {
                    const value = withInput ? inputField.value.trim() : null;
                    if (withInput && !value) {
                         inputField.placeholder = "내용을 입력해야 합니다!";
                         inputField.classList.add('border-red-500');
                         inputField.focus();
                         return;
                    }
                    div.remove();
                    resolve(value);
                };

                if (cancelButton) {
                    cancelButton.onclick = () => {
                        div.remove();
                        resolve(null);
                    };
                }

                if (inputField) {
                    inputField.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            confirmButton.click(); // Click confirm button on Enter key press
                        }
                    });
                }
            });
        }


        /**
         * Updates the global state and triggers UI re-rendering.
         * @param {object} newState - The new state object to merge
         */
        function setState(newState) {
            const prevState = { ...state }; // Capture previous state for comparison
            Object.assign(state, newState); // Merge new state into current state

            // Only re-render the whole window if major view changes or chat open/close
            if (newState.isChatOpen !== prevState.isChatOpen || newState.isMaximized !== prevState.isMaximized) {
                renderChatWindow(); // Full re-render if chat open/close or maximization changes
            }

            // Update dynamic content and element visibility based on currentView
            const dynamicContentArea = document.getElementById('dynamic-content');
            const chatHeaderTitle = document.getElementById('chat-header-title');
            const backButton = document.getElementById('back-button');
            const messageInputBar = document.getElementById('message-input-bar');
            const bottomNavBar = document.getElementById('bottom-nav-bar');

            // Handle header title and back button visibility
            if (state.currentView === 'chatMessages' || state.currentView === 'opponentProfile') {
                 if (backButton) backButton.style.display = 'block';
                 chatHeaderTitle.textContent = state.currentView === 'chatMessages' ?
                                               (state.chatRooms.find(r => r.id === state.selectedRoomId)?.name || '채팅방') :
                                               '프로필 정보';
            } else {
                 if (backButton) backButton.style.display = 'none';
                 chatHeaderTitle.textContent = state.currentView === 'home' ? '홈' : '대화';
            }


            // Handle message input bar and bottom nav bar visibility
            if (state.currentView === 'chatMessages') {
                if (messageInputBar) messageInputBar.style.display = 'flex';
                if (bottomNavBar) bottomNavBar.style.display = 'none';
                // Immediately focus the input when entering a chat room
                const messageInput = document.getElementById('message-input');
                if (messageInput) {
                    setTimeout(() => messageInput.focus(), 0);
                }
            } else {
                if (messageInputBar) messageInputBar.style.display = 'none';
                if (bottomNavBar) bottomNavBar.style.display = 'flex';
            }

            // Render dynamic content
            if (state.currentView === 'home') {
                renderHomeView(dynamicContentArea);
            } else if (state.currentView === 'chatRooms') {
                renderChatRoomsView(dynamicContentArea);
            } else if (state.currentView === 'chatMessages') {
                renderMessagesContent(); // Only render messages content here
            } else if (state.currentView === 'opponentProfile') {
                renderOpponentProfileView(dynamicContentArea);
            }

            // Re-setup listeners based on new state, only if Firebase is ready and DB is initialized
            if (isAuthReady && db) {
                setupFirestoreListeners();
            }
        }

        /**
         * Renders the floating chat button.
         */
        function renderChatButton() {
            const container = document.getElementById('chat-float-button-container');
            container.innerHTML = `
                <button id="toggle-chat-button"
                        class="bg-[#264790] hover:bg-[#345c9a] text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105
                                focus:outline-none focus:ring-2 focus:ring-[#264790] focus:ring-opacity-75">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                </button>
            `;
            document.getElementById('toggle-chat-button').onclick = () => setState({ isChatOpen: !state.isChatOpen });
        }

        /**
         * Renders the main chat window.
         * This function now renders the static shell of the chat window.
         * Dynamic content and bar visibility are handled in setState.
         */
        function renderChatWindow() {
            const container = document.getElementById('chat-window-container');
            if (!state.isChatOpen) {
                container.innerHTML = '';
                cleanupFirestoreListeners(); // Unsubscribe listeners when chat is closed
                return;
            }

            // Show loading message if Firebase is not ready (or dummy data is being prepared)
            if (!isAuthReady) {
                 container.innerHTML = `
                    <div class="SR_chat-window bg-white shadow-xl flex flex-col">
                        <div class="flex items-center justify-center h-full text-gray-500">
                            로딩 중...
                        </div>
                    </div>
                `;
                return;
            }
            
            // Set chat window class based on maximization state
            const maximizedClass = state.isMaximized ? 'SR_is-maximized' : '';

            // Render the static shell of the chat window
            container.innerHTML = `
                <div id="chat-actual-window" class="SR_chat-window bg-white shadow-xl flex flex-col border border-gray-200 ${maximizedClass}">
                    <!-- Chat window header (STATIC) -->
                    <div class="bg-gradient-to-r from-[#1e3c64] to-[#264790] text-white p-4 rounded-t-xl flex items-center shadow-md">
                        <button id="back-button" class="p-1 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors" style="display: none;">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </button>
                        <h2 id="chat-header-title" class="text-lg font-semibold truncate flex-grow text-center"></h2>
                        <!-- Maximize and Close buttons -->
                        <div class="flex items-center space-x-2 ml-auto">
                            <button id="maximize-chat-button"
                                    class="p-1 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors"
                                    title="${state.isMaximized ? '원래대로' : '전체 화면'}">
                                ${state.isMaximized ? `
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5"></path>
                                    </svg>
                                ` : `
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m7-7h4m0 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m7 7h4m0 0v-4m0 4l-5-5"></path>
                                    </svg>
                                `}
                            </button>
                            <button id="close-chat-button"
                                    class="p-1 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors"
                                    title="닫기">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Dynamic Content Area -->
                    <div id="dynamic-content" class="flex-grow flex flex-col bg-white rounded-b-xl overflow-hidden">
                        <!-- Content will be rendered dynamically by setState -->
                    </div>

                    <!-- Message Input Bar (STATIC, display controlled by JS) -->
                    <div id="message-input-bar" class="bg-gray-100 p-2 border-t border-gray-200 flex-col" style="display: none;">
                        <div class="flex items-end space-x-1.5">
                            <button class="p-1.5 rounded-full text-gray-600 hover:bg-gray-200 transition-colors flex-shrink-0">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9v-2h2v2zm0-4H9V7h2v6zm5-2v2h-2v-2h2zm0-4v2h-2v-2h2z"></path>
                                </svg>
                            </button>
                            <input type="text" id="message-input" placeholder="메시지를 입력하세요..."
                                   class="flex-grow min-w-0 p-2 text-sm rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#264790] bg-white text-gray-800">
                            <button id="ai-assistant-button"
                                    class="p-1.5 rounded-full text-[#4a72b0] hover:bg-[#e0eaf5] transition-colors flex-shrink-0"
                                    title="AI 도우미 ✨">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                                </svg>
                            </button>
                            <button id="suggest-replies-button"
                                    class="p-1.5 rounded-full text-[#4a72b0] hover:bg-[#e0eaf5] transition-colors flex-shrink-0"
                                    title="답장 제안 ✨">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"></path>
                                </svg>
                            </button>
                            <button id="send-message-button"
                                    class="bg-[#264790] hover:bg-[#345c9a] text-white w-9 h-9 rounded-full flex items-center justify-center transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-[#264790] focus:ring-opacity-75 flex-shrink-0">
                                <svg class="w-4 h-4 -rotate-45" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l.649-.187a1 1 0 00.569-.953V9.418c0-.528.261-1.026.713-1.332.083-.057.172-.1.261-.137.089-.037.18-.063.272-.078a1 1 0 00.569.953l.649.187a1 1 0 001.169 1.409l7-14a1 1 0 00-1.788 0z" clip-rule="evenodd"></path>
                            </svg>
                            </button>
                        </div>
                        <div id="reply-suggestions" class="flex flex-wrap gap-1.5 mt-1.5"></div>
                    </div>

                    <!-- Bottom navigation (STATIC, display controlled by JS) -->
                    <div id="bottom-nav-bar" class="bg-white border-t border-gray-200 py-1.5 flex justify-around items-center shadow-inner" style="display: flex;">
                        <button id="nav-home-button" class="flex flex-col items-center p-1.5">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>
                            <span class="text-xs mt-1">홈</span>
                        </button>
                        <button id="nav-chats-button" class="flex flex-col items-center p-1.5">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 2H4C2.9 2 2 2.9 2 4v18l4-4h14c1.1 0 2-0.9 2-2V4C22 2.9 21.1 2 20 2z"></path></svg>
                            <span class="text-xs mt-1">대화</span>
                        </button>
                        <button id="nav-settings-button" class="flex flex-col items-center p-1.5 text-gray-500 hover:text-[#264790] transition-colors">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8c1.1 0 2-0.9 2-2s-0.9-2-2-2-2 0.9-2 2 0.9 2 2 2zm0 2c-1.1 0-2 0.9-2 2s0.9 2 2 2 2-0.9 2-2-0.9-2-2-2zm0 6c-1.1 0-2 0.9-2 2s0.9 2 2 2 2-0.9 2-2-0.9-2-2-2z"></path></svg>
                            <span class="text-xs mt-1">설정</span>
                        </button>
                    </div>

                    <!-- Current User ID display (STATIC) -->
                    <div class="bg-gray-100 text-gray-600 text-xs p-2 text-center border-t border-gray-200">
                        내 ID: <span class="font-mono text-gray-800 break-all">${userId || '로딩 중...'}</span>
                    </div>
                </div>
            `;
            // Attach event listeners for the static elements after rendering them
            document.getElementById('close-chat-button').onclick = () => {
                setState({ isChatOpen: false, isMaximized: false }); // Reset maximize state on close
            };
            document.getElementById('maximize-chat-button').onclick = () => {
                setState({ isMaximized: !state.isMaximized });
            };

            // These navigation buttons are now always present, but their appearance changes
            document.getElementById('nav-home-button').onclick = () => {
                setState({ currentView: 'home', selectedRoomId: null, messages: [], selectedOpponentId: null });
            };
            document.getElementById('nav-chats-button').onclick = () => {
                setState({ currentView: 'chatRooms', selectedRoomId: null, messages: [], selectedOpponentId: null });
            };
            document.getElementById('nav-settings-button').onclick = () => {
                showModal("설정", "설정 페이지 기능은 아직 구현되지 않았습니다.");
            };

            // Back button logic will be set here, but its display is managed in setState
            const backButton = document.getElementById('back-button');
            if (backButton) { // Ensure button exists before attaching handler
                backButton.onclick = () => {
                    if (state.currentView === 'opponentProfile') {
                        setState({ currentView: 'chatMessages', selectedOpponentId: null });
                    } else if (state.currentView === 'chatMessages') {
                        setState({ currentView: 'chatRooms', selectedRoomId: null, messages: [], isMaximized: false });
                    }
                };
            }

            // Attach listeners for the message input bar elements once, as they are persistent
            attachMessageInputListeners();
        }

        /**
         * Renders the Home view with user profile, portfolio, and outsourcing information.
         * @param {HTMLElement} parentElement - The parent element where the home view will be rendered
         */
        function renderHomeView(parentElement) {
            parentElement.innerHTML = `
                <div class="flex-grow flex flex-col p-3 overflow-y-auto SR_chat-scroll-area">
                    <!-- User Profile Section -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex items-center space-x-3">
                        <img src="https://e7.pngegg.com/pngimages/816/90/png-clipart-computer-icons-facebook-inc-like-button-facebook-blue-logo.png" alt="기업 로고" class="w-16 h-16 rounded-full object-cover border-2 border-[#264790] flex-shrink-0">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">김철수</h3>
                            <p class="text-sm text-gray-600">ABC 솔루션 (기업회원)</p>
                            <p class="text-xs text-gray-500 mt-1">"혁신적인 솔루션으로 미래를 만듭니다."</p>
                        </div>
                    </div>

                    <!-- Portfolio Information Section -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <h3 class="text-base font-semibold text-gray-800 mb-3">포트폴리오 정보</h3>
                        <div class="relative">
                            <div id="portfolio-carousel" class="flex overflow-x-auto SR_hide-scrollbar snap-x snap-mandatory pb-3 -mx-1">
                                <!-- Portfolio items -->
                                ${dummyPortfolios.map(p => `
                                    <div class="flex-shrink-0 w-52 snap-center mx-1 p-2 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
                                        <img src="${p.imageUrl}" alt="${p.title}" class="w-full h-24 object-cover rounded-md mb-2">
                                        <h4 class="font-semibold text-sm text-gray-800 truncate">${p.title}</h4>
                                        <p class="text-xs text-gray-600 line-clamp-2">${p.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                            <button id="home-portfolio-scroll-left" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-1 rounded-full z-10 hidden md:block">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <button id="home-portfolio-scroll-right" class="absolute right-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity50 text-white p-1 rounded-full z-10 hidden md:block">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Outsourcing Information Section -->
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-base font-semibold text-gray-800 mb-3">외주 정보</h3>
                        <div class="relative">
                            <div id="outsourcing-carousel" class="flex overflow-x-auto SR_hide-scrollbar snap-x snap-mandatory pb-3 -mx-1">
                                <!-- Outsourcing items -->
                                ${dummyOutsourcings.map(o => `
                                    <div class="flex-shrink-0 w-52 snap-center mx-1 p-2 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
                                        <h4 class="font-semibold text-sm text-gray-800 truncate">${o.title}</h4>
                                        <p class="text-xs text-gray-600 line-clamp-2 mb-1">${o.description}</p>
                                        <span class="text-xs font-medium ${o.status === '진행 중' ? 'text-[#264790]' : o.status === '대기 중' ? 'text-yellow-600' : 'text-green-600'}">상태: ${o.status}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <button id="home-outsourcing-scroll-left" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-1 rounded-full z-10 hidden md:block">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <button id="home-outsourcing-scroll-right" class="absolute right-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity50 text-white p-1 rounded-full z-10 hidden md:block">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Setup scroll event listeners for carousels
            const portfolioCarousel = document.getElementById('portfolio-carousel');
            const outsourcingCarousel = document.getElementById('outsourcing-carousel');

            if (portfolioCarousel) {
                document.getElementById('home-portfolio-scroll-left').onclick = () => {
                    portfolioCarousel.scrollBy({ left: -200, behavior: 'smooth' }); // Scroll left by 200px
                };
                document.getElementById('home-portfolio-scroll-right').onclick = () => {
                    portfolioCarousel.scrollBy({ left: 200, behavior: 'smooth' }); // Scroll right by 200px
                };
            }
            if (outsourcingCarousel) {
                document.getElementById('home-outsourcing-scroll-left').onclick = () => {
                    outsourcingCarousel.scrollBy({ left: -200, behavior: 'smooth' }); // Scroll left by 200px
                };
                document.getElementById('home-outsourcing-scroll-right').onclick = () => {
                    outsourcingCarousel.scrollBy({ left: 200, behavior: 'smooth' }); // Scroll right by 200px
                };
            }
        }


        /**
         * Renders the chat room list view.
         * @param {HTMLElement} parentElement - The parent element where the chat room list will be rendered
         */
        function renderChatRoomsView(parentElement) {
            parentElement.innerHTML = `
                <div class="flex-grow flex flex-col p-3 overflow-y-auto SR_chat-scroll-area">
                    ${state.chatRooms.length === 0 ? `
                        <div class="flex flex-col items-center justify-center h-full text-gray-500 text-center space-y-3">
                            <svg class="w-14 h-14 text-gray-300" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 2H4C2.9 2 2 2.9 2 4v18l4-4h14c1.1 0 2-0.9 2-2V4C22 2.9 21.1 2 20 2zM9 10v2H7v-2h2zM13 10v2h-2v-2h2zM17 10v2h-2v-2h2z"></path>
                            </svg>
                            <p class="text-sm">대화를 시작해보세요</p>
                            <button id="start-new-chat-button"
                                    class="bg-[#264790] hover:bg-[#345c9a] text-white font-bold py-2 px-4 rounded-full shadow-md transition-transform duration-200 transform hover:scale-105 flex items-center space-x-1">
                                <span class="text-base">새 문의하기</span>
                                <svg class="w-4 h-4 -rotate-45" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l.649-.187a1 1 0 00.569-.953V9.418c0-.528.261-1.026.713-1.332.083-.057.172-.1.261-.137.089-.037.18-.063.272-.078a1 1 0 00.569.953l.649.187a1 1 0 001.169 1.409l7-14a1 1 0 00-1.788 0z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    ` : ''}

                    ${state.chatRooms.map(room => `
                        <div class="SR_chat-room-item bg-white p-3 my-2 rounded-lg shadow-sm hover:shadow-md cursor-pointer transition-all duration-200 border border-gray-100" data-room-id="${room.id}">
                            <div class="flex items-center space-x-2">
                                <!-- Platform Logo Placeholder -->
                                <img src="https://i.imgur.com/PdAzAFe.jpg" alt="플랫폼 로고" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                                <div class="flex-grow min-w-0">
                                    <div class="flex justify-between items-center mb-1">
                                        <h3 class="font-semibold text-sm text-gray-800 truncate">${room.name || '알 수 없는 채팅방'}</h3>
                                        <span class="text-xs text-gray-500 flex-shrink-0 ml-1">${room.lastMessageTimestamp ? new Date(room.lastMessageTimestamp.toDate()).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : ''}</span>
                                    </div>
                                    <p class="text-xs text-gray-600 truncate">${room.lastMessage || '새로운 대화를 시작해보세요.'}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // 'Start New Chat' button click event listener (only if the button exists)
            if (document.getElementById('start-new-chat-button')) {
                document.getElementById('start-new-chat-button').onclick = () => {
                    showModal('새 채팅방 만들기', '새로운 채팅방의 이름을 입력해주세요:', true);
                };
            }

            // Click event listener for each chat room item
            document.querySelectorAll('.SR_chat-room-item').forEach(item => {
                item.onclick = (e) => {
                    const roomId = e.currentTarget.dataset.roomId;
                    setState({ currentView: 'chatMessages', selectedRoomId: roomId });
                };
            });
        }

        /**
         * Renders the message content area (excluding the input bar).
         */
        function renderMessagesContent() {
            const chatMessagesDiv = document.getElementById('dynamic-content'); // This is now the container for messages
            if (!chatMessagesDiv) return;

            chatMessagesDiv.innerHTML = `
                <div id="chat-messages" class="flex-grow p-3 overflow-y-auto SR_chat-scroll-area SR_hide-scrollbar">
                    ${state.messages.length === 0 ? `
                        <div class="flex flex-col items-center justify-center h-full text-gray-500 text-center">
                            <svg class="w-14 h-14 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 2H4C2.9 2 2 2.9 2 4v18l4-4h14c1.1 0 2-0.9 2-2V4C22 2.9 21.1 2 20 2zM9 10v2H7v-2h2zM13 10v2h-2v-2h2zM17 10v2h-2v-2h2z"></path>
                            </svg>
                            <p class="mt-1 text-sm">메시지가 없습니다. 대화를 시작해보세요!</p>
                        </div>
                    ` : ''}

                    ${state.messages.map(msg => `
                        <div class="flex ${msg.senderId === userId ? 'justify-end' : 'justify-start'} mb-3">
                            <div class="flex items-end ${msg.senderId === userId ? 'flex-row-reverse' : ''} max-w-[85%]">
                                <!-- Opponent/AI profile initial (only shown for non-user messages) -->
                                <div class="SR_chat-profile-initial w-7 h-7 ${msg.senderId === userId ? 'hidden' : ''} ${msg.senderId === AI_ASSISTANT_ID ? 'bg-[#e0eaf5] text-[#264790]' : 'bg-gray-200 text-gray-600'} rounded-full flex items-center justify-center text-xs ${msg.senderId === userId ? 'ml-2' : 'mr-2'} flex-shrink-0 cursor-pointer"
                                     data-sender-id="${msg.senderId}">
                                    ${msg.senderName ? msg.senderName.charAt(0).toUpperCase() : '?'}
                                </div>
                                
                                <div class="p-2 rounded-t-lg text-xs shadow-sm
                                    ${msg.senderId === userId ? 'bg-[#264790] text-white rounded-bl-lg' : 'bg-gray-200 text-gray-800 rounded-br-lg'}">
                                    <span class="block font-medium text-xxs mb-0.5
                                        ${msg.senderId === userId ? 'hidden' : ''}
                                        ${msg.senderId === AI_ASSISTANT_ID ? 'text-[#264790]' : 'text-gray-700'}">
                                        ${msg.senderName}
                                    </span>
                                    ${msg.text}
                                    <div class="text-xxs mt-0.5 text-right
                                        ${msg.senderId === userId ? 'text-[#cce0f0]' : 'text-gray-500'}">
                                        ${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            scrollToBottom();

            // Profile click event (opponent)
            const profileInitials = chatMessagesDiv.querySelectorAll('.SR_chat-profile-initial');
            profileInitials.forEach(element => {
                element.addEventListener('click', (event) => {
                    const senderId = event.currentTarget.dataset.senderId;
                    setState({ currentView: 'opponentProfile', selectedOpponentId: senderId });
                });
            });
        }

        /**
         * Attaches event listeners to the message input elements.
         * This function should be called every time the message input bar's parent (chat-actual-window) is re-rendered.
         * It no longer uses a flag to ensure re-attachment on new elements.
         */
        function attachMessageInputListeners() {
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-message-button');
            const aiAssistantButton = document.getElementById('ai-assistant-button');
            const suggestRepliesButton = document.getElementById('suggest-replies-button');

            console.log("attachMessageInputListeners called."); // Debug log

            // Ensure elements exist before attaching listeners
            if (!messageInput || !sendButton) {
                console.warn("Message input or send button not found for attaching listeners. Will retry on next render.");
                return;
            }

            const send = async () => {
                console.log("Send function triggered."); // Debug log
                const text = messageInput.value.trim();
                if (text) {
                    console.log("Sending message:", text); // Debug log
                    await sendMessage(text, userId, `사용자 ${userId.substring(0, 4)}`);
                } else {
                    console.log("Attempted to send empty message."); // Debug log
                }
            };

            const handleMessageInputKeypress = (e) => {
                if (e.key === 'Enter') {
                    console.log("Enter key pressed in message input."); // Debug log
                    e.preventDefault();
                    send();
                }
            };
            const handleSendMessageClick = () => {
                console.log("Send button clicked."); // Debug log
                send();
            };
            const handleMessageInput = () => {
                const replySuggestionsContainer = document.getElementById('reply-suggestions');
                if (replySuggestionsContainer && replySuggestionsContainer.innerHTML !== '') {
                    console.log("User started typing, hiding suggestions."); // Debug log
                    replySuggestionsContainer.innerHTML = '';
                }
            };

            // Attach new listeners to the currently existing elements
            messageInput.addEventListener('keypress', handleMessageInputKeypress);
            sendButton.addEventListener('click', handleSendMessageClick);
            if (aiAssistantButton) aiAssistantButton.addEventListener('click', askAIAssistant);
            if (suggestRepliesButton) suggestRepliesButton.addEventListener('click', suggestSmartReplies);
            if (messageInput) messageInput.addEventListener('input', handleMessageInput);

            console.log("Listeners re-attached to new elements."); // Debug log
        }


        /**
         * Renders the opponent's profile view.
         * @param {HTMLElement} parentElement - The parent element where the profile view will be rendered
         */
        function renderOpponentProfileView(parentElement) {
            if (!state.selectedOpponentId) {
                parentElement.innerHTML = `<div class="flex-grow flex items-center justify-center text-gray-500">프로필 정보를 찾을 수 없습니다.</div>`;
                return;
            }

            const profile = dummyUserProfiles[state.selectedOpponentId];
            let profileContentHtml = '';

            // This structure mimics the user profile section in renderHomeView
            if (profile) {
                profileContentHtml = `
                    <div class="flex-grow flex flex-col p-3 overflow-y-auto SR_chat-scroll-area">
                        <!-- User Profile Section (Opponent's) -->
                        <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex flex-col items-center">
                            <img src="${profile.profileImageUrl}" alt="${profile.name}" class="w-20 h-20 rounded-full object-cover border-2 border-[#264790] mb-3">
                            <h3 class="text-lg font-bold text-gray-800">${profile.name}</h3>
                            <p class="text-sm text-gray-600">${profile.company}</p>
                            <p class="text-xs text-gray-500 mt-1 text-center">"${profile.description}"</p>
                        </div>

                        <!-- Portfolio Information Section (All dummy portfolios for demonstration) -->
                        <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                            <h3 class="text-base font-semibold text-gray-800 mb-3">포트폴리오 정보</h3>
                            <div class="relative">
                                <div id="opponent-portfolio-carousel" class="flex overflow-x-auto SR_hide-scrollbar snap-x snap-mandatory pb-3 -mx-1">
                                    ${dummyPortfolios.map(p => `
                                        <div class="flex-shrink-0 w-52 snap-center mx-1 p-2 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
                                            <img src="${p.imageUrl}" alt="${p.title}" class="w-full h-24 object-cover rounded-md mb-2">
                                            <h4 class="font-semibold text-sm text-gray-800 truncate">${p.title}</h4>
                                            <p class="text-xs text-gray-600 line-clamp-2">${p.description}</p>
                                        </div>
                                    `).join('')}
                                </div>
                                <button id="opponent-portfolio-scroll-left" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-1 rounded-full z-10 hidden md:block">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <button id="opponent-portfolio-scroll-right" class="absolute right-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-1 rounded-full z-10 hidden md:block">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                        </div>

                        <!-- Outsourcing Information Section (All dummy outsourcings for demonstration) -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-base font-semibold text-gray-800 mb-3">외주 정보</h3>
                            <div class="relative">
                                <div id="opponent-outsourcing-carousel" class="flex overflow-x-auto SR_hide-scrollbar snap-x snap-mandatory pb-3 -mx-1">
                                    ${dummyOutsourcings.map(o => `
                                        <div class="flex-shrink-0 w-52 snap-center mx-1 p-2 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
                                            <h4 class="font-semibold text-sm text-gray-800 truncate">${o.title}</h4>
                                            <p class="text-xs text-gray-600 line-clamp-2 mb-1">${o.description}</p>
                                            <span class="text-xs font-medium ${o.status === '진행 중' ? 'text-[#264790]' : o.status === '대기 중' ? 'text-yellow-600' : 'text-green-600'}">상태: ${o.status}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <button id="opponent-outsourcing-scroll-left" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-1 rounded-full z-10 hidden md:block">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <button id="opponent-outsourcing-scroll-right" class="absolute right-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-1 rounded-full z-10 hidden md:block">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.selectedOpponentId === userId) {
                 // Fallback for current user's own profile if clicked
                 profileContentHtml = `
                    <div class="flex-grow flex flex-col p-3 overflow-y-auto SR_chat-scroll-area">
                        <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex flex-col items-center">
                            <img src="https://placehold.co/80x80/28a745/ffffff?text=ME" alt="나의 프로필" class="w-20 h-20 rounded-full object-cover border-2 border-[#264790] mb-3">
                            <h3 class="text-lg font-bold text-gray-800">나 (김철수)</h3>
                            <p class="text-sm text-gray-600">ABC 솔루션 (기업회원)</p>
                            <p class="text-xs text-gray-500 mt-1 text-center">"혁신적인 솔루션으로 미래를 만듭니다."</p>
                        </div>

                        <!-- Portfolio Information Section (My Portfolios) -->
                        <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                            <h3 class="text-base font-semibold text-gray-800 mb-3">나의 포트폴리오 정보</h3>
                            <div class="relative">
                                <div id="opponent-portfolio-carousel" class="flex overflow-x-auto SR_hide-scrollbar snap-x snap-mandatory pb-3 -mx-1">
                                    ${dummyPortfolios.map(p => `
                                        <div class="flex-shrink-0 w-52 snap-center mx-1 p-2 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
                                            <img src="${p.imageUrl}" alt="${p.title}" class="w-full h-24 object-cover rounded-md mb-2">
                                            <h4 class="font-semibold text-sm text-gray-800 truncate">${p.title}</h4>
                                            <p class="text-xs text-gray-600 line-clamp-2">${p.description}</p>
                                        </div>
                                    `).join('')}
                                </div>
                                <button id="opponent-portfolio-scroll-left" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-1 rounded-full z-10 hidden md:block">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <button id="opponent-portfolio-scroll-right" class="absolute right-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-1 rounded-full z-10 hidden md:block">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                        </div>

                        <!-- Outsourcing Information Section (My Outsourcing) -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-base font-semibold text-gray-800 mb-3">나의 외주 정보</h3>
                            <div class="relative">
                                <div id="opponent-outsourcing-carousel" class="flex overflow-x-auto SR_hide-scrollbar snap-x snap-mandatory pb-3 -mx-1">
                                    ${dummyOutsourcings.map(o => `
                                        <div class="flex-shrink-0 w-52 snap-center mx-1 p-2 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
                                            <h4 class="font-semibold text-sm text-gray-800 truncate">${o.title}</h4>
                                            <p class="text-xs text-gray-600 line-clamp-2 mb-1">${o.description}</p>
                                            <span class="text-xs font-medium ${o.status === '진행 중' ? 'text-[#264790]' : o.status === '대기 중' ? 'text-yellow-600' : 'text-green-600'}">상태: ${o.status}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <button id="opponent-outsourcing-scroll-left" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-1 rounded-full z-10 hidden md:block">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <button id="opponent-outsourcing-scroll-right" class="absolute right-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-1 rounded-full z-10 hidden md:block">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            else {
                 profileContentHtml = `<div class="flex-grow flex items-center justify-center text-gray-500">사용자 프로필을 찾을 수 없습니다.</div>`;
            }

            parentElement.innerHTML = profileContentHtml;

            // Setup scroll event listeners for carousels in opponent profile view
            const opponentPortfolioCarousel = document.getElementById('opponent-portfolio-carousel');
            const opponentOutsourcingCarousel = document.getElementById('opponent-outsourcing-carousel');

            if (opponentPortfolioCarousel) {
                document.getElementById('opponent-portfolio-scroll-left').onclick = () => {
                    opponentPortfolioCarousel.scrollBy({ left: -200, behavior: 'smooth' });
                };
                document.getElementById('opponent-portfolio-scroll-right').onclick = () => {
                    opponentOutsourcingCarousel.scrollBy({ left: 200, behavior: 'smooth' });
                };
            }
            if (opponentOutsourcingCarousel) {
                document.getElementById('opponent-outsourcing-scroll-left').onclick = () => {
                    opponentOutsourcingCarousel.scrollBy({ left: -200, behavior: 'smooth' });
                };
                document.getElementById('opponent-outsourcing-scroll-right').onclick = () => {
                    opponentOutsourcingCarousel.scrollBy({ left: 200, behavior: 'smooth' });
                };
            }
        }


        // Function to render the entire app
        function render() {
            renderChatButton();
            renderChatWindow(); // This now renders the static shell and sets up initial listeners
        }


        // Start Firebase initialization and app rendering when the window loads
        window.onload = function() {
            initializeFirebase();
            render(); // Initial button render
        };
    </script>
</div>
</html>