<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{user/layout/userLayoutMain}">
<head>
<meta name="description" content="한국스마트정보교육원 팀프로젝트" />
<!-- 토스페이먼츠 API JS -->
<script src="https://js.tosspayments.com/v1"></script>

</head>
<body>
	<th:block layout:fragment="contents">
		<script th:inline="javascript">
	    // --- 1. 결제 요청 로직 (Toss Payments) ---
	    document.addEventListener("DOMContentLoaded", function () {
	        const tossPayments = TossPayments("test_ck_ORzdMaqN3wPvMzNqXLNqV5AkYXQG");
	        const paymentButton = document.getElementById("payment-button");
	        
	        paymentButton.addEventListener("click", function (e) {
	            e.preventDefault();
	            const memberCode = /*[[${session.SCD}]]*/ null;

	            if (!memberCode) {
	                alert("로그인 후 이용해주세요.");
	                window.location.href = '/login';
	                return;
	            }
	            
	            let selectedProductRow;
	            let orderCount = 0;
	            document.querySelectorAll('.product-row').forEach(row => {
	                const quantity = parseInt(row.querySelector('.qty-val').value, 10);
	                if (quantity > 0) {
	                    selectedProductRow = row;
	                    orderCount = quantity;
	                }
	            });
	            
	            if (!selectedProductRow) {
	                alert("상품 수량을 1개 이상 선택해주세요.");
	                return;
	            }

	            const grdCd = selectedProductRow.querySelector('input[name="gdsCd"]').value;
	            const usedMileage = document.getElementById('usedMileage').value || 0;
	            const originAmount = parseInt(selectedProductRow.getAttribute('data-price')) * orderCount;
	            const finalAmount = Math.max(0, originAmount - parseInt(usedMileage, 10));

	            tossPayments.requestPayment("카드", {
	                amount: finalAmount,
	                orderId: "ORDER_" + Date.now(),
	                orderName: selectedProductRow.querySelector('h6').textContent.trim(),
	                customerName: "고객", // 실제로는 세션에서 가져온 회원 이름 사용
	                successUrl: `http://localhost/user/paymentSuccess?usedMileage=${usedMileage}&grdCd=${grdCd}&orderCount=${orderCount}&originAmount=${originAmount}&mbrCd=${memberCode}`,
	                failUrl: "http://localhost/user/paymentFail"
	            });
	        });
	    });
	 
	    // --- 2. 화면 UI 및 금액 계산 로직 ---
	    document.addEventListener("DOMContentLoaded", function () {
	        const subsBox = document.querySelector(".subs-product");
	        const ticketBox = document.querySelector(".ticket-product");

	        const unitSubsPrice = subsBox ? parseInt(subsBox.getAttribute('data-price'), 10) : 0;
	        const unitTicketPrice = ticketBox ? parseInt(ticketBox.getAttribute('data-price'), 10) : 0;

	        const subsUnitValue = subsBox ? parseInt(subsBox.getAttribute('data-unit-value'), 10) : 30;
	        const ticketUnitValue = ticketBox ? parseInt(ticketBox.getAttribute('data-unit-value'), 10) : 3;
	        const subsUnitName = subsBox ? subsBox.getAttribute('data-unit-name') : '일';
	        const ticketUnitName = ticketBox ? ticketBox.getAttribute('data-unit-name') : '회';

	        const subsInput = document.getElementById('subsQuantity');
	        const ticketInput = document.getElementById('ticketQuantity');
	        
	        const daysEl = document.querySelector(".days-display");
	        const timesEl = document.querySelector(".times-display");
	        
	        const subsPriceEl = subsBox?.querySelectorAll(".text-body")[1];
	        const ticketPriceEl = ticketBox?.querySelectorAll(".text-body")[1];
	        
	        const totalPriceEl = document.querySelectorAll(".cart_total_amount h4.text-brand")[0];
	        const finalPriceEl = document.querySelectorAll(".cart_total_amount h4.text-brand")[1];
	        const mileageInput = document.getElementById('usedMileage');

	        function getVal(input) {
	            if (!input) return 0;
	            const val = parseInt(input.value);
	            return isNaN(val) ? 0 : val;
	        }
	        
	        function formatCurrency(num) {
				return "₩" + num.toLocaleString("ko-KR");
			}
	        
	        function updateText() {
	            const subsQty = getVal(subsInput);
	            const ticketQty = getVal(ticketInput);
	            
	            const subsTotal = subsQty * unitSubsPrice;
	            const ticketTotal = ticketQty * unitTicketPrice;
	            const total = subsTotal + ticketTotal;
	            
	            if(daysEl) daysEl.innerHTML = (subsQty > 0 ? (subsQty * subsUnitValue) : '0') + ` <span>${subsUnitName}</span>`;
	            if(timesEl) timesEl.innerHTML = (ticketQty > 0 ? (ticketQty * ticketUnitValue) : '0') + ` <span>${ticketUnitName}</span>`;
	            
	            if(subsPriceEl) subsPriceEl.textContent = formatCurrency(subsTotal);
	            if(ticketPriceEl) ticketPriceEl.textContent = formatCurrency(ticketTotal);
	            
	            totalPriceEl.textContent = formatCurrency(total);
	            applyMileage(total);
	        }

	        function applyMileage(totalAmount) {
				const usedMileage = getVal(mileageInput);
				const final = Math.max(0, totalAmount - usedMileage);
				finalPriceEl.textContent = formatCurrency(final);
			}
			
	        function applyBlur() {
				const subsVal = getVal(subsInput);
				const ticketVal = getVal(ticketInput);
				
				if (subsVal > 0 && ticketVal === 0) {
					if(subsInput) subsInput.disabled = false;
					if(ticketInput) ticketInput.disabled = true;
					subsBox?.classList.remove("blur-block");
					ticketBox?.classList.add("blur-block");
				} else if (ticketVal > 0 && subsVal === 0) {
					if(subsInput) subsInput.disabled = true;
					if(ticketInput) ticketInput.disabled = false;
					subsBox?.classList.add("blur-block");
					ticketBox?.classList.remove("blur-block");
				} else {
					if(subsInput) subsInput.disabled = false;
					if(ticketInput) ticketInput.disabled = false;
					subsBox?.classList.remove("blur-block");
					ticketBox?.classList.remove("blur-block");
				}
			}

	        subsInput?.addEventListener("input", () => { updateText(); applyBlur(); });
	        ticketInput?.addEventListener("input", () => { updateText(); applyBlur(); });
	        
	        document.querySelectorAll(".qty-up, .qty-down").forEach((btn) => {
				btn.addEventListener("click", (e) => {
					e.preventDefault();
					const input = btn.closest(".detail-qty")?.querySelector(".qty-val");
					if (!input) return;
				
					const current = getVal(input);
					if (btn.classList.contains("qty-up")) {
						input.value = current + 1;
					} else {
						if (current <= 1) return;
						input.value = current - 1;
					}
				
					input.dispatchEvent(new Event("input"));
					applyBlur();
				});
			});
			
	        mileageInput?.addEventListener("input", () => {
	          const currentTotal = getVal(subsInput) * unitSubsPrice + getVal(ticketInput) * unitTicketPrice;
	          applyMileage(currentTotal);
	        });
	        
	        document.getElementById("reset-selection")?.addEventListener("click", (e) => {
				  e.preventDefault();
				  const ok = confirm("선택한 상품을 모두 초기화할까요?\n확인을 누르면 페이지가 새로고침됩니다.");
				  if (ok) {
				    location.reload();
				  }
			});

	        updateText();
	        applyBlur();
	    });
	    </script>
		<form id="paymentForm" method="get">
			<div class="d-flex justify-content-center col-lg-10 m-auto">
				<div class="row w-100">
					<div class="col-lg-7">
						<div class="table-responsive shopping-summery">
							<button id="reset-selection" class="btn btn-secondary mt-3 mb-4" type="button">선택 초기화</button>
							<table class="table table-wishlist">
								<thead>
									<tr style="border: 0px;" class="main-heading">
										<th class="custome-checkbox start pl-30" style="text-align: center;" scope="col">상품</th>
										<th style="text-align: center;">가격</th>
										<th scope="col" style="text-align: center;">개수</th>
										<th style="text-align: center;" scope="col" class="col-2">일 / 회</th>
										<th style="text-align: center;" scope="col" class="end col-2">합계</th>
									</tr>
								</thead>
								<tbody>
								    <tr th:each="product : ${productList}" class="product-row"
								        th:classappend="${product.gdsType == '구독권'} ? 'subs-product' : 'ticket-product'"
								        th:data-price="${product.gdsAmt}"
								        th:data-unit-value="${product.gdsPeriodQuantity}"
								        th:data-unit-name="${product.gdsUnit}">
								
								        <td class="product-des product-name">
								            <h6 class="mb-5" style="text-align: center;" th:text="${product.gdsNm}"></h6>
								            <input type="hidden" name="gdsCd" th:value="${product.gdsCd}">
								        </td>
								        <td class="price" data-title="Price">
								            <h5 class="text-body" style="text-align: center;" th:text="'₩' + ${#numbers.formatDecimal(product.gdsAmt, 0, 'COMMA', 0, 'POINT')}"></h5>
								        </td>
								        <td class="text-center detail-info" data-title="Stock">
								            <div class="detail-extralink mr-15">
								                <div class="detail-qty border radius">
								                    <a href="#" class="qty-down"><i class="fi-rs-angle-small-down"></i></a>
								                    <input type="text"
								                           th:id="${product.gdsType == '구독권'} ? 'subsQuantity' : 'ticketQuantity'"
								                           name="quantity" class="qty-val" value="0" min="1">
								                    <a href="#" class="qty-up"><i class="fi-rs-angle-small-up"></i></a>
								                </div>
								            </div>
								        </td>
								        <td class="price" data-title="Price">
								            <h5 style="text-align: center;"
								                th:classappend="${product.gdsType == '구독권'} ? 'days-display' : 'times-display'">
								                0 <span th:text="${product.gdsUnit}"></span>
								            </h5>
								        </td>
								        <td class="price" data-title="Price">
								            <h5 class="text-body" style="text-align: center;">₩0</h5>
								        </td>
								    </tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="col-lg-5">
						<div class="border p-md-4 cart-totals ml-30">
							<div class="table-responsive">
								<table class="table no-border">
									<tbody>
										<tr style="border: 0px;">
											<td class="cart_total_label"><h6 class="text-muted">결제상품 금액</h6></td>
											<td class="cart_total_amount"><h4 class="text-brand text-end">₩0</h4></td>
										</tr>
										<tr style="border: 0px;"><td scope="col" colspan="2"><div class="divider-2 mt-10 mb-10"></div></td></tr>
										<tr style="border: 0px;">
											<td class="cart_total_label"><h6 class="text-muted">보유 마일리지</h6></td>
											<td class="cart_total_amount"><h5 class="text-heading text-end" id="availableMileage" th:text="${#numbers.formatDecimal(availableMileage, 0, 'COMMA', 0, 'POINT')}"></h5></td>
										</tr>
										<tr style="border: 0px;">
											<td class="cart_total_label" colspan="2">
												<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
													<span><h6>사용</h6></span> 
													<input type="text" style="padding-bottom: 3px; width: 87%; height: 40px; border: none; outline: none; text-align: right;"
														   id="usedMileage" name="usedMileage" inputmode="numeric" placeholder="0"> 
													<span><h6>원</h6></span>
												</div>
											</td>
										</tr>
										<tr style="border: 0px;"><td scope="col" colspan="2"><div class="divider-2 mt-10 mb-10"></div></td></tr>
										<tr style="border: 0px;">
											<td class="cart_total_label"><h6 class="text-muted">최종 결제 금액</h6></td>
											<td class="cart_total_amount"><h4 class="text-brand text-end">₩0</h4></td>
										</tr>
									</tbody>
								</table>
							</div>
							<a href="#" id="payment-button" class="btn mb-20 w-100">결제하기</a>
						</div>
					</div>
				</div>
			</div>
		</form>


		<!-- userGoodsList JS-->
	    <script src="/user/assets/js/vendor/modernizr-3.6.0.min.js"></script>
	    <script src="/user/assets/js/vendor/jquery-3.6.0.min.js"></script>
	    <script src="/user/assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
	    <script src="/user/assets/js/vendor/bootstrap.bundle.min.js"></script>
	    <script src="/user/assets/js/plugins/slick.js"></script>
	    <script src="/user/assets/js/plugins/jquery.syotimer.min.js"></script>
	    <script src="/user/assets/js/plugins/wow.js"></script>
	    <script src="/user/assets/js/plugins/slider-range.js"></script>
	    <script src="/user/assets/js/plugins/perfect-scrollbar.js"></script>
	    <script src="/user/assets/js/plugins/magnific-popup.js"></script>
	    <script src="/user/assets/js/plugins/select2.min.js"></script>
	    <script src="/user/assets/js/plugins/waypoints.js"></script>
	    <script src="/user/assets/js/plugins/counterup.js"></script>
	    <script src="/user/assets/js/plugins/jquery.countdown.min.js"></script>
	    <script src="/user/assets/js/plugins/images-loaded.js"></script>
	    <script src="/user/assets/js/plugins/isotope.js"></script>
	    <script src="/user/assets/js/plugins/scrollup.js"></script>
	    <script src="/user/assets/js/plugins/jquery.vticker-min.js"></script>
	    <script src="/user/assets/js/plugins/jquery.theia.sticky.js"></script>
	    <script src="/user/assets/js/plugins/jquery.elevatezoom.js"></script>
	    
	    <!-- Template  JS -->
	    <script src="/user/assets/js/main.js?v=5.6"></script>
	    <script src="/user/assets/js/shop.js?v=5.6"></script>
	    
	    
	    <!-- Main Script -->
	    <script src="/user/assets/js/main.js?v=1.1" type="text/javascript"></script>
	    
	    
	    <script th:src="@{/user/assets/js/plugins/jquery-ui.js}"></script>

	</th:block>
</body>
<!-- 추가할 js file -->

</html>